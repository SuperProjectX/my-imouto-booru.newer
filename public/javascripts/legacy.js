/*  Prototype JavaScript framework, version 1.7
 *  (c) 2005-2010 Sam Stephenson
 *
 *  Prototype is freely distributable under the terms of an MIT-style license.
 *  For details, see the Prototype web site: http://www.prototypejs.org/
 *
 *--------------------------------------------------------------------------*/
function $A(e){if(!e)return[];if("toArray"in Object(e))return e.toArray();var t=e.length||0,n=new Array(t);while(t--)n[t]=e[t];return n}function $w(e){return Object.isString(e)?(e=e.strip(),e?e.split(/\s+/):[]):[]}function $H(e){return new Hash(e)}function $R(e,t,n){return new ObjectRange(e,t,n)}function $(e){if(arguments.length>1){for(var t=0,n=[],r=arguments.length;t<r;t++)n.push($(arguments[t]));return n}return Object.isString(e)&&(e=document.getElementById(e)),Element.extend(e)}function InputHandler(){TrackFocus();var e=window.opera||Prototype.Browser.Gecko?"keypress":"keydown";document.on(e,this.document_keypress_event.bindAsEventListener(this))}function notice(e,t){if(t){var n=$("static_notice");if(n){n.update(e),n.show();return}}start_notice_timer(),$("notice").update(e),$("notice-container").show()}function number_to_human_size(e,t){return t==null&&(t=1),e=Number(e),e.toFixed(0)==1?text="1 Byte":e<1024?text=e.toFixed(0)+" Bytes":e<1048576?text=(e/1024).toFixed(t)+" KB":e<1073741824?text=(e/1048576).toFixed(t)+" MB":e<1099511627776?text=(e/1073741824).toFixed(t)+" GB":text=(e/1099511627776).toFixed(t)+" TB",text=text.gsub(/([0-9]\.\d*?)0+ /,"#{1} ").gsub(/\. /," "),text}function time_ago_in_words(e,t){t==null&&(t=new Date);var e=e.valueOf(),t=t.valueOf();distance_in_seconds=Math.abs((t-e)/1e3).round(),distance_in_minutes=(distance_in_seconds/60).round();if(distance_in_minutes<=1)return"1 minute";if(distance_in_minutes<=44)return distance_in_minutes+" minutes";if(distance_in_minutes<=89)return"1 hour";if(distance_in_minutes<=1439){var n=distance_in_minutes/60;return n=(n-.5).round(),n+" hours"}if(distance_in_minutes<=2879)return"1 day";if(distance_in_minutes<=43199){var r=distance_in_minutes/1440;return r=(r-.5).round(),r+" days"}if(distance_in_minutes<=86399)return"1 month";if(distance_in_minutes<=525959){var i=distance_in_minutes/43200;return i=(i-.5).round(),i+" months"}var s=(distance_in_minutes/525960).toFixed(1);return s+" years"}function start_notice_timer(){ClearNoticeTimer&&window.clearTimeout(ClearNoticeTimer),ClearNoticeTimer=window.setTimeout(function(){$("notice-container").hide()},5e3)}function OnKeyCharCode(e,t,n){if(window.opera)return;n||(n=document),n.observe("keyup",function(t){if(t.keyCode!=e)return;KeysDown.set(KeysDown[t.keyCode],!1)}),n.observe("keypress",function(n){if(n.charCode!=e)return;if(n.shiftKey||n.altKey||n.ctrlKey||n.metaKey)return;if(KeysDown.get(KeysDown[n.keyCode]))return;KeysDown.set(KeysDown[n.keyCode],!0);var r=n.target;if(r.tagName=="INPUT"||r.tagName=="TEXTAREA")return;t(n),n.stop(),n.preventDefault()})}function OnKey(e,t,n,r){t||(t={});var i=t.Element;i||(i=document);if(i==document&&window.opera&&!t.AlwaysAllowOpera)return;i.observe("keyup",function(t){if(t.keyCode!=e)return;KeysDown[t.keyCode]=!1,r&&r(t)}),i.observe("keydown",function(r){if(r.keyCode!=e)return;if(r.metaKey)return;if(r.shiftKey!=!!t.shiftKey)return;if(r.altKey!=!!t.altKey)return;if(r.ctrlKey!=!!t.ctrlKey)return;if(!t.allowRepeat&&KeysDown[r.keyCode])return;KeysDown[r.keyCode]=!0;var i=r.target;if(!t.AllowTextAreaFields&&i.tagName=="TEXTAREA")return;if(!t.AllowInputFields&&i.tagName=="INPUT")return;if(n&&!n(r))return;r.stop(),r.preventDefault()})}function InitTextAreas(){$$("TEXTAREA").each(function(e){var t=e.up("FORM");if(!t)return;if(e.set_login_handler)return;e.set_login_handler=!0,OnKey(13,{ctrlKey:!0,AllowInputFields:!0,AllowTextAreaFields:!0,Element:e},function(e){$(t).simulate_submit()})})}function InitAdvancedEditing(){if(Cookie.get("show_advanced_editing")!="1")return;$(document.documentElement).removeClassName("hide-advanced-editing")}function createElement(e,t,n){var r=$(document.createElement(e));return r.className=t,r.innerHTML=n,r}function TrackFocus(){document.focusedElement=null,document.addEventListener&&document.addEventListener("focus",function(e){document.focusedElement=e.target}.bindAsEventListener(this),!0),document.observe("focusin",function(e){document.focusedElement=e.srcElement}.bindAsEventListener(this))}function FormatError(e,t,n,r,i){var s="";s+="Error: "+e+"\n",i!=null&&(s+=i),s+="UA: "+window.navigator.userAgent+"\n",s+="URL: "+window.location.href+"\n";var o=document.cookie;o=o.replace(/(pass_hash)=[0-9a-f]{40}/,"$1=(removed)");try{s+="Cookies: "+decodeURIComponent(o)+"\n"}catch(u){s+="Cookies (couldn't decode): "+o+"\n"}if("localStorage"in window){var a=[];try{for(l in localStorage)a.push(a)}catch(u){a=["sample_urls","sample_url_fifo","tag_data","tag_data_version","recent_tags","tag_data_format"]}for(var f=0;f<a.length;++f){var l=a[f];try{if(!(l in localStorage))continue;var c=localStorage[l],h=c.length;c.length>512&&(c=c.slice(0,512)),s+="localStorage."+l+" (size: "+h+"): "+c+"\n"}catch(u){s+="(ignored errors retrieving localStorage for "+l+": "+u+")\n"}}}return r&&r.stack&&(s+="\n"+r.stack+"\n"),t&&(s+="File: "+t,n!=null&&(s+=" line "+n+"\n")),s}function ReportError(e,t,n,r,i){if(navigator.userAgent.match(/.*MSIE [67]/))return;if(reported_error)return;reported_error=!0;if(document.cookie.indexOf("reported_error=1")!=-1)return;var s=new Date;s.setTime(s.getTime()+36e5),document.cookie="reported_error=1; path=/; expires="+s.toGMTString();var o=FormatError(r?r.message:e,t,n,r,i);try{new Ajax.Request("/user/error.json",{parameters:{report:o}})}catch(u){alert("Error: "+u)}}function LocalStorageDisabled(){if(!("localStorage"in window))return"unsupported";var e=!1;for(;;)try{localStorage.x=1;if(localStorage.x!=1)throw"disabled";return delete localStorage.x,null}catch(t){if(!e){e=!0;try{localStorage.clear()}catch(t){}continue}return navigator.userAgent.indexOf("Gecko/")!=-1&&t.message.indexOf("Security error")!=-1?"ff-disabled":"error"}}function MainMenu(e,t){this.container=e,this.def=t,this.submenu=null,this.shown_def=null,this.focused_menu_item=null,this.dropdownTimer=null,this.dragging=null,this.dragging_over=null,this.document_mouseup_event=this.document_mouseup.bindAsEventListener(this),this.document_click_event=this.document_click.bindAsEventListener(this),this.mousemove_during_dropdown_timer_event=this.mousemove_during_dropdown_timer.bindAsEventListener(this)}function QuickSearch(e,t,n){t="<div class='dropdown-menu'>"+t+"</div>",this.container=e,this.hide_event=this.hide_event.bindAsEventListener(this),this.on_document_keydown_event=this.on_document_keydown_event.bindAsEventListener(this),this.document_mousedown_event=this.document_mousedown_event.bindAsEventListener(this),this.submenu=document.createElement("div"),this.container.insertBefore(this.submenu,this.container.firstChild),$(this.submenu).replace(t),this.submenu=this.container.down(".dropdown-menu"),align_element_to_menu(this.submenu,n),document.observe("keydown",this.on_document_keydown_event),document.observe("mousedown",this.document_mousedown_event),Element.observe(window,"pageshow",this.hide_event),Element.observe(window,"pagehide",this.hide_event),this.submenu.down(".default").focus(),this.submenu.select("form").each(function(e){e.observe("submit",this.hide_event)}.bind(this))}function MakeSearchHandler(e,t,n){var r=function(r,i,s,o){var u="";u+='<form action="'+e+'" method="get">',u+='<input id="'+t+'" name="'+t+'" size="30" type="text" class="default">',u+="<br>",u+='<input style="margin-top: 0.25em;" type="submit" value="'+n+'">',u+="</form>",new QuickSearch(i.container,u,i.get_elem_for_top_item(s))};return r}function PostQuickEdit(e){this.container=e,this.submit_event=this.submit_event.bindAsEventListener(this),this.container.down("form").observe("submit",this.submit_event),this.container.down(".cancel").observe("click",function(e){e.preventDefault(),this.hide()}.bindAsEventListener(this)),this.container.down("#post_tags").observe("keydown",function(e){if(e.keyCode==Event.KEY_ESC){e.stop(),this.hide();return}if(e.keyCode!=Event.KEY_RETURN)return;this.submit_event(e)}.bindAsEventListener(this))}function AndroidDetectWindowSize(){$("sizing-body").setStyle({overflow:"hidden"}),this.padding=document.createElement("DIV"),this.padding.setStyle({width:"1px",height:"5000px"}),this.padding.style.visibility="hidden",this.padding.hide(),document.documentElement.appendChild(this.padding),this.window_size=[0,0],this.finish=this.finish.bind(this),this.event_onresize=this.event_onresize.bindAsEventListener(this),this.finish_timer=null,this.last_window_orientation=window.orientation,window.addEventListener("resize",this.event_onresize,!0),this.active=!1;var e=0,t=navigator.userAgent.match(/Android (\d+\.\d+)/);t&&parseFloat(t[1])<2.2&&(debug("Delaying bootstrapping due to Android version "+t[1]),e=1),this.begin.bind(this).delay(e)}function EmulateDoubleClick(){this.touchstart_event=this.touchstart_event.bindAsEventListener(this),this.touchend_event=this.touchend_event.bindAsEventListener(this),this.last_click=null,window.addEventListener("touchstart",this.touchstart_event,!1),window.addEventListener("touchend",this.touchend_event,!1)}var Prototype={Version:"1.7",Browser:function(){var e=navigator.userAgent,t=Object.prototype.toString.call(window.opera)=="[object Opera]";return{IE:!!window.attachEvent&&!t,Opera:t,WebKit:e.indexOf("AppleWebKit/")>-1,Gecko:e.indexOf("Gecko")>-1&&e.indexOf("KHTML")===-1,MobileSafari:/Apple.*Mobile/.test(e)}}(),BrowserFeatures:{XPath:!!document.evaluate,SelectorsAPI:!!document.querySelector,ElementExtensions:function(){var e=window.Element||window.HTMLElement;return!!e&&!!e.prototype}(),SpecificElementExtensions:function(){if(typeof window.HTMLDivElement!="undefined")return!0;var e=document.createElement("div"),t=document.createElement("form"),n=!1;return e.__proto__&&e.__proto__!==t.__proto__&&(n=!0),e=t=null,n}()},ScriptFragment:"<script[^>]*>([\\S\\s]*?)</script>",JSONFilter:/^\/\*-secure-([\s\S]*)\*\/\s*$/,emptyFunction:function(){},K:function(e){return e}};Prototype.Browser.MobileSafari&&(Prototype.BrowserFeatures.SpecificElementExtensions=!1);var Class=function(){function t(){}function n(){function r(){this.initialize.apply(this,arguments)}var e=null,n=$A(arguments);Object.isFunction(n[0])&&(e=n.shift()),Object.extend(r,Class.Methods),r.superclass=e,r.subclasses=[],e&&(t.prototype=e.prototype,r.prototype=new t,e.subclasses.push(r));for(var i=0,s=n.length;i<s;i++)r.addMethods(n[i]);return r.prototype.initialize||(r.prototype.initialize=Prototype.emptyFunction),r.prototype.constructor=r,r}function r(t){var n=this.superclass&&this.superclass.prototype,r=Object.keys(t);e&&(t.toString!=Object.prototype.toString&&r.push("toString"),t.valueOf!=Object.prototype.valueOf&&r.push("valueOf"));for(var i=0,s=r.length;i<s;i++){var o=r[i],u=t[o];if(n&&Object.isFunction(u)&&u.argumentNames()[0]=="$super"){var a=u;u=function(e){return function(){return n[e].apply(this,arguments)}}(o).wrap(a),u.valueOf=a.valueOf.bind(a),u.toString=a.toString.bind(a)}this.prototype[o]=u}return this}var e=function(){for(var e in{toString:1})if(e==="toString")return!1;return!0}();return{create:n,Methods:{addMethods:r}}}();(function(){function d(e){switch(e){case null:return t;case void 0:return n}var u=typeof e;switch(u){case"boolean":return r;case"number":return i;case"string":return s}return o}function v(e,t){for(var n in t)e[n]=t[n];return e}function m(e){try{return D(e)?"undefined":e===null?"null":e.inspect?e.inspect():String(e)}catch(t){if(t instanceof RangeError)return"...";throw t}}function g(e){return y("",{"":e},[])}function y(t,n,r){var i=n[t],s=typeof i;d(i)===o&&typeof i.toJSON=="function"&&(i=i.toJSON(t));var u=e.call(i);switch(u){case f:case a:case l:i=i.valueOf()}switch(i){case null:return"null";case!0:return"true";case!1:return"false"}s=typeof i;switch(s){case"string":return i.inspect(!0);case"number":return isFinite(i)?String(i):"null";case"object":for(var h=0,p=r.length;h<p;h++)if(r[h]===i)throw new TypeError;r.push(i);var v=[];if(u===c){for(var h=0,p=i.length;h<p;h++){var m=y(h,i,r);v.push(typeof m=="undefined"?"null":m)}v="["+v.join(",")+"]"}else{var g=Object.keys(i);for(var h=0,p=g.length;h<p;h++){var t=g[h],m=y(t,i,r);typeof m!="undefined"&&v.push(t.inspect(!0)+":"+m)}v="{"+v.join(",")+"}"}return r.pop(),v}}function b(e){return JSON.stringify(e)}function w(e){return $H(e).toQueryString()}function E(e){return e&&e.toHTML?e.toHTML():String.interpret(e)}function S(e){if(d(e)!==o)throw new TypeError;var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t}function x(e){var t=[];for(var n in e)t.push(e[n]);return t}function T(e){return v({},e)}function N(e){return!!e&&e.nodeType==1}function C(t){return e.call(t)===c}function L(e){return e instanceof Hash}function A(t){return e.call(t)===u}function O(t){return e.call(t)===l}function M(t){return e.call(t)===f}function _(t){return e.call(t)===h}function D(e){return typeof e=="undefined"}var e=Object.prototype.toString,t="Null",n="Undefined",r="Boolean",i="Number",s="String",o="Object",u="[object Function]",a="[object Boolean]",f="[object Number]",l="[object String]",c="[object Array]",h="[object Date]",p=window.JSON&&typeof JSON.stringify=="function"&&JSON.stringify(0)==="0"&&typeof JSON.stringify(Prototype.K)=="undefined",k=typeof Array.isArray=="function"&&Array.isArray([])&&!Array.isArray({});k&&(C=Array.isArray),v(Object,{extend:v,inspect:m,toJSON:p?b:g,toQueryString:w,toHTML:E,keys:Object.keys||S,values:x,clone:T,isElement:N,isArray:C,isHash:L,isFunction:A,isString:O,isNumber:M,isDate:_,isUndefined:D})})(),Object.extend(Function.prototype,function(){function t(e,t){var n=e.length,r=t.length;while(r--)e[n+r]=t[r];return e}function n(n,r){return n=e.call(n,0),t(n,r)}function r(){var e=this.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return e.length==1&&!e[0]?[]:e}function i(t){if(arguments.length<2&&Object.isUndefined(arguments[0]))return this;var r=this,i=e.call(arguments,1);return function(){var e=n(i,arguments);return r.apply(t,e)}}function s(n){var r=this,i=e.call(arguments,1);return function(e){var s=t([e||window.event],i);return r.apply(n,s)}}function o(){if(!arguments.length)return this;var t=this,r=e.call(arguments,0);return function(){var e=n(r,arguments);return t.apply(this,e)}}function u(t){var n=this,r=e.call(arguments,1);return t*=1e3,window.setTimeout(function(){return n.apply(n,r)},t)}function a(){var e=t([.01],arguments);return this.delay.apply(this,e)}function f(e){var n=this;return function(){var r=t([n.bind(this)],arguments);return e.apply(this,r)}}function l(){if(this._methodized)return this._methodized;var e=this;return this._methodized=function(){var n=t([this],arguments);return e.apply(null,n)}}var e=Array.prototype.slice;return{argumentNames:r,bind:i,bindAsEventListener:s,curry:o,delay:u,defer:a,wrap:f,methodize:l}}()),function(e){function t(){return this.getUTCFullYear()+"-"+(this.getUTCMonth()+1).toPaddedString(2)+"-"+this.getUTCDate().toPaddedString(2)+"T"+this.getUTCHours().toPaddedString(2)+":"+this.getUTCMinutes().toPaddedString(2)+":"+this.getUTCSeconds().toPaddedString(2)+"Z"}function n(){return this.toISOString()}e.toISOString||(e.toISOString=t),e.toJSON||(e.toJSON=n)}(Date.prototype),RegExp.prototype.match=RegExp.prototype.test,RegExp.escape=function(e){return String(e).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")};var PeriodicalExecuter=Class.create({initialize:function(e,t){this.callback=e,this.frequency=t,this.currentlyExecuting=!1,this.registerCallback()},registerCallback:function(){this.timer=setInterval(this.onTimerEvent.bind(this),this.frequency*1e3)},execute:function(){this.callback(this)},stop:function(){if(!this.timer)return;clearInterval(this.timer),this.timer=null},onTimerEvent:function(){if(!this.currentlyExecuting)try{this.currentlyExecuting=!0,this.execute(),this.currentlyExecuting=!1}catch(e){throw this.currentlyExecuting=!1,e}}});Object.extend(String,{interpret:function(e){return e==null?"":String(e)},specialChar:{"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","\\":"\\\\"}}),Object.extend(String.prototype,function(){function prepareReplacement(e){if(Object.isFunction(e))return e;var t=new Template(e);return function(e){return t.evaluate(e)}}function gsub(e,t){var n="",r=this,i;t=prepareReplacement(t),Object.isString(e)&&(e=RegExp.escape(e));if(!e.length&&!e.source)return t=t(""),t+r.split("").join(t)+t;while(r.length>0)(i=r.match(e))?(n+=r.slice(0,i.index),n+=String.interpret(t(i)),r=r.slice(i.index+i[0].length)):(n+=r,r="");return n}function sub(e,t,n){return t=prepareReplacement(t),n=Object.isUndefined(n)?1:n,this.gsub(e,function(e){return--n<0?e[0]:t(e)})}function scan(e,t){return this.gsub(e,t),String(this)}function truncate(e,t){return e=e||30,t=Object.isUndefined(t)?"...":t,this.length>e?this.slice(0,e-t.length)+t:String(this)}function strip(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}function stripTags(){return this.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")}function stripScripts(){return this.replace(new RegExp(Prototype.ScriptFragment,"img"),"")}function extractScripts(){var e=new RegExp(Prototype.ScriptFragment,"img"),t=new RegExp(Prototype.ScriptFragment,"im");return(this.match(e)||[]).map(function(e){return(e.match(t)||["",""])[1]})}function evalScripts(){return this.extractScripts().map(function(script){return eval(script)})}function escapeHTML(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function unescapeHTML(){return this.stripTags().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}function toQueryParams(e){var t=this.strip().match(/([^?#]*)(#.*)?$/);return t?t[1].split(e||"&").inject({},function(e,t){if((t=t.split("="))[0]){var n=decodeURIComponent(t.shift()),r=t.length>1?t.join("="):t[0];r!=undefined&&(r=decodeURIComponent(r)),n in e?(Object.isArray(e[n])||(e[n]=[e[n]]),e[n].push(r)):e[n]=r}return e}):{}}function toArray(){return this.split("")}function succ(){return this.slice(0,this.length-1)+String.fromCharCode(this.charCodeAt(this.length-1)+1)}function times(e){return e<1?"":(new Array(e+1)).join(this)}function camelize(){return this.replace(/-+(.)?/g,function(e,t){return t?t.toUpperCase():""})}function capitalize(){return this.charAt(0).toUpperCase()+this.substring(1).toLowerCase()}function underscore(){return this.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/-/g,"_").toLowerCase()}function dasherize(){return this.replace(/_/g,"-")}function inspect(e){var t=this.replace(/[\x00-\x1f\\]/g,function(e){return e in String.specialChar?String.specialChar[e]:"\\u00"+e.charCodeAt().toPaddedString(2,16)});return e?'"'+t.replace(/"/g,'\\"')+'"':"'"+t.replace(/'/g,"\\'")+"'"}function unfilterJSON(e){return this.replace(e||Prototype.JSONFilter,"$1")}function isJSON(){var e=this;return e.blank()?!1:(e=e.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@"),e=e.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]"),e=e.replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(e))}function evalJSON(sanitize){var json=this.unfilterJSON(),cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;cx.test(json)&&(json=json.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}));try{if(!sanitize||json.isJSON())return eval("("+json+")")}catch(e){}throw new SyntaxError("Badly formed JSON string: "+this.inspect())}function parseJSON(){var e=this.unfilterJSON();return JSON.parse(e)}function include(e){return this.indexOf(e)>-1}function startsWith(e){return this.lastIndexOf(e,0)===0}function endsWith(e){var t=this.length-e.length;return t>=0&&this.indexOf(e,t)===t}function empty(){return this==""}function blank(){return/^\s*$/.test(this)}function interpolate(e,t){return(new Template(this,t)).evaluate(e)}var NATIVE_JSON_PARSE_SUPPORT=window.JSON&&typeof JSON.parse=="function"&&JSON.parse('{"test": true}').test;return{gsub:gsub,sub:sub,scan:scan,truncate:truncate,strip:String.prototype.trim||strip,stripTags:stripTags,stripScripts:stripScripts,extractScripts:extractScripts,evalScripts:evalScripts,escapeHTML:escapeHTML,unescapeHTML:unescapeHTML,toQueryParams:toQueryParams,parseQuery:toQueryParams,toArray:toArray,succ:succ,times:times,camelize:camelize,capitalize:capitalize,underscore:underscore,dasherize:dasherize,inspect:inspect,unfilterJSON:unfilterJSON,isJSON:isJSON,evalJSON:NATIVE_JSON_PARSE_SUPPORT?parseJSON:evalJSON,include:include,startsWith:startsWith,endsWith:endsWith,empty:empty,blank:blank,interpolate:interpolate}}());var Template=Class.create({initialize:function(e,t){this.template=e.toString(),this.pattern=t||Template.Pattern},evaluate:function(e){return e&&Object.isFunction(e.toTemplateReplacements)&&(e=e.toTemplateReplacements()),this.template.gsub(this.pattern,function(t){if(e==null)return t[1]+"";var n=t[1]||"";if(n=="\\")return t[2];var r=e,i=t[3],s=/^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/;t=s.exec(i);if(t==null)return n;while(t!=null){var o=t[1].startsWith("[")?t[2].replace(/\\\\]/g,"]"):t[1];r=r[o];if(null==r||""==t[3])break;i=i.substring("["==t[3]?t[1].length:t[0].length),t=s.exec(i)}return n+String.interpret(r)})}});Template.Pattern=/(^|.|\r|\n)(#\{(.*?)\})/;var $break={},Enumerable=function(){function e(e,t){var n=0;try{this._each(function(r){e.call(t,r,n++)})}catch(r){if(r!=$break)throw r}return this}function t(e,t,n){var r=-e,i=[],s=this.toArray();if(e<1)return s;while((r+=e)<s.length)i.push(s.slice(r,r+e));return i.collect(t,n)}function n(e,t){e=e||Prototype.K;var n=!0;return this.each(function(r,i){n=n&&!!e.call(t,r,i);if(!n)throw $break}),n}function r(e,t){e=e||Prototype.K;var n=!1;return this.each(function(r,i){if(n=!!e.call(t,r,i))throw $break}),n}function i(e,t){e=e||Prototype.K;var n=[];return this.each(function(r,i){n.push(e.call(t,r,i))}),n}function s(e,t){var n;return this.each(function(r,i){if(e.call(t,r,i))throw n=r,$break}),n}function o(e,t){var n=[];return this.each(function(r,i){e.call(t,r,i)&&n.push(r)}),n}function u(e,t,n){t=t||Prototype.K;var r=[];return Object.isString(e)&&(e=new RegExp(RegExp.escape(e))),this.each(function(i,s){e.match(i)&&r.push(t.call(n,i,s))}),r}function a(e){if(Object.isFunction(this.indexOf)&&this.indexOf(e)!=-1)return!0;var t=!1;return this.each(function(n){if(n==e)throw t=!0,$break}),t}function f(e,t){return t=Object.isUndefined(t)?null:t,this.eachSlice(e,function(n){while(n.length<e)n.push(t);return n})}function l(e,t,n){return this.each(function(r,i){e=t.call(n,e,r,i)}),e}function c(e){var t=$A(arguments).slice(1);return this.map(function(n){return n[e].apply(n,t)})}function h(e,t){e=e||Prototype.K;var n;return this.each(function(r,i){r=e.call(t,r,i);if(n==null||r>=n)n=r}),n}function p(e,t){e=e||Prototype.K;var n;return this.each(function(r,i){r=e.call(t,r,i);if(n==null||r<n)n=r}),n}function d(e,t){e=e||Prototype.K;var n=[],r=[];return this.each(function(i,s){(e.call(t,i,s)?n:r).push(i)}),[n,r]}function v(e){var t=[];return this.each(function(n){t.push(n[e])}),t}function m(e,t){var n=[];return this.each(function(r,i){e.call(t,r,i)||n.push(r)}),n}function g(e,t){return this.map(function(n,r){return{value:n,criteria:e.call(t,n,r)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;return n<r?-1:n>r?1:0}).pluck("value")}function y(){return this.map()}function b(){var e=Prototype.K,t=$A(arguments);Object.isFunction(t.last())&&(e=t.pop());var n=[this].concat(t).map($A);return this.map(function(t,r){return e(n.pluck(r))})}function w(){return this.toArray().length}function E(){return"#<Enumerable:"+this.toArray().inspect()+">"}return{each:e,eachSlice:t,all:n,every:n,any:r,some:r,collect:i,map:i,detect:s,findAll:o,select:o,filter:o,grep:u,include:a,member:a,inGroupsOf:f,inject:l,invoke:c,max:h,min:p,partition:d,pluck:v,reject:m,sortBy:g,toArray:y,entries:y,zip:b,size:w,inspect:E,find:s}}();Array.from=$A,function(){function r(e,t){for(var n=0,r=this.length>>>0;n<r;n++)n in this&&e.call(t,this[n],n,this)}function i(){return this.length=0,this}function s(){return this[0]}function o(){return this[this.length-1]}function u(){return this.select(function(e){return e!=null})}function a(){return this.inject([],function(e,t){return Object.isArray(t)?e.concat(t.flatten()):(e.push(t),e)})}function f(){var e=t.call(arguments,0);return this.select(function(t){return!e.include(t)})}function l(e){return(e===!1?this.toArray():this)._reverse()}function c(e){return this.inject([],function(t,n,r){return(0==r||(e?t.last()!=n:!t.include(n)))&&t.push(n),t})}function h(e){return this.uniq().findAll(function(t){return e.detect(function(e){return t===e})})}function p(){return t.call(this,0)}function d(){return this.length}function v(){return"["+this.map(Object.inspect).join(", ")+"]"}function m(e,t){t||(t=0);var n=this.length;t<0&&(t=n+t);for(;t<n;t++)if(this[t]===e)return t;return-1}function g(e,t){t=isNaN(t)?this.length:(t<0?this.length+t:t)+1;var n=this.slice(0,t).reverse().indexOf(e);return n<0?n:t-n-1}function y(){var e=t.call(this,0),n;for(var r=0,i=arguments.length;r<i;r++){n=arguments[r];if(!Object.isArray(n)||"callee"in n)e.push(n);else for(var s=0,o=n.length;s<o;s++)e.push(n[s])}return e}var e=Array.prototype,t=e.slice,n=e.forEach;n||(n=r),Object.extend(e,Enumerable),e._reverse||(e._reverse=e.reverse),Object.extend(e,{_each:n,clear:i,first:s,last:o,compact:u,flatten:a,without:f,reverse:l,uniq:c,intersect:h,clone:p,toArray:p,size:d,inspect:v});var b=function(){return[].concat(arguments)[0][0]!==1}(1,2);b&&(e.concat=y),e.indexOf||(e.indexOf=m),e.lastIndexOf||(e.lastIndexOf=g)}();var Hash=Class.create(Enumerable,function(){function e(e){this._object=Object.isHash(e)?e.toObject():Object.clone(e)}function t(e){for(var t in this._object){var n=this._object[t],r=[t,n];r.key=t,r.value=n,e(r)}}function n(e,t){return this._object[e]=t}function r(e){if(this._object[e]!==Object.prototype[e])return this._object[e]}function i(e){var t=this._object[e];return delete this._object[e],t}function s(){return Object.clone(this._object)}function o(){return this.pluck("key")}function u(){return this.pluck("value")}function a(e){var t=this.detect(function(t){return t.value===e});return t&&t.key}function f(e){return this.clone().update(e)}function l(e){return(new Hash(e)).inject(this,function(e,t){return e.set(t.key,t.value),e})}function c(e,t){return Object.isUndefined(t)?e:e+"="+encodeURIComponent(String.interpret(t))}function h(){return this.inject([],function(e,t){var n=encodeURIComponent(t.key),r=t.value;if(r&&typeof r=="object"){if(Object.isArray(r)){var i=[];for(var s=0,o=r.length,u;s<o;s++)u=r[s],i.push(c(n,u));return e.concat(i)}}else e.push(c(n,r));return e}).join("&")}function p(){return"#<Hash:{"+this.map(function(e){return e.map(Object.inspect).join(": ")}).join(", ")+"}>"}function d(){return new Hash(this)}return{initialize:e,_each:t,set:n,get:r,unset:i,toObject:s,toTemplateReplacements:s,keys:o,values:u,index:a,merge:f,update:l,toQueryString:h,inspect:p,toJSON:s,clone:d}}());Hash.from=$H,Object.extend(Number.prototype,function(){function e(){return this.toPaddedString(2,16)}function t(){return this+1}function n(e,t){return $R(0,this,!0).each(e,t),this}function r(e,t){var n=this.toString(t||10);return"0".times(e-n.length)+n}function i(){return Math.abs(this)}function s(){return Math.round(this)}function o(){return Math.ceil(this)}function u(){return Math.floor(this)}return{toColorPart:e,succ:t,times:n,toPaddedString:r,abs:i,round:s,ceil:o,floor:u}}());var ObjectRange=Class.create(Enumerable,function(){function e(e,t,n){this.start=e,this.end=t,this.exclusive=n}function t(e){var t=this.start;while(this.include(t))e(t),t=t.succ()}function n(e){return e<this.start?!1:this.exclusive?e<this.end:e<=this.end}return{initialize:e,_each:t,include:n}}()),Abstract={},Try={these:function(){var e;for(var t=0,n=arguments.length;t<n;t++){var r=arguments[t];try{e=r();break}catch(i){}}return e}},Ajax={getTransport:function(){return Try.these(function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")})||!1},activeRequestCount:0};Ajax.Responders={responders:[],_each:function(e){this.responders._each(e)},register:function(e){this.include(e)||this.responders.push(e)},unregister:function(e){this.responders=this.responders.without(e)},dispatch:function(e,t,n,r){this.each(function(i){if(Object.isFunction(i[e]))try{i[e].apply(i,[t,n,r])}catch(s){}})}},Object.extend(Ajax.Responders,Enumerable),Ajax.Responders.register({onCreate:function(){Ajax.activeRequestCount++},onComplete:function(){Ajax.activeRequestCount--}}),Ajax.Base=Class.create({initialize:function(e){this.options={method:"post",asynchronous:!0,contentType:"application/x-www-form-urlencoded",encoding:"UTF-8",parameters:"",evalJSON:!0,evalJS:!0},Object.extend(this.options,e||{}),this.options.method=this.options.method.toLowerCase(),Object.isHash(this.options.parameters)&&(this.options.parameters=this.options.parameters.toObject())}}),Ajax.Request=Class.create(Ajax.Base,{_complete:!1,initialize:function($super,e,t){$super(t),this.transport=Ajax.getTransport(),this.request(e)},request:function(e){this.url=e,this.method=this.options.method;var t=Object.isString(this.options.parameters)?this.options.parameters:Object.toQueryString(this.options.parameters);["get","post"].include(this.method)||(t+=(t?"&":"")+"_method="+this.method,this.method="post"),t&&this.method==="get"&&(this.url+=(this.url.include("?")?"&":"?")+t),this.parameters=t.toQueryParams();try{var n=new Ajax.Response(this);this.options.onCreate&&this.options.onCreate(n),Ajax.Responders.dispatch("onCreate",this,n),this.transport.open(this.method.toUpperCase(),this.url,this.options.asynchronous),this.options.asynchronous&&this.respondToReadyState.bind(this).defer(1),this.transport.onreadystatechange=this.onStateChange.bind(this),this.setRequestHeaders(),this.body=this.method=="post"?this.options.postBody||t:null,this.transport.send(this.body),!this.options.asynchronous&&this.transport.overrideMimeType&&this.onStateChange()}catch(r){this.dispatchException(r)}},onStateChange:function(){var e=this.transport.readyState;e>1&&(e!=4||!this._complete)&&this.respondToReadyState(this.transport.readyState)},setRequestHeaders:function(){var e={"X-Requested-With":"XMLHttpRequest","X-Prototype-Version":Prototype.Version,Accept:"text/javascript, text/html, application/xml, text/xml, */*"};this.method=="post"&&(this.options.contentType!=null&&(e["Content-type"]=this.options.contentType+(this.options.encoding?"; charset="+this.options.encoding:"")),this.transport.overrideMimeType&&(navigator.userAgent.match(/Gecko\/(\d{4})/)||[0,2005])[1]<2005&&(e.Connection="close"));if(typeof this.options.requestHeaders=="object"){var t=this.options.requestHeaders;if(Object.isFunction(t.push))for(var n=0,r=t.length;n<r;n+=2)e[t[n]]=t[n+1];else $H(t).each(function(t){e[t.key]=t.value})}for(var i in e)this.transport.setRequestHeader(i,e[i])},success:function(){var e=this.getStatus();return!e||e>=200&&e<300||e==304},getStatus:function(){try{return this.transport.status===1223?204:this.transport.status||0}catch(e){return 0}},respondToReadyState:function(e){var t=Ajax.Request.Events[e],n=new Ajax.Response(this);if(t=="Complete"){try{this._complete=!0,(this.options["on"+n.status]||this.options["on"+(this.success()?"Success":"Failure")]||Prototype.emptyFunction)(n,n.headerJSON)}catch(r){this.dispatchException(r)}var i=n.getHeader("Content-type");(this.options.evalJS=="force"||this.options.evalJS&&this.isSameOrigin()&&i&&i.match(/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i))&&this.evalResponse()}try{(this.options["on"+t]||Prototype.emptyFunction)(n,n.headerJSON),Ajax.Responders.dispatch("on"+t,this,n,n.headerJSON)}catch(r){this.dispatchException(r)}t=="Complete"&&(this.transport.onreadystatechange=Prototype.emptyFunction)},isSameOrigin:function(){var e=this.url.match(/^\s*https?:\/\/[^\/]*/);return!e||e[0]=="#{protocol}//#{domain}#{port}".interpolate({protocol:location.protocol,domain:document.domain,port:location.port?":"+location.port:""})},getHeader:function(e){try{return this.transport.getResponseHeader(e)||null}catch(t){return null}},evalResponse:function(){try{return eval((this.transport.responseText||"").unfilterJSON())}catch(e){this.dispatchException(e)}},dispatchException:function(e){(this.options.onException||Prototype.emptyFunction)(this,e),Ajax.Responders.dispatch("onException",this,e)}}),Ajax.Request.Events=["Uninitialized","Loading","Loaded","Interactive","Complete"],Ajax.Response=
Class.create({initialize:function(e){this.request=e;var t=this.transport=e.transport,n=this.readyState=t.readyState;if(n>2&&!Prototype.Browser.IE||n==4)this.status=this.getStatus(),this.statusText=this.getStatusText(),this.responseText=String.interpret(t.responseText),this.headerJSON=this._getHeaderJSON();if(n==4){var r=t.responseXML;this.responseXML=Object.isUndefined(r)?null:r,this.responseJSON=this._getResponseJSON()}},status:0,statusText:"",getStatus:Ajax.Request.prototype.getStatus,getStatusText:function(){try{return this.transport.statusText||""}catch(e){return""}},getHeader:Ajax.Request.prototype.getHeader,getAllHeaders:function(){try{return this.getAllResponseHeaders()}catch(e){return null}},getResponseHeader:function(e){return this.transport.getResponseHeader(e)},getAllResponseHeaders:function(){return this.transport.getAllResponseHeaders()},_getHeaderJSON:function(){var e=this.getHeader("X-JSON");if(!e)return null;e=decodeURIComponent(escape(e));try{return e.evalJSON(this.request.options.sanitizeJSON||!this.request.isSameOrigin())}catch(t){this.request.dispatchException(t)}},_getResponseJSON:function(){var e=this.request.options;if(!e.evalJSON||e.evalJSON!="force"&&!(this.getHeader("Content-type")||"").include("application/json")||this.responseText.blank())return null;try{return this.responseText.evalJSON(e.sanitizeJSON||!this.request.isSameOrigin())}catch(t){this.request.dispatchException(t)}}}),Ajax.Updater=Class.create(Ajax.Request,{initialize:function($super,e,t,n){this.container={success:e.success||e,failure:e.failure||(e.success?null:e)},n=Object.clone(n);var r=n.onComplete;n.onComplete=function(e,t){this.updateContent(e.responseText),Object.isFunction(r)&&r(e,t)}.bind(this),$super(t,n)},updateContent:function(e){var t=this.container[this.success()?"success":"failure"],n=this.options;n.evalScripts||(e=e.stripScripts());if(t=$(t))if(n.insertion)if(Object.isString(n.insertion)){var r={};r[n.insertion]=e,t.insert(r)}else n.insertion(t,e);else t.update(e)}}),Ajax.PeriodicalUpdater=Class.create(Ajax.Base,{initialize:function($super,e,t,n){$super(n),this.onComplete=this.options.onComplete,this.frequency=this.options.frequency||2,this.decay=this.options.decay||1,this.updater={},this.container=e,this.url=t,this.start()},start:function(){this.options.onComplete=this.updateComplete.bind(this),this.onTimerEvent()},stop:function(){this.updater.options.onComplete=undefined,clearTimeout(this.timer),(this.onComplete||Prototype.emptyFunction).apply(this,arguments)},updateComplete:function(e){this.options.decay&&(this.decay=e.responseText==this.lastText?this.decay*this.options.decay:1,this.lastText=e.responseText),this.timer=this.onTimerEvent.bind(this).delay(this.decay*this.frequency)},onTimerEvent:function(){this.updater=new Ajax.Updater(this.container,this.url,this.options)}}),Prototype.BrowserFeatures.XPath&&(document._getElementsByXPath=function(e,t){var n=[],r=document.evaluate(e,$(t)||document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var i=0,s=r.snapshotLength;i<s;i++)n.push(Element.extend(r.snapshotItem(i)));return n});if(!Node)var Node={};Node.ELEMENT_NODE||Object.extend(Node,{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),function(e){function t(e,t){return e==="select"?!1:"type"in t?!1:!0}var n=function(){try{var e=document.createElement('<input name="x">');return e.tagName.toLowerCase()==="input"&&e.name==="x"}catch(t){return!1}}(),r=e.Element;e.Element=function(e,r){r=r||{},e=e.toLowerCase();var i=Element.cache;if(n&&r.name)return e="<"+e+' name="'+r.name+'">',delete r.name,Element.writeAttribute(document.createElement(e),r);i[e]||(i[e]=Element.extend(document.createElement(e)));var s=t(e,r)?i[e].cloneNode(!1):document.createElement(e);return Element.writeAttribute(s,r)},Object.extend(e.Element,r||{}),r&&(e.Element.prototype=r.prototype)}(this),Element.idCounter=1,Element.cache={},Element._purgeElement=function(e){var t=e._prototypeUID;t&&(Element.stopObserving(e),e._prototypeUID=void 0,delete Element.Storage[t])},Element.Methods={visible:function(e){return $(e).style.display!="none"},toggle:function(e){return e=$(e),Element[Element.visible(e)?"hide":"show"](e),e},hide:function(e){return e=$(e),e.style.display="none",e},show:function(e){return e=$(e),e.style.display="",e},remove:function(e){return e=$(e),e.parentNode.removeChild(e),e},update:function(){function s(e,t){e=$(e);var s=Element._purgeElement,o=e.getElementsByTagName("*"),u=o.length;while(u--)s(o[u]);t&&t.toElement&&(t=t.toElement());if(Object.isElement(t))return e.update().insert(t);t=Object.toHTML(t);var a=e.tagName.toUpperCase();if(a==="SCRIPT"&&i)return e.text=t,e;if(r)if(a in Element._insertionTranslations.tags){while(e.firstChild)e.removeChild(e.firstChild);Element._getContentFromAnonymousElement(a,t.stripScripts()).each(function(t){e.appendChild(t)})}else if(n&&Object.isString(t)&&t.indexOf("<link")>-1){while(e.firstChild)e.removeChild(e.firstChild);var f=Element._getContentFromAnonymousElement(a,t.stripScripts(),!0);f.each(function(t){e.appendChild(t)})}else e.innerHTML=t.stripScripts();else e.innerHTML=t.stripScripts();return t.evalScripts.bind(t).defer(),e}var e=function(){var e=document.createElement("select"),t=!0;return e.innerHTML='<option value="test">test</option>',e.options&&e.options[0]&&(t=e.options[0].nodeName.toUpperCase()!=="OPTION"),e=null,t}(),t=function(){try{var e=document.createElement("table");if(e&&e.tBodies){e.innerHTML="<tbody><tr><td>test</td></tr></tbody>";var t=typeof e.tBodies[0]=="undefined";return e=null,t}}catch(n){return!0}}(),n=function(){try{var e=document.createElement("div");e.innerHTML="<link>";var t=e.childNodes.length===0;return e=null,t}catch(n){return!0}}(),r=e||t||n,i=function(){var e=document.createElement("script"),t=!1;try{e.appendChild(document.createTextNode("")),t=!e.firstChild||e.firstChild&&e.firstChild.nodeType!==3}catch(n){t=!0}return e=null,t}();return s}(),replace:function(e,t){e=$(e);if(t&&t.toElement)t=t.toElement();else if(!Object.isElement(t)){t=Object.toHTML(t);var n=e.ownerDocument.createRange();n.selectNode(e),t.evalScripts.bind(t).defer(),t=n.createContextualFragment(t.stripScripts())}return e.parentNode.replaceChild(t,e),e},insert:function(e,t){e=$(e);if(Object.isString(t)||Object.isNumber(t)||Object.isElement(t)||t&&(t.toElement||t.toHTML))t={bottom:t};var n,r,i,s;for(var o in t){n=t[o],o=o.toLowerCase(),r=Element._insertionTranslations[o],n&&n.toElement&&(n=n.toElement());if(Object.isElement(n)){r(e,n);continue}n=Object.toHTML(n),i=(o=="before"||o=="after"?e.parentNode:e).tagName.toUpperCase(),s=Element._getContentFromAnonymousElement(i,n.stripScripts()),(o=="top"||o=="after")&&s.reverse(),s.each(r.curry(e)),n.evalScripts.bind(n).defer()}return e},wrap:function(e,t,n){return e=$(e),Object.isElement(t)?$(t).writeAttribute(n||{}):Object.isString(t)?t=new Element(t,n):t=new Element("div",t),e.parentNode&&e.parentNode.replaceChild(t,e),t.appendChild(e),t},inspect:function(e){e=$(e);var t="<"+e.tagName.toLowerCase();return $H({id:"id",className:"class"}).each(function(n){var r=n.first(),i=n.last(),s=(e[r]||"").toString();s&&(t+=" "+i+"="+s.inspect(!0))}),t+">"},recursivelyCollect:function(e,t,n){e=$(e),n=n||-1;var r=[];while(e=e[t]){e.nodeType==1&&r.push(Element.extend(e));if(r.length==n)break}return r},ancestors:function(e){return Element.recursivelyCollect(e,"parentNode")},descendants:function(e){return Element.select(e,"*")},firstDescendant:function(e){e=$(e).firstChild;while(e&&e.nodeType!=1)e=e.nextSibling;return $(e)},immediateDescendants:function(e){var t=[],n=$(e).firstChild;while(n)n.nodeType===1&&t.push(Element.extend(n)),n=n.nextSibling;return t},previousSiblings:function(e,t){return Element.recursivelyCollect(e,"previousSibling")},nextSiblings:function(e){return Element.recursivelyCollect(e,"nextSibling")},siblings:function(e){return e=$(e),Element.previousSiblings(e).reverse().concat(Element.nextSiblings(e))},match:function(e,t){return e=$(e),Object.isString(t)?Prototype.Selector.match(e,t):t.match(e)},up:function(e,t,n){e=$(e);if(arguments.length==1)return $(e.parentNode);var r=Element.ancestors(e);return Object.isNumber(t)?r[t]:Prototype.Selector.find(r,t,n)},down:function(e,t,n){return e=$(e),arguments.length==1?Element.firstDescendant(e):Object.isNumber(t)?Element.descendants(e)[t]:Element.select(e,t)[n||0]},previous:function(e,t,n){return e=$(e),Object.isNumber(t)&&(n=t,t=!1),Object.isNumber(n)||(n=0),t?Prototype.Selector.find(e.previousSiblings(),t,n):e.recursivelyCollect("previousSibling",n+1)[n]},next:function(e,t,n){e=$(e),Object.isNumber(t)&&(n=t,t=!1),Object.isNumber(n)||(n=0);if(t)return Prototype.Selector.find(e.nextSiblings(),t,n);var r=Object.isNumber(n)?n+1:1;return e.recursivelyCollect("nextSibling",n+1)[n]},select:function(e){e=$(e);var t=Array.prototype.slice.call(arguments,1).join(", ");return Prototype.Selector.select(t,e)},adjacent:function(e){e=$(e);var t=Array.prototype.slice.call(arguments,1).join(", ");return Prototype.Selector.select(t,e.parentNode).without(e)},identify:function(e){e=$(e);var t=Element.readAttribute(e,"id");if(t)return t;do t="anonymous_element_"+Element.idCounter++;while($(t));return Element.writeAttribute(e,"id",t),t},readAttribute:function(e,t){e=$(e);if(Prototype.Browser.IE){var n=Element._attributeTranslations.read;if(n.values[t])return n.values[t](e,t);n.names[t]&&(t=n.names[t]);if(t.include(":"))return!e.attributes||!e.attributes[t]?null:e.attributes[t].value}return e.getAttribute(t)},writeAttribute:function(e,t,n){e=$(e);var r={},i=Element._attributeTranslations.write;typeof t=="object"?r=t:r[t]=Object.isUndefined(n)?!0:n;for(var s in r)t=i.names[s]||s,n=r[s],i.values[s]&&(t=i.values[s](e,n)),n===!1||n===null?e.removeAttribute(t):n===!0?e.setAttribute(t,t):e.setAttribute(t,n);return e},getHeight:function(e){return Element.getDimensions(e).height},getWidth:function(e){return Element.getDimensions(e).width},classNames:function(e){return new Element.ClassNames(e)},hasClassName:function(e,t){if(!(e=$(e)))return;var n=e.className;return n.length>0&&(n==t||(new RegExp("(^|\\s)"+t+"(\\s|$)")).test(n))},addClassName:function(e,t){if(!(e=$(e)))return;return Element.hasClassName(e,t)||(e.className+=(e.className?" ":"")+t),e},removeClassName:function(e,t){if(!(e=$(e)))return;return e.className=e.className.replace(new RegExp("(^|\\s+)"+t+"(\\s+|$)")," ").strip(),e},toggleClassName:function(e,t){if(!(e=$(e)))return;return Element[Element.hasClassName(e,t)?"removeClassName":"addClassName"](e,t)},cleanWhitespace:function(e){e=$(e);var t=e.firstChild;while(t){var n=t.nextSibling;t.nodeType==3&&!/\S/.test(t.nodeValue)&&e.removeChild(t),t=n}return e},empty:function(e){return $(e).innerHTML.blank()},descendantOf:function(e,t){e=$(e),t=$(t);if(e.compareDocumentPosition)return(e.compareDocumentPosition(t)&8)===8;if(t.contains)return t.contains(e)&&t!==e;while(e=e.parentNode)if(e==t)return!0;return!1},scrollTo:function(e){e=$(e);var t=Element.cumulativeOffset(e);return window.scrollTo(t[0],t[1]),e},getStyle:function(e,t){e=$(e),t=t=="float"?"cssFloat":t.camelize();var n=e.style[t];if(!n||n=="auto"){var r=document.defaultView.getComputedStyle(e,null);n=r?r[t]:null}return t=="opacity"?n?parseFloat(n):1:n=="auto"?null:n},getOpacity:function(e){return $(e).getStyle("opacity")},setStyle:function(e,t){e=$(e);var n=e.style,r;if(Object.isString(t))return e.style.cssText+=";"+t,t.include("opacity")?e.setOpacity(t.match(/opacity:\s*(\d?\.?\d*)/)[1]):e;for(var i in t)i=="opacity"?e.setOpacity(t[i]):n[i=="float"||i=="cssFloat"?Object.isUndefined(n.styleFloat)?"cssFloat":"styleFloat":i]=t[i];return e},setOpacity:function(e,t){return e=$(e),e.style.opacity=t==1||t===""?"":t<1e-5?0:t,e},makePositioned:function(e){e=$(e);var t=Element.getStyle(e,"position");if(t=="static"||!t)e._madePositioned=!0,e.style.position="relative",Prototype.Browser.Opera&&(e.style.top=0,e.style.left=0);return e},undoPositioned:function(e){return e=$(e),e._madePositioned&&(e._madePositioned=undefined,e.style.position=e.style.top=e.style.left=e.style.bottom=e.style.right=""),e},makeClipping:function(e){return e=$(e),e._overflow?e:(e._overflow=Element.getStyle(e,"overflow")||"auto",e._overflow!=="hidden"&&(e.style.overflow="hidden"),e)},undoClipping:function(e){return e=$(e),e._overflow?(e.style.overflow=e._overflow=="auto"?"":e._overflow,e._overflow=null,e):e},clonePosition:function(e,t){var n=Object.extend({setLeft:!0,setTop:!0,setWidth:!0,setHeight:!0,offsetTop:0,offsetLeft:0},arguments[2]||{});t=$(t);var r=Element.viewportOffset(t),i=[0,0],s=null;return e=$(e),Element.getStyle(e,"position")=="absolute"&&(s=Element.getOffsetParent(e),i=Element.viewportOffset(s)),s==document.body&&(i[0]-=document.body.offsetLeft,i[1]-=document.body.offsetTop),n.setLeft&&(e.style.left=r[0]-i[0]+n.offsetLeft+"px"),n.setTop&&(e.style.top=r[1]-i[1]+n.offsetTop+"px"),n.setWidth&&(e.style.width=t.offsetWidth+"px"),n.setHeight&&(e.style.height=t.offsetHeight+"px"),e}},Object.extend(Element.Methods,{getElementsBySelector:Element.Methods.select,childElements:Element.Methods.immediateDescendants}),Element._attributeTranslations={write:{names:{className:"class",htmlFor:"for"},values:{}}},Prototype.Browser.Opera?(Element.Methods.getStyle=Element.Methods.getStyle.wrap(function(e,t,n){switch(n){case"height":case"width":if(!Element.visible(t))return null;var r=parseInt(e(t,n),10);if(r!==t["offset"+n.capitalize()])return r+"px";var i;return n==="height"?i=["border-top-width","padding-top","padding-bottom","border-bottom-width"]:i=["border-left-width","padding-left","padding-right","border-right-width"],i.inject(r,function(n,r){var i=e(t,r);return i===null?n:n-parseInt(i,10)})+"px";default:return e(t,n)}}),Element.Methods.readAttribute=Element.Methods.readAttribute.wrap(function(e,t,n){return n==="title"?t.title:e(t,n)})):Prototype.Browser.IE?(Element.Methods.getStyle=function(e,t){e=$(e),t=t=="float"||t=="cssFloat"?"styleFloat":t.camelize();var n=e.style[t];!n&&e.currentStyle&&(n=e.currentStyle[t]);if(t=="opacity"){if(n=(e.getStyle("filter")||"").match(/alpha\(opacity=(.*)\)/))if(n[1])return parseFloat(n[1])/100;return 1}return n=="auto"?t!="width"&&t!="height"||e.getStyle("display")=="none"?null:e["offset"+t.capitalize()]+"px":n},Element.Methods.setOpacity=function(e,t){function n(e){return e.replace(/alpha\([^\)]*\)/gi,"")}e=$(e);var r=e.currentStyle;if(r&&!r.hasLayout||!r&&e.style.zoom=="normal")e.style.zoom=1;var i=e.getStyle("filter"),s=e.style;return t==1||t===""?((i=n(i))?s.filter=i:s.removeAttribute("filter"),e):(t<1e-5&&(t=0),s.filter=n(i)+"alpha(opacity="+t*100+")",e)},Element._attributeTranslations=function(){var e="className",t="for",n=document.createElement("div");return n.setAttribute(e,"x"),n.className!=="x"&&(n.setAttribute("class","x"),n.className==="x"&&(e="class")),n=null,n=document.createElement("label"),n.setAttribute(t,"x"),n.htmlFor!=="x"&&(n.setAttribute("htmlFor","x"),n.htmlFor==="x"&&(t="htmlFor")),n=null,{read:{names:{"class":e,className:e,"for":t,htmlFor:t},values:{_getAttr:function(e,t){return e.getAttribute(t)},_getAttr2:function(e,t){return e.getAttribute(t,2)},_getAttrNode:function(e,t){var n=e.getAttributeNode(t);return n?n.value:""},_getEv:function(){var e=document.createElement("div"),t;e.onclick=Prototype.emptyFunction;var n=e.getAttribute("onclick");return String(n).indexOf("{")>-1?t=function(e,t){return t=e.getAttribute(t),t?(t=t.toString(),t=t.split("{")[1],t=t.split("}")[0],t.strip()):null}:n===""&&(t=function(e,t){return t=e.getAttribute(t),t?t.strip():null}),e=null,t}(),_flag:function(e,t){return $(e).hasAttribute(t)?t:null},style:function(e){return e.style.cssText.toLowerCase()},title:function(e){return e.title}}}}}(),Element._attributeTranslations.write={names:Object.extend({cellpadding:"cellPadding",cellspacing:"cellSpacing"},Element._attributeTranslations.read.names),values:{checked:function(e,t){e.checked=!!t},style:function(e,t){e.style.cssText=t?t:""}}},Element._attributeTranslations.has={},$w("colSpan rowSpan vAlign dateTime accessKey tabIndex encType maxLength readOnly longDesc frameBorder").each(function(e){Element._attributeTranslations.write.names[e.toLowerCase()]=e,Element._attributeTranslations.has[e.toLowerCase()]=e}),function(e){Object.extend(e,{href:e._getAttr2,src:e._getAttr2,type:e._getAttr,action:e._getAttrNode,disabled:e._flag,checked:e._flag,readonly:e._flag,multiple:e._flag,onload:e._getEv,onunload:e._getEv,onclick:e._getEv,ondblclick:e._getEv,onmousedown:e._getEv,onmouseup:e._getEv,onmouseover:e._getEv,onmousemove:e._getEv,onmouseout:e._getEv,onfocus:e._getEv,onblur:e._getEv,onkeypress:e._getEv,onkeydown:e._getEv,onkeyup:e._getEv,onsubmit:e._getEv,onreset:e._getEv,onselect:e._getEv,onchange:e._getEv})}(Element._attributeTranslations.read.values),Prototype.BrowserFeatures.ElementExtensions&&function(){function e(e){var t=e.getElementsByTagName("*"),n=[];for(var r=0,i;i=t[r];r++)i.tagName!=="!"&&n.push(i);return n}Element.Methods.down=function(t,n,r){return t=$(t),arguments.length==1?t.firstDescendant():Object.isNumber(n)?e(t)[n]:Element.select(t,n)[r||0]}}()):Prototype.Browser.Gecko&&/rv:1\.8\.0/.test(navigator.userAgent)?Element.Methods.setOpacity=function(e,t){return e=$(e),e.style.opacity=t==1?.999999:t===""?"":t<1e-5?0:t,e}:Prototype.Browser.WebKit&&(Element.Methods.setOpacity=function(e,t){e=$(e),e.style.opacity=t==1||t===""?"":t<1e-5?0:t;if(t==1)if(e.tagName.toUpperCase()=="IMG"&&e.width)e.width++,e.width--;else try{var n=document.createTextNode(" ");e.appendChild(n),e.removeChild(n)}catch(r){}return e}),"outerHTML"in document.documentElement&&(Element.Methods.replace=function(e,t){e=$(e),t&&t.toElement&&(t=t.toElement());if(Object.isElement(t))return e.parentNode.replaceChild(t,e),e;t=Object.toHTML(t);var n=e.parentNode,r=n.tagName.toUpperCase();if(Element._insertionTranslations.tags[r]){var i=e.next(),s=Element._getContentFromAnonymousElement(r,t.stripScripts());n.removeChild(e),i?s.each(function(e){n.insertBefore(e,i)}):s.each(function(e){n.appendChild(e)})}else e.outerHTML=t.stripScripts();return t.evalScripts.bind(t).defer(),e}),Element._returnOffset=function(e,t){var n=[e,t];return n.left=e,n.top=t,n},Element._getContentFromAnonymousElement=function(e,t,n){var r=new Element("div"),i=Element._insertionTranslations.tags[e],s=!1;i?s=!0:n&&(s=!0,i=["","",0]);if(s){r.innerHTML="&nbsp;"+i[0]+t+i[1],r.removeChild(r.firstChild);for(var o=i[2];o--;)r=r.firstChild}else r.innerHTML=t;return $A(r.childNodes)},Element._insertionTranslations={before:function(e,t){e.parentNode.insertBefore(t,e)},top:function(e,t){e.insertBefore(t,e.firstChild)},bottom:function(e,t){e.appendChild(t)},after:function(e,t){e.parentNode.insertBefore(t,e.nextSibling)},tags:{TABLE:["<table>","</table>",1],TBODY:["<table><tbody>","</tbody></table>",2],TR:["<table><tbody><tr>","</tr></tbody></table>",3],TD:["<table><tbody><tr><td>","</td></tr></tbody></table>",4],SELECT:["<select>","</select>",1]}},function(){var e=Element._insertionTranslations.tags;Object.extend(e,{THEAD:e.TBODY,TFOOT:e.TBODY,TH:e.TD})}(),Element.Methods.Simulated={hasAttribute:function(e,t){t=Element._attributeTranslations.has[t]||t;var n=$(e).getAttributeNode(t);return!!n&&!!n.specified}},Element.Methods.ByTag={},Object.extend(Element,Element.Methods),function(e){!Prototype.BrowserFeatures.ElementExtensions&&e.__proto__&&(window.HTMLElement={},window.HTMLElement.prototype=e.__proto__,Prototype.BrowserFeatures.ElementExtensions=!0),e=null}(document.createElement("div")),Element.extend=function(){function e(e){if(typeof window.Element!="undefined"){var t=window.Element.prototype;if(t){var n="_"+(Math.random()+"").slice(2),r=document.createElement(e);t[n]="x";var i=r[n]!=="x";return delete t[n],r=null,i}}return!1}function t(e,t){for(var n in t){var r=t[n];Object.isFunction(r)&&!(n in e)&&(e[n]=r.methodize())}}var n=e("object");if(Prototype.BrowserFeatures.SpecificElementExtensions)return n?function(e){if(e&&typeof e._extendedByPrototype=="undefined"){var n=e.tagName;n&&/^(?:object|applet|embed)$/i.test(n)&&(t(e,Element.Methods),t(e,Element.Methods.Simulated),t(e,Element.Methods.ByTag[n.toUpperCase()]))}return e}:Prototype.K;var r={},i=Element.Methods.ByTag,s=Object.extend(function(e){if(!e||typeof e._extendedByPrototype!="undefined"||e.nodeType!=1||e==window)return e;var n=Object.clone(r),s=e.tagName.toUpperCase();return i[s]&&Object.extend(n,i[s]),t(e,n),e._extendedByPrototype=Prototype.emptyFunction,e},{refresh:function(){Prototype.BrowserFeatures.ElementExtensions||(Object.extend(r,Element.Methods),Object.extend(r,Element.Methods.Simulated))}});return s.refresh(),s}(),document.documentElement.hasAttribute?Element.hasAttribute=function(e,t){return e.hasAttribute(t)}:Element.hasAttribute=Element.Methods.Simulated.hasAttribute,Element.addMethods=function(e){function i(t){t=t.toUpperCase(),Element.Methods.ByTag[t]||(Element.Methods.ByTag[t]={}),Object.extend(Element.Methods.ByTag[t],e)}function s(e,t,n){n=n||!1;for(var r in e){var i=e[r];if(!Object.isFunction(i))continue;if(!n||!(r in t))t[r]=i.methodize()}}function o(e){var t,n={OPTGROUP:"OptGroup",TEXTAREA:"TextArea",P:"Paragraph",FIELDSET:"FieldSet",UL:"UList",OL:"OList",DL:"DList",DIR:"Directory",H1:"Heading",H2:"Heading",H3:"Heading",H4:"Heading",H5:"Heading",H6:"Heading",Q:"Quote",INS:"Mod",DEL:"Mod",A:"Anchor",IMG:"Image",CAPTION:"TableCaption",COL:"TableCol",COLGROUP:"TableCol",THEAD:"TableSection",TFOOT:"TableSection",TBODY:"TableSection",TR:"TableRow",TH:"TableCell",TD:"TableCell",FRAMESET:"FrameSet",IFRAME:"IFrame"};n[e]&&(t="HTML"+n[e]+"Element");if(window[t])return window[t];t="HTML"+e+"Element";if(window[t])return window[t];t="HTML"+e.capitalize()+"Element";if(window[t])return window[t];var r=document.createElement(e),i=r.__proto__||r.constructor.prototype;return r=null,i}var t=Prototype.BrowserFeatures,n=Element.Methods.ByTag;e||(Object.extend(Form,Form.Methods),Object.extend(Form.Element,Form.Element.Methods),Object.extend(Element.Methods.ByTag,{FORM:Object.clone(Form.Methods),INPUT:Object.clone(Form.Element.Methods),SELECT:Object.clone(Form.Element.Methods),TEXTAREA:Object.clone(Form.Element.Methods),BUTTON:Object.clone(Form.Element.Methods)}));if(arguments.length==2){var r=e;e=arguments[1]}r?Object.isArray(r)?r.each(i):i(r):Object.extend(Element.Methods,e||{});var u=window.HTMLElement?HTMLElement.prototype:Element.prototype;t.ElementExtensions&&(s(Element.Methods,u),s(Element.Methods.Simulated,u,!0));if(t.SpecificElementExtensions)for(var a in Element.Methods.ByTag){var f=o(a);if(Object.isUndefined(f))continue;s(n[a],f.prototype)}Object.extend(Element,Element.Methods),delete Element.ByTag,Element.extend.refresh&&Element.extend.refresh(),Element.cache={}},document.viewport={getDimensions:function(){return{width:this.getWidth(),height:this.getHeight()}},getScrollOffsets:function(){return Element._returnOffset(window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop)}},function(e){function s(){return t.WebKit&&!n.evaluate?document:t.Opera&&window.parseFloat(window.opera.version())<9.5?document.body:document.documentElement}function o(t){return r||(r=s()),i[t]="client"+t,e["get"+t]=function(){return r[i[t]]},e["get"+t]()}var t=Prototype.Browser,n=document,r,i={};e.getWidth=o.curry("Width"),e.getHeight=o.curry("Height")}(document.viewport),Element.Storage={UID:1},Element.addMethods({getStorage:function(e){if(!(e=$(e)))return;var t;return e===window?t=0:(typeof e._prototypeUID=="undefined"&&(e._prototypeUID=Element.Storage.UID++),t=e._prototypeUID),Element.Storage[t]||(Element.Storage[t]=$H()),Element.Storage[t]},store:function(e,t,n){if(!(e=$(e)))return;return arguments.length===2?Element.getStorage(e).update(t):Element.getStorage(e).set(t,n),e},retrieve:function(e,t,n){if(!(e=$(e)))return;var r=Element.getStorage(e),i=r.get(t);return Object.isUndefined(i)&&(r.set(t,n),i=n),i},clone:function(e,t){if(!(e=$(e)))return;var n=e.cloneNode(t);n._prototypeUID=void 0;if(t){var r=Element.select(n,"*"),i=r.length;while(i--)r[i]._prototypeUID=void 0}return Element.extend(n)},purge:function(e){if(!(e=$(e)))return;var t=Element._purgeElement;t(e);var n=e.getElementsByTagName("*"),r=n.length;while(r--)t(n[r]);return null}}),function(){function e(e){var t=e.match(/^(\d+)%?$/i);return t?Number(t[1])/100:null}function t(t,n,r){var i=null;Object.isElement(t)&&(i=t,t=i.getStyle(n));if(t===null)return null;if(/^(?:-)?\d+(\.\d+)?(px)?$/i.test(t))return window.parseFloat(t);var s=t.include("%"),o=r===document.viewport;if(/\d/.test(t)&&i&&i.runtimeStyle&&(!s||!o)){var u=i.style.left,a=i.runtimeStyle.left;return i.runtimeStyle.left=i.currentStyle.left,i.style.left=t||0,t=i.style.pixelLeft,i.style.left=u,i.runtimeStyle.left=a,t}if(i&&s){r=r||i.parentNode;var f=e(t),l=null,c=i.getStyle("position"),h=n.include("left")||n.include("right")||n.include("width"),p=n.include("top")||n.include("bottom")||n.include("height");return r===document.viewport?h?l=document.viewport.getWidth():p&&(l=document.viewport.getHeight()):h?l=$(r).measure("width"):p&&(l=$(r).measure("height")),l===null?0:l*f}return 0}function n(e){return Object.isString(e)&&e.endsWith("px")?e:e+"px"}function r(e){var t=e;while(e&&e.parentNode){var n=e.getStyle("display");if(n==="none")return!1;e=$(e.parentNode)}return!0}function s(e){return e.include("border")&&(e+="-width"),e.camelize()}function o(e,t){return new Element.Layout(e,t)}function u(e,t){return $(e).getLayout().get(t)}function a(e){e=$(e);var t=Element.getStyle(e,"display");if(t&&t!=="none")return{width:e.offsetWidth,height:e.offsetHeight};var n=e.style,r={visibility:n.visibility,position:n.position,display:n.display},i={visibility:"hidden",display:"block"};r.position!=="fixed"&&(i.position="absolute"),Element.setStyle(e,i);var s={width:e.offsetWidth,height:e.offsetHeight};return Element.setStyle(e,r),s}function f(e){e=$(e);if(y(e)||b(e)||m(e)||g(e))return $(document.body);var t=Element.getStyle(e,"display")==="inline";if(!t&&e.offsetParent)return $(e.offsetParent);while((e=e.parentNode)&&e!==document.body)if(Element.getStyle(e,"position")!=="static")return g(e)?$(document.body):$(e);return $(document.body)}function l(e){e=$(e);var t=0,n=0;if(e.parentNode)do t+=e.offsetTop||0,n+=e.offsetLeft||0,e=e.offsetParent;while(e);return new Element.Offset(n,t)}function c(e){e=$(e);var t=e.getLayout(),n=0,r=0;do{n+=e.offsetTop||0,r+=e.offsetLeft||0,e=e.offsetParent;if(e){if(m(e))break;var i=Element.getStyle(e,"position");if(i!=="static")break}}while(e);return r-=t.get("margin-top"),n-=t.get("margin-left"),new Element.Offset(r,n)}function h(e){var t=0,n=0;do t+=e.scrollTop||0,n+=e.scrollLeft||0,e=e.parentNode;while(e);return new Element.Offset(n,t)}function p(e){i=$(i);var t=0,n=0,r=document.body,i=e;do{t+=i.offsetTop||0,n+=i.offsetLeft||0;if(i.offsetParent==r&&Element.getStyle(i,"position")=="absolute")break}while(i=i.offsetParent);i=e;do i!=r&&(t-=i.scrollTop||0,n-=i.scrollLeft||0);while(i=i.parentNode);return new Element.Offset(n,t)}function d(e){e=$(e);if(Element.getStyle(e,"position")==="absolute")return e;var t=f(e),n=e.viewportOffset(),r=t.viewportOffset(),i=n.relativeTo(r),s=e.getLayout();return e.store("prototype_absolutize_original_styles",{left:e.getStyle("left"),top:e.getStyle("top"),width:e.getStyle("width"),height:e.getStyle("height")}),e.setStyle({position:"absolute",top:i.top+"px",left:i.left+"px",width:s.get("width")+"px",height:s.get("height")+"px"}),e}function v(e){e=$(e);if(Element.getStyle(e,"position")==="relative")return e;var t=e.retrieve("prototype_absolutize_original_styles");return t&&e.setStyle(t),e}function m(e){return e.nodeName.toUpperCase()==="BODY"}function g(e){return e.nodeName.toUpperCase()==="HTML"}function y(e){return e.nodeType===Node.DOCUMENT_NODE}function b(e){return e!==document.body&&!Element.descendantOf(e,document.body)}var i=Prototype.K;"currentStyle"in document.documentElement&&(i=function(e){return e.currentStyle.hasLayout||(e.style.zoom=1),e}),Element.Layout=Class.create(Hash,{initialize:function($super,e,t){$super(),this.element=$(e),Element.Layout.PROPERTIES.each(function(e){this._set(e,null)},this),t&&(this._preComputing=!0,this._begin(),Element.Layout.PROPERTIES.each(this._compute,this),this._end(),this._preComputing=!1)},_set:function(e,t){return Hash.prototype.set.call(this,e,t)},set:function(e,t){throw"Properties of Element.Layout are read-only."},get:function($super,e){var t=$super(e);return t===null?this._compute(e):t},_begin:function(){if(this._prepared)return;var e=this.element;if(r(e)){this._prepared=!0;return}var n={position:e.style.position||"",width:e.style.width||"",visibility:e.style.visibility||"",display:e.style.display||""};e.store("prototype_original_styles",n);var i=e.getStyle("position"),s=e.getStyle("width");if(s==="0px"||s===null)e.style.display="block",s=e.getStyle("width");var o=i==="fixed"?document.viewport:e.parentNode;e.setStyle({position:"absolute",visibility:"hidden",display:"block"});var u=e.getStyle("width"),a;if(s&&u===s)a=t(e,"width",o);else if(i==="absolute"||i==="fixed")a=t(e,"width",o);else{var f=e.parentNode,l=$(f).getLayout();a=l.get("width")-this.get("margin-left")-this.get("border-left")-this.get("padding-left")-this.get("padding-right")-this.get("border-right")-this.get("margin-right")}e.setStyle({width:a+"px"}),this._prepared=!0},_end:function(){var e=this.element,t=e.retrieve("prototype_original_styles");e.store("prototype_original_styles",null),e.setStyle(t),this._prepared=!1},_compute:function(e){var t=Element.Layout.COMPUTATIONS;if(e in t)return this._set(e,t[e].call(this,this.element));throw"Property not found."},toObject:function(){var e=$A(arguments),t=e.length===0?Element.Layout.PROPERTIES:e.join(" ").split(" "),n={};return t.each(function(e){if(!Element.Layout.PROPERTIES.include(e))return;var t=this.get(e);t!=null&&(n[e]=t)},this),n},toHash:function(){var e=this.toObject.apply(this,arguments);return new Hash(e)},toCSS:function(){var e=$A(arguments),t=e.length===0?Element.Layout.PROPERTIES:e.join(" ").split(" "),n={};return t.each(function(e){if(!Element.Layout.PROPERTIES.include(e))return;if(Element.Layout.COMPOSITE_PROPERTIES.include(e))return;var t=this.get(e);t!=null&&(n[s(e)]=t+"px")},this),n},inspect:function(){return"#<Element.Layout>"}}),Object.extend(Element.Layout,{PROPERTIES:$w("height width top left right bottom border-left border-right border-top border-bottom padding-left padding-right padding-top padding-bottom margin-top margin-bottom margin-left margin-right padding-box-width padding-box-height border-box-width border-box-height margin-box-width margin-box-height"),COMPOSITE_PROPERTIES:$w("padding-box-width padding-box-height margin-box-width margin-box-height border-box-width border-box-height"),COMPUTATIONS:{height:function(e){this._preComputing||this._begin();var t=this.get("border-box-height");if(t<=0)return this._preComputing||this._end(),0;var n=this.get("border-top"),r=this.get("border-bottom"),i=this.get("padding-top"),s=this.get("padding-bottom");return this._preComputing||this._end(),t-n-r-i-s},width:function(e){this._preComputing||this._begin();var t=this.get("border-box-width");if(t<=0)return this._preComputing||this._end(),0;var n=this.get("border-left"),r=this.get("border-right"),i=this.get("padding-left"),s=this.get("padding-right");return this._preComputing||this._end(),t-n-r-i-s},"padding-box-height":function(e){var t=this.get("height"),n=this.get("padding-top"),r=this.get("padding-bottom");return t+n+r},"padding-box-width":function(e){var t=this.get("width"),n=this.get("padding-left"),r=this.get("padding-right");return t+n+r},"border-box-height":function(e){this._preComputing||this._begin();var t=e.offsetHeight;return this._preComputing||this._end(),t},"border-box-width":function(e){this._preComputing||this._begin();var t=e.offsetWidth;return this._preComputing||this._end(),t},"margin-box-height":function(e){var t=this.get("border-box-height"),n=this.get("margin-top"),r=this.get("margin-bottom");return t<=0?0:t+n+r},"margin-box-width":function(e){var t=this.get("border-box-width"),n=this.get("margin-left"),r=this.get("margin-right");return t<=0?0:t+n+r},top:function(e){var t=e.positionedOffset();return t.top},bottom:function(e){var t=e.positionedOffset(),n=e.getOffsetParent(),r=n.measure("height"),i=this.get("border-box-height");return r-i-t.top},left:function(e){var t=e.positionedOffset();return t.left},right:function(e){var t=e.positionedOffset(),n=e.getOffsetParent(),r=n.measure("width"),i=this.get("border-box-width");return r-i-t.left},"padding-top"
:function(e){return t(e,"paddingTop")},"padding-bottom":function(e){return t(e,"paddingBottom")},"padding-left":function(e){return t(e,"paddingLeft")},"padding-right":function(e){return t(e,"paddingRight")},"border-top":function(e){return t(e,"borderTopWidth")},"border-bottom":function(e){return t(e,"borderBottomWidth")},"border-left":function(e){return t(e,"borderLeftWidth")},"border-right":function(e){return t(e,"borderRightWidth")},"margin-top":function(e){return t(e,"marginTop")},"margin-bottom":function(e){return t(e,"marginBottom")},"margin-left":function(e){return t(e,"marginLeft")},"margin-right":function(e){return t(e,"marginRight")}}}),"getBoundingClientRect"in document.documentElement&&Object.extend(Element.Layout.COMPUTATIONS,{right:function(e){var t=i(e.getOffsetParent()),n=e.getBoundingClientRect(),r=t.getBoundingClientRect();return(r.right-n.right).round()},bottom:function(e){var t=i(e.getOffsetParent()),n=e.getBoundingClientRect(),r=t.getBoundingClientRect();return(r.bottom-n.bottom).round()}}),Element.Offset=Class.create({initialize:function(e,t){this.left=e.round(),this.top=t.round(),this[0]=this.left,this[1]=this.top},relativeTo:function(e){return new Element.Offset(this.left-e.left,this.top-e.top)},inspect:function(){return"#<Element.Offset left: #{left} top: #{top}>".interpolate(this)},toString:function(){return"[#{left}, #{top}]".interpolate(this)},toArray:function(){return[this.left,this.top]}}),Prototype.Browser.IE?(f=f.wrap(function(e,t){t=$(t);if(y(t)||b(t)||m(t)||g(t))return $(document.body);var n=t.getStyle("position");if(n!=="static")return e(t);t.setStyle({position:"relative"});var r=e(t);return t.setStyle({position:n}),r}),c=c.wrap(function(e,t){t=$(t);if(!t.parentNode)return new Element.Offset(0,0);var n=t.getStyle("position");if(n!=="static")return e(t);var r=t.getOffsetParent();r&&r.getStyle("position")==="fixed"&&i(r),t.setStyle({position:"relative"});var s=e(t);return t.setStyle({position:n}),s})):Prototype.Browser.Webkit&&(l=function(e){e=$(e);var t=0,n=0;do{t+=e.offsetTop||0,n+=e.offsetLeft||0;if(e.offsetParent==document.body&&Element.getStyle(e,"position")=="absolute")break;e=e.offsetParent}while(e);return new Element.Offset(n,t)}),Element.addMethods({getLayout:o,measure:u,getDimensions:a,getOffsetParent:f,cumulativeOffset:l,positionedOffset:c,cumulativeScrollOffset:h,viewportOffset:p,absolutize:d,relativize:v}),"getBoundingClientRect"in document.documentElement&&Element.addMethods({viewportOffset:function(e){e=$(e);if(b(e))return new Element.Offset(0,0);var t=e.getBoundingClientRect(),n=document.documentElement;return new Element.Offset(t.left-n.clientLeft,t.top-n.clientTop)}})}(),window.$$=function(){var e=$A(arguments).join(", ");return Prototype.Selector.select(e,document)},Prototype.Selector=function(){function e(){throw new Error('Method "Prototype.Selector.select" must be defined.')}function t(){throw new Error('Method "Prototype.Selector.match" must be defined.')}function n(e,t,n){n=n||0;var r=Prototype.Selector.match,i=e.length,s=0,o;for(o=0;o<i;o++)if(r(e[o],t)&&n==s++)return Element.extend(e[o])}function r(e){for(var t=0,n=e.length;t<n;t++)Element.extend(e[t]);return e}var i=Prototype.K;return{select:e,match:t,find:n,extendElements:Element.extend===i?i:r,extendElement:Element.extend}}(),function(){function h(e,t,n,r,i,s){var o=e=="previousSibling"&&!s;for(var u=0,a=r.length;u<a;u++){var f=r[u];if(f){o&&f.nodeType===1&&(f.sizcache=n,f.sizset=u),f=f[e];var l=!1;while(f){if(f.sizcache===n){l=r[f.sizset];break}f.nodeType===1&&!s&&(f.sizcache=n,f.sizset=u);if(f.nodeName===t){l=f;break}f=f[e]}r[u]=l}}}function p(e,t,n,r,i,o){var u=e=="previousSibling"&&!o;for(var a=0,f=r.length;a<f;a++){var l=r[a];if(l){u&&l.nodeType===1&&(l.sizcache=n,l.sizset=a),l=l[e];var c=!1;while(l){if(l.sizcache===n){c=r[l.sizset];break}if(l.nodeType===1){o||(l.sizcache=n,l.sizset=a);if(typeof t!="string"){if(l===t){c=!0;break}}else if(s.filter(t,[l]).length>0){c=l;break}}l=l[e]}r[a]=c}}}var e=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^[\]]*\]|['"][^'"]*['"]|[^[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,t=0,n=Object.prototype.toString,r=!1,i=!0;[0,0].sort(function(){return i=!1,0});var s=function(t,r,i,a){i=i||[];var l=r=r||document;if(r.nodeType!==1&&r.nodeType!==9)return[];if(!t||typeof t!="string")return i;var c=[],h,p,g,y,b,w,E=!0,S=v(r),x=t;while((e.exec(""),h=e.exec(x))!==null){x=h[3],c.push(h[1]);if(h[2]){w=h[3];break}}if(c.length>1&&u.exec(t))if(c.length===2&&o.relative[c[0]])p=m(c[0]+c[1],r);else{p=o.relative[c[0]]?[r]:s(c.shift(),r);while(c.length)t=c.shift(),o.relative[t]&&(t+=c.shift()),p=m(t,p)}else{if(!a&&c.length>1&&r.nodeType===9&&!S&&o.match.ID.test(c[0])&&!o.match.ID.test(c[c.length-1])){var T=s.find(c.shift(),r,S);r=T.expr?s.filter(T.expr,T.set)[0]:T.set[0]}if(r){var T=a?{expr:c.pop(),set:f(a)}:s.find(c.pop(),c.length!==1||c[0]!=="~"&&c[0]!=="+"||!r.parentNode?r:r.parentNode,S);p=T.expr?s.filter(T.expr,T.set):T.set,c.length>0?g=f(p):E=!1;while(c.length){var N=c.pop(),C=N;o.relative[N]?C=c.pop():N="",C==null&&(C=r),o.relative[N](g,C,S)}}else g=c=[]}g||(g=p);if(!g)throw"Syntax error, unrecognized expression: "+(N||t);if(n.call(g)==="[object Array]")if(!E)i.push.apply(i,g);else if(r&&r.nodeType===1)for(var k=0;g[k]!=null;k++)g[k]&&(g[k]===!0||g[k].nodeType===1&&d(r,g[k]))&&i.push(p[k]);else for(var k=0;g[k]!=null;k++)g[k]&&g[k].nodeType===1&&i.push(p[k]);else f(g,i);return w&&(s(w,l,i,a),s.uniqueSort(i)),i};s.uniqueSort=function(e){if(c){r=i,e.sort(c);if(r)for(var t=1;t<e.length;t++)e[t]===e[t-1]&&e.splice(t--,1)}return e},s.matches=function(e,t){return s(e,null,null,t)},s.find=function(e,t,n){var r,i;if(!e)return[];for(var s=0,u=o.order.length;s<u;s++){var a=o.order[s],i;if(i=o.leftMatch[a].exec(e)){var f=i[1];i.splice(1,1);if(f.substr(f.length-1)!=="\\"){i[1]=(i[1]||"").replace(/\\/g,""),r=o.find[a](i,t,n);if(r!=null){e=e.replace(o.match[a],"");break}}}}return r||(r=t.getElementsByTagName("*")),{set:r,expr:e}},s.filter=function(e,t,n,r){var i=e,s=[],u=t,a,f,l=t&&t[0]&&v(t[0]);while(e&&t.length){for(var c in o.filter)if((a=o.match[c].exec(e))!=null){var h=o.filter[c],p,d;f=!1,u==s&&(s=[]);if(o.preFilter[c]){a=o.preFilter[c](a,u,n,s,r,l);if(!a)f=p=!0;else if(a===!0)continue}if(a)for(var m=0;(d=u[m])!=null;m++)if(d){p=h(d,a,m,u);var g=r^!!p;n&&p!=null?g?f=!0:u[m]=!1:g&&(s.push(d),f=!0)}if(p!==undefined){n||(u=s),e=e.replace(o.match[c],"");if(!f)return[];break}}if(e==i){if(f==null)throw"Syntax error, unrecognized expression: "+e;break}i=e}return u};var o=s.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF-]|\\.)+)\s*(?:(\S?=)\s*(['"]*)(.*?)\3|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\((even|odd|[\dn+-]*)\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF-]|\\.)+)(?:\((['"]*)((?:\([^\)]+\)|[^\2\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(e){return e.getAttribute("href")}},relative:{"+":function(e,t,n){var r=typeof t=="string",i=r&&!/\W/.test(t),o=r&&!i;i&&!n&&(t=t.toUpperCase());for(var u=0,a=e.length,f;u<a;u++)if(f=e[u]){while((f=f.previousSibling)&&f.nodeType!==1);e[u]=o||f&&f.nodeName===t?f||!1:f===t}o&&s.filter(t,e,!0)},">":function(e,t,n){var r=typeof t=="string";if(r&&!/\W/.test(t)){t=n?t:t.toUpperCase();for(var i=0,o=e.length;i<o;i++){var u=e[i];if(u){var a=u.parentNode;e[i]=a.nodeName===t?a:!1}}}else{for(var i=0,o=e.length;i<o;i++){var u=e[i];u&&(e[i]=r?u.parentNode:u.parentNode===t)}r&&s.filter(t,e,!0)}},"":function(e,n,r){var i=t++,s=p;if(!/\W/.test(n)){var o=n=r?n:n.toUpperCase();s=h}s("parentNode",n,i,e,o,r)},"~":function(e,n,r){var i=t++,s=p;if(typeof n=="string"&&!/\W/.test(n)){var o=n=r?n:n.toUpperCase();s=h}s("previousSibling",n,i,e,o,r)}},find:{ID:function(e,t,n){if(typeof t.getElementById!="undefined"&&!n){var r=t.getElementById(e[1]);return r?[r]:[]}},NAME:function(e,t,n){if(typeof t.getElementsByName!="undefined"){var r=[],i=t.getElementsByName(e[1]);for(var s=0,o=i.length;s<o;s++)i[s].getAttribute("name")===e[1]&&r.push(i[s]);return r.length===0?null:r}},TAG:function(e,t){return t.getElementsByTagName(e[1])}},preFilter:{CLASS:function(e,t,n,r,i,s){e=" "+e[1].replace(/\\/g,"")+" ";if(s)return e;for(var o=0,u;(u=t[o])!=null;o++)u&&(i^(u.className&&(" "+u.className+" ").indexOf(e)>=0)?n||r.push(u):n&&(t[o]=!1));return!1},ID:function(e){return e[1].replace(/\\/g,"")},TAG:function(e,t){for(var n=0;t[n]===!1;n++);return t[n]&&v(t[n])?e[1]:e[1].toUpperCase()},CHILD:function(e){if(e[1]=="nth"){var n=/(-?)(\d*)n((?:\+|-)?\d*)/.exec(e[2]=="even"&&"2n"||e[2]=="odd"&&"2n+1"||!/\D/.test(e[2])&&"0n+"+e[2]||e[2]);e[2]=n[1]+(n[2]||1)-0,e[3]=n[3]-0}return e[0]=t++,e},ATTR:function(e,t,n,r,i,s){var u=e[1].replace(/\\/g,"");return!s&&o.attrMap[u]&&(e[1]=o.attrMap[u]),e[2]==="~="&&(e[4]=" "+e[4]+" "),e},PSEUDO:function(t,n,r,i,u){if(t[1]==="not"){if(!((e.exec(t[3])||"").length>1||/^\w/.test(t[3]))){var a=s.filter(t[3],n,r,!0^u);return r||i.push.apply(i,a),!1}t[3]=s(t[3],null,null,n)}else if(o.match.POS.test(t[0])||o.match.CHILD.test(t[0]))return!0;return t},POS:function(e){return e.unshift(!0),e}},filters:{enabled:function(e){return e.disabled===!1&&e.type!=="hidden"},disabled:function(e){return e.disabled===!0},checked:function(e){return e.checked===!0},selected:function(e){return e.parentNode.selectedIndex,e.selected===!0},parent:function(e){return!!e.firstChild},empty:function(e){return!e.firstChild},has:function(e,t,n){return!!s(n[3],e).length},header:function(e){return/h\d/i.test(e.nodeName)},text:function(e){return"text"===e.type},radio:function(e){return"radio"===e.type},checkbox:function(e){return"checkbox"===e.type},file:function(e){return"file"===e.type},password:function(e){return"password"===e.type},submit:function(e){return"submit"===e.type},image:function(e){return"image"===e.type},reset:function(e){return"reset"===e.type},button:function(e){return"button"===e.type||e.nodeName.toUpperCase()==="BUTTON"},input:function(e){return/input|select|textarea|button/i.test(e.nodeName)}},setFilters:{first:function(e,t){return t===0},last:function(e,t,n,r){return t===r.length-1},even:function(e,t){return t%2===0},odd:function(e,t){return t%2===1},lt:function(e,t,n){return t<n[3]-0},gt:function(e,t,n){return t>n[3]-0},nth:function(e,t,n){return n[3]-0==t},eq:function(e,t,n){return n[3]-0==t}},filter:{PSEUDO:function(e,t,n,r){var i=t[1],s=o.filters[i];if(s)return s(e,n,t,r);if(i==="contains")return(e.textContent||e.innerText||"").indexOf(t[3])>=0;if(i==="not"){var u=t[3];for(var n=0,a=u.length;n<a;n++)if(u[n]===e)return!1;return!0}},CHILD:function(e,t){var n=t[1],r=e;switch(n){case"only":case"first":while(r=r.previousSibling)if(r.nodeType===1)return!1;if(n=="first")return!0;r=e;case"last":while(r=r.nextSibling)if(r.nodeType===1)return!1;return!0;case"nth":var i=t[2],s=t[3];if(i==1&&s==0)return!0;var o=t[0],u=e.parentNode;if(u&&(u.sizcache!==o||!e.nodeIndex)){var a=0;for(r=u.firstChild;r;r=r.nextSibling)r.nodeType===1&&(r.nodeIndex=++a);u.sizcache=o}var f=e.nodeIndex-s;return i==0?f==0:f%i==0&&f/i>=0}},ID:function(e,t){return e.nodeType===1&&e.getAttribute("id")===t},TAG:function(e,t){return t==="*"&&e.nodeType===1||e.nodeName===t},CLASS:function(e,t){return(" "+(e.className||e.getAttribute("class"))+" ").indexOf(t)>-1},ATTR:function(e,t){var n=t[1],r=o.attrHandle[n]?o.attrHandle[n](e):e[n]!=null?e[n]:e.getAttribute(n),i=r+"",s=t[2],u=t[4];return r==null?s==="!=":s==="="?i===u:s==="*="?i.indexOf(u)>=0:s==="~="?(" "+i+" ").indexOf(u)>=0:u?s==="!="?i!=u:s==="^="?i.indexOf(u)===0:s==="$="?i.substr(i.length-u.length)===u:s==="|="?i===u||i.substr(0,u.length+1)===u+"-":!1:i&&r!==!1},POS:function(e,t,n,r){var i=t[2],s=o.setFilters[i];if(s)return s(e,n,t,r)}}},u=o.match.POS;for(var a in o.match)o.match[a]=new RegExp(o.match[a].source+/(?![^\[]*\])(?![^\(]*\))/.source),o.leftMatch[a]=new RegExp(/(^(?:.|\r|\n)*?)/.source+o.match[a].source);var f=function(e,t){return e=Array.prototype.slice.call(e,0),t?(t.push.apply(t,e),t):e};try{Array.prototype.slice.call(document.documentElement.childNodes,0)}catch(l){f=function(e,t){var r=t||[];if(n.call(e)==="[object Array]")Array.prototype.push.apply(r,e);else if(typeof e.length=="number")for(var i=0,s=e.length;i<s;i++)r.push(e[i]);else for(var i=0;e[i];i++)r.push(e[i]);return r}}var c;document.documentElement.compareDocumentPosition?c=function(e,t){if(!e.compareDocumentPosition||!t.compareDocumentPosition)return e==t&&(r=!0),0;var n=e.compareDocumentPosition(t)&4?-1:e===t?0:1;return n===0&&(r=!0),n}:"sourceIndex"in document.documentElement?c=function(e,t){if(!e.sourceIndex||!t.sourceIndex)return e==t&&(r=!0),0;var n=e.sourceIndex-t.sourceIndex;return n===0&&(r=!0),n}:document.createRange&&(c=function(e,t){if(!e.ownerDocument||!t.ownerDocument)return e==t&&(r=!0),0;var n=e.ownerDocument.createRange(),i=t.ownerDocument.createRange();n.setStart(e,0),n.setEnd(e,0),i.setStart(t,0),i.setEnd(t,0);var s=n.compareBoundaryPoints(Range.START_TO_END,i);return s===0&&(r=!0),s}),function(){var e=document.createElement("div"),t="script"+(new Date).getTime();e.innerHTML="<a name='"+t+"'/>";var n=document.documentElement;n.insertBefore(e,n.firstChild),!document.getElementById(t)||(o.find.ID=function(e,t,n){if(typeof t.getElementById!="undefined"&&!n){var r=t.getElementById(e[1]);return r?r.id===e[1]||typeof r.getAttributeNode!="undefined"&&r.getAttributeNode("id").nodeValue===e[1]?[r]:undefined:[]}},o.filter.ID=function(e,t){var n=typeof e.getAttributeNode!="undefined"&&e.getAttributeNode("id");return e.nodeType===1&&n&&n.nodeValue===t}),n.removeChild(e),n=e=null}(),function(){var e=document.createElement("div");e.appendChild(document.createComment("")),e.getElementsByTagName("*").length>0&&(o.find.TAG=function(e,t){var n=t.getElementsByTagName(e[1]);if(e[1]==="*"){var r=[];for(var i=0;n[i];i++)n[i].nodeType===1&&r.push(n[i]);n=r}return n}),e.innerHTML="<a href='#'></a>",e.firstChild&&typeof e.firstChild.getAttribute!="undefined"&&e.firstChild.getAttribute("href")!=="#"&&(o.attrHandle.href=function(e){return e.getAttribute("href",2)}),e=null}(),document.querySelectorAll&&function(){var e=s,t=document.createElement("div");t.innerHTML="<p class='TEST'></p>";if(t.querySelectorAll&&t.querySelectorAll(".TEST").length===0)return;s=function(t,n,r,i){n=n||document;if(!i&&n.nodeType===9&&!v(n))try{return f(n.querySelectorAll(t),r)}catch(s){}return e(t,n,r,i)};for(var n in e)s[n]=e[n];t=null}(),document.getElementsByClassName&&document.documentElement.getElementsByClassName&&function(){var e=document.createElement("div");e.innerHTML="<div class='test e'></div><div class='test'></div>";if(e.getElementsByClassName("e").length===0)return;e.lastChild.className="e";if(e.getElementsByClassName("e").length===1)return;o.order.splice(1,0,"CLASS"),o.find.CLASS=function(e,t,n){if(typeof t.getElementsByClassName!="undefined"&&!n)return t.getElementsByClassName(e[1])},e=null}();var d=document.compareDocumentPosition?function(e,t){return e.compareDocumentPosition(t)&16}:function(e,t){return e!==t&&(e.contains?e.contains(t):!0)},v=function(e){return e.nodeType===9&&e.documentElement.nodeName!=="HTML"||!!e.ownerDocument&&e.ownerDocument.documentElement.nodeName!=="HTML"},m=function(e,t){var n=[],r="",i,u=t.nodeType?[t]:t;while(i=o.match.PSEUDO.exec(e))r+=i[0],e=e.replace(o.match.PSEUDO,"");e=o.relative[e]?e+"*":e;for(var a=0,f=u.length;a<f;a++)s(e,u[a],n);return s.filter(r,n)};window.Sizzle=s}(),Prototype._original_property=window.Sizzle,function(e){function n(n,r){return t(e(n,r||document))}function r(t,n){return e.matches(n,[t]).length==1}var t=Prototype.Selector.extendElements;Prototype.Selector.engine=e,Prototype.Selector.select=n,Prototype.Selector.match=r}(Sizzle),window.Sizzle=Prototype._original_property,delete Prototype._original_property;var Form={reset:function(e){return e=$(e),e.reset(),e},serializeElements:function(e,t){typeof t!="object"?t={hash:!!t}:Object.isUndefined(t.hash)&&(t.hash=!0);var n,r,i=!1,s=t.submit,o,u;return t.hash?(u={},o=function(e,t,n){return t in e?(Object.isArray(e[t])||(e[t]=[e[t]]),e[t].push(n)):e[t]=n,e}):(u="",o=function(e,t,n){return e+(e?"&":"")+encodeURIComponent(t)+"="+encodeURIComponent(n)}),e.inject(u,function(e,t){return!t.disabled&&t.name&&(n=t.name,r=$(t).getValue(),r!=null&&t.type!="file"&&(t.type!="submit"||!i&&s!==!1&&(!s||n==s)&&(i=!0))&&(e=o(e,n,r))),e})}};Form.Methods={serialize:function(e,t){return Form.serializeElements(Form.getElements(e),t)},getElements:function(e){var t=$(e).getElementsByTagName("*"),n,r=[],i=Form.Element.Serializers;for(var s=0;n=t[s];s++)r.push(n);return r.inject([],function(e,t){return i[t.tagName.toLowerCase()]&&e.push(Element.extend(t)),e})},getInputs:function(e,t,n){e=$(e);var r=e.getElementsByTagName("input");if(!t&&!n)return $A(r).map(Element.extend);for(var i=0,s=[],o=r.length;i<o;i++){var u=r[i];if(t&&u.type!=t||n&&u.name!=n)continue;s.push(Element.extend(u))}return s},disable:function(e){return e=$(e),Form.getElements(e).invoke("disable"),e},enable:function(e){return e=$(e),Form.getElements(e).invoke("enable"),e},findFirstElement:function(e){var t=$(e).getElements().findAll(function(e){return"hidden"!=e.type&&!e.disabled}),n=t.findAll(function(e){return e.hasAttribute("tabIndex")&&e.tabIndex>=0}).sortBy(function(e){return e.tabIndex}).first();return n?n:t.find(function(e){return/^(?:input|select|textarea)$/i.test(e.tagName)})},focusFirstElement:function(e){e=$(e);var t=e.findFirstElement();return t&&t.activate(),e},request:function(e,t){e=$(e),t=Object.clone(t||{});var n=t.parameters,r=e.readAttribute("action")||"";return r.blank()&&(r=window.location.href),t.parameters=e.serialize(!0),n&&(Object.isString(n)&&(n=n.toQueryParams()),Object.extend(t.parameters,n)),e.hasAttribute("method")&&!t.method&&(t.method=e.method),new Ajax.Request(r,t)}},Form.Element={focus:function(e){return $(e).focus(),e},select:function(e){return $(e).select(),e}},Form.Element.Methods={serialize:function(e){e=$(e);if(!e.disabled&&e.name){var t=e.getValue();if(t!=undefined){var n={};return n[e.name]=t,Object.toQueryString(n)}}return""},getValue:function(e){e=$(e);var t=e.tagName.toLowerCase();return Form.Element.Serializers[t](e)},setValue:function(e,t){e=$(e);var n=e.tagName.toLowerCase();return Form.Element.Serializers[n](e,t),e},clear:function(e){return $(e).value="",e},present:function(e){return $(e).value!=""},activate:function(e){e=$(e);try{e.focus(),e.select&&(e.tagName.toLowerCase()!="input"||!/^(?:button|reset|submit)$/i.test(e.type))&&e.select()}catch(t){}return e},disable:function(e){return e=$(e),e.disabled=!0,e},enable:function(e){return e=$(e),e.disabled=!1,e}};var Field=Form.Element,$F=Form.Element.Methods.getValue;Form.Element.Serializers=function(){function e(e,r){switch(e.type.toLowerCase()){case"checkbox":case"radio":return t(e,r);default:return n(e,r)}}function t(e,t){if(Object.isUndefined(t))return e.checked?e.value:null;e.checked=!!t}function n(e,t){if(Object.isUndefined(t))return e.value;e.value=t}function r(e,t){if(Object.isUndefined(t))return(e.type==="select-one"?i:s)(e);var n,r,o=!Object.isArray(t);for(var u=0,a=e.length;u<a;u++){n=e.options[u],r=this.optionValue(n);if(o){if(r==t){n.selected=!0;return}}else n.selected=t.include(r)}}function i(e){var t=e.selectedIndex;return t>=0?o(e.options[t]):null}function s(e){var t,n=e.length;if(!n)return null;for(var r=0,t=[];r<n;r++){var i=e.options[r];i.selected&&t.push(o(i))}return t}function o(e){return Element.hasAttribute(e,"value")?e.value:e.text}return{input:e,inputSelector:t,textarea:n,select:r,selectOne:i,selectMany:s,optionValue:o,button:n}}(),Abstract.TimedObserver=Class.create(PeriodicalExecuter,{initialize:function($super,e,t,n){$super(n,t),this.element=$(e),this.lastValue=this.getValue()},execute:function(){var e=this.getValue();if(Object.isString(this.lastValue)&&Object.isString(e)?this.lastValue!=e:String(this.lastValue)!=String(e))this.callback(this.element,e),this.lastValue=e}}),Form.Element.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.Element.getValue(this.element)}}),Form.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.serialize(this.element)}}),Abstract.EventObserver=Class.create({initialize:function(e,t){this.element=$(e),this.callback=t,this.lastValue=this.getValue(),this.element.tagName.toLowerCase()=="form"?this.registerFormCallbacks():this.registerCallback(this.element)},onElementEvent:function(){var e=this.getValue();this.lastValue!=e&&(this.callback(this.element,e),this.lastValue=e)},registerFormCallbacks:function(){Form.getElements(this.element).each(this.registerCallback,this)},registerCallback:function(e){if(e.type)switch(e.type.toLowerCase()){case"checkbox":case"radio":Event.observe(e,"click",this.onElementEvent.bind(this));break;default:Event.observe(e,"change",this.onElementEvent.bind(this))}}}),Form.Element.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.Element.getValue(this.element)}}),Form.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.serialize(this.element)}}),function(){function s(e,t){return e.which?e.which===t+1:e.button===t}function u(e,t){return e.button===o[t]}function a(e,t){switch(t){case 0:return e.which==1&&!e.metaKey;case 1:return e.which==2||e.which==1&&e.metaKey;case 2:return e.which==3;default:return!1}}function f(e){return i(e,0)}function l(e){return i(e,1)}function c(e){return i(e,2)}function h(t){t=e.extend(t);var n=t.target,r=t.type,i=t.currentTarget;return i&&i.tagName&&(r==="load"||r==="error"||r==="click"&&i.tagName.toLowerCase()==="input"&&i.type==="radio")&&(n=i),n.nodeType==Node.TEXT_NODE&&(n=n.parentNode),Element.extend(n)}function p(t,n){var r=e.element(t);if(!n)return r;while(r){if(Object.isElement(r)&&Prototype.Selector.match(r,n))return Element.extend(r);r=r.parentNode}}function d(e){return{x:v(e),y:m(e)}}function v(e){var t=document.documentElement,n=document.body||{scrollLeft:0};return e.pageX||e.clientX+(t.scrollLeft||n.scrollLeft)-(t.clientLeft||0)}function m(e){var t=document.documentElement,n=document.body||{scrollTop:0};return e.pageY||e.clientY+(t.scrollTop||n.scrollTop)-(t.clientTop||0)}function g(t){e.extend(t),t.preventDefault(),t.stopPropagation(),t.stopped=!0}function E(t,r,i){var s=Element.retrieve(t,"prototype_event_registry");Object.isUndefined(s)&&(x.push(t),s=Element.retrieve(t,"prototype_event_registry",$H()));var o=s.get(r);Object.isUndefined(o)&&(o=[],s.set(r,o));if(o.pluck("handler").include(i))return!1;var u;if(r.include(":"))u=function(n){if(Object.isUndefined(n.eventName))return!1;if(n.eventName!==r)return!1;e.extend(n,t),i.call(t,n)};else if(!!n||r!=="mouseenter"&&r!=="mouseleave")u=function(n){e.extend(n,t),i.call(t,n)};else if(r==="mouseenter"||r==="mouseleave")u=function(n){e.extend(n,t);var r=n.relatedTarget;while(r&&r!==t)try{r=r.parentNode}catch(s){r=t}if(r===t)return;i.call(t,n)};return u.handler=i,o.push(u),u}function S(){for(var t=0,n=x.length;t<n;t++)e.stopObserving(x[t]),x[t]=null}function C(e,t,n){e=$(e);var r=E(e,t,n);if(!r)return e;if(t.include(":"))e.addEventListener?e.addEventListener("dataavailable",r,!1):(e.attachEvent("ondataavailable",r),e.attachEvent("onlosecapture",r));else{var i=T(t);e.addEventListener?e.addEventListener(i,r,!1):e.attachEvent("on"+i,r)}return e}function k(e,t,n){e=$(e);var r=Element.retrieve(e,"prototype_event_registry");if(!r)return e;if(!t)return r.each(function(t){var n=t.key;k(e,n)}),e;var i=r.get(t);if(!i)return e;if(!n)return i.each(function(n){k(e,t,n.handler)}),e;var s=i.length,o;while(s--)if(i[s].handler===n){o=i[s];break}if(!o)return e;if(t.include(":"))e.removeEventListener?e.removeEventListener("dataavailable",o,!1):(e.detachEvent("ondataavailable",o),e.detachEvent("onlosecapture",o));else{var u=T(t);e.removeEventListener?e.removeEventListener(u,o,!1):e.detachEvent("on"+u,o)}return r.set(t,i.without(o)),e}function L(t,n,r,i){t=$(t),Object.isUndefined(i)&&(i=!0),t==document&&document.createEvent&&!t.dispatchEvent&&(t=document.documentElement);var s;return document.createEvent?(s=document.createEvent("HTMLEvents"),s.initEvent("dataavailable",i,!0)):(s=document.createEventObject(),s.eventType=i?"ondataavailable":"onlosecapture"),s.eventName=n,s.memo=r||{},document.createEvent?t.dispatchEvent(s):t.fireEvent(s.eventType,s),e.extend(s)}function A(t,n,r,i){return t=$(t),Object.isFunction(r)&&Object.isUndefined(i)&&(i=r,r=null),(new e.Handler(t,n,r,i)).start()}var e={KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,KEY_HOME:36,KEY_END:35,KEY_PAGEUP:33,KEY_PAGEDOWN:34,KEY_INSERT:45,cache:{}},t=document.documentElement,n="onmouseenter"in t&&"onmouseleave"in t,r=function(e){return!1};window.attachEvent&&(window.addEventListener?r=function(e){return!(e instanceof window.Event)}:r=function(e){return!0});var i,o={0:1,1:4,2:2};window.attachEvent?window.addEventListener?i=function(e,t){return r(e)?u(e,t):s(e,t)}:i=u:Prototype.Browser.WebKit?i=a:i=s,e.Methods={isLeftClick:f,isMiddleClick:l,isRightClick:c,element:h,findElement:p,pointer:d,pointerX:v,pointerY:m,stop:g};var y=Object.keys(e.Methods).inject({},function(t,n){return t[n]=e.Methods[n].methodize(),t});if(window.attachEvent){function b(e){var t;switch(e.type){case"mouseover":case"mouseenter":t=e.fromElement;break;case"mouseout":case"mouseleave":t=e.toElement;break;default:return null}return Element.extend(t)}var w={stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.returnValue=!1},inspect:function(){return"[object Event]"}};e.extend=function(t,n){if(!t)return!1;if(!r(t))return t;if(t._extendedByPrototype)return t;t._extendedByPrototype=Prototype.emptyFunction;var i=e.pointer(t);return Object.extend(t,{target:t.srcElement||n,relatedTarget:b(t),pageX:i.x,pageY:i.y}),Object.extend(t,y),Object.extend(t,w),t}}else e.extend=Prototype.K;window.addEventListener&&(e.prototype=window.Event.prototype||document.createEvent("HTMLEvents").__proto__,Object.extend(e.prototype,y));var x=[];Prototype.Browser.IE&&window.attachEvent("onunload",S),Prototype.Browser.WebKit&&window.addEventListener("unload",Prototype.emptyFunction,!1);var T=Prototype.K,N={mouseenter:"mouseover",mouseleave:"mouseout"};n||(T=function(e){return N[e]||e}),e.Handler=Class.create({initialize:function(e,t,n,r){this.element=$(e),this.eventName=t,this.selector=n,this.callback=r,this.handler=this.handleEvent.bind(this)},start:function(){return e.observe(this.element,this.eventName,this.handler),this},stop:function(){return e.stopObserving(this.element,this.eventName,this.handler),this},handleEvent:function(t){var n=e.findElement(t,this.selector);n&&this.callback.call(this.element,t,n)}}),Object.extend(e,e.Methods),Object.extend(e,{fire:L,observe:C,stopObserving:k,on:A}),Element.addMethods({fire:L,observe:C,stopObserving:k,on:A}),Object.extend(document,{fire:L.methodize(),observe:C.methodize(),stopObserving:k.methodize(),on:A.methodize(),loaded:!1}),window.Event?Object.extend(window.Event,e):window.Event=e}(),function(){function t(){if(document.loaded)return;e&&window.clearTimeout(e),document.loaded=!0,document.fire("dom:loaded")}function n(){document.readyState==="complete"&&(document.stopObserving("readystatechange",n),t())}function r(){try{document.documentElement.doScroll("left")}catch(n){e=r.defer();return}t()}var e;document.addEventListener?document.addEventListener("DOMContentLoaded",t,!1):(document.observe("readystatechange",n),window==top&&(e=r.defer())),Event.observe(window,"load",t)}(),Element.addMethods(),Hash.toQueryString=Object.toQueryString;var Toggle={display:Element.toggle};Element.Methods.childOf=Element.Methods.descendantOf;var Insertion={Before:function(e,t){return Element.insert(e,{before:t})},Top:function(e,t){return Element.insert(e,{top:t})},Bottom:function(e,t){return Element.insert(e,{bottom:t})},After:function(e,t){return Element.insert(e,{after:t})}},$continue=new Error('"throw $continue" is deprecated, use "return" instead'),Position={includeScrollOffsets:!1,prepare:function(){this.deltaX=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0,this.deltaY=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0},within:function(e,t,n){return this.includeScrollOffsets?this.withinIncludingScrolloffsets(e,t,n):(this.xcomp=t,this.ycomp=n,this.offset=Element.cumulativeOffset(e),n>=this.offset[1]&&n<this.offset[1]+e.offsetHeight&&t>=this.offset[0]&&t<this.offset[0]+e.offsetWidth)},withinIncludingScrolloffsets:function(e,t,n){var r=Element.cumulativeScrollOffset(e);return this.xcomp=t+r[0]-this.deltaX,this.ycomp=n+r[1]-this.deltaY,this.offset=Element.cumulativeOffset(e),this.ycomp>=this.offset[1]&&this.ycomp<this.offset[1]+e.offsetHeight&&this.xcomp>=this.offset[0]&&this.xcomp<this.offset[0]+e.offsetWidth},overlap:function(e,t){if(!e)return 0;if(e=="vertical")return(this.offset[1]+t.offsetHeight-this.ycomp)/t.offsetHeight;if(e=="horizontal")return(this.offset[0]+t.offsetWidth-this.xcomp)/t.offsetWidth},cumulativeOffset:Element.Methods.cumulativeOffset,positionedOffset:Element.Methods.positionedOffset,absolutize:function(e){return Position.prepare(),Element.absolutize(e)},relativize:function(e){return Position.prepare(),Element.relativize(e)},realOffset:Element.Methods.cumulativeScrollOffset,offsetParent:Element.Methods.getOffsetParent,page:Element.Methods.viewportOffset,clone:function(e,t,n){return n=n||{},Element.clonePosition(t,e,n)}};document.getElementsByClassName||(document.getElementsByClassName=function(e){function t(e){return e.blank()?null:"[contains(concat(' ', @class, ' '), ' "+e+" ')]"}return e.getElementsByClassName=Prototype.BrowserFeatures.XPath?function(e,n){n=n.toString().strip();var r=/\s/.test(n)?$w(n).map(t).join(""):t(n);return r?document._getElementsByXPath(".//*"+r,e):[]}:function(e,t){t=t.toString().strip();var n=[],r=/\s/.test(t)?$w(t):null;if(!r&&!t)return n;var i=$(e).getElementsByTagName("*");t=" "+t+" ";for(var s=0,o,u;o=i[s];s++)o.className&&(u=" "+o.className+" ")&&(u.include(t)||r&&r.all(function(e){return!e.toString().blank()&&u.include(" "+e+" ")}))&&n.push(Element.extend(o));return n},function(e,t){return $(t||document.body).getElementsByClassName(e)}}(Element.Methods)),Element.ClassNames=Class.create(),Element.ClassNames.prototype={initialize:function(e){this.element=$(e)},_each:function(e){this.element.className.split(/\s+/).select(function(e){return e.length>0})._each(e)},set:function(e){this.element.className=e},add:function(e){if(this.include(e))return;this.set($A(this).concat(e).join(" "))},remove:function(e){if(!this.include(e))return;this.set($A(this).without(e).join(" "))},toString:function(){return $A(this).join(" ")}},Object.extend(Element.ClassNames.prototype,Enumerable),function(){window.Selector=Class.create({initialize:function(e){this.expression=e.strip()},findElements:function(e){return Prototype.Selector.select(this.expression,e)},match:function(e){return Prototype.Selector.match(e,this.expression)},toString:function(){return this.expression},inspect:function(){return"#<Selector: "+this.expression+">"}}),Object.extend(Selector,{matchElements:function(e,t){var n=Prototype.Selector.match,r=[];for(var i=0,s=e.length;i<s;i++){var o=e[i];n(o,t)&&r.push(Element.extend(o))}return r},findElement:function(e,t,n){n=n||0;var r=0,i;for(var s=0,o=e.length;s<o;s++){i=e[s];if(Prototype.Selector.match(i,t)&&n===r++)return Element.extend(i)}},findChildElements:function(e,t){var n=t.toArray().join(", ");return Prototype.Selector.select(n,e||document)}})}();var Scriptaculous={Version:"1.9.0",require:function(e){try{document.write('<script type="text/javascript" src="'+e+'"></script>')}catch(t){var n=document.createElement("script");n.type="text/javascript",n.src=e,document.getElementsByTagName("head")[0].appendChild(n)}},REQUIRED_PROTOTYPE:"1.6.0.3",load:function(){function e(e){var t=e.replace(/_.*|\./g,"");return t=parseInt(t+"0".times(4-t.length)),e.indexOf("_")>-1?t-1:t}if(typeof Prototype=="undefined"||typeof Element=="undefined"||typeof Element.Methods=="undefined"||e(Prototype.Version)<e(Scriptaculous.REQUIRED_PROTOTYPE))throw"script.aculo.us requires the Prototype JavaScript framework >= "+Scriptaculous.REQUIRED_PROTOTYPE;var t=/scriptaculous\.js(\?.*)?$/;$$("script[src]").findAll(function(e){return e.src.match(t)}).each(function(e){var n=e.src.replace(t,""),r=e.src.match(/\?.*load=([a-z,]*)/);(r?r[1]:"builder,effects,dragdrop,controls,slider,sound").split(",").each(function(e){Scriptaculous.require
(n+e+".js")})})}};Scriptaculous.load(),String.prototype.parseColor=function(){var e="#";if(this.slice(0,4)=="rgb("){var t=this.slice(4,this.length-1).split(","),n=0;do e+=parseInt(t[n]).toColorPart();while(++n<3)}else if(this.slice(0,1)=="#"){if(this.length==4)for(var n=1;n<4;n++)e+=(this.charAt(n)+this.charAt(n)).toLowerCase();this.length==7&&(e=this.toLowerCase())}return e.length==7?e:arguments[0]||this},Element.collectTextNodes=function(e){return $A($(e).childNodes).collect(function(e){return e.nodeType==3?e.nodeValue:e.hasChildNodes()?Element.collectTextNodes(e):""}).flatten().join("")},Element.collectTextNodesIgnoreClass=function(e,t){return $A($(e).childNodes).collect(function(e){return e.nodeType==3?e.nodeValue:e.hasChildNodes()&&!Element.hasClassName(e,t)?Element.collectTextNodesIgnoreClass(e,t):""}).flatten().join("")},Element.setContentZoom=function(e,t){return e=$(e),e.setStyle({fontSize:t/100+"em"}),Prototype.Browser.WebKit&&window.scrollBy(0,0),e},Element.getInlineOpacity=function(e){return $(e).style.opacity||""},Element.forceRerendering=function(e){try{e=$(e);var t=document.createTextNode(" ");e.appendChild(t),e.removeChild(t)}catch(n){}};var Effect={_elementDoesNotExistError:{name:"ElementDoesNotExistError",message:"The specified DOM element does not exist, but is required for this effect to operate"},Transitions:{linear:Prototype.K,sinoidal:function(e){return-Math.cos(e*Math.PI)/2+.5},reverse:function(e){return 1-e},flicker:function(e){var e=-Math.cos(e*Math.PI)/4+.75+Math.random()/4;return e>1?1:e},wobble:function(e){return-Math.cos(e*Math.PI*9*e)/2+.5},pulse:function(e,t){return-Math.cos(e*((t||5)-.5)*2*Math.PI)/2+.5},spring:function(e){return 1-Math.cos(e*4.5*Math.PI)*Math.exp(-e*6)},none:function(e){return 0},full:function(e){return 1}},DefaultOptions:{duration:1,fps:100,sync:!1,from:0,to:1,delay:0,queue:"parallel"},tagifyText:function(e){var t="position:relative";Prototype.Browser.IE&&(t+=";zoom:1"),e=$(e),$A(e.childNodes).each(function(n){n.nodeType==3&&(n.nodeValue.toArray().each(function(r){e.insertBefore((new Element("span",{style:t})).update(r==" "?String.fromCharCode(160):r),n)}),Element.remove(n))})},multiple:function(e,t){var n;(typeof e=="object"||Object.isFunction(e))&&e.length?n=e:n=$(e).childNodes;var r=Object.extend({speed:.1,delay:0},arguments[2]||{}),i=r.delay;$A(n).each(function(e,n){new t(e,Object.extend(r,{delay:n*r.speed+i}))})},PAIRS:{slide:["SlideDown","SlideUp"],blind:["BlindDown","BlindUp"],appear:["Appear","Fade"]},toggle:function(e,t,n){return e=$(e),t=(t||"appear").toLowerCase(),Effect[Effect.PAIRS[t][e.visible()?1:0]](e,Object.extend({queue:{position:"end",scope:e.id||"global",limit:1}},n||{}))}};Effect.DefaultOptions.transition=Effect.Transitions.sinoidal,Effect.ScopedQueue=Class.create(Enumerable,{initialize:function(){this.effects=[],this.interval=null},_each:function(e){this.effects._each(e)},add:function(e){var t=(new Date).getTime(),n=Object.isString(e.options.queue)?e.options.queue:e.options.queue.position;switch(n){case"front":this.effects.findAll(function(e){return e.state=="idle"}).each(function(t){t.startOn+=e.finishOn,t.finishOn+=e.finishOn});break;case"with-last":t=this.effects.pluck("startOn").max()||t;break;case"end":t=this.effects.pluck("finishOn").max()||t}e.startOn+=t,e.finishOn+=t,(!e.options.queue.limit||this.effects.length<e.options.queue.limit)&&this.effects.push(e),this.interval||(this.interval=setInterval(this.loop.bind(this),15))},remove:function(e){this.effects=this.effects.reject(function(t){return t==e}),this.effects.length==0&&(clearInterval(this.interval),this.interval=null)},loop:function(){var e=(new Date).getTime();for(var t=0,n=this.effects.length;t<n;t++)this.effects[t]&&this.effects[t].loop(e)}}),Effect.Queues={instances:$H(),get:function(e){return Object.isString(e)?this.instances.get(e)||this.instances.set(e,new Effect.ScopedQueue):e}},Effect.Queue=Effect.Queues.get("global"),Effect.Base=Class.create({position:null,start:function(e){e&&e.transition===!1&&(e.transition=Effect.Transitions.linear),this.options=Object.extend(Object.extend({},Effect.DefaultOptions),e||{}),this.currentFrame=0,this.state="idle",this.startOn=this.options.delay*1e3,this.finishOn=this.startOn+this.options.duration*1e3,this.fromToDelta=this.options.to-this.options.from,this.totalTime=this.finishOn-this.startOn,this.totalFrames=this.options.fps*this.options.duration,this.render=function(){function e(e,t){e.options[t+"Internal"]&&e.options[t+"Internal"](e),e.options[t]&&e.options[t](e)}return function(t){this.state==="idle"&&(this.state="running",e(this,"beforeSetup"),this.setup&&this.setup(),e(this,"afterSetup")),this.state==="running"&&(t=this.options.transition(t)*this.fromToDelta+this.options.from,this.position=t,e(this,"beforeUpdate"),this.update&&this.update(t),e(this,"afterUpdate"))}}(),this.event("beforeStart"),this.options.sync||Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).add(this)},loop:function(e){if(e>=this.startOn){if(e>=this.finishOn){this.render(1),this.cancel(),this.event("beforeFinish"),this.finish&&this.finish(),this.event("afterFinish");return}var t=(e-this.startOn)/this.totalTime,n=(t*this.totalFrames).round();n>this.currentFrame&&(this.render(t),this.currentFrame=n)}},cancel:function(){this.options.sync||Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).remove(this),this.state="finished"},event:function(e){this.options[e+"Internal"]&&this.options[e+"Internal"](this),this.options[e]&&this.options[e](this)},inspect:function(){var e=$H();for(property in this)Object.isFunction(this[property])||e.set(property,this[property]);return"#<Effect:"+e.inspect()+",options:"+$H(this.options).inspect()+">"}}),Effect.Parallel=Class.create(Effect.Base,{initialize:function(e){this.effects=e||[],this.start(arguments[1])},update:function(e){this.effects.invoke("render",e)},finish:function(e){this.effects.each(function(t){t.render(1),t.cancel(),t.event("beforeFinish"),t.finish&&t.finish(e),t.event("afterFinish")})}}),Effect.Tween=Class.create(Effect.Base,{initialize:function(e,t,n){e=Object.isString(e)?$(e):e;var r=$A(arguments),i=r.last(),s=r.length==5?r[3]:null;this.method=Object.isFunction(i)?i.bind(e):Object.isFunction(e[i])?e[i].bind(e):function(t){e[i]=t},this.start(Object.extend({from:t,to:n},s||{}))},update:function(e){this.method(e)}}),Effect.Event=Class.create(Effect.Base,{initialize:function(){this.start(Object.extend({duration:0},arguments[0]||{}))},update:Prototype.emptyFunction}),Effect.Opacity=Class.create(Effect.Base,{initialize:function(e){this.element=$(e);if(!this.element)throw Effect._elementDoesNotExistError;Prototype.Browser.IE&&!this.element.currentStyle.hasLayout&&this.element.setStyle({zoom:1});var t=Object.extend({from:this.element.getOpacity()||0,to:1},arguments[1]||{});this.start(t)},update:function(e){this.element.setOpacity(e)}}),Effect.Move=Class.create(Effect.Base,{initialize:function(e){this.element=$(e);if(!this.element)throw Effect._elementDoesNotExistError;var t=Object.extend({x:0,y:0,mode:"relative"},arguments[1]||{});this.start(t)},setup:function(){this.element.makePositioned(),this.originalLeft=parseFloat(this.element.getStyle("left")||"0"),this.originalTop=parseFloat(this.element.getStyle("top")||"0"),this.options.mode=="absolute"&&(this.options.x=this.options.x-this.originalLeft,this.options.y=this.options.y-this.originalTop)},update:function(e){this.element.setStyle({left:(this.options.x*e+this.originalLeft).round()+"px",top:(this.options.y*e+this.originalTop).round()+"px"})}}),Effect.MoveBy=function(e,t,n){return new Effect.Move(e,Object.extend({x:n,y:t},arguments[3]||{}))},Effect.Scale=Class.create(Effect.Base,{initialize:function(e,t){this.element=$(e);if(!this.element)throw Effect._elementDoesNotExistError;var n=Object.extend({scaleX:!0,scaleY:!0,scaleContent:!0,scaleFromCenter:!1,scaleMode:"box",scaleFrom:100,scaleTo:t},arguments[2]||{});this.start(n)},setup:function(){this.restoreAfterFinish=this.options.restoreAfterFinish||!1,this.elementPositioning=this.element.getStyle("position"),this.originalStyle={},["top","left","width","height","fontSize"].each(function(e){this.originalStyle[e]=this.element.style[e]}.bind(this)),this.originalTop=this.element.offsetTop,this.originalLeft=this.element.offsetLeft;var e=this.element.getStyle("font-size")||"100%";["em","px","%","pt"].each(function(t){e.indexOf(t)>0&&(this.fontSize=parseFloat(e),this.fontSizeType=t)}.bind(this)),this.factor=(this.options.scaleTo-this.options.scaleFrom)/100,this.dims=null,this.options.scaleMode=="box"&&(this.dims=[this.element.offsetHeight,this.element.offsetWidth]),/^content/.test(this.options.scaleMode)&&(this.dims=[this.element.scrollHeight,this.element.scrollWidth]),this.dims||(this.dims=[this.options.scaleMode.originalHeight,this.options.scaleMode.originalWidth])},update:function(e){var t=this.options.scaleFrom/100+this.factor*e;this.options.scaleContent&&this.fontSize&&this.element.setStyle({fontSize:this.fontSize*t+this.fontSizeType}),this.setDimensions(this.dims[0]*t,this.dims[1]*t)},finish:function(e){this.restoreAfterFinish&&this.element.setStyle(this.originalStyle)},setDimensions:function(e,t){var n={};this.options.scaleX&&(n.width=t.round()+"px"),this.options.scaleY&&(n.height=e.round()+"px");if(this.options.scaleFromCenter){var r=(e-this.dims[0])/2,i=(t-this.dims[1])/2;this.elementPositioning=="absolute"?(this.options.scaleY&&(n.top=this.originalTop-r+"px"),this.options.scaleX&&(n.left=this.originalLeft-i+"px")):(this.options.scaleY&&(n.top=-r+"px"),this.options.scaleX&&(n.left=-i+"px"))}this.element.setStyle(n)}}),Effect.Highlight=Class.create(Effect.Base,{initialize:function(e){this.element=$(e);if(!this.element)throw Effect._elementDoesNotExistError;var t=Object.extend({startcolor:"#ffff99"},arguments[1]||{});this.start(t)},setup:function(){if(this.element.getStyle("display")=="none"){this.cancel();return}this.oldStyle={},this.options.keepBackgroundImage||(this.oldStyle.backgroundImage=this.element.getStyle("background-image"),this.element.setStyle({backgroundImage:"none"})),this.options.endcolor||(this.options.endcolor=this.element.getStyle("background-color").parseColor("#ffffff")),this.options.restorecolor||(this.options.restorecolor=this.element.getStyle("background-color")),this._base=$R(0,2).map(function(e){return parseInt(this.options.startcolor.slice(e*2+1,e*2+3),16)}.bind(this)),this._delta=$R(0,2).map(function(e){return parseInt(this.options.endcolor.slice(e*2+1,e*2+3),16)-this._base[e]}.bind(this))},update:function(e){this.element.setStyle({backgroundColor:$R(0,2).inject("#",function(t,n,r){return t+(this._base[r]+this._delta[r]*e).round().toColorPart()}.bind(this))})},finish:function(){this.element.setStyle(Object.extend(this.oldStyle,{backgroundColor:this.options.restorecolor}))}}),Effect.ScrollTo=function(e){var t=arguments[1]||{},n=document.viewport.getScrollOffsets(),r=$(e).cumulativeOffset();return t.offset&&(r[1]+=t.offset),new Effect.Tween(null,n.top,r[1],t,function(e){scrollTo(n.left,e.round())})},Effect.Fade=function(e){e=$(e);var t=e.getInlineOpacity(),n=Object.extend({from:e.getOpacity()||1,to:0,afterFinishInternal:function(e){if(e.options.to!=0)return;e.element.hide().setStyle({opacity:t})}},arguments[1]||{});return new Effect.Opacity(e,n)},Effect.Appear=function(e){e=$(e);var t=Object.extend({from:e.getStyle("display")=="none"?0:e.getOpacity()||0,to:1,afterFinishInternal:function(e){e.element.forceRerendering()},beforeSetup:function(e){e.element.setOpacity(e.options.from).show()}},arguments[1]||{});return new Effect.Opacity(e,t)},Effect.Puff=function(e){e=$(e);var t={opacity:e.getInlineOpacity(),position:e.getStyle("position"),top:e.style.top,left:e.style.left,width:e.style.width,height:e.style.height};return new Effect.Parallel([new Effect.Scale(e,200,{sync:!0,scaleFromCenter:!0,scaleContent:!0,restoreAfterFinish:!0}),new Effect.Opacity(e,{sync:!0,to:0})],Object.extend({duration:1,beforeSetupInternal:function(e){Position.absolutize(e.effects[0].element)},afterFinishInternal:function(e){e.effects[0].element.hide().setStyle(t)}},arguments[1]||{}))},Effect.BlindUp=function(e){return e=$(e),e.makeClipping(),new Effect.Scale(e,0,Object.extend({scaleContent:!1,scaleX:!1,restoreAfterFinish:!0,afterFinishInternal:function(e){e.element.hide().undoClipping()}},arguments[1]||{}))},Effect.BlindDown=function(e){e=$(e);var t=e.getDimensions();return new Effect.Scale(e,100,Object.extend({scaleContent:!1,scaleX:!1,scaleFrom:0,scaleMode:{originalHeight:t.height,originalWidth:t.width},restoreAfterFinish:!0,afterSetup:function(e){e.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(e){e.element.undoClipping()}},arguments[1]||{}))},Effect.SwitchOff=function(e){e=$(e);var t=e.getInlineOpacity();return new Effect.Appear(e,Object.extend({duration:.4,from:0,transition:Effect.Transitions.flicker,afterFinishInternal:function(e){new Effect.Scale(e.element,1,{duration:.3,scaleFromCenter:!0,scaleX:!1,scaleContent:!1,restoreAfterFinish:!0,beforeSetup:function(e){e.element.makePositioned().makeClipping()},afterFinishInternal:function(e){e.element.hide().undoClipping().undoPositioned().setStyle({opacity:t})}})}},arguments[1]||{}))},Effect.DropOut=function(e){e=$(e);var t={top:e.getStyle("top"),left:e.getStyle("left"),opacity:e.getInlineOpacity()};return new Effect.Parallel([new Effect.Move(e,{x:0,y:100,sync:!0}),new Effect.Opacity(e,{sync:!0,to:0})],Object.extend({duration:.5,beforeSetup:function(e){e.effects[0].element.makePositioned()},afterFinishInternal:function(e){e.effects[0].element.hide().undoPositioned().setStyle(t)}},arguments[1]||{}))},Effect.Shake=function(e){e=$(e);var t=Object.extend({distance:20,duration:.5},arguments[1]||{}),n=parseFloat(t.distance),r=parseFloat(t.duration)/10,i={top:e.getStyle("top"),left:e.getStyle("left")};return new Effect.Move(e,{x:n,y:0,duration:r,afterFinishInternal:function(e){new Effect.Move(e.element,{x:-n*2,y:0,duration:r*2,afterFinishInternal:function(e){new Effect.Move(e.element,{x:n*2,y:0,duration:r*2,afterFinishInternal:function(e){new Effect.Move(e.element,{x:-n*2,y:0,duration:r*2,afterFinishInternal:function(e){new Effect.Move(e.element,{x:n*2,y:0,duration:r*2,afterFinishInternal:function(e){new Effect.Move(e.element,{x:-n,y:0,duration:r,afterFinishInternal:function(e){e.element.undoPositioned().setStyle(i)}})}})}})}})}})}})},Effect.SlideDown=function(e){e=$(e).cleanWhitespace();var t=e.down().getStyle("bottom"),n=e.getDimensions();return new Effect.Scale(e,100,Object.extend({scaleContent:!1,scaleX:!1,scaleFrom:window.opera?0:1,scaleMode:{originalHeight:n.height,originalWidth:n.width},restoreAfterFinish:!0,afterSetup:function(e){e.element.makePositioned(),e.element.down().makePositioned(),window.opera&&e.element.setStyle({top:""}),e.element.makeClipping().setStyle({height:"0px"}).show()},afterUpdateInternal:function(e){e.element.down().setStyle({bottom:e.dims[0]-e.element.clientHeight+"px"})},afterFinishInternal:function(e){e.element.undoClipping().undoPositioned(),e.element.down().undoPositioned().setStyle({bottom:t})}},arguments[1]||{}))},Effect.SlideUp=function(e){e=$(e).cleanWhitespace();var t=e.down().getStyle("bottom"),n=e.getDimensions();return new Effect.Scale(e,window.opera?0:1,Object.extend({scaleContent:!1,scaleX:!1,scaleMode:"box",scaleFrom:100,scaleMode:{originalHeight:n.height,originalWidth:n.width},restoreAfterFinish:!0,afterSetup:function(e){e.element.makePositioned(),e.element.down().makePositioned(),window.opera&&e.element.setStyle({top:""}),e.element.makeClipping().show()},afterUpdateInternal:function(e){e.element.down().setStyle({bottom:e.dims[0]-e.element.clientHeight+"px"})},afterFinishInternal:function(e){e.element.hide().undoClipping().undoPositioned(),e.element.down().undoPositioned().setStyle({bottom:t})}},arguments[1]||{}))},Effect.Squish=function(e){return new Effect.Scale(e,window.opera?1:0,{restoreAfterFinish:!0,beforeSetup:function(e){e.element.makeClipping()},afterFinishInternal:function(e){e.element.hide().undoClipping()}})},Effect.Grow=function(e){e=$(e);var t=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.full},arguments[1]||{}),n={top:e.style.top,left:e.style.left,height:e.style.height,width:e.style.width,opacity:e.getInlineOpacity()},r=e.getDimensions(),i,s,o,u;switch(t.direction){case"top-left":i=s=o=u=0;break;case"top-right":i=r.width,s=u=0,o=-r.width;break;case"bottom-left":i=o=0,s=r.height,u=-r.height;break;case"bottom-right":i=r.width,s=r.height,o=-r.width,u=-r.height;break;case"center":i=r.width/2,s=r.height/2,o=-r.width/2,u=-r.height/2}return new Effect.Move(e,{x:i,y:s,duration:.01,beforeSetup:function(e){e.element.hide().makeClipping().makePositioned()},afterFinishInternal:function(e){new Effect.Parallel([new Effect.Opacity(e.element,{sync:!0,to:1,from:0,transition:t.opacityTransition}),new Effect.Move(e.element,{x:o,y:u,sync:!0,transition:t.moveTransition}),new Effect.Scale(e.element,100,{scaleMode:{originalHeight:r.height,originalWidth:r.width},sync:!0,scaleFrom:window.opera?1:0,transition:t.scaleTransition,restoreAfterFinish:!0})],Object.extend({beforeSetup:function(e){e.effects[0].element.setStyle({height:"0px"}).show()},afterFinishInternal:function(e){e.effects[0].element.undoClipping().undoPositioned().setStyle(n)}},t))}})},Effect.Shrink=function(e){e=$(e);var t=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.none},arguments[1]||{}),n={top:e.style.top,left:e.style.left,height:e.style.height,width:e.style.width,opacity:e.getInlineOpacity()},r=e.getDimensions(),i,s;switch(t.direction){case"top-left":i=s=0;break;case"top-right":i=r.width,s=0;break;case"bottom-left":i=0,s=r.height;break;case"bottom-right":i=r.width,s=r.height;break;case"center":i=r.width/2,s=r.height/2}return new Effect.Parallel([new Effect.Opacity(e,{sync:!0,to:0,from:1,transition:t.opacityTransition}),new Effect.Scale(e,window.opera?1:0,{sync:!0,transition:t.scaleTransition,restoreAfterFinish:!0}),new Effect.Move(e,{x:i,y:s,sync:!0,transition:t.moveTransition})],Object.extend({beforeStartInternal:function(e){e.effects[0].element.makePositioned().makeClipping()},afterFinishInternal:function(e){e.effects[0].element.hide().undoClipping().undoPositioned().setStyle(n)}},t))},Effect.Pulsate=function(e){e=$(e);var t=arguments[1]||{},n=e.getInlineOpacity(),r=t.transition||Effect.Transitions.linear,i=function(e){return 1-r(-Math.cos(e*(t.pulses||5)*2*Math.PI)/2+.5)};return new Effect.Opacity(e,Object.extend(Object.extend({duration:2,from:0,afterFinishInternal:function(e){e.element.setStyle({opacity:n})}},t),{transition:i}))},Effect.Fold=function(e){e=$(e);var t={top:e.style.top,left:e.style.left,width:e.style.width,height:e.style.height};return e.makeClipping(),new Effect.Scale(e,5,Object.extend({scaleContent:!1,scaleX:!1,afterFinishInternal:function(n){new Effect.Scale(e,1,{scaleContent:!1,scaleY:!1,afterFinishInternal:function(e){e.element.hide().undoClipping().setStyle(t)}})}},arguments[1]||{}))},Effect.Morph=Class.create(Effect.Base,{initialize:function(e){this.element=$(e);if(!this.element)throw Effect._elementDoesNotExistError;var t=Object.extend({style:{}},arguments[1]||{});if(!Object.isString(t.style))this.style=$H(t.style);else if(t.style.include(":"))this.style=t.style.parseStyle();else{this.element.addClassName(t.style),this.style=$H(this.element.getStyles()),this.element.removeClassName(t.style);var n=this.element.getStyles();this.style=this.style.reject(function(e){return e.value==n[e.key]}),t.afterFinishInternal=function(e){e.element.addClassName(e.options.style),e.transforms.each(function(t){e.element.style[t.style]=""})}}this.start(t)},setup:function(){function e(e){if(!e||["rgba(0, 0, 0, 0)","transparent"].include(e))e="#ffffff";return e=e.parseColor(),$R(0,2).map(function(t){return parseInt(e.slice(t*2+1,t*2+3),16)})}this.transforms=this.style.map(function(t){var n=t[0],r=t[1],i=null;if(r.parseColor("#zzzzzz")!="#zzzzzz")r=r.parseColor(),i="color";else if(n=="opacity")r=parseFloat(r),Prototype.Browser.IE&&!this.element.currentStyle.hasLayout&&this.element.setStyle({zoom:1});else if(Element.CSS_LENGTH.test(r)){var s=r.match(/^([\+\-]?[0-9\.]+)(.*)$/);r=parseFloat(s[1]),i=s.length==3?s[2]:null}var o=this.element.getStyle(n);return{style:n.camelize(),originalValue:i=="color"?e(o):parseFloat(o||0),targetValue:i=="color"?e(r):r,unit:i}}.bind(this)).reject(function(e){return e.originalValue==e.targetValue||e.unit!="color"&&(isNaN(e.originalValue)||isNaN(e.targetValue))})},update:function(e){var t={},n,r=this.transforms.length;while(r--)t[(n=this.transforms[r]).style]=n.unit=="color"?"#"+Math.round(n.originalValue[0]+(n.targetValue[0]-n.originalValue[0])*e).toColorPart()+Math.round(n.originalValue[1]+(n.targetValue[1]-n.originalValue[1])*e).toColorPart()+Math.round(n.originalValue[2]+(n.targetValue[2]-n.originalValue[2])*e).toColorPart():(n.originalValue+(n.targetValue-n.originalValue)*e).toFixed(3)+(n.unit===null?"":n.unit);this.element.setStyle(t,!0)}}),Effect.Transform=Class.create({initialize:function(e){this.tracks=[],this.options=arguments[1]||{},this.addTracks(e)},addTracks:function(e){return e.each(function(e){e=$H(e);var t=e.values().first();this.tracks.push($H({ids:e.keys().first(),effect:Effect.Morph,options:{style:t}}))}.bind(this)),this},play:function(){return new Effect.Parallel(this.tracks.map(function(e){var t=e.get("ids"),n=e.get("effect"),r=e.get("options"),i=[$(t)||$$(t)].flatten();return i.map(function(e){return new n(e,Object.extend({sync:!0},r))})}).flatten(),this.options)}}),Element.CSS_PROPERTIES=$w("backgroundColor backgroundPosition borderBottomColor borderBottomStyle borderBottomWidth borderLeftColor borderLeftStyle borderLeftWidth borderRightColor borderRightStyle borderRightWidth borderSpacing borderTopColor borderTopStyle borderTopWidth bottom clip color fontSize fontWeight height left letterSpacing lineHeight marginBottom marginLeft marginRight marginTop markerOffset maxHeight maxWidth minHeight minWidth opacity outlineColor outlineOffset outlineWidth paddingBottom paddingLeft paddingRight paddingTop right textIndent top width wordSpacing zIndex"),Element.CSS_LENGTH=/^(([\+\-]?[0-9\.]+)(em|ex|px|in|cm|mm|pt|pc|\%))|0$/,String.__parseStyleElement=document.createElement("div"),String.prototype.parseStyle=function(){var e,t=$H();return Prototype.Browser.WebKit?e=(new Element("div",{style:this})).style:(String.__parseStyleElement.innerHTML='<div style="'+this+'"></div>',e=String.__parseStyleElement.childNodes[0].style),Element.CSS_PROPERTIES.each(function(n){e[n]&&t.set(n,e[n])}),Prototype.Browser.IE&&this.include("opacity")&&t.set("opacity",this.match(/opacity:\s*((?:0|1)?(?:\.\d*)?)/)[1]),t},document.defaultView&&document.defaultView.getComputedStyle?Element.getStyles=function(e){var t=document.defaultView.getComputedStyle($(e),null);return Element.CSS_PROPERTIES.inject({},function(e,n){return e[n]=t[n],e})}:Element.getStyles=function(e){e=$(e);var t=e.currentStyle,n;return n=Element.CSS_PROPERTIES.inject({},function(e,n){return e[n]=t[n],e}),n.opacity||(n.opacity=e.getOpacity()),n},Effect.Methods={morph:function(e,t){return e=$(e),new Effect.Morph(e,Object.extend({style:t},arguments[2]||{})),e},visualEffect:function(e,t,n){e=$(e);var r=t.dasherize().camelize(),i=r.charAt(0).toUpperCase()+r.substring(1);return new Effect[i](e,n),e},highlight:function(e,t){return e=$(e),new Effect.Highlight(e,t),e}},$w("fade appear grow shrink fold blindUp blindDown slideUp slideDown pulsate shake puff squish switchOff dropOut").each(function(e){Effect.Methods[e]=function(t,n){return t=$(t),Effect[e.charAt(0).toUpperCase()+e.substring(1)](t,n),t}}),$w("getInlineOpacity forceRerendering setContentZoom collectTextNodes collectTextNodesIgnoreClass getStyles").each(function(e){Effect.Methods[e]=Element[e]}),Element.addMethods(Effect.Methods);var Builder={NODEMAP:{AREA:"map",CAPTION:"table",COL:"table",COLGROUP:"table",LEGEND:"fieldset",OPTGROUP:"select",OPTION:"select",PARAM:"object",TBODY:"table",TD:"table",TFOOT:"table",TH:"table",THEAD:"table",TR:"table"},node:function(e){e=e.toUpperCase();var t=this.NODEMAP[e]||"div",n=document.createElement(t);try{n.innerHTML="<"+e+"></"+e+">"}catch(r){}var i=n.firstChild||null;i&&i.tagName.toUpperCase()!=e&&(i=i.getElementsByTagName(e)[0]),i||(i=document.createElement(e));if(!i)return;if(arguments[1])if(this._isStringOrNumber(arguments[1])||arguments[1]instanceof Array||arguments[1].tagName)this._children(i,arguments[1]);else{var s=this._attributes(arguments[1]);if(s.length){try{n.innerHTML="<"+e+" "+s+"></"+e+">"}catch(r){}i=n.firstChild||null;if(!i){i=document.createElement(e);for(attr in arguments[1])i[attr=="class"?"className":attr]=arguments[1][attr]}i.tagName.toUpperCase()!=e&&(i=n.getElementsByTagName(e)[0])}}return arguments[2]&&this._children(i,arguments[2]),$(i)},_text:function(e){return document.createTextNode(e)},ATTR_MAP:{className:"class",htmlFor:"for"},_attributes:function(e){var t=[];for(attribute in e)t.push((attribute in this.ATTR_MAP?this.ATTR_MAP[attribute]:attribute)+'="'+e[attribute].toString().escapeHTML().gsub(/"/,"&quot;")+'"');return t.join(" ")},_children:function(e,t){if(t.tagName){e.appendChild(t);return}typeof t=="object"?t.flatten().each(function(t){typeof t=="object"?e.appendChild(t):Builder._isStringOrNumber(t)&&e.appendChild(Builder._text(t))}):Builder._isStringOrNumber(t)&&e.appendChild(Builder._text(t))},_isStringOrNumber:function(e){return typeof e=="string"||typeof e=="number"},build:function(e){var t=this.node("div");return $(t).update(e.strip()),t.down()},dump:function(e){typeof e!="object"&&typeof e!="function"&&(e=window);var t="A ABBR ACRONYM ADDRESS APPLET AREA B BASE BASEFONT BDO BIG BLOCKQUOTE BODY BR BUTTON CAPTION CENTER CITE CODE COL COLGROUP DD DEL DFN DIR DIV DL DT EM FIELDSET FONT FORM FRAME FRAMESET H1 H2 H3 H4 H5 H6 HEAD HR HTML I IFRAME IMG INPUT INS ISINDEX KBD LABEL LEGEND LI LINK MAP MENU META NOFRAMES NOSCRIPT OBJECT OL OPTGROUP OPTION P PARAM PRE Q S SAMP SCRIPT SELECT SMALL SPAN STRIKE STRONG STYLE SUB SUP TABLE TBODY TD TEXTAREA TFOOT TH THEAD TITLE TR TT U UL VAR".split(/\s+/);t.each(function(t){e[t]=function(){return Builder.node.apply(Builder,[t].concat($A(arguments)))}})}};if(typeof Effect=="undefined")throw"controls.js requires including script.aculo.us' effects.js library";var Autocompleter={};Autocompleter.Base=Class.create({baseInitialize:function(e,t,n){e=$(e),this.element=e,this.update=$(t),this.hasFocus=!1,this.changed=!1,this.active=!1,this.index=0,this.entryCount=0,this.oldElementValue=this.element.value,this.setOptions?this.setOptions(n):this.options=n||{},this.options.paramName=this.options.paramName||this.element.name,this.options.tokens=this.options.tokens||[],this.options.frequency=this.options.frequency||.4,this.options.minChars=this.options.minChars||1,this.options.onShow=this.options.onShow||function(e,t){if(!t.style.position||t.style.position=="absolute")t.style.position="absolute",Position.clone(e,t,{setHeight:!1,offsetTop:e.offsetHeight});Effect.Appear(t,{duration:.15})},this.options.onHide=this.options.onHide||function(e,t){new Effect.Fade(t,{duration:.15})},typeof this.options.tokens=="string"&&(this.options.tokens=new Array(this.options.tokens)),this.options.tokens.include("\n")||this.options.tokens.push("\n"),this.observer=null,this.element.setAttribute("autocomplete","off"),Element.hide(this.update),Event.observe(this.element,"blur",this.onBlur.bindAsEventListener(this)),Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},show:function(){Element.getStyle(this.update,"display")=="none"&&this.options.onShow(this.element,this.update),!this.iefix&&Prototype.Browser.IE&&Element.getStyle(this.update,"position")=="absolute"&&(new Insertion.After(this.update,'<iframe id="'+this.update.id+'_iefix" '+'style="display:none;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);" '+'src="javascript:false;" frameborder="0" scrolling="no"></iframe>'),this.iefix=$(this.update.id+"_iefix")),this.iefix&&setTimeout(this.fixIEOverlapping.bind(this),50)},fixIEOverlapping:function(){Position.clone(this.update,this.iefix,{setTop:!this.update.style.height}),this.iefix.style.zIndex=1,this.update.style.zIndex=2,Element.show(this.iefix)},hide:function(){this.stopIndicator(),Element.getStyle(this.update,"display")!="none"&&this.options.onHide(this.element,this.update),this.iefix&&Element.hide(this.iefix)},startIndicator:function(){this.options.indicator&&Element.show(this.options.indicator)},stopIndicator:function(){this.options.indicator&&Element.hide(this.options.indicator)},onKeyPress:function(e){if(this.active)switch(e.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.selectEntry(),Event.stop(e);case Event.KEY_ESC:this.hide(),this.active=!1,Event.stop(e);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious(),this.render(),Event.stop(e);return;case Event.KEY_DOWN:this.markNext(),this.render(),Event.stop(e);return}else if(e.keyCode==Event.KEY_TAB||e.keyCode==Event.KEY_RETURN||Prototype.Browser.WebKit>0&&e.keyCode==0)return;this.changed=!0,this.hasFocus=!0,this.observer&&clearTimeout(this.observer),this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1e3)},activate:function(){this.changed=!1,this.hasFocus=!0,this.getUpdatedChoices()},onHover:function(e){var t=Event.findElement(e,"LI");this.index!=t.autocompleteIndex&&(this.index=t.autocompleteIndex,this.render()),Event.stop(e)},onClick:function(e){var t=Event.findElement(e,"LI");this.index=t.autocompleteIndex,this.selectEntry(),this.hide()},onBlur:function(e){setTimeout(this.hide.bind(this),250),this.hasFocus=!1,this.active=!1},render:function(){if(this.entryCount>0){for(var e=0;e<this.entryCount;e++)this.index==e?Element.addClassName(this.getEntry(e),"selected"):Element.removeClassName(this.getEntry(e),"selected");this.hasFocus&&(this.show(),this.active=!0)}else this.active=!1,this.hide()},markPrevious:function(){this.index>0?this.index--:this.index=this.entryCount-1,this.getEntry(this.index).scrollIntoView(!0)},markNext:function(){this.index<this.entryCount-1?this.index++:this.index=0,this.getEntry(this.index).scrollIntoView(!1)},getEntry:function(e){return this.update.firstChild.childNodes[e]},getCurrentEntry:function(){return this.getEntry(this.index)},selectEntry:function(){this.active=!1,this.updateElement(this.getCurrentEntry())},updateElement:function(e){if(this.options.updateElement){this.options.updateElement(e);return}var t="";if(this.options.select){var n=$(e).select("."+this.options.select)||[];n.length>0&&(t=Element.collectTextNodes(n[0],this.options.select))}else t=Element.collectTextNodesIgnoreClass(e,"informal");var r=this.getTokenBounds();if(r[0]!=-1){var i=this.element.value.substr(0,r[0]),s=this.element.value.substr(r[0]).match(/^\s+/);s&&(i+=s[0]),this.element.value=i+t+this.element.value.substr(r[1])}else this.element.value=t;this.oldElementValue=this.element.value,this.element.focus(),this.options.afterUpdateElement&&this.options.afterUpdateElement(this.element,e)},updateChoices:function(e){if(!this.changed&&this.hasFocus){this.update.innerHTML=e,Element.cleanWhitespace(this.update),Element.cleanWhitespace(this.update.down());if(this.update.firstChild&&this.update.down().childNodes){this.entryCount=this.update.down().childNodes.length;for(var t=0;t<this.entryCount;t++){var n=this.getEntry(t);n.autocompleteIndex=t,this.addObservers(n)}}else this.entryCount=0;this.stopIndicator(),this.index=0,this.entryCount==1&&this.options.autoSelect?(this.selectEntry(),this.hide()):this.render()}},addObservers:function(e){Event.observe(e,"mouseover",this.onHover.bindAsEventListener(this)),Event.observe(e,"click",this.onClick.bindAsEventListener(this))},onObserverEvent:function(){this.changed=!1,this.tokenBounds=null,this.getToken().length>=this.options.minChars?this.getUpdatedChoices():(this.active=!1,this.hide()),this.oldElementValue=this.element.value},getToken:function(){var e=this.getTokenBounds();return this.element.value.substring(e[0],e[1]).strip()},getTokenBounds:function(){if(null!=this.tokenBounds)return this.tokenBounds;var e=this.element.value;if(e.strip().empty())return[-1,0];var t=arguments.callee.getFirstDifferencePos(e,this.oldElementValue),n=t==this.oldElementValue.length?1:0,r=-1,i=e.length,s;for(var o=0,u=this.options.tokens.length;o<u;++o)s=e.lastIndexOf(this.options.tokens[o],t+n-1),s>r&&(r=s),s=e.indexOf(this.options.tokens[o],t+n),-1!=s&&s<i&&(i=s)
;return this.tokenBounds=[r+1,i]}}),Autocompleter.Base.prototype.getTokenBounds.getFirstDifferencePos=function(e,t){var n=Math.min(e.length,t.length);for(var r=0;r<n;++r)if(e[r]!=t[r])return r;return n},Ajax.Autocompleter=Class.create(Autocompleter.Base,{initialize:function(e,t,n,r){this.baseInitialize(e,t,r),this.options.asynchronous=!0,this.options.onComplete=this.onComplete.bind(this),this.options.defaultParams=this.options.parameters||null,this.url=n},getUpdatedChoices:function(){this.startIndicator();var e=encodeURIComponent(this.options.paramName)+"="+encodeURIComponent(this.getToken());this.options.parameters=this.options.callback?this.options.callback(this.element,e):e,this.options.defaultParams&&(this.options.parameters+="&"+this.options.defaultParams),new Ajax.Request(this.url,this.options)},onComplete:function(e){this.updateChoices(e.responseText)}}),Autocompleter.Local=Class.create(Autocompleter.Base,{initialize:function(e,t,n,r){this.baseInitialize(e,t,r),this.options.array=n},getUpdatedChoices:function(){this.updateChoices(this.options.selector(this))},setOptions:function(e){this.options=Object.extend({choices:10,partialSearch:!0,partialChars:2,ignoreCase:!0,fullSearch:!1,selector:function(e){var t=[],n=[],r=e.getToken(),i=0;for(var s=0;s<e.options.array.length&&t.length<e.options.choices;s++){var o=e.options.array[s],u=e.options.ignoreCase?o.toLowerCase().indexOf(r.toLowerCase()):o.indexOf(r);while(u!=-1){if(u==0&&o.length!=r.length){t.push("<li><strong>"+o.substr(0,r.length)+"</strong>"+o.substr(r.length)+"</li>");break}if(r.length>=e.options.partialChars&&e.options.partialSearch&&u!=-1)if(e.options.fullSearch||/\s/.test(o.substr(u-1,1))){n.push("<li>"+o.substr(0,u)+"<strong>"+o.substr(u,r.length)+"</strong>"+o.substr(u+r.length)+"</li>");break}u=e.options.ignoreCase?o.toLowerCase().indexOf(r.toLowerCase(),u+1):o.indexOf(r,u+1)}}return n.length&&(t=t.concat(n.slice(0,e.options.choices-t.length))),"<ul>"+t.join("")+"</ul>"}},e||{})}}),Field.scrollFreeActivate=function(e){setTimeout(function(){Field.activate(e)},1)},Ajax.InPlaceEditor=Class.create({initialize:function(e,t,n){this.url=t,this.element=e=$(e),this.prepareOptions(),this._controls={},arguments.callee.dealWithDeprecatedOptions(n),Object.extend(this.options,n||{}),!this.options.formId&&this.element.id&&(this.options.formId=this.element.id+"-inplaceeditor",$(this.options.formId)&&(this.options.formId="")),this.options.externalControl&&(this.options.externalControl=$(this.options.externalControl)),this.options.externalControl||(this.options.externalControlOnly=!1),this._originalBackground=this.element.getStyle("background-color")||"transparent",this.element.title=this.options.clickToEditText,this._boundCancelHandler=this.handleFormCancellation.bind(this),this._boundComplete=(this.options.onComplete||Prototype.emptyFunction).bind(this),this._boundFailureHandler=this.handleAJAXFailure.bind(this),this._boundSubmitHandler=this.handleFormSubmission.bind(this),this._boundWrapperHandler=this.wrapUp.bind(this),this.registerListeners()},checkForEscapeOrReturn:function(e){if(!this._editing||e.ctrlKey||e.altKey||e.shiftKey)return;Event.KEY_ESC==e.keyCode?this.handleFormCancellation(e):Event.KEY_RETURN==e.keyCode&&this.handleFormSubmission(e)},createControl:function(e,t,n){var r=this.options[e+"Control"],i=this.options[e+"Text"];if("button"==r){var s=document.createElement("input");s.type="submit",s.value=i,s.className="editor_"+e+"_button","cancel"==e&&(s.onclick=this._boundCancelHandler),this._form.appendChild(s),this._controls[e]=s}else if("link"==r){var o=document.createElement("a");o.href="#",o.appendChild(document.createTextNode(i)),o.onclick="cancel"==e?this._boundCancelHandler:this._boundSubmitHandler,o.className="editor_"+e+"_link",n&&(o.className+=" "+n),this._form.appendChild(o),this._controls[e]=o}},createEditField:function(){var e=this.options.loadTextURL?this.options.loadingText:this.getText(),t;if(1>=this.options.rows&&!/\r|\n/.test(this.getText())){t=document.createElement("input"),t.type="text";var n=this.options.size||this.options.cols||0;0<n&&(t.size=n)}else t=document.createElement("textarea"),t.rows=1>=this.options.rows?this.options.autoRows:this.options.rows,t.cols=this.options.cols||40;t.name=this.options.paramName,t.value=e,t.className="editor_field",this.options.submitOnBlur&&(t.onblur=this._boundSubmitHandler),this._controls.editor=t,this.options.loadTextURL&&this.loadExternalText(),this._form.appendChild(this._controls.editor)},createForm:function(){function t(t,n){var r=e.options["text"+t+"Controls"];if(!r||n===!1)return;e._form.appendChild(document.createTextNode(r))}var e=this;this._form=$(document.createElement("form")),this._form.id=this.options.formId,this._form.addClassName(this.options.formClassName),this._form.onsubmit=this._boundSubmitHandler,this.createEditField(),"textarea"==this._controls.editor.tagName.toLowerCase()&&this._form.appendChild(document.createElement("br")),this.options.onFormCustomization&&this.options.onFormCustomization(this,this._form),t("Before",this.options.okControl||this.options.cancelControl),this.createControl("ok",this._boundSubmitHandler),t("Between",this.options.okControl&&this.options.cancelControl),this.createControl("cancel",this._boundCancelHandler,"editor_cancel"),t("After",this.options.okControl||this.options.cancelControl)},destroy:function(){this._oldInnerHTML&&(this.element.innerHTML=this._oldInnerHTML),this.leaveEditMode(),this.unregisterListeners()},enterEditMode:function(e){if(this._saving||this._editing)return;this._editing=!0,this.triggerCallback("onEnterEditMode"),this.options.externalControl&&this.options.externalControl.hide(),this.element.hide(),this.createForm(),this.element.parentNode.insertBefore(this._form,this.element),this.options.loadTextURL||this.postProcessEditField(),e&&Event.stop(e)},enterHover:function(e){this.options.hoverClassName&&this.element.addClassName(this.options.hoverClassName);if(this._saving)return;this.triggerCallback("onEnterHover")},getText:function(){return this.element.innerHTML.unescapeHTML()},handleAJAXFailure:function(e){this.triggerCallback("onFailure",e),this._oldInnerHTML&&(this.element.innerHTML=this._oldInnerHTML,this._oldInnerHTML=null)},handleFormCancellation:function(e){this.wrapUp(),e&&Event.stop(e)},handleFormSubmission:function(e){var t=this._form,n=$F(this._controls.editor);this.prepareSubmission();var r=this.options.callback(t,n)||"";Object.isString(r)&&(r=r.toQueryParams()),r.editorId=this.element.id;if(this.options.htmlResponse){var i=Object.extend({evalScripts:!0},this.options.ajaxOptions);Object.extend(i,{parameters:r,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler}),new Ajax.Updater({success:this.element},this.url,i)}else{var i=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(i,{parameters:r,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler}),new Ajax.Request(this.url,i)}e&&Event.stop(e)},leaveEditMode:function(){this.element.removeClassName(this.options.savingClassName),this.removeForm(),this.leaveHover(),this.element.style.backgroundColor=this._originalBackground,this.element.show(),this.options.externalControl&&this.options.externalControl.show(),this._saving=!1,this._editing=!1,this._oldInnerHTML=null,this.triggerCallback("onLeaveEditMode")},leaveHover:function(e){this.options.hoverClassName&&this.element.removeClassName(this.options.hoverClassName);if(this._saving)return;this.triggerCallback("onLeaveHover")},loadExternalText:function(){this._form.addClassName(this.options.loadingClassName),this._controls.editor.disabled=!0;var e=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(e,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(e){this._form.removeClassName(this.options.loadingClassName);var t=e.responseText;this.options.stripLoadedTextTags&&(t=t.stripTags()),this._controls.editor.value=t,this._controls.editor.disabled=!1,this.postProcessEditField()}.bind(this),onFailure:this._boundFailureHandler}),new Ajax.Request(this.options.loadTextURL,e)},postProcessEditField:function(){var e=this.options.fieldPostCreation;e&&$(this._controls.editor)["focus"==e?"focus":"activate"]()},prepareOptions:function(){this.options=Object.clone(Ajax.InPlaceEditor.DefaultOptions),Object.extend(this.options,Ajax.InPlaceEditor.DefaultCallbacks),[this._extraDefaultOptions].flatten().compact().each(function(e){Object.extend(this.options,e)}.bind(this))},prepareSubmission:function(){this._saving=!0,this.removeForm(),this.leaveHover(),this.showSaving()},registerListeners:function(){this._listeners={};var e;$H(Ajax.InPlaceEditor.Listeners).each(function(t){e=this[t.value].bind(this),this._listeners[t.key]=e,this.options.externalControlOnly||this.element.observe(t.key,e),this.options.externalControl&&this.options.externalControl.observe(t.key,e)}.bind(this))},removeForm:function(){if(!this._form)return;this._form.remove(),this._form=null,this._controls={}},showSaving:function(){this._oldInnerHTML=this.element.innerHTML,this.element.innerHTML=this.options.savingText,this.element.addClassName(this.options.savingClassName),this.element.style.backgroundColor=this._originalBackground,this.element.show()},triggerCallback:function(e,t){"function"==typeof this.options[e]&&this.options[e](this,t)},unregisterListeners:function(){$H(this._listeners).each(function(e){this.options.externalControlOnly||this.element.stopObserving(e.key,e.value),this.options.externalControl&&this.options.externalControl.stopObserving(e.key,e.value)}.bind(this))},wrapUp:function(e){this.leaveEditMode(),this._boundComplete(e,this.element)}}),Object.extend(Ajax.InPlaceEditor.prototype,{dispose:Ajax.InPlaceEditor.prototype.destroy}),Ajax.InPlaceCollectionEditor=Class.create(Ajax.InPlaceEditor,{initialize:function($super,e,t,n){this._extraDefaultOptions=Ajax.InPlaceCollectionEditor.DefaultOptions,$super(e,t,n)},createEditField:function(){var e=document.createElement("select");e.name=this.options.paramName,e.size=1,this._controls.editor=e,this._collection=this.options.collection||[],this.options.loadCollectionURL?this.loadCollection():this.checkForExternalText(),this._form.appendChild(this._controls.editor)},loadCollection:function(){this._form.addClassName(this.options.loadingClassName),this.showLoadingText(this.options.loadingCollectionText);var options=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(options,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(transport){var js=transport.responseText.strip();if(!/^\[.*\]$/.test(js))throw"Server returned an invalid collection representation.";this._collection=eval(js),this.checkForExternalText()}.bind(this),onFailure:this.onFailure}),new Ajax.Request(this.options.loadCollectionURL,options)},showLoadingText:function(e){this._controls.editor.disabled=!0;var t=this._controls.editor.firstChild;t||(t=document.createElement("option"),t.value="",this._controls.editor.appendChild(t),t.selected=!0),t.update((e||"").stripScripts().stripTags())},checkForExternalText:function(){this._text=this.getText(),this.options.loadTextURL?this.loadExternalText():this.buildOptionList()},loadExternalText:function(){this.showLoadingText(this.options.loadingText);var e=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(e,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(e){this._text=e.responseText.strip(),this.buildOptionList()}.bind(this),onFailure:this.onFailure}),new Ajax.Request(this.options.loadTextURL,e)},buildOptionList:function(){this._form.removeClassName(this.options.loadingClassName),this._collection=this._collection.map(function(e){return 2===e.length?e:[e,e].flatten()});var e="value"in this.options?this.options.value:this._text,t=this._collection.any(function(t){return t[0]==e}.bind(this));this._controls.editor.update("");var n;this._collection.each(function(r,i){n=document.createElement("option"),n.value=r[0],n.selected=t?r[0]==e:0==i,n.appendChild(document.createTextNode(r[1])),this._controls.editor.appendChild(n)}.bind(this)),this._controls.editor.disabled=!1,Field.scrollFreeActivate(this._controls.editor)}}),Ajax.InPlaceEditor.prototype.initialize.dealWithDeprecatedOptions=function(e){function t(t,n){if(t in e||n===undefined)return;e[t]=n}if(!e)return;t("cancelControl",e.cancelLink?"link":e.cancelButton?"button":e.cancelLink==e.cancelButton==0?!1:undefined),t("okControl",e.okLink?"link":e.okButton?"button":e.okLink==e.okButton==0?!1:undefined),t("highlightColor",e.highlightcolor),t("highlightEndColor",e.highlightendcolor)},Object.extend(Ajax.InPlaceEditor,{DefaultOptions:{ajaxOptions:{},autoRows:3,cancelControl:"link",cancelText:"cancel",clickToEditText:"Click to edit",externalControl:null,externalControlOnly:!1,fieldPostCreation:"activate",formClassName:"inplaceeditor-form",formId:null,highlightColor:"#ffff99",highlightEndColor:"#ffffff",hoverClassName:"",htmlResponse:!0,loadingClassName:"inplaceeditor-loading",loadingText:"Loading...",okControl:"button",okText:"ok",paramName:"value",rows:1,savingClassName:"inplaceeditor-saving",savingText:"Saving...",size:0,stripLoadedTextTags:!1,submitOnBlur:!1,textAfterControls:"",textBeforeControls:"",textBetweenControls:""},DefaultCallbacks:{callback:function(e){return Form.serialize(e)},onComplete:function(e,t){new Effect.Highlight(t,{startcolor:this.options.highlightColor,keepBackgroundImage:!0})},onEnterEditMode:null,onEnterHover:function(e){e.element.style.backgroundColor=e.options.highlightColor,e._effect&&e._effect.cancel()},onFailure:function(e,t){alert("Error communication with the server: "+e.responseText.stripTags())},onFormCustomization:null,onLeaveEditMode:null,onLeaveHover:function(e){e._effect=new Effect.Highlight(e.element,{startcolor:e.options.highlightColor,endcolor:e.options.highlightEndColor,restorecolor:e._originalBackground,keepBackgroundImage:!0})}},Listeners:{click:"enterEditMode",keydown:"checkForEscapeOrReturn",mouseover:"enterHover",mouseout:"leaveHover"}}),Ajax.InPlaceCollectionEditor.DefaultOptions={loadingCollectionText:"Loading options..."},Form.Element.DelayedObserver=Class.create({initialize:function(e,t,n){this.delay=t||.5,this.element=$(e),this.callback=n,this.timer=null,this.lastValue=$F(this.element),Event.observe(this.element,"keyup",this.delayedListener.bindAsEventListener(this))},delayedListener:function(e){if(this.lastValue==$F(this.element))return;this.timer&&clearTimeout(this.timer),this.timer=setTimeout(this.onTimerEvent.bind(this),this.delay*1e3),this.lastValue=$F(this.element)},onTimerEvent:function(){this.timer=null,this.callback(this.element,$F(this.element))}});if(Object.isUndefined(Effect))throw"dragdrop.js requires including script.aculo.us' effects.js library";var Droppables={drops:[],remove:function(e){this.drops=this.drops.reject(function(t){return t.element==$(e)})},add:function(e){e=$(e);var t=Object.extend({greedy:!0,hoverclass:null,tree:!1},arguments[1]||{});if(t.containment){t._containers=[];var n=t.containment;Object.isArray(n)?n.each(function(e){t._containers.push($(e))}):t._containers.push($(n))}t.accept&&(t.accept=[t.accept].flatten()),Element.makePositioned(e),t.element=e,this.drops.push(t)},findDeepestChild:function(e){deepest=e[0];for(i=1;i<e.length;++i)Element.isParent(e[i].element,deepest.element)&&(deepest=e[i]);return deepest},isContained:function(e,t){var n;return t.tree?n=e.treeNode:n=e.parentNode,t._containers.detect(function(e){return n==e})},isAffected:function(e,t,n){return n.element!=t&&(!n._containers||this.isContained(t,n))&&(!n.accept||Element.classNames(t).detect(function(e){return n.accept.include(e)}))&&Position.within(n.element,e[0],e[1])},deactivate:function(e){e.hoverclass&&Element.removeClassName(e.element,e.hoverclass),this.last_active=null},activate:function(e){e.hoverclass&&Element.addClassName(e.element,e.hoverclass),this.last_active=e},show:function(e,t){if(!this.drops.length)return;var n,r=[];this.drops.each(function(n){Droppables.isAffected(e,t,n)&&r.push(n)}),r.length>0&&(n=Droppables.findDeepestChild(r)),this.last_active&&this.last_active!=n&&this.deactivate(this.last_active),n&&(Position.within(n.element,e[0],e[1]),n.onHover&&n.onHover(t,n.element,Position.overlap(n.overlap,n.element)),n!=this.last_active&&Droppables.activate(n))},fire:function(e,t){if(!this.last_active)return;Position.prepare();if(this.isAffected([Event.pointerX(e),Event.pointerY(e)],t,this.last_active)&&this.last_active.onDrop)return this.last_active.onDrop(t,this.last_active.element,e),!0},reset:function(){this.last_active&&this.deactivate(this.last_active)}},Draggables={drags:[],observers:[],register:function(e){this.drags.length==0&&(this.eventMouseUp=this.endDrag.bindAsEventListener(this),this.eventMouseMove=this.updateDrag.bindAsEventListener(this),this.eventKeypress=this.keyPress.bindAsEventListener(this),Event.observe(document,"mouseup",this.eventMouseUp),Event.observe(document,"mousemove",this.eventMouseMove),Event.observe(document,"keypress",this.eventKeypress)),this.drags.push(e)},unregister:function(e){this.drags=this.drags.reject(function(t){return t==e}),this.drags.length==0&&(Event.stopObserving(document,"mouseup",this.eventMouseUp),Event.stopObserving(document,"mousemove",this.eventMouseMove),Event.stopObserving(document,"keypress",this.eventKeypress))},activate:function(e){e.options.delay?this._timeout=setTimeout(function(){Draggables._timeout=null,window.focus(),Draggables.activeDraggable=e}.bind(this),e.options.delay):(window.focus(),this.activeDraggable=e)},deactivate:function(){this.activeDraggable=null},updateDrag:function(e){if(!this.activeDraggable)return;var t=[Event.pointerX(e),Event.pointerY(e)];if(this._lastPointer&&this._lastPointer.inspect()==t.inspect())return;this._lastPointer=t,this.activeDraggable.updateDrag(e,t)},endDrag:function(e){this._timeout&&(clearTimeout(this._timeout),this._timeout=null);if(!this.activeDraggable)return;this._lastPointer=null,this.activeDraggable.endDrag(e),this.activeDraggable=null},keyPress:function(e){this.activeDraggable&&this.activeDraggable.keyPress(e)},addObserver:function(e){this.observers.push(e),this._cacheObserverCallbacks()},removeObserver:function(e){this.observers=this.observers.reject(function(t){return t.element==e}),this._cacheObserverCallbacks()},notify:function(e,t,n){this[e+"Count"]>0&&this.observers.each(function(r){r[e]&&r[e](e,t,n)}),t.options[e]&&t.options[e](t,n)},_cacheObserverCallbacks:function(){["onStart","onEnd","onDrag"].each(function(e){Draggables[e+"Count"]=Draggables.observers.select(function(t){return t[e]}).length})}},Draggable=Class.create({initialize:function(e){var t={handle:!1,reverteffect:function(e,t,n){var r=Math.sqrt(Math.abs(t^2)+Math.abs(n^2))*.02;new Effect.Move(e,{x:-n,y:-t,duration:r,queue:{scope:"_draggable",position:"end"}})},endeffect:function(e){var t=Object.isNumber(e._opacity)?e._opacity:1;new Effect.Opacity(e,{duration:.2,from:.7,to:t,queue:{scope:"_draggable",position:"end"},afterFinish:function(){Draggable._dragging[e]=!1}})},zindex:1e3,revert:!1,quiet:!1,scroll:!1,scrollSensitivity:20,scrollSpeed:15,snap:!1,delay:0};(!arguments[1]||Object.isUndefined(arguments[1].endeffect))&&Object.extend(t,{starteffect:function(e){e._opacity=Element.getOpacity(e),Draggable._dragging[e]=!0,new Effect.Opacity(e,{duration:.2,from:e._opacity,to:.7})}});var n=Object.extend(t,arguments[1]||{});this.element=$(e),n.handle&&Object.isString(n.handle)&&(this.handle=this.element.down("."+n.handle,0)),this.handle||(this.handle=$(n.handle)),this.handle||(this.handle=this.element),n.scroll&&!n.scroll.scrollTo&&!n.scroll.outerHTML&&(n.scroll=$(n.scroll),this._isScrollChild=Element.childOf(this.element,n.scroll)),Element.makePositioned(this.element),this.options=n,this.dragging=!1,this.eventMouseDown=this.initDrag.bindAsEventListener(this),Event.observe(this.handle,"mousedown",this.eventMouseDown),Draggables.register(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown),Draggables.unregister(this)},currentDelta:function(){return[parseInt(Element.getStyle(this.element,"left")||"0"),parseInt(Element.getStyle(this.element,"top")||"0")]},initDrag:function(e){if(!Object.isUndefined(Draggable._dragging[this.element])&&Draggable._dragging[this.element])return;if(Event.isLeftClick(e)){var t=Event.element(e);if(!(!(tag_name=t.tagName.toUpperCase())||tag_name!="INPUT"&&tag_name!="SELECT"&&tag_name!="OPTION"&&tag_name!="BUTTON"&&tag_name!="TEXTAREA"))return;var n=[Event.pointerX(e),Event.pointerY(e)],r=this.element.cumulativeOffset();this.offset=[0,1].map(function(e){return n[e]-r[e]}),Draggables.activate(this),Event.stop(e)}},startDrag:function(e){this.dragging=!0,this.delta||(this.delta=this.currentDelta()),this.options.zindex&&(this.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0),this.element.style.zIndex=this.options.zindex),this.options.ghosting&&(this._clone=this.element.cloneNode(!0),this._originallyAbsolute=this.element.getStyle("position")=="absolute",this._originallyAbsolute||Position.absolutize(this.element),this.element.parentNode.insertBefore(this._clone,this.element));if(this.options.scroll)if(this.options.scroll==window){var t=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=t.left,this.originalScrollTop=t.top}else this.originalScrollLeft=this.options.scroll.scrollLeft,this.originalScrollTop=this.options.scroll.scrollTop;Draggables.notify("onStart",this,e),this.options.starteffect&&this.options.starteffect(this.element)},updateDrag:function(event,pointer){this.dragging||this.startDrag(event),this.options.quiet||(Position.prepare(),Droppables.show(pointer,this.element)),Draggables.notify("onDrag",this,event),this.draw(pointer),this.options.change&&this.options.change(this);if(this.options.scroll){this.stopScrolling();var p;if(this.options.scroll==window)with(this._getWindowScroll(this.options.scroll))p=[left,top,left+width,top+height];else p=Position.page(this.options.scroll).toArray(),p[0]+=this.options.scroll.scrollLeft+Position.deltaX,p[1]+=this.options.scroll.scrollTop+Position.deltaY,p.push(p[0]+this.options.scroll.offsetWidth),p.push(p[1]+this.options.scroll.offsetHeight);var speed=[0,0];pointer[0]<p[0]+this.options.scrollSensitivity&&(speed[0]=pointer[0]-(p[0]+this.options.scrollSensitivity)),pointer[1]<p[1]+this.options.scrollSensitivity&&(speed[1]=pointer[1]-(p[1]+this.options.scrollSensitivity)),pointer[0]>p[2]-this.options.scrollSensitivity&&(speed[0]=pointer[0]-(p[2]-this.options.scrollSensitivity)),pointer[1]>p[3]-this.options.scrollSensitivity&&(speed[1]=pointer[1]-(p[3]-this.options.scrollSensitivity)),this.startScrolling(speed)}Prototype.Browser.WebKit&&window.scrollBy(0,0),Event.stop(event)},finishDrag:function(e,t){this.dragging=!1;if(this.options.quiet){Position.prepare();var n=[Event.pointerX(e),Event.pointerY(e)];Droppables.show(n,this.element)}this.options.ghosting&&(this._originallyAbsolute||Position.relativize(this.element),delete this._originallyAbsolute,Element.remove(this._clone),this._clone=null);var r=!1;t&&(r=Droppables.fire(e,this.element),r||(r=!1)),r&&this.options.onDropped&&this.options.onDropped(this.element),Draggables.notify("onEnd",this,e);var i=this.options.revert;i&&Object.isFunction(i)&&(i=i(this.element));var s=this.currentDelta();i&&this.options.reverteffect?(r==0||i!="failure")&&this.options.reverteffect(this.element,s[1]-this.delta[1],s[0]-this.delta[0]):this.delta=s,this.options.zindex&&(this.element.style.zIndex=this.originalZ),this.options.endeffect&&this.options.endeffect(this.element),Draggables.deactivate(this),Droppables.reset()},keyPress:function(e){if(e.keyCode!=Event.KEY_ESC)return;this.finishDrag(e,!1),Event.stop(e)},endDrag:function(e){if(!this.dragging)return;this.stopScrolling(),this.finishDrag(e,!0),Event.stop(e)},draw:function(e){var t=this.element.cumulativeOffset();if(this.options.ghosting){var n=Position.realOffset(this.element);t[0]+=n[0]-Position.deltaX,t[1]+=n[1]-Position.deltaY}var r=this.currentDelta();t[0]-=r[0],t[1]-=r[1],this.options.scroll&&this.options.scroll!=window&&this._isScrollChild&&(t[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft,t[1]-=this.options.scroll.scrollTop-this.originalScrollTop);var i=[0,1].map(function(n){return e[n]-t[n]-this.offset[n]}.bind(this));this.options.snap&&(Object.isFunction(this.options.snap)?i=this.options.snap(i[0],i[1],this):Object.isArray(this.options.snap)?i=i.map(function(e,t){return(e/this.options.snap[t]).round()*this.options.snap[t]}.bind(this)):i=i.map(function(e){return(e/this.options.snap).round()*this.options.snap}.bind(this)));var s=this.element.style;if(!this.options.constraint||this.options.constraint=="horizontal")s.left=i[0]+"px";if(!this.options.constraint||this.options.constraint=="vertical")s.top=i[1]+"px";s.visibility=="hidden"&&(s.visibility="")},stopScrolling:function(){this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null,Draggables._lastScrollPointer=null)},startScrolling:function(e){if(!e[0]&&!e[1])return;this.scrollSpeed=[e[0]*this.options.scrollSpeed,e[1]*this.options.scrollSpeed],this.lastScrolled=new Date,this.scrollInterval=setInterval(this.scroll.bind(this),10)},scroll:function(){var current=new Date,delta=current-this.lastScrolled;this.lastScrolled=current;if(this.options.scroll==window)with(this._getWindowScroll(this.options.scroll))if(this.scrollSpeed[0]||this.scrollSpeed[1]){var d=delta/1e3;this.options.scroll.scrollTo(left+d*this.scrollSpeed[0],top+d*this.scrollSpeed[1])}else this.options.scroll.scrollLeft+=this.scrollSpeed[0]*delta/1e3,this.options.scroll.scrollTop+=this.scrollSpeed[1]*delta/1e3;Position.prepare(),Droppables.show(Draggables._lastPointer,this.element),Draggables.notify("onDrag",this),this._isScrollChild&&(Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer),Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*delta/1e3,Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*delta/1e3,Draggables._lastScrollPointer[0]<0&&(Draggables._lastScrollPointer[0]=0),Draggables._lastScrollPointer[1]<0&&(Draggables._lastScrollPointer[1]=0),this.draw(Draggables._lastScrollPointer)),this.options.change&&this.options.change(this)},_getWindowScroll:function(w){var T,L,W,H;with(w.document)w.document.documentElement&&documentElement.scrollTop?(T=documentElement.scrollTop,L=documentElement.scrollLeft):w.document.body&&(T=body.scrollTop,L=body.scrollLeft),w.innerWidth?(W=w.innerWidth,H=w.innerHeight):w.document.documentElement&&documentElement.clientWidth?(W=documentElement.clientWidth,H=documentElement.clientHeight):(W=body.offsetWidth,H=body.offsetHeight);return{top:T,left:L,width:W,height:H}}});Draggable._dragging={};var SortableObserver=Class.create({initialize:function(e,t){this.element=$(e),this.observer=t,this.lastValue=Sortable.serialize(this.element)},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark(),this.lastValue!=Sortable.serialize(this.element)&&this.observer(this.element)}}),Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,sortables:{},_findRootElement:function(e){while(e.tagName.toUpperCase()!="BODY"){if(e.id&&Sortable.sortables[e.id])return e;e=e.parentNode}},options:function(e){e=Sortable._findRootElement($(e));if(!e)return;return Sortable.sortables[e.id]},destroy:function(e){e=$(e);var t=Sortable.sortables[e.id];t&&(Draggables.removeObserver(t.element),t.droppables.each(function(e){Droppables.remove(e)}),t.draggables.invoke("destroy"),delete Sortable.sortables[t.element.id])},create:function(e){e=$(e);var t=Object.extend({element:e,tag:"li",dropOnEmpty:!1,tree:!1,treeTag:"ul",overlap:"vertical",constraint:"vertical",containment:e,handle:!1,only:!1,delay:0,hoverclass:null,ghosting:!1,quiet:!1,scroll:!1,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,elements:!1,handles:!1,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(e);var n={revert:!0,quiet:t.quiet,scroll:t.scroll,scrollSpeed:t.scrollSpeed,scrollSensitivity:t.scrollSensitivity,delay:t.delay,ghosting:t.ghosting,constraint:t.constraint,handle:t.handle};t.starteffect&&(n.starteffect=t.starteffect),t.reverteffect?n.reverteffect=t.reverteffect:t.ghosting&&(n.reverteffect=function(e){e.style.top=0,e.style.left=0}),t.endeffect&&(n.endeffect=t.endeffect),t.zindex&&(n.zindex=t.zindex);var r={overlap:t.overlap,containment:t.containment,tree:t.tree,hoverclass:t.hoverclass,onHover:Sortable.onHover},i={onHover:Sortable.onEmptyHover,overlap:t.overlap,containment:t.containment,hoverclass:t.hoverclass};Element.cleanWhitespace(e),t.draggables=[],t.droppables=[];if(t.dropOnEmpty||t.tree)Droppables.add(e,i),t.droppables.push(e);(t.elements||this.findElements(e,t)||[]).each(function(i,s){var o=t.handles?$(t.handles[s]):t.handle?$(i).select("."+t.handle)[0]:i;t.draggables.push(new Draggable(i,Object.extend(n,{handle:o}))),Droppables.add(i,r),t.tree&&(i.treeNode=e),t.droppables.push(i)}),t.tree&&(Sortable.findTreeElements(e,t)||[]).each(function(n){Droppables.add(n,i),n.treeNode=e,t.droppables.push(n)}),this.sortables[e.identify()]=t,Draggables.addObserver(new SortableObserver(e,t.onUpdate))},findElements:function(e,t){return Element.findChildren(e,t.only,t.tree?!0:!1,t.tag)},findTreeElements:function(e,t){return Element.findChildren(e,t.only,t.tree?!0:!1,t.treeTag)},onHover:function(e,t,n){if(Element.isParent(t,e))return;if(n>.33&&n<.66&&Sortable.options(t).tree)return;if(n>.5){Sortable.mark(t,"before");if(t.previousSibling!=e){var r=e.parentNode;e.style.visibility="hidden",t.parentNode.insertBefore(e,t),t.parentNode!=r&&Sortable.options(r).onChange(e),Sortable.options(t.parentNode).onChange(e)}}else{Sortable.mark(t,"after");var i=t.nextSibling||null;if(i!=e){var r=e.parentNode;e.style.visibility="hidden",t.parentNode.insertBefore(e,i),t.parentNode!=r&&Sortable.options(r).onChange(e),Sortable.options(t.parentNode).onChange(e)}}},onEmptyHover:function(e,t,n){var r=e.parentNode,i=Sortable.options(t);if(!Element.isParent(t,e)){var s,o=Sortable.findElements(t,{tag:i.tag,only:i.only}),u=null;if(o){var a=Element.offsetSize(t,i.overlap)*(1-n);for(s=0;s<o.length;s+=1){if(!(a-Element.offsetSize(o[s],i.overlap)>=0)){if(a-Element.offsetSize(o[s],i.overlap)/2>=0){u=s+1<o.length?o[s+1]:null;break}u=o[s];break}a-=Element.offsetSize(o[s],i.overlap)}}t.insertBefore(e,u),Sortable.options(r).onChange(e),i.onChange(e)}},unmark:function(){Sortable._marker&&Sortable._marker.hide()},mark:function(e,t){var n=Sortable.options(e.parentNode);if(n&&!n.ghosting)return;Sortable._marker||(Sortable._marker=($("dropmarker")||Element.extend(document.createElement("DIV"))).hide().addClassName("dropmarker").setStyle({position:"absolute"}),document.getElementsByTagName("body").item(0).appendChild(Sortable._marker));var r=e.cumulativeOffset();Sortable._marker.setStyle({left:r[0]+"px",top:r[1]+"px"}),t=="after"&&(n.overlap=="horizontal"?Sortable._marker.setStyle({left:r[0]+e.clientWidth+"px"}):Sortable._marker.setStyle({top:r[1]+e.clientHeight+"px"})),Sortable._marker.show()},_tree:function(e,t,n){var r=Sortable.findElements(e,t)||[];for(var i=0;i<r.length;++i){var s=r[i].id.match(t.format);if(!s)continue;var o={id:encodeURIComponent(s?s[1]:null),element:e,parent:n,children:[],position:n.children.length,container:$(r[i]).down(t.treeTag)};o.container&&this._tree(o.container,t,o),n.children.push(o)}return n},tree:function(e){e=$(e);var t=this.options(e),n=Object.extend({tag:t.tag,treeTag:t.treeTag,only:t.only,name:e.id,format:t.format},arguments[1]||{}),r={id:null,parent:null,children:[],container:e,position:0};return Sortable._tree(e,n,r)},_constructIndex:function(e){var t="";do e.id&&(t="["+e.position+"]"+t);while((e=e.parent)!=null);return t},sequence:function(e){e=$(e);var t=Object.extend(this.options(e),arguments[1]||{});return $(this.findElements(e,t)||[]).map(function(e){return e.id.match(t.format)?e.id.match(t.format)[1]:""})},setSequence:function(e,t){e=$(e);var n=Object.extend(this.options(e),arguments[2]||{}),r={};this.findElements(e,n).each(function(e){e.id.match(n.format)&&(r[e.id.match(n.format)[1]]=[e,e.parentNode]),e.parentNode.removeChild(e)}),t.each(function(e){var t=r[e];t&&(t[1].appendChild(t[0]),delete r[e])})},serialize:function(e){e=$(e);var t=Object.extend(Sortable.options(e),arguments[1]||{}),n=encodeURIComponent(arguments[1]&&arguments[1].name?arguments[1].name:e.id);return t.tree?Sortable.tree(e,arguments[1]).children.map(function(e){return[n+Sortable._constructIndex(e)+"[id]="+encodeURIComponent(e.id)].concat(e.children
.map(arguments.callee))}).flatten().join("&"):Sortable.sequence(e,arguments[1]).map(function(e){return n+"[]="+encodeURIComponent(e)}).join("&")}};Element.isParent=function(e,t){return!e.parentNode||e==t?!1:e.parentNode==t?!0:Element.isParent(e.parentNode,t)},Element.findChildren=function(e,t,n,r){if(!e.hasChildNodes())return null;r=r.toUpperCase(),t&&(t=[t].flatten());var i=[];return $A(e.childNodes).each(function(e){e.tagName&&e.tagName.toUpperCase()==r&&(!t||Element.classNames(e).detect(function(e){return t.include(e)}))&&i.push(e);if(n){var s=Element.findChildren(e,t,n,r);s&&i.push(s)}}),i.length>0?i.flatten():[]},Element.offsetSize=function(e,t){return e["offset"+(t=="vertical"||t=="height"?"Height":"Width")]};if(!Control)var Control={};Control.Slider=Class.create({initialize:function(e,t,n){var r=this;Object.isArray(e)?this.handles=e.collect(function(e){return $(e)}):this.handles=[$(e)],this.track=$(t),this.options=n||{},this.axis=this.options.axis||"horizontal",this.increment=this.options.increment||1,this.step=parseInt(this.options.step||"1"),this.range=this.options.range||$R(0,1),this.value=0,this.values=this.handles.map(function(){return 0}),this.spans=this.options.spans?this.options.spans.map(function(e){return $(e)}):!1,this.options.startSpan=$(this.options.startSpan||null),this.options.endSpan=$(this.options.endSpan||null),this.restricted=this.options.restricted||!1,this.maximum=this.options.maximum||this.range.end,this.minimum=this.options.minimum||this.range.start,this.alignX=parseInt(this.options.alignX||"0"),this.alignY=parseInt(this.options.alignY||"0"),this.trackLength=this.maximumOffset()-this.minimumOffset(),this.handleLength=this.isVertical()?this.handles[0].offsetHeight!=0?this.handles[0].offsetHeight:this.handles[0].style.height.replace(/px$/,""):this.handles[0].offsetWidth!=0?this.handles[0].offsetWidth:this.handles[0].style.width.replace(/px$/,""),this.active=!1,this.dragging=!1,this.disabled=!1,this.options.disabled&&this.setDisabled(),this.allowedValues=this.options.values?this.options.values.sortBy(Prototype.K):!1,this.allowedValues&&(this.minimum=this.allowedValues.min(),this.maximum=this.allowedValues.max()),this.eventMouseDown=this.startDrag.bindAsEventListener(this),this.eventMouseUp=this.endDrag.bindAsEventListener(this),this.eventMouseMove=this.update.bindAsEventListener(this),this.handles.each(function(e,t){t=r.handles.length-1-t,r.setValue(parseFloat((Object.isArray(r.options.sliderValue)?r.options.sliderValue[t]:r.options.sliderValue)||r.range.start),t),e.makePositioned().observe("mousedown",r.eventMouseDown)}),this.track.observe("mousedown",this.eventMouseDown),document.observe("mouseup",this.eventMouseUp),document.observe("mousemove",this.eventMouseMove),this.initialized=!0},dispose:function(){var e=this;Event.stopObserving(this.track,"mousedown",this.eventMouseDown),Event.stopObserving(document,"mouseup",this.eventMouseUp),Event.stopObserving(document,"mousemove",this.eventMouseMove),this.handles.each(function(t){Event.stopObserving(t,"mousedown",e.eventMouseDown)})},setDisabled:function(){this.disabled=!0},setEnabled:function(){this.disabled=!1},getNearestValue:function(e){if(this.allowedValues){if(e>=this.allowedValues.max())return this.allowedValues.max();if(e<=this.allowedValues.min())return this.allowedValues.min();var t=Math.abs(this.allowedValues[0]-e),n=this.allowedValues[0];return this.allowedValues.each(function(r){var i=Math.abs(r-e);i<=t&&(n=r,t=i)}),n}return e>this.range.end?this.range.end:e<this.range.start?this.range.start:e},setValue:function(e,t){this.active||(this.activeHandleIdx=t||0,this.activeHandle=this.handles[this.activeHandleIdx],this.updateStyles()),t=t||this.activeHandleIdx||0,this.initialized&&this.restricted&&(t>0&&e<this.values[t-1]&&(e=this.values[t-1]),t<this.handles.length-1&&e>this.values[t+1]&&(e=this.values[t+1])),e=this.getNearestValue(e),this.values[t]=e,this.value=this.values[0],this.handles[t].style[this.isVertical()?"top":"left"]=this.translateToPx(e),this.drawSpans(),(!this.dragging||!this.event)&&this.updateFinished()},setValueBy:function(e,t){this.setValue(this.values[t||this.activeHandleIdx||0]+e,t||this.activeHandleIdx||0)},translateToPx:function(e){return Math.round((this.trackLength-this.handleLength)/(this.range.end-this.range.start)*(e-this.range.start))+"px"},translateToValue:function(e){return e/(this.trackLength-this.handleLength)*(this.range.end-this.range.start)+this.range.start},getRange:function(e){var t=this.values.sortBy(Prototype.K);return e=e||0,$R(t[e],t[e+1])},minimumOffset:function(){return this.isVertical()?this.alignY:this.alignX},maximumOffset:function(){return this.isVertical()?(this.track.offsetHeight!=0?this.track.offsetHeight:this.track.style.height.replace(/px$/,""))-this.alignY:(this.track.offsetWidth!=0?this.track.offsetWidth:this.track.style.width.replace(/px$/,""))-this.alignX},isVertical:function(){return this.axis=="vertical"},drawSpans:function(){var e=this;this.spans&&$R(0,this.spans.length-1).each(function(t){e.setSpan(e.spans[t],e.getRange(t))}),this.options.startSpan&&this.setSpan(this.options.startSpan,$R(0,this.values.length>1?this.getRange(0).min():this.value)),this.options.endSpan&&this.setSpan(this.options.endSpan,$R(this.values.length>1?this.getRange(this.spans.length-1).max():this.value,this.maximum))},setSpan:function(e,t){this.isVertical()?(e.style.top=this.translateToPx(t.start),e.style.height=this.translateToPx(t.end-t.start+this.range.start)):(e.style.left=this.translateToPx(t.start),e.style.width=this.translateToPx(t.end-t.start+this.range.start))},updateStyles:function(){this.handles.each(function(e){Element.removeClassName(e,"selected")}),Element.addClassName(this.activeHandle,"selected")},startDrag:function(e){if(Event.isLeftClick(e)){if(!this.disabled){this.active=!0;var t=Event.element(e),n=[Event.pointerX(e),Event.pointerY(e)],r=t;if(r==this.track){var i=this.track.cumulativeOffset();this.event=e,this.setValue(this.translateToValue((this.isVertical()?n[1]-i[1]:n[0]-i[0])-this.handleLength/2));var i=this.activeHandle.cumulativeOffset();this.offsetX=n[0]-i[0],this.offsetY=n[1]-i[1]}else{while(this.handles.indexOf(t)==-1&&t.parentNode)t=t.parentNode;if(this.handles.indexOf(t)!=-1){this.activeHandle=t,this.activeHandleIdx=this.handles.indexOf(this.activeHandle),this.updateStyles();var i=this.activeHandle.cumulativeOffset();this.offsetX=n[0]-i[0],this.offsetY=n[1]-i[1]}}}Event.stop(e)}},update:function(e){this.active&&(this.dragging||(this.dragging=!0),this.draw(e),Prototype.Browser.WebKit&&window.scrollBy(0,0),Event.stop(e))},draw:function(e){var t=[Event.pointerX(e),Event.pointerY(e)],n=this.track.cumulativeOffset();t[0]-=this.offsetX+n[0],t[1]-=this.offsetY+n[1],this.event=e,this.setValue(this.translateToValue(this.isVertical()?t[1]:t[0])),this.initialized&&this.options.onSlide&&this.options.onSlide(this.values.length>1?this.values:this.value,this)},endDrag:function(e){this.active&&this.dragging&&(this.finishDrag(e,!0),Event.stop(e)),this.active=!1,this.dragging=!1},finishDrag:function(e,t){this.active=!1,this.dragging=!1,this.updateFinished()},updateFinished:function(){this.initialized&&this.options.onChange&&this.options.onChange(this.values.length>1?this.values:this.value,this),this.event=null}}),Sound={tracks:{},_enabled:!0,template:new Template('<embed style="height:0" id="sound_#{track}_#{id}" src="#{url}" loop="false" autostart="true" hidden="true"/>'),enable:function(){Sound._enabled=!0},disable:function(){Sound._enabled=!1},play:function(e){if(!Sound._enabled)return;var t=Object.extend({track:"global",url:e,replace:!1},arguments[1]||{});t.replace&&this.tracks[t.track]&&($R(0,this.tracks[t.track].id).each(function(e){var n=$("sound_"+t.track+"_"+e);n.Stop&&n.Stop(),n.remove()}),this.tracks[t.track]=null),this.tracks[t.track]?this.tracks[t.track].id++:this.tracks[t.track]={id:0},t.id=this.tracks[t.track].id,$$("body")[0].insert(Prototype.Browser.IE?new Element("bgsound",{id:"sound_"+t.track+"_"+t.id,src:t.url,loop:1,autostart:!0}):Sound.template.evaluate(t))}},Prototype.Browser.Gecko&&navigator.userAgent.indexOf("Win")>0&&(navigator.plugins&&$A(navigator.plugins).detect(function(e){return e.name.indexOf("QuickTime")!=-1})?Sound.template=new Template('<object id="sound_#{track}_#{id}" width="0" height="0" type="audio/mpeg" data="#{url}"/>'):navigator.plugins&&$A(navigator.plugins).detect(function(e){return e.name.indexOf("Windows Media")!=-1})?Sound.template=new Template('<object id="sound_#{track}_#{id}" type="application/x-mplayer2" data="#{url}"></object>'):navigator.plugins&&$A(navigator.plugins).detect(function(e){return e.name.indexOf("RealPlayer")!=-1})?Sound.template=new Template('<embed type="audio/x-pn-realaudio-plugin" style="height:0" id="sound_#{track}_#{id}" src="#{url}" loop="false" autostart="true" hidden="true"/>'):Sound.play=function(){}),Event.simulateMouse=function(e,t){var n=Object.extend({pointerX:0,pointerY:0,buttons:0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1},arguments[2]||{}),r=document.createEvent("MouseEvents");r.initMouseEvent(t,!0,!0,document.defaultView,n.buttons,n.pointerX,n.pointerY,n.pointerX,n.pointerY,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,0,$(e)),this.mark&&Element.remove(this.mark),this.mark=document.createElement("div"),this.mark.appendChild(document.createTextNode(" ")),document.body.appendChild(this.mark),this.mark.style.position="absolute",this.mark.style.top=n.pointerY+"px",this.mark.style.left=n.pointerX+"px",this.mark.style.width="5px",this.mark.style.height="5px;",this.mark.style.borderTop="1px solid red;",this.mark.style.borderLeft="1px solid red;",this.step&&alert("["+(new Date).getTime().toString()+"] "+t+"/"+Test.Unit.inspect(n)),$(e).dispatchEvent(r)},Event.simulateKey=function(e,t){var n=Object.extend({ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:0,charCode:0},arguments[2]||{}),r=document.createEvent("KeyEvents");r.initKeyEvent(t,!0,!0,window,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.keyCode,n.charCode),$(e).dispatchEvent(r)},Event.simulateKeys=function(e,t){for(var n=0;n<t.length;n++)Event.simulateKey(e,"keypress",{charCode:t.charCodeAt(n)})};var Test={};Test.Unit={},Test.Unit.inspect=Object.inspect,Test.Unit.Logger=Class.create(),Test.Unit.Logger.prototype={initialize:function(e){this.log=$(e),this.log&&this._createLogTable()},start:function(e){if(!this.log)return;this.testName=e,this.lastLogLine=document.createElement("tr"),this.statusCell=document.createElement("td"),this.nameCell=document.createElement("td"),this.nameCell.className="nameCell",this.nameCell.appendChild(document.createTextNode(e)),this.messageCell=document.createElement("td"),this.lastLogLine.appendChild(this.statusCell),this.lastLogLine.appendChild(this.nameCell),this.lastLogLine.appendChild(this.messageCell),this.loglines.appendChild(this.lastLogLine)},finish:function(e,t){if(!this.log)return;this.lastLogLine.className=e,this.statusCell.innerHTML=e,this.messageCell.innerHTML=this._toHTML(t),this.addLinksToResults()},message:function(e){if(!this.log)return;this.messageCell.innerHTML=this._toHTML(e)},summary:function(e){if(!this.log)return;this.logsummary.innerHTML=this._toHTML(e)},_createLogTable:function(){this.log.innerHTML='<div id="logsummary"></div><table id="logtable"><thead><tr><th>Status</th><th>Test</th><th>Message</th></tr></thead><tbody id="loglines"></tbody></table>',this.logsummary=$("logsummary"),this.loglines=$("loglines")},_toHTML:function(e){return e.escapeHTML().replace(/\n/g,"<br/>")},addLinksToResults:function(){$$("tr.failed .nameCell").each(function(e){e.title="Run only this test",Event.observe(e,"click",function(){window.location.search="?tests="+e.innerHTML})}),$$("tr.passed .nameCell").each(function(e){e.title="Run all tests",Event.observe(e,"click",function(){window.location.search=""})})}},Test.Unit.Runner=Class.create(),Test.Unit.Runner.prototype={initialize:function(e){this.options=Object.extend({testLog:"testlog"},arguments[1]||{}),this.options.resultsURL=this.parseResultsURLQueryParameter(),this.options.tests=this.parseTestsQueryParameter(),this.options.testLog&&(this.options.testLog=$(this.options.testLog)||null);if(this.options.tests){this.tests=[];for(var t=0;t<this.options.tests.length;t++)/^test/.test(this.options.tests[t])&&this.tests.push(new Test.Unit.Testcase(this.options.tests[t],e[this.options.tests[t]],e.setup,e.teardown))}else if(this.options.test)this.tests=[new Test.Unit.Testcase(this.options.test,e[this.options.test],e.setup,e.teardown)];else{this.tests=[];for(var n in e)/^test/.test(n)&&this.tests.push(new Test.Unit.Testcase(this.options.context?" -> "+this.options.titles[n]:n,e[n],e.setup,e.teardown))}this.currentTest=0,this.logger=new Test.Unit.Logger(this.options.testLog),setTimeout(this.runTests.bind(this),1e3)},parseResultsURLQueryParameter:function(){return window.location.search.parseQuery().resultsURL},parseTestsQueryParameter:function(){if(window.location.search.parseQuery().tests)return window.location.search.parseQuery().tests.split(",")},getResult:function(){var e=!1;for(var t=0;t<this.tests.length;t++){if(this.tests[t].errors>0)return"ERROR";this.tests[t].failures>0&&(e=!0)}return e?"FAILURE":"SUCCESS"},postResults:function(){this.options.resultsURL&&new Ajax.Request(this.options.resultsURL,{method:"get",parameters:"result="+this.getResult(),asynchronous:!1})},runTests:function(){var e=this.tests[this.currentTest];if(!e){this.postResults(),this.logger.summary(this.summary());return}e.isWaiting||this.logger.start(e.name),e.run(),e.isWaiting?(this.logger.message("Waiting for "+e.timeToWait+"ms"),setTimeout(this.runTests.bind(this),e.timeToWait||1e3)):(this.logger.finish(e.status(),e.summary()),this.currentTest++,this.runTests())},summary:function(){var e=0,t=0,n=0,r=[];for(var i=0;i<this.tests.length;i++)e+=this.tests[i].assertions,t+=this.tests[i].failures,n+=this.tests[i].errors;return(this.options.context?this.options.context+": ":"")+this.tests.length+" tests, "+e+" assertions, "+t+" failures, "+n+" errors"}},Test.Unit.Assertions=Class.create(),Test.Unit.Assertions.prototype={initialize:function(){this.assertions=0,this.failures=0,this.errors=0,this.messages=[]},summary:function(){return this.assertions+" assertions, "+this.failures+" failures, "+this.errors+" errors"+"\n"+this.messages.join("\n")},pass:function(){this.assertions++},fail:function(e){this.failures++,this.messages.push("Failure: "+e)},info:function(e){this.messages.push("Info: "+e)},error:function(e){this.errors++,this.messages.push(e.name+": "+e.message+"("+Test.Unit.inspect(e)+")")},status:function(){return this.failures>0?"failed":this.errors>0?"error":"passed"},assert:function(e){var t=arguments[1]||'assert: got "'+Test.Unit.inspect(e)+'"';try{e?this.pass():this.fail(t)}catch(n){this.error(n)}},assertEqual:function(e,t){var n=arguments[2]||"assertEqual";try{e==t?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+Test.Unit.inspect(t)+'"')}catch(r){this.error(r)}},assertInspect:function(e,t){var n=arguments[2]||"assertInspect";try{e==t.inspect()?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+Test.Unit.inspect(t)+'"')}catch(r){this.error(r)}},assertEnumEqual:function(e,t){var n=arguments[2]||"assertEnumEqual";try{$A(e).length==$A(t).length&&e.zip(t).all(function(e){return e[0]==e[1]})?this.pass():this.fail(n+": expected "+Test.Unit.inspect(e)+", actual "+Test.Unit.inspect(t))}catch(r){this.error(r)}},assertNotEqual:function(e,t){var n=arguments[2]||"assertNotEqual";try{e!=t?this.pass():this.fail(n+': got "'+Test.Unit.inspect(t)+'"')}catch(r){this.error(r)}},assertIdentical:function(e,t){var n=arguments[2]||"assertIdentical";try{e===t?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+Test.Unit.inspect(t)+'"')}catch(r){this.error(r)}},assertNotIdentical:function(e,t){var n=arguments[2]||"assertNotIdentical";try{e!==t?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+Test.Unit.inspect(t)+'"')}catch(r){this.error(r)}},assertNull:function(e){var t=arguments[1]||"assertNull";try{e==null?this.pass():this.fail(t+': got "'+Test.Unit.inspect(e)+'"')}catch(n){this.error(n)}},assertMatch:function(e,t){var n=arguments[2]||"assertMatch",r=new RegExp(e);try{r.exec(t)?this.pass():this.fail(n+' : regex: "'+Test.Unit.inspect(e)+" did not match: "+Test.Unit.inspect(t)+'"')}catch(i){this.error(i)}},assertHidden:function(e){var t=arguments[1]||"assertHidden";this.assertEqual("none",e.style.display,t)},assertNotNull:function(e){var t=arguments[1]||"assertNotNull";this.assert(e!=null,t)},assertType:function(e,t){var n=arguments[2]||"assertType";try{t.constructor==e?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+t.constructor+'"')}catch(r){this.error(r)}},assertNotOfType:function(e,t){var n=arguments[2]||"assertNotOfType";try{t.constructor!=e?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+t.constructor+'"')}catch(r){this.error(r)}},assertInstanceOf:function(e,t){var n=arguments[2]||"assertInstanceOf";try{t instanceof e?this.pass():this.fail(n+": object was not an instance of the expected type")}catch(r){this.error(r)}},assertNotInstanceOf:function(e,t){var n=arguments[2]||"assertNotInstanceOf";try{t instanceof e?this.fail(n+": object was an instance of the not expected type"):this.pass()}catch(r){this.error(r)}},assertRespondsTo:function(e,t){var n=arguments[2]||"assertRespondsTo";try{t[e]&&typeof t[e]=="function"?this.pass():this.fail(n+": object doesn't respond to ["+e+"]")}catch(r){this.error(r)}},assertReturnsTrue:function(e,t){var n=arguments[2]||"assertReturnsTrue";try{var r=t[e];r||(r=t["is"+e.charAt(0).toUpperCase()+e.slice(1)]),r()?this.pass():this.fail(n+": method returned false")}catch(i){this.error(i)}},assertReturnsFalse:function(e,t){var n=arguments[2]||"assertReturnsFalse";try{var r=t[e];r||(r=t["is"+e.charAt(0).toUpperCase()+e.slice(1)]),r()?this.fail(n+": method returned true"):this.pass()}catch(i){this.error(i)}},assertRaise:function(e,t){var n=arguments[2]||"assertRaise";try{t(),this.fail(n+": exception expected but none was raised")}catch(r){e==null||r.name==e?this.pass():this.error(r)}},assertElementsMatch:function(){var e=$A(arguments),t=$A(e.shift());if(t.length!=e.length)return this.fail("assertElementsMatch: size mismatch: "+t.length+" elements, "+e.length+" expressions"),!1;t.zip(e).all(function(e,t){var n=$(e.first()),r=e.last();if(n.match(r))return!0;this.fail("assertElementsMatch: (in index "+t+") expected "+r.inspect()+" but got "+n.inspect())}.bind(this))&&this.pass()},assertElementMatches:function(e,t){this.assertElementsMatch([e],t)},benchmark:function(e,t){var n=new Date;(t||1).times(e);var r=new Date-n;return this.info((arguments[2]||"Operation")+" finished "+t+" iterations in "+r/1e3+"s"),r},_isVisible:function(e){return e=$(e),e.parentNode?(this.assertNotNull(e),e.style&&Element.getStyle(e,"display")=="none"?!1:this._isVisible(e.parentNode)):!0},assertNotVisible:function(e){this.assert(!this._isVisible(e),Test.Unit.inspect(e)+" was not hidden and didn't have a hidden parent either. "+arguments[1])},assertVisible:function(e){this.assert(this._isVisible(e),Test.Unit.inspect(e)+" was not visible. "+arguments[1])},benchmark:function(e,t){var n=new Date;(t||1).times(e);var r=new Date-n;return this.info((arguments[2]||"Operation")+" finished "+t+" iterations in "+r/1e3+"s"),r}},Test.Unit.Testcase=Class.create(),Object.extend(Object.extend(Test.Unit.Testcase.prototype,Test.Unit.Assertions.prototype),{initialize:function(name,test,setup,teardown){Test.Unit.Assertions.prototype.initialize.bind(this)(),this.name=name,typeof test=="string"?(test=test.gsub(/(\.should[^\(]+\()/,"#{0}this,"),test=test.gsub(/(\.should[^\(]+)\(this,\)/,"#{1}(this)"),this.test=function(){eval("with(this){"+test+"}")}):this.test=test||function(){},this.setup=setup||function(){},this.teardown=teardown||function(){},this.isWaiting=!1,this.timeToWait=1e3},wait:function(e,t){this.isWaiting=!0,this.test=t,this.timeToWait=e},run:function(){try{try{this.isWaiting||this.setup.bind(this)(),this.isWaiting=!1,this.test.bind(this)()}finally{this.isWaiting||this.teardown.bind(this)()}}catch(e){this.error(e)}}}),Test.setupBDDExtensionMethods=function(){var e={shouldEqual:"assertEqual",shouldNotEqual:"assertNotEqual",shouldEqualEnum:"assertEnumEqual",shouldBeA:"assertType",shouldNotBeA:"assertNotOfType",shouldBeAn:"assertType",shouldNotBeAn:"assertNotOfType",shouldBeNull:"assertNull",shouldNotBeNull:"assertNotNull",shouldBe:"assertReturnsTrue",shouldNotBe:"assertReturnsFalse",shouldRespondTo:"assertRespondsTo"},t=function(e,t,n){this[e].apply(this,(t||[]).concat([n]))};Test.BDDMethods={},$H(e).each(function(e){Test.BDDMethods[e.key]=function(){var n=$A(arguments),r=n.shift();t.apply(r,[e.value,n,this])}}),[Array.prototype,String.prototype,Number.prototype,Boolean.prototype].each(function(e){Object.extend(e,Test.BDDMethods)})},Test.context=function(e,t,n){Test.setupBDDExtensionMethods();var r={},i={};for(specName in t)switch(specName){case"setup":case"teardown":r[specName]=t[specName];break;default:var s="test"+specName.gsub(/\s+/,"-").camelize(),o=t[specName].toString().split("\n").slice(1);/^\{/.test(o[0])&&(o=o.slice(1)),o.pop(),o=o.map(function(e){return e.strip()}),r[s]=o.join("\n"),i[s]=specName}new Test.Unit.Runner(r,{titles:i,testLog:n||"testlog",context:e})};var ImgPoolHandlerWebKit=Class.create({initialize:function(){this.pool=[],this.pool_waiting=[],this.blank_image_loaded_event=this.blank_image_loaded_event.bind(this)},get:function(){return this.pool.length==0?$(document.createElement("IMG")):this.pool.pop()},release:function(e){e.observe("load",this.blank_image_loaded_event),this.pool_waiting.push(e),e.src="/images/blank.png"},blank_image_loaded_event:function(e){var t=e.target;t.stopObserving("load",this.blank_image_loaded_event),this.pool_waiting=this.pool_waiting.without(t),this.pool.push(t)}}),ImgPoolHandlerDummy=Class.create({get:function(){return $(document.createElement("IMG"))},release:function(e){e.src="/images/blank.png"}}),ImgPoolHandler=function(){var e=Prototype.Browser.WebKit,t=UrlHash.get("image-pools");return t!=null&&(e=t!="0"),e?new ImgPoolHandlerWebKit(arguments):new ImgPoolHandlerDummy(arguments)};PostLoader=function(){document.on("viewer:need-more-thumbs",this.need_more_post_data.bindAsEventListener(this)),document.on("viewer:perform-search",this.perform_search.bindAsEventListener(this)),this.hashchange_tags=this.hashchange_tags.bind(this),UrlHash.observe("tags",this.hashchange_tags),this.cached_posts=new Hash,this.cached_pools=new Hash,this.sample_preload_container=null,this.preloading_sample_for_post_id=null,this.load({results_mode:"center-on-current"})},PostLoader.prototype.need_more_post_data=function(){if(this.loaded_extended_results)return;this.load({extending:!0})},PostLoader.prototype.preload_sample_image=function(){var e=UrlHash.get("post-id");if(this.preloading_sample_for_post_id==e)return;this.preloading_sample_for_post_id=e,this.sample_preload_container&&(this.sample_preload_container.destroy(),this.sample_preload_container=null);if(e==null)return;var t=Post.get_cached_sample_urls();if(t==null)return;if(!(String(e)in t))return;var n=t[String(e)];debug("Advance preloading sample image for post "+e),this.sample_preload_container=new PreloadContainer,this.sample_preload_container.preload(n)},PostLoader.prototype.server_load_pool=function(){if(this.result.pool_id==null)return;if(!this.result.disable_cache){var e=this.cached_pools.get(this.result.pool_id);if(e){this.result.pool=e,this.request_finished();return}}new Ajax.Request("/pool/show.json",{parameters:{id:this.result.pool_id},method:"get",onCreate:function(e){this.current_ajax_requests.push(e.request)}.bind(this),onComplete:function(e){this.current_ajax_requests=this.current_ajax_requests.without(e.request),this.request_finished()}.bind(this),onSuccess:function(e){if(this.current_ajax_requests.indexOf(e.request)==-1)return;this.result.pool=e.responseJSON,this.cached_pools.set(this.result.pool_id,this.result.pool)}.bind(this)})},PostLoader.prototype.server_load_posts=function(){var e=this.result.tags,t="holds:false "+e+" limit:"+this.result.post_limit;if(!this.result.disable_cache){var n=this.cached_posts.get(t);if(n){this.result.posts=n,this.request_finished();return}}new Ajax.Request("/post.json",{parameters:{tags:t,api_version:2,filter:1,include_tags:1,include_votes:1,include_pools:1},method:"get",onCreate:function(e){this.current_ajax_requests.push(e.request)}.bind(this),onComplete:function(e){this.current_ajax_requests=this.current_ajax_requests.without(e.request),this.request_finished()}.bind(this),onSuccess:function(e){if(this.current_ajax_requests.indexOf(e.request)==-1)return;var e=e.responseJSON;this.result.posts=e.posts,Post.register_resp(e),this.cached_posts.set(t,this.result.posts)}.bind(this),onFailure:function(e){var t="error "+e.status;e.responseJSON&&(t=e.responseJSON.reason),notice("Error loading posts: "+t),this.result.error=!0}.bind(this)})},PostLoader.prototype.request_finished=function(){if(this.current_ajax_requests.length)return;var e=this.result;this.result=null;if(e.error!=null)return;var t=[];if(e.posts!=null)for(var n=0;n<e.posts.length;++n)t.push(e.posts[n].id);document.fire("viewer:displayed-pool-changed",{pool:e.pool}),document.fire("viewer:searched-tags-changed",{tags:e.tags});var r=!0;e.pool&&(r=!1),e.load_options.extending&&(r=!1),t.length<e.post_limit&&(debug("Received posts fewer than requested ("+t.length+" < "+e.post_limit+"), clamping"),r=!1),UrlHash.set_deferred({tags:e.tags}),document.fire("viewer:loaded-posts",{tags:e.tags,post_ids:t,pool:e.pool,extending:e.load_options.extending,can_be_extended_further:r,load_options:e.load_options})},PostLoader.prototype.load=function(e){e||(e={});var t=e.disable_cache,n=e.extending,r=e.tags;r==null&&(r=UrlHash.get("tags"));if(!n&&r==null&&UrlHash.get("post-id")==null){UrlHash.set({tags:""});return}debug("PostLoader.load("+n+", "+t+")"),this.preload_sample_image(),this.loaded_extended_results=n,this.current_ajax_requests=[],this.result={},this.result.load_options=e,this.result.tags=r,this.result.disable_cache=t;if(this.result.tags==null){this.request_finished();return}var i=null;this.result.tags.split(" ").each(function(e){var t=e.match(/^pool:(\d+)/);if(!t)return;i=parseInt(t[1])}),this.result.pool_id=i;var s=n?1e3:100;i!=null&&(s=1e3),this.result.post_limit=s,this.current_ajax_requests.push(null),this.server_load_pool(),this.server_load_posts(),this.current_ajax_requests=this.current_ajax_requests.without(null),this.request_finished()},PostLoader.prototype.hashchange_tags=function(){var e=UrlHash.get("tags");if(e==this.last_seen_tags)return;this.last_seen_tags=e,debug("changed tags"),this.load()},PostLoader.prototype.perform_search=function(e){var t=e.memo.tags;this.last_seen_tags=t;var n=e.memo.results_mode||"center-on-first";debug("do search: "+t),this.load({tags:t,results_mode:n})},ThumbnailView=function(e,t){this.container=e,this.view=t,this.post_ids=[],this.post_frames=[],this.expanded_post_idx=null,this.centered_post_idx=null,this.centered_post_offset=0,this.last_mouse_x=0,this.last_mouse_y=0,this.thumb_container_shown=!0,this.allow_wrapping=!0,this.thumb_preload_container=new PreloadContainer,this.unused_thumb_pool=[],this.posts_populated=[0,0],document.on("DOMMouseScroll",this.document_mouse_wheel_event.bindAsEventListener(this)),document.on("mousewheel",this.document_mouse_wheel_event.bindAsEventListener(this)),document.on("viewer:displayed-image-loaded",this.displayed_image_loaded_event.bindAsEventListener(this)),document.on("viewer:set-active-post",function(e){var t=[e.memo.post_id,e.memo.post_frame];this.set_active_post(t,e.memo.lazy,e.memo.center_thumbs)}.bindAsEventListener(this)),document.on("viewer:show-next-post",function(e){this.show_next_post(e.memo.prev)}.bindAsEventListener(this)),document.on("viewer:scroll",function(e){this.scroll(e.memo.left)}.bindAsEventListener(this)),document.on("viewer:set-thumb-bar",function(e){e.memo.toggle?this.show_thumb_bar(!this.thumb_container_shown):this.show_thumb_bar(e.memo.set)}.bindAsEventListener(this)),document.on("viewer:loaded-posts",this.loaded_posts_event.bindAsEventListener(this)),this.hashchange_post_id=this.hashchange_post_id.bind(this),UrlHash.observe("post-id",this.hashchange_post_id),UrlHash.observe("post-frame",this.hashchange_post_id),new DragElement(this.container,{ondrag:this.container_ondrag.bind(this)}),Element.on(window,"resize",this.window_resize_event.bindAsEventListener(this)),this.container.on("mousemove",this.container_mousemove_event.bindAsEventListener(this)),this.container.on("mouseover",this.container_mouseover_event.bindAsEventListener(this)),this.container.on("mouseout",this.container_mouseout_event.bindAsEventListener(this)),this.container.on("click",this.container_click_event.bindAsEventListener(this)),this.container.on("dblclick",".post-thumb,.browser-thumb-hover-overlay",this.container_dblclick_event.bindAsEventListener(this)),this.container.down(".browser-thumb-hover-overlay").on("click",function(e){e.isLeftClick()&&e.preventDefault()}.bindAsEventListener(this)),this.config={};if(navigator.userAgent.indexOf("iPad")!=-1)this.config.thumb_scale=1;else if(navigator.userAgent.indexOf("iPhone")!=-1||navigator.userAgent.indexOf("iPod")!=-1)this.config.thumb_scale=.5;else if(navigator.userAgent.indexOf("Android")!=-1){var n=Math.min(window.innerWidth,window.innerHeight);this.config.thumb_scale=scale(n,320,640,.5,1),debug("Unclamped thumb scale: "+this.config.thumb_scale),this.config.thumb_scale=Math.min(this.config.thumb_scale,1),this.config.thumb_scale=Math.max(this.config.thumb_scale,.5),debug("startup, window size: "+window.innerWidth+"x"+window.innerHeight)}else this.config.thumb_scale=1;debug("Thumb scale: "+this.config.thumb_scale),this.config_changed(),this.thumb_container_shown=!1,this.show_thumb_bar(!0)},ThumbnailView.prototype.window_resize_event=function(e){if(e.stopped)return;this.thumb_container_shown&&this.center_on_post_for_scroll(this.centered_post_idx)},ThumbnailView.prototype.loaded_posts_event=function(e){var t=e.memo.post_ids,n=this.post_ids,r=this.centered_post_idx;this.remove_all_posts(),t=t.reject(Post.is_blacklisted),this.post_ids=[],this.post_frames=[];for(var i=0;i<t.length;++i){var s=t[i],o=Post.posts.get(s);if(o.frames.length>0)for(var u=0;u<o.frames.length;++u)this.post_ids.push(s),this.post_frames.push(u);else this.post_ids.push(s),this.post_frames.push(-1)}this.allow_wrapping=!e.memo.can_be_extended_further,this.container.down(".post-browser-no-results").show(e.memo.tags!=null&&this.post_ids.length==0),this.container.down(".post-browser-posts").show(this.post_ids.length!=0);if(e.memo.extending){var a=sort_array_by_distance(n.slice(0,r+3),r),f=null;for(var i=0;i<a.length;++i){var l=a[i],o=Post.posts.get(l);if(o!=null){f=o.id;break}}debug("center-on-"+f),f==null&&(this.centered_post_offset=0,f=new_post_ids[0]);var c=this.post_ids.indexOf(f);this.center_on_post_for_scroll(c)}else{var h=e.memo.load_options.results_mode||"center-on-current",p;h=="center-on-first"||h=="jump-to-first"?p=[this.post_ids[0],this.post_frames[0]]:p=this.get_current_post_id_and_frame();var c=this.get_post_idx(p);c==null&&(c=0),this.centered_post_offset=0,this.center_on_post_for_scroll(c),(h=="jump-to-first"||this.view.wanted_post_id==null)&&this.set_active_post(p,!1,!1,!0)}e.memo.tags==null&&this.show_thumb_bar(!1)},ThumbnailView.prototype.container_ondrag=function(e){this.centered_post_offset-=e.dX,this.center_on_post_for_scroll(this.centered_post_idx)},ThumbnailView.prototype.container_mouseover_event=function(e){var t=$(e.target);t.hasClassName(".post-thumb")||(t=t.up(".post-thumb")),t&&this.expand_post(t.post_idx)},ThumbnailView.prototype.container_mouseout_event=function(e){var t=$(e.target);t.hasClassName(".browser-thumb-hover-overlay")||(t=t.up(".browser-thumb-hover-overlay")),t&&this.expand_post(null)},ThumbnailView.prototype.hashchange_post_id=function(){var e=this.get_current_post_id_and_frame();if(e[0]==null)return;var t=e[0],n=e[1];if(t==this.view.displayed_post_id&&n==this.view.displayed_post_frame)return;var r=this.get_post_idx(e);this.centered_post_offset=0,this.center_on_post_for_scroll(r),this.set_active_post(e,!1,!1,!0)},ThumbnailView.prototype.get_post_idx=function(e){var t=e[0],n=e[1],r=this.post_ids.indexOf(t);if(r==-1)return null;if(n==-1)return r;var i=r;while(i<this.post_ids.length&&this.post_ids[i]==t){if(this.post_frames[i]==n)return i;++i}return r},ThumbnailView.prototype.get_current_post_id_and_frame=function(){var e=UrlHash.get("post-id");if(e==null)return this.post_ids.length==0?[null,null]:[this.post_ids[0],this.post_frames[0]];e=
parseInt(e);var t=UrlHash.get("post-frame");return t==null&&(t=this.view.get_default_post_frame(e)),[e,t]},ThumbnailView.prototype.container_mousemove_event=function(e){var t=e.pointerX()-document.documentElement.scrollLeft,n=e.pointerY()-document.documentElement.scrollTop;this.last_mouse_x=t,this.last_mouse_y=n},ThumbnailView.prototype.document_mouse_wheel_event=function(e){e.stop();var t;e.wheelDelta?t=e.wheelDelta:e.detail&&(t=-e.detail),this.thumb_container_shown?document.fire("viewer:scroll",{left:t>=0}):document.fire("viewer:show-next-post",{prev:t>=0})},ThumbnailView.prototype.set_active_post=function(e,t,n,r,i){if(e[0]==null)return;this.view.set_post(e[0],e[1],t,r,i);if(n){var s=this.get_post_idx(e);this.centered_post_offset=0,this.center_on_post_for_scroll(s)}},ThumbnailView.prototype.set_active_post_idx=function(e,t,n,r,i){if(e==null)return;var s=this.post_ids[e],o=this.post_frames[e];this.set_active_post([s,o],t,n,r,i)},ThumbnailView.prototype.show_next_post=function(e){if(this.post_ids.length==0)return;var t=this.get_post_idx([this.view.wanted_post_id,this.view.wanted_post_frame]);t==null&&(t=0);var n=e?-1:1;this.post_frames[t]!=this.view.wanted_post_frame&&n==+1&&(debug("Snapped the display to the nearest frame"),n==+1&&(n=0));var r=t;r+=n,r+=this.post_ids.length,r%=this.post_ids.length;var i=e&&r>t||!e&&r<t;if(i){if(!this.allow_wrapping)return;!this.thumb_container_shown&&e?notice("Continued from the end"):!this.thumb_container_shown&&!e&&notice("Starting over from the beginning")}this.set_active_post_idx(r,!0,!0,!1,!0)},ThumbnailView.prototype.scroll=function(e){if(!this.thumb_container_shown)return;var t=this.centered_post_idx;this.centered_post_offset>0&&e||this.centered_post_offset<0&&!e||(t+=e?-1:1),this.centered_post_offset=0,t<0?this.allow_wrapping?t=this.post_ids.length-1:t=0:t>=this.post_ids.length&&(this.allow_wrapping?t=0:t=this.post_ids.length-1),this.center_on_post_for_scroll(t)},ThumbnailView.prototype.center_on_post_for_scroll=function(e){this.thumb_container_shown&&this.expand_post(null),this.center_on_post(e);if(this.thumb_container_shown){var t=document.elementFromPoint(this.last_mouse_x,this.last_mouse_y);t=$(t);if(t){var n=t.up(".post-thumb");n&&this.expand_post(n.post_idx)}}},ThumbnailView.prototype.remove_post=function(e){if(this.posts_populated[0]==this.posts_populated[1])return!1;var t=this.container.down(".post-browser-posts");if(e){--this.posts_populated[1];var n=t.lastChild}else{++this.posts_populated[0];var n=t.firstChild}var r=t.removeChild(n);return this.unused_thumb_pool.push(r),!0},ThumbnailView.prototype.remove_all_posts=function(){while(this.remove_post(!0));},ThumbnailView.prototype.add_post_to_display=function(e){var t=this.container.down(".post-browser-posts");if(e){var n=this.posts_populated[1];if(n==this.post_ids.length)return!1;++this.posts_populated[1];var r=this.create_thumb(n);t.insertBefore(r,null)}else{if(this.posts_populated[0]==0)return!1;--this.posts_populated[0];var n=this.posts_populated[0],r=this.create_thumb(n);t.insertBefore(r,t.firstChild)}return!0},ThumbnailView.prototype.populate_post=function(e){if(this.is_post_idx_shown(e))return;if(e==this.posts_populated[1]){this.add_post_to_display(!0);return}if(e==this.posts_populated[0]){this.add_post_to_display(!1);return}this.remove_all_posts();var t=this.container.down(".post-browser-posts"),n=this.create_thumb(e);t.appendChild(n),this.posts_populated[0]=e,this.posts_populated[1]=e+1},ThumbnailView.prototype.is_post_idx_shown=function(e){return e>=this.posts_populated[1]?!1:e>=this.posts_populated[0]},ThumbnailView.prototype.get_width_adjacent_to_post=function(e,t){var n=$("p"+e);if(t){var r=n.parentNode.lastChild;if(r==n)return 0;var i=r.offsetLeft+r.offsetWidth,s=n.offsetLeft+n.offsetWidth;return i-s}return n.offsetLeft},ThumbnailView.prototype.center_on_post=function(e){if(!this.post_ids){debug("unexpected: center_on_post has no post_ids");return}var t=this.post_ids[e];if(Post.posts.get(t)==null)return;e>this.post_ids.length*3/4&&function(){document.fire("viewer:need-more-thumbs",{view:this})}.defer(),this.centered_post_idx=e;if(!this.thumb_container_shown)return;for(;;){var n=$("p"+this.centered_post_idx);if(!n)break;var r=n.offsetWidth/2+this.centered_post_offset;if(r>=0&&r<n.offsetWidth)break;var i=this.centered_post_idx+(this.centered_post_offset>0?1:-1),s=$("p"+i);if(s==null)break;var o=n.offsetLeft+n.offsetWidth/2,u=s.offsetLeft+s.offsetWidth/2,a=u-o;this.centered_post_offset-=a,this.centered_post_idx=i,e=this.centered_post_idx;break}this.populate_post(e);for(var f=0;f<2;++f){var l=!!f,c=this.container.offsetWidth/2;c*=1.25;var h=c+500;for(;;){var p=!1,d=this.get_width_adjacent_to_post(e,l);d+=this.centered_post_offset*(l?-1:1),d<0&&(d=1);if(d<c){if(!this.add_post_to_display(l))break;p=!1}else{if(!(d>h))break;this.remove_post(l);if(p){alert("error");break}}}}this.preload_thumbs();var v=$("p"+e),m=this.container.offsetWidth/2,g=m-v.offsetWidth/2-v.offsetLeft;g-=this.centered_post_offset,g=Math.round(g);var y=this.container.down(".post-browser-scroller");y.setStyle({left:g+"px"})},ThumbnailView.prototype.preload_thumbs=function(){var e=[];for(var t=0;t<5;++t){var n=this.posts_populated[0]-t-1;n>=0&&e.push(n);var n=this.posts_populated[1]+t;n<this.post_ids.length&&e.push(n)}this.thumb_preload_container.get_all().each(function(t){var n=t.post_idx;if(e.indexOf(n)!=-1){e[n]=null;return}this.thumb_preload_container.cancel_preload(t)}.bind(this));for(var t=0;t<e.length;++t){var r=e[t];if(r==null)continue;var i=this.post_ids[r],s=Post.posts.get(i),o=this.post_frames[r],u;o!=-1?u=s.frames[o].preview_url:u=s.preview_url;var a=this.thumb_preload_container.preload(u);a.post_idx=r}},ThumbnailView.prototype.expand_post=function(e){if(Prototype.BrowserFeatures.Touchscreen)return;if(!this.thumb_container_shown)return;var t=this.post_ids[e],n=this.container.down(".browser-thumb-hover-overlay");n.hide(),n.down("IMG").src="/images/blank.gif",this.expanded_post_idx=e;if(e==null)return;var r=Post.posts.get(t);if(r.status=="deleted")return;var i=$("p"+e),s=this.container.down(".browser-bottom-bar").offsetHeight;n.style.bottom=s+"px";var o=this.post_frames[e],u,a;if(o!=-1){var f=r.frames[o];u=f.preview_width,a=f.preview_url}else u=r.actual_preview_width,a=r.preview_url;var l=i.cumulativeOffset().left-u/2+i.offsetWidth/2;n.style.left=l+"px";var c=document.viewport.getDimensions().width-l;n.style.maxWidth=c+"px",n.href="/post/browse#"+r.id+this.view.post_frame_hash(r,o),n.down("IMG").src=a,n.show()},ThumbnailView.prototype.create_thumb=function(e){var t=this.post_ids[e],n=this.post_frames[e],r=Post.posts.get(t);if(this.unused_thumb_pool.length==0){var i='<div class="inner"><a class="thumb" tabindex="-1"><img alt="" class="preview" onload="this.style.visibility = \'visible\';"></a></div>',s=$(document.createElement("li"));s.innerHTML=i,s.className="post-thumb"}else var s=this.unused_thumb_pool.pop();s.id="p"+e,s.post_idx=e,s.down("A").href="/post/browse#"+r.id+this.view.post_frame_hash(r,n);var o=s.down("IMG"),u;return n!=-1?u=r.frames[n].preview_url:u=r.preview_url,o.src!=u&&(o.style.visibility="hidden",o.src=u),this.set_thumb_dimensions(s),s},ThumbnailView.prototype.set_thumb_dimensions=function(e){var t=e.post_idx,n=this.post_ids[t],r=this.post_frames[t],i=Post.posts.get(n),s,o;if(r!=-1){var u=i.frames[r];s=u.preview_width,o=u.preview_height}else s=i.actual_preview_width,o=i.actual_preview_height;s*=this.config.thumb_scale,o*=this.config.thumb_scale;var a=[Math.min(s,200*this.config.thumb_scale),200*this.config.thumb_scale],f=Math.round((s-a[0])/2),l=Math.max(0,a[1]-o),c=e.down(".inner");c.actual_width=a[0],c.actual_height=a[1],c.setStyle({width:a[0]+"px",height:a[1]+"px"});var h=c.down("img");h.width=s,h.height=o,h.setStyle({marginTop:l+"px",marginLeft:-f+"px"})},ThumbnailView.prototype.config_changed=function(){var e=200*this.config.thumb_scale+10;this.container.down(".post-browser-posts-container").setStyle({height:e+"px"}),this.container.select("LI.post-thumb").each(this.set_thumb_dimensions.bind(this)),this.center_on_post_for_scroll(this.centered_post_idx)},ThumbnailView.prototype.container_click_event=function(e){if(e.stopped)return;if($(e.target).up(".browser-thumb-hover-overlay")){this.set_active_post_idx(this.expanded_post_idx),e.preventDefault();return}var t=$(e.target).up(".post-thumb");if(t==null)return;e.preventDefault(),this.set_active_post_idx(t.post_idx)},ThumbnailView.prototype.container_dblclick_event=function(e){if(e.button)return;e.preventDefault(),this.show_thumb_bar(!1)},ThumbnailView.prototype.show_thumb_bar=function(e){if(this.thumb_container_shown==e)return;this.thumb_container_shown=e,this.container.show(e),this.center_on_post_for_scroll(this.centered_post_idx),document.fire("viewer:thumb-bar-changed",{shown:this.thumb_container_shown,height:this.thumb_container_shown?this.container.offsetHeight:0})},ThumbnailView.prototype.get_adjacent_post_idx_wrapped=function(e,t){return e+=t?1:-1,e=(e+this.post_ids.length)%this.post_ids.length,e},ThumbnailView.prototype.displayed_image_loaded_event=function(e){if(this.post_ids==null)return;var t=e.memo.post_id,n=e.memo.post_frame,r=this.get_post_idx([t,n]);if(r==null)return;var i=[];i.push([this.post_ids[r],this.post_frames[r]]);var s=this.get_adjacent_post_idx_wrapped(r,!0);s!=null&&i.push([this.post_ids[s],this.post_frames[s]]);var s=this.get_adjacent_post_idx_wrapped(r,!1);s!=null&&i.push([this.post_ids[s],this.post_frames[s]]),this.view.preload(i)},InputHandler.prototype.handle_keypress=function(e){var t=e.charCode;t||(t=e.keyCode);if(t==Event.KEY_ESC&&document.focusedElement&&document.focusedElement.blur&&!document.focusedElement.hasClassName("no-blur-on-escape"))return document.focusedElement.blur(),!0;var n=e.target;if(n.tagName=="INPUT"||n.tagName=="TEXTAREA")return!1;if(t==63)return debug("xxx"),document.fire("viewer:show-help"),!0;if(e.shiftKey||e.altKey||e.ctrlKey||e.metaKey)return!1;var r=Prototype.Browser.WebKit?192:96;if(t==32)document.fire("viewer:set-thumb-bar",{toggle:!0});else if(t==49)document.fire("viewer:vote",{score:1});else if(t==50)document.fire("viewer:vote",{score:2});else if(t==51)document.fire("viewer:vote",{score:3});else if(t==r)document.fire("viewer:vote",{score:0});else if(t==65||t==97)document.fire("viewer:show-next-post",{prev:!0});else if(t==69||t==101)document.fire("viewer:edit-post");else if(t==83||t==115)document.fire("viewer:show-next-post",{prev:!1});else if(t==70||t==102)document.fire("viewer:focus-tag-box");else if(t==86||t==118)document.fire("viewer:view-large-toggle");else if(t==Event.KEY_PAGEUP)document.fire("viewer:show-next-post",{prev:!0});else if(t==Event.KEY_PAGEDOWN)document.fire("viewer:show-next-post",{prev:!1});else if(t==Event.KEY_LEFT)document.fire("viewer:scroll",{left:!0});else{if(t!=Event.KEY_RIGHT)return!1;document.fire("viewer:scroll",{left:!1})}return!0},InputHandler.prototype.document_keypress_event=function(e){this.handle_keypress(e)&&e.stop()},BrowserView=function(e){this.container=e,this.wanted_post_id=null,this.wanted_post_frame=null,this.displayed_post_id=null,this.displayed_post_frame=null,this.current_ajax_request=null,this.last_preload_request=[],this.last_preload_request_active=!1,this.image_pool=new ImgPoolHandler,this.img_box=this.container.down(".image-box"),this.container.down(".image-canvas"),Prototype.Browser.Opera||(this.canvas=create_canvas_2d()),this.canvas&&(this.canvas.hide(),this.img_box.appendChild(this.canvas)),this.zoom_level=0,this.post_ui_visible=!0,this.update_navigator=this.update_navigator.bind(this),Event.on(window,"resize",this.window_resize_event.bindAsEventListener(this)),document.on("viewer:vote",function(e){this.vote_widget&&this.vote_widget.vote(e.memo.score)}.bindAsEventListener(this)),TagCompletion&&TagCompletion.init(),this.container.down(".image-container").on("dblclick",".image-container",function(e){if(e.button)return;e.stop(),document.fire("viewer:set-thumb-bar",{toggle:!0})}.bindAsEventListener(this)),document.on("viewer:view-large-toggle",function(e){this.toggle_view_large_image()}.bindAsEventListener(this)),this.container.down(".post-info").on("click",".toggle-zoom",function(e){e.stop(),this.toggle_view_large_image()}.bindAsEventListener(this)),this.container.down(".parent-post").down("A").on("click",this.parent_post_click_event.bindAsEventListener(this)),this.container.down(".child-posts").down("A").on("click",this.child_posts_click_event.bindAsEventListener(this)),this.container.down(".post-frames").on("click",".post-frame-link",function(e,t){e.stop(),document.fire("viewer:set-active-post",{post_id:this.displayed_post_id,post_frame:t.post_frame,center_thumbs:!0})}.bind(this)),this.thumb_bar_height=0,document.on("viewer:thumb-bar-changed",function(e){this.thumb_bar_height=e.memo.height,this.update_image_window_size(),this.set_post_ui(e.memo.shown),this.scale_and_position_image(!0)}.bindAsEventListener(this)),$(document.body).pickClassName("is-member","not-member",User.is_member_or_higher()),$(document.body).pickClassName("is-moderator","not-moderator",User.is_mod_or_higher());var t=this.container.down(".post-tags");t.on("click",".post-tag",function(e,t){e.stop(),document.fire("viewer:perform-search",{tags:t.tag_name})}.bind(this)),this.container.down(".post-approve").on("click",function(e){e.stop();if(!confirm("Approve this post?"))return;var t=this.displayed_post_id;Post.approve(t,!1)}.bindAsEventListener(this)),this.container.down(".post-unflag").on("click",function(e){e.stop();if(!confirm("Unflag this post?"))return;var t=this.displayed_post_id;Post.unflag(t)}.bindAsEventListener(this)),this.container.down(".post-delete").on("click",function(e){e.stop();var t=Post.posts.get(this.displayed_post_id),n="";t.flag_detail&&(n=t.flag_detail.reason);var r=prompt("Reason:",n);if(!r||r=="")return;var i=this.displayed_post_id;Post.approve(i,r)}.bindAsEventListener(this)),this.container.down(".post-undelete").on("click",function(e){e.stop();if(!confirm("Undelete this post?"))return;var t=this.displayed_post_id;Post.undelete(t)}.bindAsEventListener(this)),this.container.down(".flag-button").on("click",function(e){e.stop();var t=this.displayed_post_id;Post.flag(t)}.bindAsEventListener(this)),this.container.down(".activate-post").on("click",function(e){e.stop();var t=this.displayed_post_id;if(!confirm("Activate this post?"))return;Post.update_batch([{id:t,is_held:!1}],function(){var e=Post.posts.get(t);e.is_held?notice("Couldn't activate post"):notice("Activated post")}.bind(this))}.bindAsEventListener(this)),this.container.down(".reparent-post").on("click",function(e){e.stop();if(!confirm("Make this post the parent?"))return;var t=this.displayed_post_id,n=Post.posts.get(t);if(n==null)return;Post.reparent_post(t,n.parent_id,!1)}.bindAsEventListener(this)),this.container.down(".pool-info").on("click",".remove-pool-from-post",function(e,t){e.stop();var n=t.up(".pool-info"),r=Pool.pools.get(n.pool_id),i=r.name.replace(/_/g," ");if(!confirm("Remove this post from pool #"+n.pool_id+": "+i+"?"))return;Pool.remove_post(n.post_id,n.pool_id)}.bind(this));var n=this.container.down(".post-edit");n.down("FORM").on("submit",function(e){e.stop(),this.edit_save()}.bindAsEventListener(this)),this.container.down(".show-tag-edit").on("click",function(e){e.stop(),this.edit_show(!0)}.bindAsEventListener(this)),this.container.down(".edit-save").on("click",function(e){e.stop(),this.edit_save()}.bindAsEventListener(this)),this.container.down(".edit-cancel").on("click",function(e){e.stop(),this.edit_show(!1)}.bindAsEventListener(this)),this.edit_post_area_changed=this.edit_post_area_changed.bind(this),n.down(".edit-tags").on("paste",function(e){this.edit_post_area_changed.defer()}.bindAsEventListener(this)),n.down(".edit-tags").on("keydown",function(e){this.edit_post_area_changed.defer()}.bindAsEventListener(this)),new TagCompletionBox(n.down(".edit-tags")),this.container.down(".post-edit").on("keydown",function(e){e.keyCode==Event.KEY_ESC?this.edit_show(!1):e.keyCode==Event.KEY_RETURN&&(e.stop(),this.edit_save())}.bindAsEventListener(this)),document.on("viewer:edit-post",function(e){document.fire("viewer:set-thumb-bar",{set:!0}),this.edit_show(!0)}.bindAsEventListener(this)),document.on("posts:update",function(e){if(e.memo.post_ids.get(this.displayed_post_id)==null)return;this.set_post_info()}.bindAsEventListener(this)),this.vote_widget=new Vote(jQuery(this.container.down(".vote-container"),null)),this.blacklist_override_post_id=null,this.container.down(".show-blacklisted").on("click",function(e){e.preventDefault()}.bindAsEventListener(this)),this.container.down(".show-blacklisted").on("dblclick",function(e){e.stop(),this.blacklist_override_post_id=this.displayed_post_id;var t=Post.posts.get(this.displayed_post_id);this.set_main_image(t,this.displayed_post_frame)}.bindAsEventListener(this)),this.img_box.on("viewer:center-on",function(e){this.center_image_on(e.memo.x,e.memo.y)}.bindAsEventListener(this)),this.navigator=new Navigator(this.container.down(".image-navigator"),this.img_box),this.container.on("swipe:horizontal",function(e){document.fire("viewer:show-next-post",{prev:e.memo.right})}.bindAsEventListener(this)),Prototype.BrowserFeatures.Touchscreen&&(this.create_voting_popup(),this.image_swipe=new SwipeHandler(this.container.down(".image-container"))),this.container.down(".edit-frames-button").on("click",function(e){e.stop(),this.show_frame_editor()}.bindAsEventListener(this)),this.frame_editor=new FrameEditor(this.container.down(".frame-editor"),this.img_box,this.container.down(".frame-editor-popup"),{onClose:function(){this.hide_frame_editor()}.bind(this)}),this.image_swipe==null&&(this.image_dragger=new WindowDragElementAbsolute(this.img_box,this.update_navigator))},BrowserView.prototype.create_voting_popup=function(){var e=this.container.down(".vote-popup-container");e.show(),this.popup_vote_widget=new Vote(jQuery(e),null);var t=this.container.down(".vote-popup-flash"),n=this.container.down(".vote-popup-expand");n.show();var r=null;this.popup_vote_dragger=new DragElement(n,{ondown:function(n){n.latest_event.stop(),t.hide(),t.removeClassName("flash-star"),this.popup_vote_widget.set_mouseover(null),r=null,e.removeClassName("vote-popup-hidden")}.bind(this),onup:function(n){n.cancelling&&(debug("cancelling drag"),r=null),this.popup_vote_widget.set_mouseover(r);var i=this.popup_vote_widget.activate_item(r);if(i!=null){for(var s=0;s<4;++s)t.removeClassName("star-"+s);t.addClassName("star-"+i),t.show();var o=this.image_window_size,u=o.width/2-t.offsetWidth/2,a=o.height/2-t.offsetHeight/2;t.setStyle({left:u+"px",top:a+"px"}),t.addClassName("flash-star")}e.addClassName("vote-popup-hidden"),r=null}.bind(this),ondrag:function(e){r=document.elementFromPoint(e.x,e.y),this.popup_vote_widget.set_mouseover(r)}.bind(this)})},BrowserView.prototype.set_post_ui=function(e){Prototype.BrowserFeatures.Touchscreen&&(e=!1),this.container.down(".post-info").show(e&&this.displayed_post_id!=null);if(e==this.post_ui_visible)return;this.post_ui_visible=e,this.navigator&&this.navigator.set_autohide(!e),this.post_ui_visible||this.edit_show(!1)},BrowserView.prototype.image_loaded_event=function(e){this.img.fully_loaded=!0,document.fire("viewer:displayed-image-loaded",{post_id:this.displayed_post_id,post_frame:this.displayed_post_frame}),this.update_canvas()},BrowserView.prototype.post_frame_list_includes=function(e,t,n){var r=e.find(function(e){return e[0]==t&&e[1]==n});return r!=null},BrowserView.prototype.preload=function(e){var t=this.last_preload_request;this.last_preload_request=e;if(!this.post_frame_list_includes(t,this.wanted_post_id,this.wanted_post_frame)){this.last_preload_request_active=!1;return}this.last_preload_request_active=!0;var n=new PreloadContainer;for(var r=0;r<e.length;++r){var i=e[r][0],s=e[r][1],o=Post.posts.get(i);if(s!=-1){var u=o.frames[s];n.preload(u.url)}else n.preload(o.sample_url)}this.preload_container&&this.preload_container.destroy(),this.preload_container=n},BrowserView.prototype.load_post_id_data=function(e){debug("load needed");if(this.current_ajax_request!=null)return;new Ajax.Request("/post.json",{parameters:{tags:"id:"+e,api_version:2,filter:1,include_tags:"1",include_votes:"1",include_pools:1},method:"get",onCreate:function(e){this.current_ajax_request=e.request}.bind(this),onSuccess:function(t){if(this.current_ajax_request!=t.request)return;var t=t.responseJSON;this.success=t.posts.length>0;if(!this.success){notice("Post #"+e+" doesn't exist");return}Post.register_resp(t)}.bind(this),onComplete:function(t){this.current_ajax_request==t.request&&(this.current_ajax_request=null);var n=t.request.success()&&this.success;if(!n&&e==this.wanted_post_id){this.displayed_post_id==null&&document.fire("viewer:set-thumb-bar",{set:!0});return}this.set_post(this.wanted_post_id,this.wanted_post_frame)}.bind(this),onFailure:function(e){notice("Error "+e.status+" loading post")}.bind(this)})},BrowserView.prototype.set_viewing_larger_version=function(e){this.viewing_larger_version=e;var t=Post.posts.get(this.displayed_post_id),n=t!=null&&t.jpeg_url!=t.sample_url;this.container.down(".zoom-icon-none").show(!n),this.container.down(".zoom-icon-in").show(n&&!this.viewing_larger_version),this.container.down(".zoom-icon-out").show(n&&this.viewing_larger_version),Prototype.BrowserFeatures.Touchscreen&&this.image_dragger&&this.image_dragger.set_disabled(!e),this.frame_editor&&(this.frame_editor.set_drag_to_create(!e),this.frame_editor.set_show_corner_drag(!e))},BrowserView.prototype.set_main_image=function(e,t){this.img!=null&&(this.img.stopObserving(),this.img.parentNode.removeChild(this.img),this.image_pool.release(this.img),this.img=null);var n=Post.is_blacklisted(e.id)&&e.id!=this.blacklist_override_post_id;this.container.down(".blacklisted-message").show(n);if(n)return;this.img=this.image_pool.get(),this.img.className="main-image",this.canvas&&this.canvas.hide(),this.img.show(),this.img.setStyle({pointerEvents:"none"}),this.img.on("load",this.image_loaded_event.bindAsEventListener(this)),this.img.fully_loaded=!1;if(t!=-1&&t<e.frames.length){var r=e.frames[t];this.img.src=r.url,this.img_box.original_width=r.width,this.img_box.original_height=r.height,this.img_box.show()}else this.viewing_larger_version&&e.jpeg_url?(this.img.src=e.jpeg_url,this.img_box.original_width=e.jpeg_width,this.img_box.original_height=e.jpeg_height,this.img_box.show()):!this.viewing_larger_version&&e.sample_url?(this.img.src=e.sample_url,this.img_box.original_width=e.sample_width,this.img_box.original_height=e.sample_height,this.img_box.show()):this.img_box.hide();this.container.down(".image-box").appendChild(this.img),this.viewing_larger_version&&(this.navigator.set_image(e.preview_url,e.actual_preview_width,e.actual_preview_height),this.navigator.set_autohide(!this.post_ui_visible)),this.navigator.enable(this.viewing_larger_version),this.scale_and_position_image()},BrowserView.prototype.set_post=function(e,t,n,r,i){if(e==null)throw"post_id must not be null";this.cancel_lazily_load(),this.wanted_post_id=e,this.wanted_post_frame=t,this.wanted_post_no_hash_change=r,this.wanted_post_replace_history=i;if(e==this.displayed_post_id&&t==this.displayed_post_frame)return;var s=this.last_preload_request_active&&this.post_frame_list_includes(this.last_preload_request,e,t);if(n&&!s){this.lazy_load_timer=window.setTimeout(function(){this.lazy_load_timer=null,this.set_post(this.wanted_post_id,this.wanted_post_frame,!1,this.wanted_post_no_hash_change,this.wanted_post_replace_history)}.bind(this),500);return}this.hide_frame_editor();var o=Post.posts.get(e);if(o==null){this.displayed_post_id==null&&this.container.down(".post-info").hide(),this.load_post_id_data(e);return}t==null&&(t=this.get_default_post_frame(e),this.wanted_post_frame=t),t!=-1&&o.frames.length<=t&&(t=-1),this.displayed_post_id=e,this.displayed_post_frame=t;if(!r){var u=this.get_post_frame_hash(o,t);UrlHash.set_deferred({"post-id":e,"post-frame":u},i)}this.set_viewing_larger_version(!1),this.set_main_image(o,t),this.vote_widget&&(this.vote_widget.post_id=o.id),this.popup_vote_widget&&(this.popup_vote_widget.post_id=o.id),document.fire("viewer:displayed-post-changed",{post_id:e,post_frame:t}),this.set_post_info(),this.edit_show(!1)},BrowserView.prototype.post_frame_hash=function(e,t){return e.frames.length==0?"":"-"+(t==-1?"F":t)},BrowserView.prototype.get_default_post_frame=function(e){var t=Post.posts.get(e);return t==null?null:t.frames.length>0?0:-1},BrowserView.prototype.get_post_frame_hash=function(e,t){var n=e.frames.length>0?0:-1;return t==n?null:t},BrowserView.prototype.set_post_info=function(){var e=Post.posts.get(this.displayed_post_id);if(!e)return;this.container.down(".post-id").setTextContent(e.id),this.container.down(".post-id-link").href="/post/show/"+e.id,this.container.down(".posted-by").show(e.creator_id!=null),this.container.down(".posted-at").setTextContent(time_ago_in_words(new Date(e.created_at*1e3)));var t=this.container.down(".pool-info");while(t.firstChild)t.removeChild(t.firstChild);e.pool_posts&&e.pool_posts.each(function(n){var r=n[1],i=r.pool_id,s=Pool.pools.get(i),o=s.name.replace(/_/g," "),u=r.sequence;u.match(/^[0-9]/)&&(u="#"+u);var a='<div class="pool-info">Post ${sequence} in <a class="pool-link" href="/post/browse#/pool:${pool_id}">${desc}</a> (<a target="_blank" href="/pool/show/${pool_id}">pool page</a>)';Pool.can_edit_pool(s)&&(a+='<span class="advanced-editing"> (<a href="#" class="remove-pool-from-post">remove</a>)</div></span>');var f=a.subst({sequence:u,pool_id:i,desc:o.escapeHTML()}).createElement();f.post_id=e.id,f.pool_id=i,t.appendChild(f)}.bind(this)),e.creator_id!=null&&(this.container.down(".posted-by").down("A").href="/user/show/"+e.creator_id,this.container.down(".posted-by").down("A").setTextContent(e.author)),this.container.down(".post-dimensions").setTextContent(e.width+"x"+e.height),this.container.down(".post-source").show(e.source!="");if(e.source!=""){var n=e.source,r=null,i=e.source.match(/^http:\/\/.*pixiv\.net\/img\/(\w+)\/(\d+)\.\w+$/);i?(n="pixiv #"+i[2]+" ("+i[1]+")",r="http://www.pixiv.net/member_illust.php?mode=medium&illust_id="+i[2]):e.source.substr(0,7)=="http://"&&(n=n.substr(7),n.substr(0,4)=="www."&&(n=n.substr(4)),n.length>20&&(n=n.substr(0,20)+"..."),r=e.source);var s=this.container.down(".post-source");s.down("A").show(r!=null),s.down("SPAN").show(r==null),r?(s.down("A").href=r,s.down("A").setTextContent(n)):s.down("SPAN").setTextContent(n)}if(e.frames.length>0){this.container.down(".post-frames").removeClassName("no-frames");var o=this.container.down(".post-frame-list");while(o.firstChild)o.removeChild(o.firstChild);for(var u=-1;u<e.frames.length;++u){var n=u==-1?"main":u+1,a=document.createElement("a");a.href="/post/browse#"+e.id+this.post_frame_hash(e,u),a.className="post-frame-link",this.displayed_post_frame==u&&(a.className+=" current-post-frame"),a.setTextContent(n),a.post_frame=u,o.appendChild(a)}}else this.container.down(".post-frames").addClassName("no-frames");var f={s:"Safe",q:"Questionable",e:"Explicit"};this.container.down(".post-rating").setTextContent(f[e.rating]),this.container.down(".post-score").setTextContent(e.score),this.container.down(".post-hidden").show(!e.is_shown_in_index),this.container.down(".post-info").show(this.post_ui_visible);var l=function(e){var t=e.match(/.*\.([^.]+)/);return t?t[1]:""},c=e.sample_url!=e.file_url,h=e.jpeg_url!=e.file_url,p=e.file_url!=null&&!c;this.container.down(".download-links").show(p||c||h),this.container.down(".download-image").show(p),p&&(this.container.down(".download-image").href=e.file_url,this.container.down(".download-image-desc").setTextContent(number_to_human_size(e.file_size)+" "+l(e.file_url.toUpperCase()))),this.container.down(".download-jpeg").show(c);if(c){this.container.down(".download-jpeg").href=h?e.jpeg_url:e.file_url;var d=number_to_human_size(h?e.jpeg_file_size:e.file_size)+" JPG";this.container.down(".download-jpeg-desc").setTextContent(d)}this.container.down(".download-png").show(h);if(h){this.container.down(".download-png").href=e.file_url;var v=number_to_human_size(e.file_size)+" "+l(e.file_url.toUpperCase());this.container.down(".download-png-desc").setTextContent(v)}var m=this.container.down(".parent-post");m.show(e.parent_id!=null),e.parent_id&&(m.down("A").href="/post/browse#"+e.parent_id);var g=this.container.down(".child-posts");g.show(e.has_children),e.has_children&&(g.down("A").href="/post/browse#/parent:"+e.id);var y=this.container.down(".post-tags"),b=!0;while(y.firstChild)y.removeChild(y.firstChild);var w=Post.get_post_tags_with_type(e);w.each(function(e){var t=e[0],n=e[1],r=$(document.createElement("SPAN",""));r=$(r),r.className="tag-type-"+n;var i=document.createTextNode(" ");r.appendChild(i);var s=$(document.createElement("A",""));s.href="/post/browse#/"+window.encodeURIComponent(t),s.tag_name=t,s.className="post-tag tag-type-"+n;var o=t.replace(/_/g,"_");s.setTextContent(o),r.appendChild(s),y.appendChild(r)});var E=this.container.down(".flag-button");E.show(e.status=="active"),this.container.down(".post-approve").show(e.status=="flagged"||e.status=="pending"),this.container.down(".post-delete").show(e.status!="deleted"),this.container.down(".post-undelete").show(e.status=="deleted");var S=this.container.down(".flagged-info");S.show(e.status=="flagged");if(e.status=="flagged"&&e.flag_detail){var x=S.down(".by");S.down(".flagged-by-box").show(e.flag_detail.user_id!=null),e.flag_detail.user_id!=null&&(x.setTextContent(e.flag_detail.flagged_by),x.href="/user/show/"+e.flag_detail.user_id);var T=S.down(".reason");T.setTextContent(e.flag_detail.reason)}var N=e.flag_detail&&e.flag_detail.user_id==User.get_current_user_id(),C=S&&(User.is_mod_or_higher()||N);S.down(".post-unflag").show(C);var k=this.container.down(".status-pending");k.show(e.status=="pending"),this.container.down(".pending-reason-box").show(e.flag_detail&&e.flag_detail.reason),e.flag_detail&&this.container.down(".pending-reason").setTextContent(e.flag_detail.reason);var L=this.container.down(".status-deleted");L.show(e.status=="deleted");if(e.status=="deleted"){var A=L.down(".by-container");A.show(e.flag_detail.flagged_by!=null);var x=A.down(".by");x.setTextContent(e.flag_detail.flagged_by),x.href="/user/show/"+e.flag_detail.user_id;var T=L.down(".reason");T.setTextContent(e.flag_detail.reason)}this.container.down(".status-held").show(e.is_held);var O=User.get_current_user_id()==e.creator_id||User.is_mod_or_higher();this.container.down(".activate-post").show(O)},BrowserView.prototype.edit_show=function(e){var t=Post.posts.get(this.displayed_post_id);t||(e=!1),User.is_member_or_higher()||(e=!1),this.edit_shown=e,this.container.down(".post-tags-box").show(!e),this.container.down(".post-edit").show(e);if(!e){this.frame_editor.discard();return}this.select_edit_box(".post-edit-main");var n=Post.get_post_tags_with_type(t),r=n.pluck(0);r=r.join(" ")+" ",this.container.down(".edit-tags").old_value=r,this.container.down(".edit-tags").value=r,this.container.down(".edit-source").value=t.source,this.container.down(".edit-parent").value=t.parent_id,this.container.down(".edit-shown-in-index").checked=t.is_shown_in_index;var i=new Hash({s:".edit-safe",q:".edit-questionable",e:".edit-explicit"});this.container.down(i.get(t.rating)).checked=!0,this.edit_post_area_changed(),this.container.down(".edit-tags").focus()},BrowserView.prototype.edit_post_area_changed=function(){var e=this.container.down(".post-edit"),t=e.down(".edit-tags");t.style.height="0px",t.style.height=t.scrollHeight+"px"},BrowserView.prototype.edit_save=function(){var e=function(){notice("Post saved"),this.displayed_post_id==t&&this.edit_show(!1)}.bind(this),t=this.displayed_post_id;if(this.frame_editor&&this.frame_editor.is_opened()){this.frame_editor.save(e);return}var n=this.container.down(".edit-tags"),r=n.value;n.blur();var i=new Hash({s:".edit-safe",q:".edit-questionable",e:".edit-explicit"}),s="s";i.each(function(e){this.container.down(e[1]).checked&&(s=e[0])}.bind(this)),Post.update_batch([{id:t,tags:this.container.down(".edit-tags").value,old_tags:this.container.down(".edit-tags").old_value,source:this.container.down(".edit-source").value,parent_id:this.container.down(".edit-parent").value,is_shown_in_index:this.container.down(".edit-shown-in-index").checked,rating:s}],e)},BrowserView.prototype.window_resize_event=function(e){if(e.stopped)return;this.update_image_window_size(),this.scale_and_position_image(!0)},BrowserView.prototype.toggle_view_large_image=function(){var e=Post.posts.get(this.displayed_post_id);if(e==null)return;if(this.img==null)return;if(e.jpeg_url==e.sample_url)return;this.set_viewing_larger_version(!this.viewing_larger_version),this.set_main_image(e)},BrowserView.prototype.
update_image_window_size=function(){this.image_window_size=getWindowSize(),this.image_window_size.height-=this.thumb_bar_height,this.image_window_size.height=Math.max(this.image_window_size.height,0),this.update_navigator()},BrowserView.prototype.scale_and_position_image=function(e){var t=this.img_box;if(!this.img)return;var n=t.original_width,r=t.original_height,i=Post.posts.get(this.displayed_post_id);if(!i){debug("unexpected: displayed post "+this.displayed_post_id+" unknown");return}var s=this.image_window_size,o=1;if(!this.viewing_larger_version){var o=s.width/n;r*o>s.height&&(o=s.height/r)}o*=Math.pow(.9,this.zoom_level),this.displayed_image_width=Math.round(n*o),this.displayed_image_height=Math.round(r*o),this.img.width=this.displayed_image_width,this.img.height=this.displayed_image_height,this.update_canvas(),this.frame_editor&&this.frame_editor.set_image_dimensions(this.displayed_image_width,this.displayed_image_height);if(e&&this.viewing_larger_version)return;var u=.5,a=.5;this.viewing_larger_version&&(a=this.image_window_size.height/2,a/=this.displayed_image_height),this.center_image_on(u,a)},BrowserView.prototype.update_navigator=function(){if(!this.navigator)return;if(!this.img)return;var e=-this.img_box.offsetLeft,t=-this.img_box.offsetTop;x=e+this.image_window_size.width/2,y=t+this.image_window_size.height/2;var n=x/this.displayed_image_width,r=y/this.displayed_image_height,i=this.image_window_size.height/this.displayed_image_height,s=this.image_window_size.width/this.displayed_image_width;this.navigator.image_position_changed(n,r,i,s)},BrowserView.prototype.update_canvas=function(){if(!this.img.fully_loaded)return debug("image incomplete; can't render to canvas"),!1;if(!this.canvas)return;if(this.canvas.rendered_url==this.img.src&&this.canvas.width==this.displayed_image_width&&this.canvas.height==this.displayed_image_height)return;this.canvas.rendered_url=this.img.src,this.canvas.width=this.displayed_image_width,this.canvas.height=this.displayed_image_height;var e=this.canvas.getContext("2d");return e.drawImage(this.img,0,0,this.displayed_image_width,this.displayed_image_height),this.canvas.show(),this.img.hide(),!0},BrowserView.prototype.center_image_on=function(e,t){var n=e*this.displayed_image_width,r=t*this.displayed_image_height,i=n-this.image_window_size.width/2;i=Math.round(i);var s=r-this.image_window_size.height/2;s=Math.round(s),this.img_box.setStyle({left:-i+"px",top:-s+"px"}),this.update_navigator()},BrowserView.prototype.cancel_lazily_load=function(){if(this.lazy_load_timer==null)return;window.clearTimeout(this.lazy_load_timer),this.lazy_load_timer=null},WindowTitleHandler=function(){this.searched_tags="",this.post_id=null,this.post_frame=null,this.pool=null,document.on("viewer:searched-tags-changed",function(e){this.searched_tags=e.memo.tags||"",this.update()}.bindAsEventListener(this)),document.on("viewer:displayed-post-changed",function(e){this.post_id=e.memo.post_id,this.post_frame=e.memo.post_id,this.update()}.bindAsEventListener(this)),document.on("viewer:displayed-pool-changed",function(e){this.pool=e.memo.pool,this.update()}.bindAsEventListener(this)),this.update()},WindowTitleHandler.prototype.update=function(){var e=Post.posts.get(this.post_id);if(this.pool){var t=this.pool.name.replace(/_/g," ");if(e&&e.pool_posts){var n=e.pool_posts.get(this.pool.id);if(n){var r=n.sequence;t+=" ",r.match(/^[0-9]/)&&(t+="#"),t+=r}}}else var t="/"+this.searched_tags.replace(/_/g," ");t+=" - Browse",document.title=t},BrowserView.prototype.parent_post_click_event=function(e){e.stop();var t=Post.posts.get(this.displayed_post_id);if(t==null||t.parent_id==null)return;this.set_post(t.parent_id)},BrowserView.prototype.child_posts_click_event=function(e){e.stop(),document.fire("viewer:perform-search",{tags:"parent:"+this.displayed_post_id,results_mode:"center-on-current"})},BrowserView.prototype.select_edit_box=function(e){this.shown_edit_container&&this.shown_edit_container.hide(),this.shown_edit_container=this.container.down(e),this.shown_edit_container.show()},BrowserView.prototype.show_frame_editor=function(){this.select_edit_box(".frame-editor");var e=null;this.displayed_post_frame!=-1&&(e=this.displayed_post_frame,document.fire("viewer:set-active-post",{post_id:this.displayed_post_id,post_frame:-1})),this.frame_editor.open(this.displayed_post_id),this.container.down(".post-frames").hide(),e!=null&&this.frame_editor.focus(e)},BrowserView.prototype.hide_frame_editor=function(){this.frame_editor.discard(),this.container.down(".post-frames").show()};var Navigator=function(e,t){this.container=e,this.target=t,this.hovering=!1,this.autohide=!1,this.img=this.container.down(".image-navigator-img"),this.container.show(),this.handlers=[],this.handlers.push(this.container.on("mousedown",this.mousedown_event.bindAsEventListener(this))),this.handlers.push(this.container.on("mouseover",this.mouseover_event.bindAsEventListener(this))),this.handlers.push(this.container.on("mouseout",this.mouseout_event.bindAsEventListener(this))),this.dragger=new DragElement(this.container,{snap_pixels:0,onenddrag:this.enddrag.bind(this),ondrag:this.ondrag.bind(this)})};Navigator.prototype.set_image=function(e,t,n){this.img.src=e,this.img.width=t,this.img.height=n},Navigator.prototype.enable=function(e){this.container.show(e)},Navigator.prototype.mouseover_event=function(e){if(e.relatedTarget&&e.relatedTarget.isParentNode(this.container))return;debug("over "+e.target.className+", "+this.container.className+", "+e.target.isParentNode(this.container)),this.hovering=!0,this.update_visibility()},Navigator.prototype.mouseout_event=function(e){if(e.relatedTarget&&e.relatedTarget.isParentNode(this.container))return;debug("out "+e.target.className),this.hovering=!1,this.update_visibility()},Navigator.prototype.mousedown_event=function(e){var t=e.pointerX(),n=e.pointerY(),r=this.get_normalized_coords(t,n);this.center_on_position(r)},Navigator.prototype.enddrag=function(e){this.shift_lock_anchor=null,this.locked_to_x=null,this.update_visibility()},Navigator.prototype.ondrag=function(e){var t=this.get_normalized_coords(e.x,e.y);e.latest_event.shiftKey!=(this.shift_lock_anchor!=null)&&(e.latest_event.shiftKey?this.shift_lock_anchor=[t[0],t[1]]:(this.shift_lock_anchor=null,this.locked_to_x=null)),this.center_on_position(t)},Navigator.prototype.image_position_changed=function(e,t,n,r){var i=this.container.down(".navigator-cursor");i.setStyle({top:this.img.height*(t-n/2)+"px",left:this.img.width*(e-r/2)+"px",width:this.img.width*r+"px",height:this.img.height*n+"px"})},Navigator.prototype.get_normalized_coords=function(e,t){var n=this.img.cumulativeOffset();return e-=n.left,t-=n.top,e/=this.img.width,t/=this.img.height,[e,t]},Navigator.prototype.center_on_position=function(e){if(this.shift_lock_anchor){if(this.locked_to_x==null){var t=Math.abs(e[0]-this.shift_lock_anchor[0]),n=Math.abs(e[1]-this.shift_lock_anchor[1]);if(t>.1||n>.1)this.locked_to_x=t>n}this.locked_to_x!=null&&(this.locked_to_x?e[1]=this.shift_lock_anchor[1]:e[0]=this.shift_lock_anchor[0])}e[0]=Math.max(0,Math.min(e[0],1)),e[1]=Math.max(0,Math.min(e[1],1)),this.target.fire("viewer:center-on",{x:e[0],y:e[1]})},Navigator.prototype.set_autohide=function(e){this.autohide=e,this.update_visibility()},Navigator.prototype.update_visibility=function(){var e=this.container.down(".image-navigator-box"),t=!this.autohide||this.hovering||this.dragger.dragging;e.style.visibility=t?"visible":"hidden"},Navigator.prototype.destroy=function(){this.dragger.destroy(),this.handlers.each(function(e){e.stop()}),this.dragger=this.handlers=null,this.container.hide()};var DANBOORU_VERSION={major:1,minor:13,build:0};scale=function(e,t,n,r,i){return(e-t)*(i-r)/(n-t)+r},clamp=function(e,t,n){return Math.max(Math.min(e,n),t)};var ClearNoticeTimer,ClipRange=Class.create({initialize:function(e,t){if(e>t)throw"paramError";this.min=e,this.max=t},clip:function(e){return e<this.min?this.min:e>this.max?this.max:e}});Object.extend(Element,{appendChildBase:Element.appendChild,appendChild:function(e){return this.appendChildBase(e),e}}),Object.extend(Element.Methods,{showBase:Element.show,show:function(e,t){return t||t==null?$(e).showBase():$(e).hide()},setClassName:function(e,t,n){return n?$(e).addClassName(t):$(e).removeClassName(t)},pickClassName:function(e,t,n,r){$(e).setClassName(t,r),$(e).setClassName(n,!r)},isParentNode:function(e,t){while(e){if(e==t)return!0;e=e.parentNode}return!1},setTextContent:function(e,t){return e.innerText!=null?e.innerText=t:e.textContent=t,e},recursivelyVisible:function(e){while(e!=document.documentElement){if(!e.visible())return!1;e=e.parentNode}return!0}}),Element.addMethods();var KeysDown=new Hash;document.observe("blur",function(e){KeysDown=new Hash}),Element.addMethods("FORM",{simulate_submit:function(e){e=$(e);if(document.createEvent){var t=document.createEvent("HTMLEvents");t.initEvent("submit",!0,!0),e.dispatchEvent(t),t.stopped||e.submit()}else e.fireEvent("onsubmit")&&e.submit()}}),Element.addMethods({simulate_anchor_click:function(e,t){e=$(e),document.dispatchEvent?e.dispatchEvent(t)&&!t.stopped&&(window.location.href=e.href):e.fireEvent("onclick",t)&&(window.location.href=e.href)}}),clone_event=function(e){if(document.dispatchEvent){var t=document.createEvent("MouseEvent");return t.initMouseEvent(e.type,e.canBubble,e.cancelable,e.view,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget),Event.extend(t)}var t=document.createEventObject(e);return Event.extend(t)},Object.extend(String.prototype,{subst:function(e){var t=this;for(var n in e){var r=new RegExp("\\${"+n+"}","g"),i=e[n];i==null&&(i=""),t=t.replace(r,i)}return t},createElement:function(){var e=document.createElement("div");return e.innerHTML=this,e.removeChild(e.firstChild)}}),Ajax.Request.prototype.successBase=Ajax.Request.prototype.success,Ajax.Request.prototype.success=function(){try{if(this.transport.getAllResponseHeaders()==null)return!1}catch(e){return!1}return this.successBase()},Ajax.Responders.register({onException:function(e,t){var n="";e.url&&(n+="AJAX URL: "+e.url+"\n");try{var r=e.parameters;for(key in r){var i=r[key],s=i.length;i.length>1024&&(i=i.slice(0,1024)+"..."),n+="Parameter ("+s+"): "+key+"="+i+"\n"}}catch(o){n+="Couldn't get response parameters: "+o+"\n"}try{var i=e.transport.responseText,s=i.length;i.length>1024&&(i=i.slice(0,1024)+"..."),n+="Response ("+s+"): ->"+i+"<-\n"}catch(o){n+="Couldn't get response text: "+o+"\n"}ReportError(null,null,null,t,n),function(){throw t}.defer()}}),Prototype.Browser.Gecko&&(Function.prototype.bindAsEventListener=function(){var e=this,t=$A(arguments),n=t.shift();return function(r){try{return e.apply(n,[r||window.event].concat(t))}catch(i){(function(){throw i}).defer()}}}),window.onerror=function(e,t,n){ReportError(e,t,n,null)},sort_array_by_distance=function(e,t){var n=[];n.push(e[t]);for(var r=1;;++r){var i=n.length;t-r>=0&&n.push(e[t-r]),t+r<e.length&&n.push(e[t+r]);if(i==n.length)break}return n},distance_squared=function(e,t,n,r){return Math.pow(e-n,2)+Math.pow(t-r,2)},getWindowSize=function(){var e={};return window.innerWidth!=null?(e.width=window.innerWidth,e.height=window.innerHeight):(e.width=document.documentElement.clientWidth,e.height=document.documentElement.clientHeight),e},create_canvas_2d=function(){var e=document.createElement("canvas");return e.getContext&&e.getContext("2d")?e:null},Prototype.Browser.AndroidWebKit=navigator.userAgent.indexOf("Android")!=-1&&navigator.userAgent.indexOf("WebKit")!=-1,Prototype.BrowserFeatures.Touchscreen=function(){return window.Touch?!0:navigator.userAgent.indexOf("Mobile Safari/")!=-1?!0:navigator.userAgent.indexOf("Mobile/")!=-1?!0:!1}(),DragElement=function(e,t){$(document.body).addClassName("not-dragging"),this.options=t||{},this.options.snap_pixels==null&&(this.options.snap_pixels=10),this.ignore_mouse_events_until=null,this.mousemove_event=this.mousemove_event.bindAsEventListener(this),this.mousedown_event=this.mousedown_event.bindAsEventListener(this),this.dragstart_event=this.dragstart_event.bindAsEventListener(this),this.mouseup_event=this.mouseup_event.bindAsEventListener(this),this.click_event=this.click_event.bindAsEventListener(this),this.selectstart_event=this.selectstart_event.bindAsEventListener(this),this.touchmove_event=this.touchmove_event.bindAsEventListener(this),this.touchstart_event=this.touchstart_event.bindAsEventListener(this),this.touchend_event=this.touchend_event.bindAsEventListener(this),this.move_timer_update=this.move_timer_update.bind(this),this.element=e,this.dragging=!1,this.drag_handlers=[],this.handlers=[],t.no_mouse||(this.handlers.push(e.on("mousedown",this.mousedown_event)),this.handlers.push(e.on("dragstart",this.dragstart_event))),t.no_touch||(this.handlers.push(e.on("touchstart",this.touchstart_event)),this.handlers.push(e.on("touchmove",this.touchmove_event))),Prototype.Browser.WebKit||this.handlers.push(e.on("click",this.click_event))},DragElement.prototype.destroy=function(){this.stop_dragging(null,!0),this.handlers.each(function(e){e.stop()}),this.handlers=[]},DragElement.prototype.move_timer_update=function(){this.move_timer=null;if(!this.options.ondrag)return;if(this.last_event_params==null)return;var e=this.last_event_params;this.last_event_params=null;var t=e.x,n=e.y,r=t-this.anchor_x,i=n-this.anchor_y,s=t-this.last_x,o=n-this.last_y;this.last_x=t,this.last_y=n,this.options.ondrag&&this.options.ondrag({dragger:this,x:t,y:n,aX:r,aY:i,dX:s,dY:o,latest_event:e.event})},DragElement.prototype.mousemove_event=function(e){e.stop();var t=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,n=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,r=e.pointerX()-t,i=e.pointerY()-n;this.handle_move_event(e,r,i)},DragElement.prototype.touchmove_event=function(e){var t=null;for(var n=0;n<e.changedTouches.length;++n){var r=e.changedTouches[n];if(r.identifier==this.dragging_touch_identifier){t=r;break}}if(t==null)return;e.preventDefault();if(!window.navigator.standalone&&t.pageY>window.innerHeight-10){debug("Dragged off the bottom"),this.stop_dragging(e,!0);return}var i=t.pageX,s=t.pageY;this.handle_move_event(e,i,s)},DragElement.prototype.handle_move_event=function(e,t,n){if(!this.dragging)return;if(!this.dragged){var r=Math.pow(t-this.anchor_x,2)+Math.pow(n-this.anchor_y,2),i=this.options.snap_pixels;i*=i;if(r<i)return}if(!this.dragged){if(this.options.onstartdrag&&this.options.onstartdrag({handler:this,latest_event:e})){this.dragging=!1;return}this.dragged=!0,$(document.body).addClassName(this.overriden_drag_class||"dragging"),$(document.body).removeClassName("not-dragging")}this.last_event_params={x:t,y:n,event:e},this.dragging_by_touch&&Prototype.Browser.AndroidWebKit?this.move_timer==null&&(this.move_timer=window.setTimeout(this.move_timer_update,10)):this.move_timer_update()},DragElement.prototype.mousedown_event=function(e){if(!e.isLeftClick())return;if(this.ignore_mouse_events_until!=null){var t=(new Date).valueOf();if(t<this.ignore_mouse_events_until)return;this.ignore_mouse_events_until=null}var n=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,r=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,i=e.pointerX()-n,s=e.pointerY()-r;this.start_dragging(e,!1,i,s,0)},DragElement.prototype.touchstart_event=function(e){var t=null;for(var n=0;n<e.changedTouches.length;++n){var r=e.changedTouches[n];if(!r.target.isParentNode(this.element))continue;t=r;break}if(t==null)return;var i=t.pageX,s=t.pageY;this.start_dragging(e,!0,i,s,t.identifier)},DragElement.prototype.start_dragging=function(e,t,n,r,i){if(this.dragging_touch_identifier!=null)return;this.drag_handlers.push(document.on("selectstart",this.selectstart_event)),this.drag_handlers.push(Element.on(window,"pagehide",this.pagehide_event.bindAsEventListener(this))),t?(this.drag_handlers.push(document.on("touchend",this.touchend_event)),this.drag_handlers.push(document.on("touchcancel",this.touchend_event)),this.drag_handlers.push(document.on("touchmove",this.touchmove_event))):(this.drag_handlers.push(document.on("mouseup",this.mouseup_event)),this.drag_handlers.push(document.on("mousemove",this.mousemove_event))),this.dragging=!0,this.dragged=!1,this.dragging_by_touch=t,this.dragging_touch_identifier=i,this.anchor_x=n,this.anchor_y=r,this.last_x=this.anchor_x,this.last_y=this.anchor_y,this.options.ondown&&this.options.ondown({dragger:this,x:n,y:r,latest_event:e})},DragElement.prototype.pagehide_event=function(e){this.stop_dragging(e,!0)},DragElement.prototype.touchend_event=function(e){for(var t=0;t<e.changedTouches.length;++t){var n=e.changedTouches[t];if(n.identifier==this.dragging_touch_identifier){this.stop_dragging(e,e.type=="touchcancel"),this.ignore_mouse_events_until=(new Date).valueOf()+500;return}}},DragElement.prototype.mouseup_event=function(e){if(!e.isLeftClick())return;this.stop_dragging(e,!1)},DragElement.prototype.stop_dragging=function(e,t){this.dragging&&(this.dragging=!1,$(document.body).removeClassName(this.overriden_drag_class||"dragging"),$(document.body).addClassName("not-dragging"),this.options.onenddrag&&this.options.onenddrag(this)),this.drag_handlers.each(function(e){e.stop()}),this.drag_handlers=[],this.dragging_touch_identifier=null,this.options.onup&&this.options.onup({dragger:this,latest_event:e,cancelling:t})},DragElement.prototype.click_event=function(e){this.dragged&&e.stop(),this.dragged=!1},DragElement.prototype.dragstart_event=function(e){e.preventDefault()},DragElement.prototype.selectstart_event=function(e){e.target.tagName!="INPUT"&&e.stop()},WindowDragElement=function(e){this.element=e,this.dragger=new DragElement(e,{no_touch:!0,ondrag:this.ondrag.bind(this),onstartdrag:this.startdrag.bind(this)})},WindowDragElement.prototype.startdrag=function(){this.scroll_anchor_x=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,this.scroll_anchor_y=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop},WindowDragElement.prototype.ondrag=function(e){var t=this.scroll_anchor_x-e.aX,n=this.scroll_anchor_y-e.aY;scrollTo(t,n)},WindowDragElementAbsolute=function(e,t){this.element=e,this.ondrag_callback=t,this.disabled=!1,this.dragger=new DragElement(e,{ondrag:this.ondrag.bind(this),onstartdrag:this.startdrag.bind(this)})},WindowDragElementAbsolute.prototype.set_disabled=function(e){this.disabled=e},WindowDragElementAbsolute.prototype.startdrag=function(){return this.disabled?!0:(this.scroll_anchor_x=this.element.offsetLeft,this.scroll_anchor_y=this.element.offsetTop,!1)},WindowDragElementAbsolute.prototype.ondrag=function(e){var t=this.scroll_anchor_x+e.aX,n=this.scroll_anchor_y+e.aY,r=getWindowSize(),i=Math.min(100,this.element.offsetWidth);t=Math.max(t,i-this.element.offsetWidth),t=Math.min(t,r.width-i);var i=Math.min(100,this.element.offsetHeight);n=Math.max(n,i-this.element.offsetHeight),n=Math.min(n,r.height-i),this.element.setStyle({left:t+"px",top:n+"px"}),this.ondrag_callback&&this.ondrag_callback()},WindowDragElementAbsolute.prototype.destroy=function(){this.dragger.destroy()};var reported_error=!1;!("URL"in window)&&"webkitURL"in window&&(window.URL=window.webkitURL),"createObjectURL"in window&&!("URL"in window)&&(window.URL={createObjectURL:function(e){return window.createObjectURL(e)},revokeObjectURL:function(e){window.revokeObjectURL(e)}}),navigator.userAgent.indexOf("AppleWebKit/")!=-1&&(document.documentElement.className+=" webkit");var CropDraggable=Class.create();Object.extend(Object.extend(CropDraggable.prototype,Draggable.prototype),{initialize:function(e){this.options=Object.extend({drawMethod:function(){}},arguments[1]||{}),this.element=$(e),this.handle=this.element,this.delta=this.currentDelta(),this.dragging=!1,this.eventMouseDown=this.initDrag.bindAsEventListener(this),Event.observe(this.handle,"mousedown",this.eventMouseDown),Draggables.register(this)},draw:function(e){var t=Position.cumulativeOffset(this.element),n=this.currentDelta();t[0]-=n[0],t[1]-=n[1];var r=[0,1].map(function(n){return e[n]-t[n]-this.offset[n]}.bind(this));this.options.drawMethod(r)}});var Cropper={};Cropper.Img=Class.create(),Cropper.Img.prototype={initialize:function(e,t){this.options=Object.extend({ratioDim:{x:0,y:0},minWidth:0,minHeight:0,displayOnInit:!1,onEndCrop:Prototype.emptyFunction,captureKeys:!0,onloadCoords:null,maxWidth:0,maxHeight:0},t||{}),this.img=$(e),this.clickCoords={x:0,y:0},this.dragging=!1,this.resizing=!1,this.isWebKit=/Konqueror|Safari|KHTML/.test(navigator.userAgent),this.isIE=/MSIE/.test(navigator.userAgent),this.isOpera8=/Opera\s[1-8]/.test(navigator.userAgent),this.ratioX=0,this.ratioY=0,this.attached=!1,this.fixedWidth=this.options.maxWidth>0&&this.options.minWidth>=this.options.maxWidth,this.fixedHeight=this.options.maxHeight>0&&this.options.minHeight>=this.options.maxHeight;if(typeof this.img=="undefined")return;if(this.options.ratioDim.x>0&&this.options.ratioDim.y>0){var n=this.getGCD(this.options.ratioDim.x,this.options.ratioDim.y);this.ratioX=this.options.ratioDim.x/n,this.ratioY=this.options.ratioDim.y/n}this.subInitialize(),this.img.complete||this.isWebKit?this.onLoad():Event.observe(this.img,"load",this.onLoad.bindAsEventListener(this))},getGCD:function(e,t){return t==0?e:this.getGCD(t,e%t)},onLoad:function(){var e="imgCrop_",t=this.img.parentNode,n="";this.isOpera8&&(n=" opera8"),this.imgWrap=Builder.node("div",{"class":e+"wrap"+n}),this.north=Builder.node("div",{"class":e+"overlay "+e+"north"},[Builder.node("span")]),this.east=Builder.node("div",{"class":e+"overlay "+e+"east"},[Builder.node("span")]),this.south=Builder.node("div",{"class":e+"overlay "+e+"south"},[Builder.node("span")]),this.west=Builder.node("div",{"class":e+"overlay "+e+"west"},[Builder.node("span")]);var r=[this.north,this.east,this.south,this.west];this.dragArea=Builder.node("div",{"class":e+"dragArea"},r),this.handleN=Builder.node("div",{"class":e+"handle "+e+"handleN"}),this.handleNE=Builder.node("div",{"class":e+"handle "+e+"handleNE"}),this.handleE=Builder.node("div",{"class":e+"handle "+e+"handleE"}),this.handleSE=Builder.node("div",{"class":e+"handle "+e+"handleSE"}),this.handleS=Builder.node("div",{"class":e+"handle "+e+"handleS"}),this.handleSW=Builder.node("div",{"class":e+"handle "+e+"handleSW"}),this.handleW=Builder.node("div",{"class":e+"handle "+e+"handleW"}),this.handleNW=Builder.node("div",{"class":e+"handle "+e+"handleNW"}),this.selArea=Builder.node("div",{"class":e+"selArea"},[Builder.node("div",{"class":e+"marqueeHoriz "+e+"marqueeNorth"},[Builder.node("span")]),Builder.node("div",{"class":e+"marqueeVert "+e+"marqueeEast"},[Builder.node("span")]),Builder.node("div",{"class":e+"marqueeHoriz "+e+"marqueeSouth"},[Builder.node("span")]),Builder.node("div",{"class":e+"marqueeVert "+e+"marqueeWest"},[Builder.node("span")]),this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW,Builder.node("div",{"class":e+"clickArea"})]),this.imgWrap.appendChild(this.img),this.imgWrap.appendChild(this.dragArea),this.dragArea.appendChild(this.selArea),this.dragArea.appendChild(Builder.node("div",{"class":e+"clickArea"})),t.appendChild(this.imgWrap),this.startDragBind=this.startDrag.bindAsEventListener(this),Event.observe(this.dragArea,"mousedown",this.startDragBind),this.onDragBind=this.onDrag.bindAsEventListener(this),Event.observe(document,"mousemove",this.onDragBind),this.endCropBind=this.endCrop.bindAsEventListener(this),Event.observe(document,"mouseup",this.endCropBind),this.resizeBind=this.startResize.bindAsEventListener(this),this.handles=[this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW],this.registerHandles(!0),this.options.captureKeys&&(this.keysBind=this.handleKeys.bindAsEventListener(this),Event.observe(document,"keypress",this.keysBind)),new CropDraggable(this.selArea,{drawMethod:this.moveArea.bindAsEventListener(this)}),this.setParams()},registerHandles:function(e){for(var t=0;t<this.handles.length;t++){var n=$(this.handles[t]);if(e){var r=!1;if(this.fixedWidth&&this.fixedHeight)r=!0;else if(this.fixedWidth||this.fixedHeight){var i=n.className.match(/([S|N][E|W])$/),s=n.className.match(/(E|W)$/),o=n.className.match(/(N|S)$/);i?r=!0:this.fixedWidth&&s?r=!0:this.fixedHeight&&o&&(r=!0)}r?n.hide():Event.observe(n,"mousedown",this.resizeBind)}else n.show(),Event.stopObserving(n,"mousedown",this.resizeBind)}},setParams:function(){this.imgW=this.img.width,this.imgH=this.img.height,$(this.north).setStyle({height:0}),$(this.east).setStyle({width:0,height:0}),$(this.south).setStyle({height:0}),$(this.west).setStyle({width:0,height:0}),$(this.imgWrap).setStyle({width:this.imgW+"px",height:this.imgH+"px"}),$(this.selArea).hide();var e={x1:0,y1:0,x2:0,y2:0},t=!1;this.options.onloadCoords!=null?(e=this.cloneCoords(this.options.onloadCoords),t=!0):this.options.ratioDim.x>0&&this.options.ratioDim.y>0&&(e.x1=Math.ceil((this.imgW-this.options.ratioDim.x)/2),e.y1=Math.ceil((this.imgH-this.options.ratioDim.y)/2),e.x2=e.x1+this.options.ratioDim.x,e.y2=e.y1+this.options.ratioDim.y,t=!0),this.setAreaCoords(e,!1,!1,1),this.options.displayOnInit&&t&&(this.selArea.show(),this.drawArea(),this.endCrop()),this.attached=!0},remove:function(){this.attached&&(this.attached=!1,this.imgWrap.parentNode.insertBefore(this.img,this.imgWrap),this.imgWrap.parentNode.removeChild(this.imgWrap),Event.stopObserving(this.dragArea,"mousedown",this.startDragBind),Event.stopObserving(document,"mousemove",this.onDragBind),Event.stopObserving(document,"mouseup",this.endCropBind),this.registerHandles(!1),this.options.captureKeys&&Event.stopObserving(document,"keypress",this.keysBind))},reset:function(){this.attached?this.setParams():this.onLoad(),this.endCrop()},handleKeys:function(e){var t={x:0,y:0};if(!this.dragging&&!e.altKey){switch(e.keyCode){case 37:t.x=-1;break;case 38:t.y=-1;break;case 39:t.x=1;break;case 40:t.y=1}if(t.x!=0||t.y!=0)e.shiftKey&&(t.x*=10,t.y*=10),this.moveArea([this.areaCoords.x1+t.x,this.areaCoords.y1+t.y]),Event.stop(e)}},calcW:function(){return this.areaCoords.x2-this.areaCoords.x1},calcH:function(){return this.areaCoords.y2-this.areaCoords.y1},moveArea:function(e){this.setAreaCoords({x1:e[0],y1:e[1],x2:e[0]+this.calcW(),y2:e[1]+this.calcH()},!0,!1),this.drawArea()},cloneCoords:function(e){return{x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2}},setAreaCoords:function(e,t,n,r,i){if(t){var s=e.x2-e.x1,o=e.y2-e.y1;e.x1<0&&(e.x1=0,e.x2=s),e.y1<0&&(e.y1=0,e.y2=o),e.x2>this.imgW&&(e.x2=this.imgW,e.x1=this.imgW-s),e.y2>this.imgH&&(e.y2=this.imgH,e.y1=this.imgH-o)}else{e.x1<0&&(e.x1=0),e.y1<0&&(e.y1=0),e.x2>this.imgW&&(e.x2=this.imgW),e.y2>this.imgH&&(e.y2=this.imgH);if(r!=null){this.ratioX>0?this.applyRatio(e,{x:this.ratioX,y:this.ratioY},r,i):n&&this.applyRatio(e,{x:1,y:1},r,i);var u=[this.options.minWidth,this.options.minHeight],a=[this.options.maxWidth,this.options.maxHeight];if(u[0]>0||u[1]>0||a[0]>0||a[1]>0){var f={a1:e.x1,a2:e.x2},l={a1:e.y1,a2:e.y2},c={min:0,max:this.imgW},h={min:0,max:this.imgH};(u[0]!=0||u[1]!=0)&&n&&(u[0]>0?u[1]=u[0]:u[1]>0&&(u[0]=u[1])),(a[0]!=0||a[0]!=0)&&n&&(a[0]>0&&a[0]<=a[1]?a[1]=a[0]:a[1]>0&&a[1]<=a[0]&&(a[0]=a[1])),u[0]>0&&this.applyDimRestriction(f,u[0],r.x,c,"min"),u[1]>1&&this.applyDimRestriction(l,u[1],r.y,h,"min"),a[0]>0&&this.applyDimRestriction(f,a[0],r.x,c,"max"),a[1]>1&&this.applyDimRestriction(l,a[1],r.y,h,"max"),e={x1:f.a1,y1:l.a1,x2:f.a2,y2:l.a2}}}}this.areaCoords=e},applyDimRestriction:function(e,t,n,r,i){var s;i=="min"?s=e.a2-e.a1<t:s=e.a2-e.a1>t,s&&(n==1?e.a2=e.a1+t:e.a1=e.a2-t,e.a1<r.min?(e.a1=r.min,e.a2=t):e.a2>r.max&&(e.a1=r.max-t,e.a2=r.max))},applyRatio:function(e,t,n,r){var i;r=="N"||r=="S"?(i=this.applyRatioToAxis({a1:e.y1,b1:e.x1,a2:e.y2,b2:e.x2},{a:t.y,b:t.x},{a:n.y,b:n.x},{min:0,max:this.imgW}),e.x1=i.b1,e.y1=i.a1,e.x2=i.b2,e.y2=i.a2):(i=this.applyRatioToAxis({a1:e.x1,b1:e.y1,a2:e.x2,b2:e.y2},{a:t.x,b:t.y},{a:n.x,b:n.y},{min:0,max:this.imgH}),e.x1=i.a1,e.y1=i.b1,e.x2=i.a2,e.y2=i.b2)},applyRatioToAxis:function(e,t,n,r){var i=Object.extend(e,{}),s=i.a2-i.a1,o=Math.floor(s*t.b/t.a),u,a,f=null;return n.b==1?(u=i.b1+o,u>r.max&&(u=r.max,f=u-i.b1),i.b2=u):(u=i.b2-o,u<r.min&&(u=r.min,f=u+i.b2),i.b1=u),f!=null&&(a=Math.floor(f*t.a/t.b),n.a==1?i.a2=i.a1+a:i.a1=i.a1=i.a2-a),i},drawArea:function(){var e=this.calcW(),t=this.calcH(),n="px",r=[this.areaCoords.x1+n,this.areaCoords.y1+n,e+n,t+n,this.areaCoords.x2+n,this.areaCoords.y2+n,this.img.width-this.areaCoords.x2+n,this.img.height-this.areaCoords.y2+n],i=this.selArea.style;i.left=r[0],i.top=r[1],i.width=r[2],i.height=r[3];var s=Math.ceil((e-6)/2)+n,o=Math.ceil((t-6)/2)+n;this.handleN.style.left=s,this.handleE.style.top=o,this.handleS.style.left=s,this.handleW.style.top=o,this.north.style.height=r[1];var u=this.east.style;u.top=r[1],u.height=r[3],u.left=r[4],u.width=r[6];var a=this.south.style;a.top=r[5],a.height=r[7];var f=this.west.style;f.top=r[1],f.height=r[3],f.width=r[0],this.subDrawArea(),this.forceReRender()},forceReRender:function(){if(this.isIE||this.isWebKit){var e=document.createTextNode(" "),t,n,r,i;if(this.isIE)fixEl=this.selArea;else if(this.isWebKit){fixEl=document.getElementsByClassName("imgCrop_marqueeSouth",this.imgWrap)[0],t=Builder.node("div",""),t.style.visibility="hidden";var s=["SE","S","SW"];for(i=0;i<s.length;i++)n=document.getElementsByClassName("imgCrop_handle"+s[i],this.selArea)[0],n.childNodes.length&&n.removeChild(n.childNodes[0]),n.appendChild(t)}fixEl.appendChild(e),fixEl.removeChild(e)}},startResize:function(e){this.startCoords=this.cloneCoords(this.areaCoords),this.resizing=!0,this.resizeHandle=Event.element(e).classNames().toString().replace(/([^N|NE|E|SE|S|SW|W|NW])+/,""),Event.stop(e)},startDrag:function(e){this.selArea.show(),this.clickCoords=this.getCurPos(e),this.setAreaCoords({x1:this.clickCoords.x,y1:this.clickCoords.y,x2:this.clickCoords.x,y2:this.clickCoords.y},!1,!1,null),this.dragging=!0,this.onDrag(e),Event.stop(e)},getCurPos:function(e){var t=this.imgWrap,n=Position.cumulativeOffset(t);while(t.nodeName!="BODY")n[1]-=t.scrollTop||0,n[0]-=t.scrollLeft||0,t=t.parentNode;return curPos={x:Event.pointerX(e)-n[0],y:Event.pointerY(e)-n[1]}},onDrag:function(e){if(this.dragging||this.resizing){var t=null,n=this.getCurPos(e),r=this.cloneCoords(this.areaCoords),i={x:1,y:1};this.dragging?(n.x<this.clickCoords.x&&(i.x=-1),n.y<this.clickCoords.y&&(i.y=-1),this.transformCoords(n.x,this.clickCoords.x,r,"x"),this.transformCoords(n.y,this.clickCoords.y,r,"y")):this.resizing&&(t=this.resizeHandle,t.match(/E/)?(this.transformCoords(n.x,this.startCoords.x1,r,"x"),n.x<this.startCoords.x1&&(i.x=-1)):t.match(/W/)&&(this.transformCoords(n.x,this.startCoords.x2,r,"x"),n.x<this.startCoords.x2&&(i.x=-1)),t.match(/N/)?(this.transformCoords(n.y,this.startCoords.y2,r,"y"),n.y<this.startCoords.y2&&(i.y=-1)):t.match(/S/)&&(this.transformCoords(n.y,this.startCoords.y1,r,"y"),n.y<this.startCoords.y1&&(i.y=-1))),this.setAreaCoords(r,!1,e.shiftKey,i,t),this.drawArea(),Event.stop(e)}},transformCoords:function(e,t,n,r){var i=[e,t];e>t&&i.reverse(),n[r+"1"]=i[0],n[r+"2"]=i[1]},endCrop:function(){this.dragging=!1,this.resizing=!1,this.options.onEndCrop(this.areaCoords,{width:this.calcW(),height:this.calcH()})},subInitialize:function(){},subDrawArea:function(){}},Cropper.ImgWithPreview=Class.create(),Object.extend(Object.extend(Cropper.ImgWithPreview.prototype,Cropper.Img.prototype),{subInitialize:function(){this.hasPreviewImg=!1,typeof this.options.previewWrap!="undefined"&&(this.previewWrap=$(this.options.previewWrap),this.previewImg=this.img.cloneNode(!1),this.previewImg.id="imgCrop_"+this.previewImg.id,this.previewWrap.hide(),this.options.displayOnInit=!0,this.hasPreviewImg=!0,this.previewWrap.addClassName("imgCrop_previewWrap"),this.options.resizePreview||this.previewWrap.setStyle({width:this.options.minWidth+"px",height:this.options.minHeight+"px"}),this.previewWrap.appendChild(this.previewImg))},subDrawArea:function(){if(this.hasPreviewImg){var e=this.calcW(),t=this.calcH();if(e==0||t==0){this.previewWrap.hide();return}var n;if(this.options.resizePreview){n=this.options.resizePreview({x:e,y:t});var r=this.previewWrap.style;r.width=n.x+"px",r.height=n.y+"px"}else n={x:this.options.minWidth,y:this.options.minHeight};var i={x:this.imgW/e,y:this.imgH/t},s={x:e/n.x,y:t/n.y},o={w:Math.ceil(n.x*i.x)+"px",h:Math.ceil(n.y*i.y)+"px",x:"-"+Math.ceil(this.areaCoords.x1/s.x)+"px",y:"-"+Math.ceil(this.areaCoords.y1/s.y)+"px"},u=this.previewImg.style;u.width=o.w,u.height=o.h,u.left=o.x,u.top=o.y,this.previewWrap.show()}}}),DebugWindow=function(){this.shown=!1,this.log_data=[],this.hooks=[],this.counter=0,this.update=
this.update.bind(this),this.hashchange_debug=this.hashchange_debug.bind(this),UrlHash.observe("debug",this.hashchange_debug),this.hashchange_debug(),this.log("*** Started")},DebugWindow.prototype.create_container=function(){if(this.container)return;var e=document.createElement("DIV");e=$(e),e.className="debug-box",e.setStyle({position:"fixed",top:"0px",right:"0px",height:"25%",backgroundColor:"#000",fontSize:"100%"}),document.body.appendChild(e),this.container=e,this.shown_debug=""},DebugWindow.prototype.destroy_container=function(){if(!this.container)return;document.body.removeChild(this.container),this.container=null},DebugWindow.prototype.log=function(e){window.console&&window.console.log&&console.log(e),++this.counter,this.log_data.push(this.counter+": "+e);var t=10;this.log_data.length>t&&(this.log_data=this.log_data.slice(1,t+1)),this.shown&&this.update.defer()},DebugWindow.prototype.hashchange_debug=function(){var e=UrlHash.get("debug");e==null&&(e="0"),e=e=="1";if(e==this.shown)return;this.shown=e,e?this.create_container():this.destroy_container(),this.update()},DebugWindow.prototype.add_hook=function(e){this.hooks.push(e)},DebugWindow.prototype.update=function(){if(!this.container)return;var e="";for(var t=0;t<this.hooks.length;++t){var n=this.hooks[t];e+=n()+"<br>"}e+=this.log_data.join("<br>");if(e==this.shown_debug)return;this.shown_debug=e,this.container.update(e)},NewDebug=function(){var e=new DebugWindow,t=e.log.bind(e);return t.handler=e,t},History={last_click:-1,checked:[],dragging:!1,init:function(){$("history").observe("mousedown",function(e){e.shiftKey||(History.last_click=-1),History.mouse_is_down(),e.stopPropagation(),e.preventDefault()},!0),History.update()},add_change:function(e,t,n,r,i){History.checked.push({id:e,ids:r,group_by_type:t,group_by_id:n,user_id:i,on:!1,row:$("r"+e)}),$("r"+e).observe("mousedown",function(t){History.mousedown(e,t),!0}),$("r"+e).observe("mouseover",function(t){History.mouseover(e,t),!0}),$("r"+e).down(".id")&&$("r"+e).down(".id").observe("click",function(t){History.id_click(e)}),$("r"+e).down(".author").observe("click",function(t){History.author_click(e)}),$("r"+e).down(".change").observe("click",function(t){History.change_click(e)})},update:function(){for(i=0;i<History.checked.length;++i){var e=History.checked[i].row;History.checked[i].on?e.addClassName("selected"):e.removeClassName("selected")}History.count_selected()>0?($("undo").removeClassName("footer-disabled"),$("redo").removeClassName("footer-disabled")):($("undo").addClassName("footer-disabled"),$("redo").addClassName("footer-disabled"))},id_click:function(e,t){e=History.get_row_by_id(e),$("search").value=History.checked[e].group_by_type.toLowerCase()+":"+History.checked[e].group_by_id},author_click:function(e,t){e=History.get_row_by_id(e),$("search").value="user:"+History.checked[e].user_id},change_click:function(e,t){e=History.get_row_by_id(e),$("search").value="change:"+History.checked[e].id},count_selected:function(){ret=0;for(i=0;i<History.checked.length;++i)History.checked[i].on&&++ret;return ret},get_first_selected_row:function(){for(i=0;i<History.checked.length;++i)if(History.checked[i].on)return i;return null},get_row_by_id:function(e){for(i=0;i<History.checked.length;++i)if(History.checked[i].id==e)return i;return-1},set:function(e,t,n){i=e;for(;;){History.checked[i].on=n;if(i==t)break;i+=t>e?1:-1}},doc_mouseup:function(e){History.dragging=!1,document.stopObserving("mouseup",History.doc_mouseup)},mouse_is_down:function(){History.dragging=!0,document.observe("mouseup",History.doc_mouseup)},mousedown:function(e,t){if(!Event.isLeftClick(t))return;History.mouse_is_down();var n=History.get_row_by_id(e);if(n==-1)return;var r=null,i=null;History.last_click!=-1&&t.shiftKey?(r=History.last_click,i=n):(r=i=History.last_click=n,History.checked[n].on=!History.checked[n].on);var s=History.checked[r].on;t.ctrlKey||History.set(0,History.checked.length-1,!1),History.set(r,i,s),History.update(),t.stopPropagation(),t.preventDefault()},mouseover:function(e,t){var n=History.get_row_by_id(e);if(n==-1)return;History.last_click==-1&&(History.last_click=n);if(!History.dragging)return;History.set(0,History.checked.length-1,!1),first=History.last_click,last=n,this_click=n,History.set(first,last,!0),History.update()},undo:function(e){if(History.count_selected()==0)return;var t=[];for(i=0;i<History.checked.length;++i){if(!History.checked[i].on)continue;t=t.concat(History.checked[i].ids)}e?notice("Reapplying..."):notice("Undoing..."),new Ajax.Request("/history/undo.json",{parameters:{id:t.join(","),redo:e?1:0},onComplete:function(t){var t=t.responseJSON;if(t.success){var n=t.errors;t.successful>0&&n.unshift(e?"Changes reapplied.":"Changes undone."),notice(n.join("<br>"))}else notice("Error: "+t.reason)}})}},InlineImage={mouse_down:null,zoom_levels:[1,1.5,2,4],get_zoom:function(e){return e>=0?InlineImage.zoom_levels[e]:1/InlineImage.zoom_levels[-e]},register:function(e,t){var n=$(e);t.html_id=e,n.inline_image=t,t.initted=!1,t.expanded=!1,t.toggled_from=null,t.current=-1,t.zoom_level=0;var r="";if(t.images.length>1)for(var i=0;i<t.images.length;++i){var s=t.html_id+"-"+i,o=t.images[i].description.escapeHTML();o==""&&(o="#"+(i+1)),r+="<a href='#' id='"+s+"' class='select-image' onclick='InlineImage.show_image_no(\""+t.html_id+'", '+i+"); return false;'>"+o+"</a>"}r+="<a href='#' class='select-image' onclick='InlineImage.zoom(\""+t.html_id+"\", +1); return false;'>+</a>",r+="<a href='#' class='select-image' onclick='InlineImage.zoom(\""+t.html_id+"\", -1); return false;'>-</a>";var u=t.html_id+"-zoom";r+="<a href='#' id='"+u+"' class='select-image' onclick='InlineImage.zoom(\""+t.html_id+"\", 0); return false;'>100%</a>",r+="<a href='#' class='select-image' onclick='InlineImage.close(\""+t.html_id+"\"); return false;'>Close</a>",r+="<a href='/inline/edit/"+t.id+"' class='edit-link'>Image&nbsp;#"+t.id+"</a>",n.down(".expanded-image-ui").innerHTML=r,n.down(".inline-thumb").observe("click",function(e){e.stop(),InlineImage.expand(t.html_id)}),n.observe("dblclick",function(e){e.stop()});var a=n.down(".main-inline-image");t.images.length>1&&a.addClassName("clickable"),a.observe("mousedown",function(e){if(e.button!=0)return;t.toggled_from=t.current;var n=(t.current+1)%t.images.length;InlineImage.show_image_no(t.html_id,n),InlineImage.mouse_down=t,e.stop()})},init:function(){document.observe("mouseup",function(e){if(e.button!=0)return;if(InlineImage.mouse_down==null)return;e.stop();var t=InlineImage.mouse_down;InlineImage.mouse_down=null,InlineImage.show_image_no(t.html_id,t.toggled_from),t.toggled_from=null})},expand:function(e){var t=$(e),n=t.inline_image;n.expanded=!0;if(!n.initted){n.initted=!0;var r=n.images,i="";for(var s=0;s<n.images.length;++s){var o=r[s],u,a,f;o.sample_width?f=o.sample_url:f=o.file_url;var l=n.html_id+"-img-"+s;i+="<img src='"+f+"' id='"+l+"' width="+u+" height="+a+" style='display: none;'>"}var c=t.down(".main-inline-image");c.innerHTML=i}t.down(".inline-thumb").hide(),InlineImage.show_image_no(n.html_id,0),t.down(".expanded-image").show()},close:function(e){var t=$(e),n=t.inline_image;n.expanded=!1,t.down(".expanded-image").hide(),t.down(".inline-thumb").show()},show_image_no:function(e,t){var n=$(e),r=n.inline_image,i=r.images,s=i[t],o=InlineImage.get_zoom(r.zoom_level),u,a;s.sample_width?(u=s.sample_width*o,a=s.sample_height*o):(u=s.width*o,a=s.height*o),u=u.toFixed(0),a=a.toFixed(0);if(r.current!=t){var f=r.html_id+"-img-"+r.current,l=$(f);l&&l.hide()}var c=r.html_id+"-img-"+t,h=$(c);h&&(h.width=u,h.height=a,h.show());if(r.current!=t){var p=$(r.html_id+"-"+t);p&&p.addClassName("selected-image-tab");var d=$(r.html_id+"-"+r.current);d&&d.removeClassName("selected-image-tab"),r.current=t}},zoom:function(e,t){var n=$(e),r=n.inline_image;t==0?r.zoom_level=0:r.zoom_level+=t,r.zoom_level>InlineImage.zoom_levels.length-1&&(r.zoom_level=InlineImage.zoom_levels.length-1),r.zoom_level<-InlineImage.zoom_levels.length+1&&(r.zoom_level=-InlineImage.zoom_levels.length+1);var i=r.html_id+"-zoom",s=InlineImage.get_zoom(r.zoom_level)*100;$(i).update(s.toFixed(0)+"%"),InlineImage.show_image_no(e,r.current)}};var align_element_to_menu=function(e,t){var n=t.cumulativeOffset(),r=n.left-3,i=e.offsetWidth+n.left,s=i-document.body.offsetWidth;s>0&&(r-=s),e.style.left=r+"px";var o=n.top;if(t.getBoundingClientRect){var u=t.getBoundingClientRect().bottom-t.getBoundingClientRect().top;o+=u}else o+=t.scrollHeight;e.style.top=o+"px"};MainMenu.prototype.get_elem_for_top_item=function(e){return this.container.down(".top-item-"+e.name)},MainMenu.prototype.init=function(){for(var e=0;e<this.def.length;++e){var t=this.def[e],n=this.get_elem_for_top_item(t);t.sub&&!t.sub.length&&(t.sub=null);var r=n.down("a");r.observe("mousedown",this.top_menu_mousedown.bindAsEventListener(this,t)),r.observe("click",this.top_menu_click.bindAsEventListener(this)),r.observe("mouseover",this.top_menu_mouseover.bindAsEventListener(this,t)),r.observe("dragstart",function(e){e.stop()}.bindAsEventListener(this))}var i=this.remove_submenu.bindAsEventListener(this);Element.observe(window,"blur",i),Element.observe(window,"pageshow",i),Element.observe(window,"pagehide",i)},MainMenu.prototype.get_submenu=function(e){for(var t=0;t<this.def.length;++t)if(this.def[t].name==e)return this.def[t];return null},MainMenu.prototype.show_submenu=function(e,t){if(this.shown_def==t)return;this.remove_submenu();if(!t.sub){this.shown_def=t;return}var n=this.get_elem_for_top_item(t);n.addClassName("selected-menu"),this.shown_def=t;var r="",i="";t.html_id&&(i='id="'+t.html_id+'" '),r+="<div "+i+"class='dropdown-menu'>";for(var s=0;s<t.sub.length;++s){var o=t.sub[s];if(o.separator==1){r+='<div class="separator"></div>';continue}var u="submenu";u+=" submenu-item-"+s,o.class_names&&(u+=" "+o.class_names.join(" ")),r+="<a class='"+u+"' href=\""+(o.dest||"#")+'">',r+=o.label.replace(" ","&nbsp;","g"),r+="</a>"}r+="</div>",this.submenu=document.createElement("div"),this.container.insertBefore(this.submenu,this.container.firstChild),$(this.submenu).replace(r),this.submenu=this.container.down(".dropdown-menu"),align_element_to_menu(this.submenu,n);var a=this.remove_submenu.bind(this),f=function(e){this.hovering_over_item(e.target)}.bindAsEventListener(this),l=function(e){this.hovering_over_item(null)}.bindAsEventListener(this);for(var s=0;s<t.sub.length;++s){var c=this.submenu.down(".submenu-item-"+s);if(!c)continue;var o=t.sub[s];o.func&&c.observe("click",function(e,n){e.stop(),n.func(e,this,t,n)}.bindAsEventListener(this,o)),o.login&&c.observe("click",User.run_login_onclick),c.observe("mouseover",f),c.observe("mouseout",l)}},MainMenu.prototype.remove_submenu=function(){this.submenu&&(this.submenu.parentNode.removeChild(this.submenu),this.submenu=null);if(this.shown_def){var e=this.get_elem_for_top_item(this.shown_def);e.removeClassName("selected-menu"),this.shown_def=null}},MainMenu.prototype.stop_dropdown_timer=function(){if(!this.dropdownTimer)return;clearTimeout(this.dropdownTimer),this.dropdownTimer=null,document.stopObserving("mousemove",this.mousemove_during_dropdown_timer_event)},MainMenu.prototype.hovering_over_item=function(e){this.focused_menu_item&&this.focused_menu_item.removeClassName("focused-menu-item"),this.focused_menu_item=e,e&&e.addClassName("focused-menu-item")},MainMenu.prototype.stop_drag=function(){if(!this.dragging)return;this.dragging=null,this.dragging_over=null,this.hovering_over_item(null),document.stopObserving("mouseup",this.document_mouseup_event),document.stopObserving("click",this.document_click_event),this.stop_dropdown_timer(),this.remove_submenu()},MainMenu.prototype.top_menu_mousedown=function(e,t){if(!e.isLeftClick())return;e.preventDefault(),this.stop_drag(),document.observe("mouseup",this.document_mouseup_event),document.observe("click",this.document_click_event),this.dragging=[e.clientX,e.clientY],this.dragging_over=t,document.observe("mousemove",this.mousemove_during_dropdown_timer_event),this.dropdownTimer=window.setTimeout(function(){this.dragging_over&&this.show_submenu(e.target,this.dragging_over)}.bind(this),250)},MainMenu.prototype.document_click=function(e){if(e.isLeftClick())return;this.stop_drag()},MainMenu.prototype.document_mouseup=function(e){if(!e.isLeftClick()){this.stop_drag.bind(this).defer();return}this.dropdownTimer&&(clearTimeout(this.dropdownTimer),this.dropdownTimer=null);var t=this.shown_def,n=this.focused_menu_item;this.stop_drag();if(!t)return;e.stop(),this.cancel_next_click=!0,function(){this.cancel_next_click=!1}.bind(this).defer();if(!n)return;if(document.createEvent){var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!0,document.defaultView,1,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(r)&&!r.stopped&&(window.location.href=n.href)}else n.fireEvent("onclick")&&(window.location.href=n.href)},MainMenu.prototype.mousemove_during_dropdown_timer=function(e){e.returnValue=!1,e.preventDefault();if(!this.dropdownTimer)return;if(e.clientY-this.dragging[1]<3)return;this.stop_dropdown_timer(),this.show_submenu(e.target,this.dragging_over)},MainMenu.prototype.top_menu_click=function(e){this.stop_drag(),this.cancel_next_click&&(this.cancel_next_click=!1,e.stop())},MainMenu.prototype.top_menu_mouseover=function(e,t){this.dragging&&(this.dragging_over=t);if(!this.shown_def)return;this.show_submenu(e.target,t)},MainMenu.prototype.add_forum_posts_to_submenu=function(){var e=this.get_submenu("forum").sub;if(!e)return;var t=Cookie.get("current_forum_posts");if(!t)return;var t=t.evalJSON();if(!t.length)return;var n=!1;for(var r=0;r<t.length;++r)t[r][2]&&(n=!0);n&&e.push({label:"Mark&nbsp;all&nbsp;read",func:Forum.mark_all_read}),e.push({separator:!0});for(var r=0;r<t.length;++r){var i=t[r],s="/forum/show/"+i[1];parseInt(i[3])>"1"&&(s+="?page="+i[3]),e.push({label:i[0],dest:s,class_names:["forum-topic"]}),i[2]&&e[e.length-1].class_names.push("unread-topic")}},MainMenu.prototype.mark_forum_posts_read=function(){var e=this.get_submenu("forum").sub;if(!e)return;for(var t=0;t<e.length;++t){if(!e[t].class_names)continue;e[t].class_names=e[t].class_names.reject(function(e){return e=="unread-topic"})}},QuickSearch.prototype.on_document_keydown_event=function(e){e.keyCode==Event.KEY_ESC&&this.hide()},QuickSearch.prototype.document_mousedown_event=function(e){if($(e.target).isParentNode(this.submenu))return;this.hide()},QuickSearch.prototype.hide_event=function(e){this.hide()},QuickSearch.prototype.hide=function(){if(!this.submenu)return;this.submenu.hide(),function(e){e.parentNode.removeChild(e)}.curry(this.submenu).defer(),this.submenu=null,document.stopObserving("keydown",this.on_document_keydown_event),document.stopObserving("mousedown",this.document_mousedown_event),Element.stopObserving(window,"blur",this.hide_event),Element.stopObserving(window,"pageshow",this.hide_event),Element.stopObserving(window,"pagehide",this.hide_event)},ShowPostSearch=MakeSearchHandler("/post","tags","Search posts"),ShowCommentSearch=MakeSearchHandler("/comment/search","query","Search comments"),ShowNoteSearch=MakeSearchHandler("/note/search","query","Search notes"),ShowArtistSearch=MakeSearchHandler("/artist","name","Search artists"),ShowTagSearch=MakeSearchHandler("/tag","name","Search tags"),ShowPoolSearch=MakeSearchHandler("/pool","query","Search pools"),ShowWikiSearch=MakeSearchHandler("/wiki","query","Search wiki"),ShowForumSearch=MakeSearchHandler("/forum/search","query","Search forums");var Note=Class.create({initialize:function(e,t,n){Note.debug&&console.debug("Note#initialize (id=%d)",e),this.id=e,this.is_new=t,this.document_observers=[],this.elements={box:$("note-box-"+this.id),corner:$("note-corner-"+this.id),body:$("note-body-"+this.id),image:$("image")},this.fullsize={left:this.elements.box.offsetLeft,top:this.elements.box.offsetTop,width:this.elements.box.clientWidth,height:this.elements.box.clientHeight},this.old={raw_body:n,formatted_body:this.elements.body.innerHTML};for(p in this.fullsize)this.old[p]=this.fullsize[p];t?this.elements.box.setOpacity(.2):this.elements.box.setOpacity(.5),t&&n==""&&(this.bodyfit=!0,this.elements.body.style.height="100px"),this.elements.box.observe("mousedown",this.dragStart.bindAsEventListener(this)),this.elements.box.observe("mouseout",this.bodyHideTimer.bindAsEventListener(this)),this.elements.box.observe("mouseover",this.bodyShow.bindAsEventListener(this)),this.elements.corner.observe("mousedown",this.resizeStart.bindAsEventListener(this)),this.elements.body.observe("mouseover",this.bodyShow.bindAsEventListener(this)),this.elements.body.observe("mouseout",this.bodyHideTimer.bindAsEventListener(this)),this.elements.body.observe("click",this.showEditBox.bindAsEventListener(this)),this.adjustScale()},textValue:function(){return Note.debug&&console.debug("Note#textValue (id=%d)",this.id),this.old.raw_body.strip()},hideEditBox:function(e){Note.debug&&console.debug("Note#hideEditBox (id=%d)",this.id);var t=$("edit-box");if(t!=null){var n=t.noteid;$("edit-box").stopObserving(),$("note-save-"+n).stopObserving(),$("note-cancel-"+n).stopObserving(),$("note-remove-"+n).stopObserving(),$("note-history-"+n).stopObserving(),$("edit-box").remove()}},showEditBox:function(e){Note.debug&&console.debug("Note#showEditBox (id=%d)",this.id),this.hideEditBox(e);var t=Note.getInsertionPosition(),n=t[0],r=t[1],i="";i+='<div id="edit-box" style="top: '+n+"px; left: "+r+'px; position: absolute; visibility: visible; z-index: 100; background: white; border: 1px solid black; padding: 12px;">',i+='<form onsubmit="return false;" style="padding: 0; margin: 0;">',i+='<textarea rows="7" id="edit-box-text" style="width: 350px; margin: 2px 2px 12px 2px;">'+this.textValue()+"</textarea>",i+='<input type="submit" value="Save" name="save" id="note-save-'+this.id+'">',i+='<input type="submit" value="Cancel" name="cancel" id="note-cancel-'+this.id+'">',i+='<input type="submit" value="Remove" name="remove" id="note-remove-'+this.id+'">',i+='<input type="submit" value="History" name="history" id="note-history-'+this.id+'">',i+="</form>",i+="</div>",$("note-container").insert({bottom:i}),$("edit-box").noteid=this.id,$("edit-box").observe("mousedown",this.editDragStart.bindAsEventListener(this)),$("note-save-"+this.id).observe("click",this.save.bindAsEventListener(this)),$("note-cancel-"+this.id).observe("click",this.cancel.bindAsEventListener(this)),$("note-remove-"+this.id).observe("click",this.remove.bindAsEventListener(this)),$("note-history-"+this.id).observe("click",this.history.bindAsEventListener(this)),$("edit-box-text").focus()},bodyShow:function(e){Note.debug&&console.debug("Note#bodyShow (id=%d)",this.id);if(this.dragging)return;this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null);if(Note.noteShowingBody==this)return;Note.noteShowingBody&&Note.noteShowingBody.bodyHide(),Note.noteShowingBody=this;if(Note.zindex>=9){Note.zindex=0;for(var t=0;t<Note.all.length;++t)Note.all[t].elements.box.style.zIndex=0}this.elements.box.style.zIndex=++Note.zindex,this.elements.body.style.zIndex=10,this.elements.body.style.top="0px",this.elements.body.style.left="0px";var n=document.documentElement.scrollWidth;this.elements.body.style.visibility="hidden",this.elements.body.style.display="block";if(!this.bodyfit){this.elements.body.style.height="auto",this.elements.body.style.minWidth="140px";var r=null,i=null,s=null,o=null,u=null,a=null;r=this.elements.body.offsetWidth,i=this.elements.body.offsetHeight;if(r/i<1.6180339887){s=140,o=400;do a=r,u=(s+o)/2,this.elements.body.style.minWidth=u+"px",r=this.elements.body.offsetWidth,i=this.elements.body.offsetHeight,r/i<1.6180339887?s=u:o=u;while(s<o&&r>a)}else if(this.elements.body.scrollWidth<=this.elements.body.clientWidth){s=20,o=r;do u=(s+o)/2,this.elements.body.style.minWidth=u+"px",this.elements.body.offsetHeight>i?s=u:o=u;while(o-s>4);this.elements.body.offsetHeight>i&&(this.elements.body.style.minWidth=o+"px")}Prototype.Browser.IE&&(this.elements.body.offsetHeight<35&&(this.elements.body.style.minHeight="35px"),this.elements.body.offsetWidth<47&&(this.elements.body.style.minWidth="47px")),this.bodyfit=!0}this.elements.body.style.top=this.elements.box.offsetTop+this.elements.box.clientHeight+5+"px";var f=0,e=this.elements.box;do f+=e.offsetLeft;while(e=e.offsetParent);f+=this.elements.body.offsetWidth+10-n,f>0?this.elements.body.style.left=this.elements.box.offsetLeft-f+"px":this.elements.body.style.left=this.elements.box.offsetLeft+"px",this.elements.body.style.visibility="visible"},bodyHideTimer:function(e){Note.debug&&console.debug("Note#bodyHideTimer (id=%d)",this.id),this.hideTimer=setTimeout(this.bodyHide.bindAsEventListener(this),250)},bodyHide:function(e){Note.debug&&console.debug("Note#bodyHide (id=%d)",this.id),this.elements.body.hide(),Note.noteShowingBody==this&&(Note.noteShowingBody=null)},addDocumentObserver:function(e,t){document.observe(e,t),this.document_observers.push([e,t])},clearDocumentObservers:function(e,t){for(var n=0;n<this.document_observers.length;++n){var r=this.document_observers[n];document.stopObserving(r[0],r[1])}this.document_observers=[]},dragStart:function(e){Note.debug&&console.debug("Note#dragStart (id=%d)",this.id),this.addDocumentObserver("mousemove",this.drag.bindAsEventListener(this)),this.addDocumentObserver("mouseup",this.dragStop.bindAsEventListener(this)),this.addDocumentObserver("selectstart",function(){return!1}),this.cursorStartX=e.pointerX(),this.cursorStartY=e.pointerY(),this.boxStartX=this.elements.box.offsetLeft,this.boxStartY=this.elements.box.offsetTop,this.boundsX=new ClipRange(5,this.elements.image.clientWidth-this.elements.box.clientWidth-5),this.boundsY=new ClipRange(5,this.elements.image.clientHeight-this.elements.box.clientHeight-5),this.dragging=!0,this.bodyHide()},dragStop:function(e){Note.debug&&console.debug("Note#dragStop (id=%d)",this.id),this.clearDocumentObservers(),this.cursorStartX=null,this.cursorStartY=null,this.boxStartX=null,this.boxStartY=null,this.boundsX=null,this.boundsY=null,this.dragging=!1,this.bodyShow()},ratio:function(){return this.elements.image.width/this.elements.image.getAttribute("large_width")},adjustScale:function(){Note.debug&&console.debug("Note#adjustScale (id=%d)",this.id);var e=this.ratio();for(p in this.fullsize)this.elements.box.style[p]=this.fullsize[p]*e+"px"},drag:function(e){var t=this.boxStartX+e.pointerX()-this.cursorStartX,n=this.boxStartY+e.pointerY()-this.cursorStartY;t=this.boundsX.clip(t),n=this.boundsY.clip(n),this.elements.box.style.left=t+"px",this.elements.box.style.top=n+"px";var r=this.ratio();this.fullsize.left=t/r,this.fullsize.top=n/r,e.stop()},editDragStart:function(e){Note.debug&&console.debug("Note#editDragStart (id=%d)",this.id);var t=e.element().nodeName;if(t!="FORM"&&t!="DIV")return;this.addDocumentObserver("mousemove",this.editDrag.bindAsEventListener(this)),this.addDocumentObserver("mouseup",this.editDragStop.bindAsEventListener(this)),this.addDocumentObserver("selectstart",function(){return!1}),this.elements.editBox=$("edit-box"),this.cursorStartX=e.pointerX(),this.cursorStartY=e.pointerY(),this.editStartX=this.elements.editBox.offsetLeft,this.editStartY=this.elements.editBox.offsetTop,this.dragging=!0},editDragStop:function(e){Note.debug&&console.debug("Note#editDragStop (id=%d)",this.id),this.clearDocumentObservers(),this.cursorStartX=null,this.cursorStartY=null,this.editStartX=null,this.editStartY=null,this.dragging=!1},editDrag:function(e){var t=this.editStartX+e.pointerX()-this.cursorStartX,n=this.editStartY+e.pointerY()-this.cursorStartY;this.elements.editBox.style.left=t+"px",this.elements.editBox.style.top=n+"px",e.stop()},resizeStart:function(e){Note.debug&&console.debug("Note#resizeStart (id=%d)",this.id),this.cursorStartX=e.pointerX(),this.cursorStartY=e.pointerY(),this.boxStartWidth=this.elements.box.clientWidth,this.boxStartHeight=this.elements.box.clientHeight,this.boxStartX=this.elements.box.offsetLeft,this.boxStartY=this.elements.box.offsetTop,this.boundsX=new ClipRange(10,this.elements.image.clientWidth-this.boxStartX-5),this.boundsY=new ClipRange(10,this.elements.image.clientHeight-this.boxStartY-5),this.dragging=!0,this.clearDocumentObservers(),this.addDocumentObserver("mousemove",this.resize.bindAsEventListener(this)),this.addDocumentObserver("mouseup",this.resizeStop.bindAsEventListener(this)),e.stop(),this.bodyHide()},resizeStop:function(e){Note.debug&&console.debug("Note#resizeStop (id=%d)",this.id),this.clearDocumentObservers(),this.boxCursorStartX=null,this.boxCursorStartY=null,this.boxStartWidth=null,this.boxStartHeight=null,this.boxStartX=null,this.boxStartY=null,this.boundsX=null,this.boundsY=null,this.dragging=!1,e.stop()},resize:function(e){var t=this.boxStartWidth+e.pointerX()-this.cursorStartX,n=this.boxStartHeight+e.pointerY()-this.cursorStartY;t=this.boundsX.clip(t),n=this.boundsY.clip(n),this.elements.box.style.width=t+"px",this.elements.box.style.height=n+"px";var r=this.ratio();this.fullsize.width=t/r,this.fullsize.height=n/r,e.stop()},save:function(e){Note.debug&&console.debug("Note#save (id=%d)",this.id);var t=this;for(p in this.fullsize)this.old[p]=this.fullsize[p];this.old.raw_body=$("edit-box-text").value,this.old.formatted_body=this.textValue(),this.elements.body.update(this.textValue()),this.hideEditBox(e),this.bodyHide(),this.bodyfit=!1;var n={id:this.id,"note[x]":this.old.left,"note[y]":this.old.top,"note[width]":this.old.width,"note[height]":this.old.height,"note[body]":this.old.raw_body};this.is_new&&(n["note[post_id]"]=Note.post_id),notice("Saving note..."),new Ajax.Request("/note/update.json",{parameters:n,onComplete:function(e){var e=e.responseJSON;if(e.success){notice("Note saved");var t=Note.find(e.old_id);e.old_id<0&&(t.is_new=!1,t.id=e.new_id,t.elements.box.id="note-box-"+t.id,t.elements.body.id="note-body-"+t.id,t.elements.corner.id="note-corner-"+t.id),t.elements.body.innerHTML=e.formatted_body,t.elements.box.setOpacity(.5),t.elements.box.removeClassName("unsaved")}else notice("Error: "+e.reason),t.elements.box.addClassName("unsaved")}}),e.stop()},cancel:function(e){Note.debug&&console.debug("Note#cancel (id=%d)",this.id),this.hideEditBox(e),this.bodyHide();var t=this.ratio();for(p in this.fullsize)this.fullsize[p]=this.old[p],this.elements.box.style[p]=this.fullsize[p]*t+"px";this.elements.body.innerHTML=this.old.formatted_body,e.stop()},removeCleanup:function(){Note.debug&&console.debug("Note#removeCleanup (id=%d)",this.id),this.elements.box.remove(),this.elements.body.remove();var e=[];for(i=0;i<Note.all.length;++i)Note.all[i].id!=this.id&&e.push(Note.all[i]);Note.all=e,Note.updateNoteCount()},remove:function(e){Note.debug&&console.debug("Note#remove (id=%d)",this.id),this.hideEditBox(e),this.bodyHide(),this_note=this,this.is_new?(this.removeCleanup(),notice("Note removed")):(notice("Removing note..."),new Ajax.Request("/note/update.json",{parameters:{id:this.id,"note[is_active]":"0"},onComplete:function(e){var e=e.responseJSON;e.success?(notice("Note removed"),this_note.removeCleanup()):notice("Error: "+e.reason)}})),e.stop()},history:function(e){Note.debug&&console.debug("Note#history (id=%d)",this.id),this.hideEditBox(e),this.is_new?notice("This note has no history"):location.href="/history?search=notes:"+this.id,e.stop()}});Object.extend(Note,{zindex:0,counter:-1,all:[],display:!0,debug:!1,show:function(){Note.debug&&console.debug("Note.show"),$("note-container").show()},hide:function(){Note.debug&&console.debug("Note.hide"),$("note-container").hide()},find:function(e){Note.debug&&console.debug("Note.find");for(var t=0;t<Note.all.size();++t)if(Note.all[t].id==e)return Note.all[t];return null},toggle:function(){Note.debug&&console.debug("Note.toggle"),Note.display?(Note.hide(),Note.display=!1):(Note.show(),Note.display=!0)},updateNoteCount:function(){Note.debug&&console.debug("Note.updateNoteCount");if(Note.all.length>0){var e="";Note.all.length==1?e="note":e="notes",$("note-count").innerHTML='This post has <a href="/note/history?post_id='+Note.post_id+'">'+Note.all.length+" "+e+"</a>"}else $("note-count").innerHTML=""},create:function(){Note.debug&&console.debug("Note.create"),Note.show();var e=Note.getInsertionPosition(),t=e[0],n=e[1],r="";r+='<div class="note-box unsaved" style="width: 150px; height: 150px; ',r+="top: "+t+"px; ",r+="left: "+n+'px;" ',r+='id="note-box-'+Note.counter+'">',r+='<div class="note-corner" id="note-corner-'+Note.counter+'"></div>',r+="</div>",r+='<div class="note-body" title="Click to edit" id="note-body-'+Note.counter+'"></div>',$("note-container").insert({bottom:r});var i=new Note(Note.counter,!0,"");Note.all.push(i),Note.counter-=1},getInsertionPosition:function(){Note.debug&&console.debug("Note.getInsertionPosition");var e=$("image").cumulativeScrollOffset()[0],t=$("image").cumulativeScrollOffset()[1],n=$("image").positionedOffset()[0],r=$("image").positionedOffset()[1],i=n+$("image").width,s=r+$("image").height,o=0,u=0;return e>n?o=e:o=n,t>r?u=t:u=r+20,u>s&&(u=r+20),[u,o]}}),Pool={pools:new Hash,register:function(e){Pool.pools.set(e.id,e)},register_pools:function(e){e!=null&&e.each(function(e){Pool.register(e)})},register_pool_posts:function(e,t){e.each(function(e){var t=Post.posts.get(e.post_id);t&&(t.pool_posts||(t.pool_posts=new Hash),t.pool_posts.set(e.pool_id,e))})},can_edit_pool:function(e){return User.is_member_or_higher()?e.is_public||e.user_id==User.get_current_user_id():!1},add_post:function(e,t){notice("Adding to pool..."),new Ajax.Request("/pool/add_post.json",{parameters:{post_id:e,pool_id:t},onComplete:function(e){var e=e.responseJSON;e.success?notice("Post added to pool"):notice("Error: "+e.reason)}})},remove_post:function(e,t){var n=function(){notice("Post removed from pool"),$("p"+e)&&$("p"+e).addClassName("deleted"),$("pool"+t)&&$("pool"+t).remove()};Post.make_request("/pool/remove_post.json",{post_id:e,pool_id:t},n)},transfer_post:function(e,t,n,r){Post.update_batch([{id:e,tags:"-pool:"+n,old_tags:""},{id:t,tags:"pool:"+n+":"+r,old_tags:""}],function(){notice("Pool post transferred to parent"),document.location.reload()})},detach_post:function(e,t,n){Post.update_batch([{id:e,tags:"-pool:"+t,old_tags:""}],function(){notice("Post detached");if(n){var r=$("pool-detach-"+t+"-"+e);r&&r.remove()}else $("pool"+t)&&$("pool"+t).remove()})},post_pretty_sequence:function(e){return e.match(/^[0-9]+.*/)?"#"+e:'"'+e+'"'},change_sequence:function(e,t,n){new_sequence=prompt("Please enter the new page number:",n);if(new_sequence==null)return;if(new_sequence.indexOf(" ")!=-1){notice("Invalid page number");return}Post.update_batch([{id:e,tags:"pool:"+t+":"+new_sequence,old_tags:""}],function(){notice("Post updated");var e=$("pool-seq-"+t);Object.isUndefined(e.innerText)?e.textContent=Pool.post_pretty_sequence(new_sequence):e.innerText=Pool.post_pretty_sequence(new_sequence)})}};var create_drag_box=function(e){var t=function(t,n){var r=$(document.createElement("div"));r.style.position="absolute",r.className="frame-box-handle "+t,r.frame_drag_cursor=t,r.style.pointerEvents="all",e.appendChild(r);for(s in n)r.style[s]=n[s];return r};t("n-resize",{top:"-5px",width:"100%",height:"10px"}),t("s-resize",{bottom:"-5px",width:"100%",height:"10px"}),t("w-resize",{left:"-5px",height:"100%",width:"10px"}),t("e-resize",{right:"-5px",height:"100%",width:"10px"}),t("nw-resize",{top:"-5px",left:"-5px",height:"10px",width:"10px"}),t("ne-resize",{top:"-5px",right:"-5px",height:"10px",width:"10px"}),t("sw-resize",{bottom:"-5px",left:"-5px",height:"10px",width:"10px"}),t("se-resize",{bottom:"-5px",right:"-5px",height:"10px",width:"10px"})},apply_drag=function(e,t,n,r,i){var s={move:{left:1,top:1,bottom:1,right:1},"n-resize":{top:1},"s-resize":{bottom:1},"w-resize":{left:1},"e-resize":{right:1},"nw-resize":{top:1,left:1},"ne-resize":{top:1,right:1},"sw-resize":{bottom:1,left:1},"se-resize":{bottom:1,right:1}},o=s[e],u={left:i.left,top:i.top,width:i.width,height:i.height},a=u.left+u.width,f=u.top+u.height;return e=="move"&&(t=clamp(t,-u.left,r.width-a),n=clamp(n,-u.top,r.height-f)),o.top!=null&&(u.top+=n*o.top),o.left!=null&&(u.left+=t*o.left),o.right!=null&&(a+=t*o.right),o.bottom!=null&&(f+=n*o.bottom),e!="move"&&(o.left!=null&&(u.left=clamp(u.left,0,a-1)),o.top!=null&&(u.top=clamp(u.top,0,f-1)),o.bottom!=null&&(f=clamp(f,u.top+1,r.height)),o.right!=null&&(a=clamp(a,u.left+1,r.width))),u.width=a-u.left,u.height=f-u.top,u},frame_dimensions_to_image=function(e,t,n){var r={top:e.source_top,left:e.source_left,width:e.source_width,height:e.source_height};return r.left*=t.width/n.width,r.top*=t.height/n.height,r.width*=t.width/n.width,r.height*=t.height/n.height,r.top=Math.round(r.top),r.left=Math.round(r.left),r.width=Math.round(r.width),r.height=Math.round(r.height),r},frame_dimensions_from_image=function(e,t,n){var r=
{source_top:e.top,source_left:e.left,source_width:e.width,source_height:e.height};return r.source_top/=t.height/n.height,r.source_left/=t.width/n.width,r.source_height/=t.height/n.height,r.source_width/=t.width/n.width,r.source_top=Math.round(r.source_top),r.source_left=Math.round(r.source_left),r.source_width=Math.round(r.source_width),r.source_height=Math.round(r.source_height),r};FrameEditor=function(e,t,n,r){this.container=e,this.popup_container=n,this.image_container=t,this.options=r,this.show_corner_drag=!0,this.image_frames=[],this.open_handlers=[];var i=[".frame-editor-nw",".frame-editor-ne",".frame-editor-sw",".frame-editor-se"];this.corner_draggers=[];for(var s=0;s<i.length;++s){var o=i[s],u=this.popup_container.down(o),a=new CornerDragger(u,o,{onUpdate:function(){this.update_frame_in_list(this.editing_frame),this.update_image_frame(this.editing_frame)}.bind(this)});this.corner_draggers.push(a)}var u=$(document.createElement("div"));u.style.position="absolute",u.style.left="0",u.style.top="0",u.className="frame-editor-main-frame",this.image_container.appendChild(u),this.main_frame=u,this.main_frame.hide(),this.container.down(".frame-editor-add").on("click",function(e){e.stop(),this.add_frame()}.bindAsEventListener(this)),this.container.on("click",".frame-label",function(e,t){e.stop();var n=t.up(".frame-row").frame_idx;this.focus(n)}.bind(this)),this.container.on("click",".frame-delete",function(e,t){e.stop();var n=t.up(".frame-row").frame_idx;this.delete_frame(n)}.bind(this)),this.container.on("click",".frame-up",function(e,t){e.stop();var n=t.up(".frame-row").frame_idx;this.move_frame(n,n-1)}.bind(this)),this.container.on("click",".frame-down",function(e,t){e.stop();var n=t.up(".frame-row").frame_idx;this.move_frame(n,n+1)}.bind(this)),this.container.down("table").on("change",function(e){this.form_data_changed()}.bind(this))},FrameEditor.prototype.move_frame=function(e,t){var n=Post.posts.get(this.post_id);t=Math.max(t,0),t=Math.min(t,n.frames_pending.length-1);if(e==t)return;var r=n.frames_pending[e];n.frames_pending.splice(e,1),n.frames_pending.splice(t,0,r),this.repopulate_table();var i=this.editing_frame==e?t:this.editing_frame;this.editing_frame=null,this.focus(i)},FrameEditor.prototype.form_data_changed=function(){var e=Post.posts.get(this.post_id);for(var t=0;t<e.frames_pending.length;++t)this.update_frame_from_list(t);this.update()},FrameEditor.prototype.set_drag_to_create=function(e){this.drag_to_create=e},FrameEditor.prototype.update_show_corner_drag=function(){var e=this.post_id!=null&&this.editing_frame!=null&&this.show_corner_drag;Prototype.Browser.WebKit?(e?(this.popup_container.style.opacity=1,this.popup_container.style.pointerEvents="",this.popup_container.style.position="static"):(this.popup_container.style.opacity=.001,this.popup_container.style.pointerEvents="none",this.popup_container.style.position="absolute",this.popup_container.style.top="0px",this.popup_container.style.right="0px"),this.popup_container.show()):this.popup_container.show(e);for(var t=0;t<this.corner_draggers.length;++t)this.corner_draggers[t].update()},FrameEditor.prototype.set_show_corner_drag=function(e){this.show_corner_drag=e,this.update_show_corner_drag()},FrameEditor.prototype.set_image_dimensions=function(e,t){var n=this.editing_frame,r=this.post_id;this.close(),this.image_dimensions={width:e,height:t},this.main_frame.style.width=this.image_dimensions.width+"px",this.main_frame.style.height=this.image_dimensions.height+"px",r!=null&&(this.open(r),this.focus(n))};var elementArrayFromPoint=function(e,t,n){var r=[];for(;;){var i=document.elementFromPoint(e,t);if(i==this.main_frame||i==document.documentElement)break;i.original_display=i.style.display,i.style.display="none",r.push(i)}return r.each(function(e){e.style.display=e.original_display,e.original_display=null}),r};FrameEditor.prototype.is_opened=function(){return this.post_id!=null},FrameEditor.prototype.open=function(e){if(this.image_dimensions==null)throw"Must call set_image_dimensions before open";if(this.post_id!=null)return;this.post_id=e,this.editing_frame=null,this.dragging_item=null,this.container.show(),this.main_frame.show(),this.update_show_corner_drag();var t=Post.posts.get(this.post_id);for(var n=0;n<this.corner_draggers.length;++n)this.corner_draggers[n].set_post_id(this.post_id);this.open_handlers.push(document.on("keydown",function(e){e.keyCode==Event.KEY_ESC&&this.discard()}.bindAsEventListener(this))),this.original_frames=Object.toJSON(t.frames_pending),this.repopulate_table(),this.create_dragger(),t.frames_pending.length>0&&this.focus(0),this.update()},FrameEditor.prototype.create_dragger=function(){this.dragger&&this.dragger.destroy(),this.dragger=new DragElement(this.main_frame,{ondown:function(e){var t=Post.posts.get(this.post_id);this.image_frames.each(function(e){e.style.pointerEvents="all"});var n=elementArrayFromPoint(e.x,e.y,this.main_frame);this.image_frames.each(function(e){e.style.pointerEvents="none"});var r=null;n.each(function(e){r==null&&e.hasClassName("frame-box-handle")&&(r=e)}.bind(this)),r==null&&n.each(function(e){e.hasClassName("frame-editor-frame-box")||(e=e.up(".frame-editor-frame-box")),this.image_frames.indexOf(e)==this.editing_frame&&(r=e)}.bind(this)),r==null&&(r=n[0]);var i=r;i.hasClassName("frame-editor-frame-box")||(i=i.up(".frame-editor-frame-box"));if(i==null){if(!this.drag_to_create)return;this.dragging_new=!0}else this.dragging_new=!1;r.hasClassName("frame-box-handle")?this.dragging_mode=r.frame_drag_cursor:this.dragging_mode="move";if(i&&i.hasClassName("frame-editor-frame-box")){var s=this.image_frames.indexOf(i);this.dragging_idx=s;var o=t.frames_pending[this.dragging_idx];this.dragging_anchor=frame_dimensions_to_image(o,this.image_dimensions,t)}this.focus(this.dragging_idx),this.dragger.overriden_drag_class=this.dragging_mode=="move"?null:this.dragging_mode,this.dragger.options.snap_pixels=this.dragging_new?10:0,e.latest_event.stopPropagation()}.bind(this),onup:function(e){this.dragging_idx=null,this.dragging_anchor=null}.bind(this),ondrag:function(e){var t=Post.posts.get(this.post_id);if(this.dragging_new){if(e.aX>0&&e.aY>0)this.dragging_mode="se-resize";else if(e.aX>0&&e.aY<0)this.dragging_mode="ne-resize";else if(e.aX<0&&e.aY>0)this.dragging_mode="sw-resize";else{if(!(e.aX<0&&e.aY<0))return;this.dragging_mode="nw-resize"}this.dragging_new=!1;var n=this.main_frame.cumulativeOffset(),r={left:e.dragger.anchor_x-n.left,top:e.dragger.anchor_y-n.top,height:0,width:0};this.dragging_anchor=r;var i=frame_dimensions_from_image(r,this.image_dimensions,t);this.dragging_idx=this.add_frame(i),t.frames_pending[this.editing_frame]=i}if(this.dragging_idx==null)return;var r=apply_drag(this.dragging_mode,e.aX,e.aY,this.image_dimensions,this.dragging_anchor),i=frame_dimensions_from_image(r,this.image_dimensions,t);t.frames_pending[this.editing_frame]=i,this.update_frame_in_list(this.editing_frame),this.update_image_frame(this.editing_frame)}.bind(this)})},FrameEditor.prototype.repopulate_table=function(){var e=Post.posts.get(this.post_id),t=this.container.down(".frame-list").down("TBODY");while(t.firstChild)t.removeChild(t.firstChild);this.image_frames.each(function(e){e.parentNode.removeChild(e)}.bind(this)),this.image_frames=[];for(var n=0;n<e.frames_pending.length;++n)this.add_frame_to_list(n),this.create_image_frame(),this.update_image_frame(n)},FrameEditor.prototype.update=function(){this.update_show_corner_drag();if(this.image_dimensions==null)return;var e=Post.posts.get(this.post_id);if(e!=null)for(var t=0;t<e.frames_pending.length;++t)this.update_image_frame(t)},FrameEditor.prototype.discard=function(){if(this.post_id==null)return;var e=this.original_frames,t=this.post_id;this.close();var n=Post.posts.get(t);n.frames_pending=e.evalJSON()},FrameEditor.prototype.get_current_frames_spec=function(){var e=Post.posts.get(this.post_id),t=e.frames_pending,n=[];return e.frames_pending.each(function(e){var t=e.source_left+"x"+e.source_top+","+e.source_width+"x"+e.source_height;n.push(t)}.bind(this)),n.join(";")},FrameEditor.prototype.changed=function(){var e=Post.posts.get(this.post_id),t=this.get_current_frames_spec();return t!=e.frames_pending_string},FrameEditor.prototype.save=function(e){if(this.post_id==null){e&&e();return}var t=this.post_id,n=Post.posts.get(t),r=n.frames_pending,i=this.get_current_frames_spec();if(i==n.frames_pending_string){e&&e();return}Post.update_batch([{id:t,frames_pending_string:i}],function(n){if(this.post_id==t){var r=Post.posts.get(t);this.original_frames=Object.toJSON(r.frames_pending),this.update()}e&&e()}.bind(this))},FrameEditor.prototype.create_image_frame=function(){var e=$(document.createElement("div"));e.className="frame-editor-frame-box",e.style.pointerEvents="none",this.main_frame.appendChild(e),this.image_frames.push(e),create_drag_box(e)},FrameEditor.prototype.update_image_frame=function(e){var t=Post.posts.get(this.post_id),n=t.frames_pending[e];if(e==this.editing_frame)for(var r=0;r<this.corner_draggers.length;++r)this.corner_draggers[r].update();var i=frame_dimensions_to_image(n,this.image_dimensions,t),s=this.image_frames[e];s.style.left=i.left+"px",s.style.top=i.top+"px",s.style.width=i.width+"px",s.style.height=i.height+"px",e==this.editing_frame?s.addClassName("focused-frame-box"):s.removeClassName("focused-frame-box")},FrameEditor.prototype.add_frame_to_list=function(e){var t=this.container.down(".frame-list").down("TBODY"),n=$(document.createElement("TR"));n.className="frame-row frame-"+e,n.frame_idx=e,t.appendChild(n);var r="<td><span class='frame-label'>Frame "+e+"</span></td>";r+="<td><input class='frame-left frame-dims' size=4></td>",r+="<td><input class='frame-top frame-dims' size=4></td>",r+="<td><input class='frame-width frame-dims' size=4></td>",r+="<td><input class='frame-height frame-dims' size=4></td>",r+="<td><a class='frame-delete frame-button-box' href='#'>X</a></td>",r+="<td><a class='frame-up frame-button-box' href='#'></a></td>",r+="<td><a class='frame-down frame-button-box' href='#'></a></td>",n.innerHTML=r,this.update_frame_in_list(e)},FrameEditor.prototype.update_frame_in_list=function(e){var t=Post.posts.get(this.post_id),n=t.frames_pending[e],r=this.container.down(".frame-list").down("TBODY"),i=r.down(".frame-"+e);i.down(".frame-left").value=n.source_left,i.down(".frame-top").value=n.source_top,i.down(".frame-width").value=n.source_width,i.down(".frame-height").value=n.source_height},FrameEditor.prototype.update_frame_from_list=function(e){var t=Post.posts.get(this.post_id),n=t.frames_pending[e],r=this.container.down(".frame-list").down("TBODY"),i=r.down(".frame-"+e);n.source_left=i.down(".frame-left").value,n.source_top=i.down(".frame-top").value,n.source_width=i.down(".frame-width").value,n.source_height=i.down(".frame-height").value},FrameEditor.prototype.add_frame=function(e){var t=Post.posts.get(this.post_id);return e==null&&(e={source_top:t.height*1/4,source_left:t.width*1/4,source_width:t.width/2,source_height:t.height/2}),t.frames_pending.push(e),this.add_frame_to_list(t.frames_pending.length-1),this.create_image_frame(),this.update_image_frame(t.frames_pending.length-1),this.focus(t.frames_pending.length-1),t.frames_pending.length-1},FrameEditor.prototype.delete_frame=function(e){var t=Post.posts.get(this.post_id),n=null;this.editing_frame==e&&(n=this.editing_frame,this.focus(null),e==t.frames_pending.length-1&&--n,n<0&&(n=null)),t.frames_pending.splice(e,1),this.repopulate_table(),this.focus(n)},FrameEditor.prototype.focus=function(e){if(this.editing_frame==e)return;if(this.editing_frame!=null){var t=this.container.down(".frame-"+this.editing_frame);t.removeClassName("frame-focused")}this.editing_frame=e;if(this.editing_frame!=null){var t=this.container.down(".frame-"+this.editing_frame);t.addClassName("frame-focused")}for(var n=0;n<this.corner_draggers.length;++n)this.corner_draggers[n].set_post_frame(this.editing_frame);this.update()},FrameEditor.prototype.close=function(){if(this.post_id==null)return;this.post_id=null,this.editing_frame=null;for(var e=0;e<this.corner_draggers.length;++e)this.corner_draggers[e].set_post_id(null);this.keydown_handler&&(this.open_handlers.each(function(e){e.stop()}),this.open_handlers=[]),this.dragger&&this.dragger.destroy(),this.dragger=null,this.container.hide(),this.main_frame.hide(),this.update_show_corner_drag();var t=this.container.down(".frame-list").down("TBODY");while(t.firstChild)t.removeChild(t.firstChild);this.original_frames=null,this.update(),this.options.onClose&&this.options.onClose(this)},CornerDragger=function(e,t,n){this.container=e,this.part=t,this.options=n;var r=e.down(".frame-editor-popup-div"),i=$(document.createElement("div"));i.className="frame-editor-frame-box",create_drag_box(i),r.appendChild(i),this.dragger=new DragElement(r,{snap_pixels:0,ondown:function(e){var n=document.elementFromPoint(e.x,e.y);n.hasClassName("frame-box-handle")?this.dragging_mode=n.frame_drag_cursor:t==".frame-editor-nw"?this.dragging_mode="nw-resize":t==".frame-editor-ne"?this.dragging_mode="ne-resize":t==".frame-editor-sw"?this.dragging_mode="sw-resize":t==".frame-editor-se"&&(this.dragging_mode="se-resize");var r=Post.posts.get(this.post_id),i=r.frames_pending[this.post_frame];this.dragging_anchor=frame_dimensions_to_image(i,this.image_dimensions,r),this.dragger.overriden_drag_class=this.dragging_mode=="move"?null:"hide-cursor",e.latest_event.stopPropagation()}.bind(this),ondrag:function(e){var t=Post.posts.get(this.post_id),n=apply_drag(this.dragging_mode,-e.aX,-e.aY,this.image_dimensions,this.dragging_anchor),r=frame_dimensions_from_image(n,this.image_dimensions,t);t.frames_pending[this.post_frame]=r,this.options.onUpdate&&this.options.onUpdate()}.bind(this)}),this.update()},CornerDragger.prototype.set_post_id=function(e){this.post_id=e,this.post_frame=null;var t=null,n=this.container.down("img");if(e!=null){var r=Post.posts.get(this.post_id);this.image_dimensions={width:r.jpeg_width,height:r.jpeg_height},t=r.jpeg_url,n.width=this.image_dimensions.width,n.height=this.image_dimensions.height}n.src!=t&&(n.src=t,Prototype.Browser.WebKit&&t&&(document.documentElement.addClassName("hourglass"),function(){document.documentElement.removeClassName("hourglass")}.defer())),this.update()},CornerDragger.prototype.set_post_frame=function(e){this.post_frame=e,this.update()},CornerDragger.prototype.update=function(){if(this.post_id==null||this.post_frame==null)return;var e=Post.posts.get(this.post_id),t=e.frames_pending[this.post_frame],n=frame_dimensions_to_image(t,this.image_dimensions,e),r=this.container,i=this.container.down(".frame-editor-frame-box");i.style.left=n.left+"px",i.style.top=n.top+"px",i.style.width=n.width+"px",i.style.height=n.height+"px";var s=n.top,o=n.left;if(this.part==".frame-editor-ne"||this.part==".frame-editor-se")o+=n.width;if(this.part==".frame-editor-sw"||this.part==".frame-editor-se")s+=n.height;var u=r.offsetHeight/2,a=r.offsetWidth/2;o-=a,s-=u;if(this.part==".frame-editor-nw"||this.part==".frame-editor-sw")o=Math.min(o,n.left+n.width/2-r.offsetWidth);if(this.part==".frame-editor-ne"||this.part==".frame-editor-se")o=Math.max(o,n.left+n.width/2);if(this.part==".frame-editor-nw"||this.part==".frame-editor-ne")s=Math.min(s,n.top+n.height/2-r.offsetHeight);if(this.part==".frame-editor-sw"||this.part==".frame-editor-se")s=Math.max(s,n.top+n.height/2);var f=this.container.down(".frame-editor-popup-div");f.style.marginTop=-s+"px",f.style.marginLeft=-o+"px"};var PostUploadForm=function(e,t){var n="XMLHttpRequest"in window&&(new XMLHttpRequest).upload!=null,r="FormData"in window;if(!n||!r)return;this.form_element=e,this.cancel_element=this.form_element.down(".cancel"),this.progress=t,this.document_title=document.documentElement.down("TITLE"),this.document_title_orig=this.document_title.textContent,this.current_request=null,this.form_element.on("submit",this.form_submit_event.bindAsEventListener(this)),this.cancel_element.on("click",this.click_cancel.bindAsEventListener(this));var i=window.opera||Prototype.Browser.Gecko?"keypress":"keydown";document.on(i,this.document_keydown_event.bindAsEventListener(this))};PostUploadForm.prototype.set_progress=function(e){var t=e*100;this.progress.down(".upload-progress-bar-fill").style.width=t+"%",this.document_title.textContent=this.document_title_orig+" ("+t.toFixed(0)+"%)"},PostUploadForm.prototype.request_starting=function(){this.form_element.down(".submit").hide(),this.cancel_element.show(),this.progress.show(),document.documentElement.addClassName("progress")},PostUploadForm.prototype.request_ending=function(){this.form_element.down(".submit").show(),this.cancel_element.hide(),this.progress.hide(),this.document_title.textContent=this.document_title_orig,document.documentElement.removeClassName("progress")},PostUploadForm.prototype.document_keydown_event=function(e){var t=e.charCode;t||(t=e.keyCode);if(t!=Event.KEY_ESC)return;this.cancel()},PostUploadForm.prototype.click_cancel=function(e){e.stop(),this.cancel()},PostUploadForm.prototype.form_submit_event=function(e){if(e.stopped)return;if(this.current_request!=null)return;$("post-exists").hide(),$("post-upload-error").hide();var t=$("post_file");if(t.files==null||t.files.length==0)return;e.stop(),this.set_progress(0),this.request_starting();var n=new FormData(this.form_element),r=function(e){var t=e.loaded,n=e.total;this.set_progress(n?t/n:1)}.bind(this);this.current_request=new Ajax.Request("/post/create.json",{contentType:null,method:"post",postBody:n,onCreate:function(e){var t=e.request.transport;t.upload.onprogress=r},onComplete:function(e){this.current_request=null,this.request_ending();var t=e.responseJSON;if(!t)return;if(!t.success){if(t.location){var n=$("post-exists-link");n.setTextContent("post #"+t.post_id),n.href=t.location,$("post-exists").show();return}$("post-upload-error").setTextContent(t.reason),$("post-upload-error").show();return}var r=t.location;t.similar_location&&t.has_similar_hits&&(r=t.similar_location),window.location.href=r}.bind(this)})},PostUploadForm.prototype.cancel=function(){if(this.current_request==null)return;this.current_request.transport.abort()},UploadSimilarSearch=function(e,t){if(!ThumbnailUserImage)return;this.file_field=e,this.results=t,e.on("change",this.field_changed_event.bindAsEventListener(this))},UploadSimilarSearch.prototype.field_changed_event=function(e){this.results.hide();if(this.file_field.files==null||this.file_field.files.length==0)return;this.results.innerHTML="Searching...",this.results.show();var t=this.file_field.files[0],n=new ThumbnailUserImage(t,this.thumbnail_complete.bind(this))},UploadSimilarSearch.prototype.thumbnail_complete=function(e){if(!e.success){this.results.innerHTML="Image load failed.",this.results.show();return}var t=e.canvas.toDataURL(),n=new FormData;n.append("url",t);var r=new Ajax.Request("/post/similar.json",{method:"post",postBody:n,contentType:null,onComplete:function(e){this.results.innerHTML="",this.results.show();var t=e.responseJSON;if(!t.success){this.results.innerHTML=t.reason;return}if(t.posts.length>0){var n=[],r=3;t.posts.slice(0,r).each(function(e){var t;User.get_use_browser()?t="/post/browse#"+e.id:t="/post/show/"+e.id;var r="<a href='"+t+"'>post #"+e.id+"</a>";n.push(r)});var i=n.join(", "),s="<a href='/post/similar?search_id="+t.search_id+"'>(see all)</a>",o="Similar posts "+s+": "+i;if(t.posts.length>r){var u=t.posts.length-r;o+=" ("+u+" more)"}this.results.innerHTML=o}else this.results.innerHTML="No similar posts found."}.bind(this)})},Post={posts:new Hash,tag_types:new Hash,votes:new Hash,tag_type_names:["general","artist","","copyright","character","circle","faults"],find_similar:function(){var e=$("post_source").name,t=$("post_file").name,n=$("edit-form").target,r=$("edit-form").action;$("post_source").name="url",$("post_file").name="file",$("edit-form").target="_blank",$("edit-form").action="http://danbooru.iqdb.hanyuu.net/",$("edit-form").submit(),$("post_source").name=e,$("post_file").name=t,$("edit-form").target=n,$("edit-form").action=r},make_request:function(e,t,n){return new Ajax.Request(e,{parameters:t,onFailure:function(e){var t=e.responseJSON;notice("Error: "+t.reason)},onSuccess:function(e){var e=e.responseJSON;Post.register_resp(e);var t=new Hash;for(var r=0;r<e.posts.length;++r)t.set(e.posts[r].id,!0);document.fire("posts:update",{resp:e,post_ids:t}),n&&n(e)}})},approve:function(e,t,n){notice("Approving post #"+e);var r={};r["ids["+e+"]"]="1",r.commit=t?"Delete":"Approve",t&&(r.reason=t);var i=function(){notice(t?"Post deleted":"Post approved"),n?n(e):($("p"+e)&&$("p"+e).removeClassName("pending"),$("pending-notice")&&$("pending-notice").hide())};return Post.make_request("/post/moderate.json",r,i)},undelete:function(e,t){return Post.make_request("/post/undelete.json",{id:e},t)},applied_list:[],reset_tag_script_applied:function(){for(var e=0;e<Post.applied_list.length;++e)Post.applied_list[e].removeClassName("tag-script-applied");Post.applied_list=[]},update_batch:function(e,t){var n=e.length;TagCompletion&&e.each(function(e){if(e.tags==null)return;TagCompletion.add_recent_tags_from_update(e.tags,e.old_tags)});var r=[];/*Pop.{*/var i=0;/*}Pop.*/e.each(function(e){;$H(e).each(function(e){var t=/*Pop.{*/"post["+i+"]["+e.key+"]="+window.encodeURIComponent(e.value);/*}Pop.*/r.push(t)})/*Pop.{*/;i++;/*}Pop.*/});var i=function(e){e.posts.each(function(e){Post.update_styles(e);var t=$$("#p"+e.id+" > .directlink");t.length>0&&(t[0].addClassName("tag-script-applied"),Post.applied_list.push(t[0]))}),notice((n==1?"Post":"Posts")+" updated"),t&&t(e.posts)},s=r.join("&");Post.make_request("/post/update_batch.json",s,i)},update_styles:function(e){var t=$("p"+e.id);if(!t)return;e.has_children?t.addClassName("has-children"):t.removeClassName("has-children"),e.parent_id?t.addClassName("has-parent"):t.removeClassName("has-parent")},update:function(e,t,n){notice("Updating post #"+e),t.id=e,new Ajax.Request("/post/update.json",{parameters:t,onComplete:function(t){var t=t.responseJSON;if(t.success){notice("Post updated"),Post.register(t.post),Post.register_tags(t.tags),Post.update_styles(t.post);var r=r=$$("#p"+e+" > .directlink");r.length>0&&(r[0].addClassName("tag-script-applied"),Post.applied_list.push(r[0])),n&&n(t.post)}else notice("Error: "+t.reason)}})},activate_posts:function(e,t){notice("Activating "+e.length+(e.length==1?" post":" posts"));var n={};n["post_ids[]"]=e,new Ajax.Request("/post/activate.json",{parameters:n,onComplete:function(e){var e=e.responseJSON;e.success?t&&t(e):notice("Error: "+e.reason)}})},activate_all_posts:function(){var e=[];Post.posts.each(function(t){$("p"+t.key)&&e.push(t.key)}),Post.activate_posts(e,function(e){e.count==0?notice("No posts were activated."):notice(e.count+(e.count==1?" post":" posts")+" activated")})},activate_post:function(e){Post.update_batch([{id:e,is_held:!1}],function(){var t=Post.posts.get(e);t.is_held?notice("Couldn't activate post"):$("held-notice").remove()})},init_add_to_favs:function(e,t,n){var r=function(r){if(r!=null&&r.memo.post_ids.get(e)==null)return;var i=Post.votes.get(e)||0;t.show(i<3),n.show(i>=3)};r(),document.on("posts:update",r)},vote:function(e,t){if(t>3)return;notice("Voting..."),Post.make_request("/post/vote.json",{id:e,score:t},function(e){notice("Vote saved")})},flag:function(e,t){var n=prompt("Why should this post be flagged for deletion?","");if(!n)return!1;var r=function(){notice("Post was flagged for deletion");if(t)t(e);else{var n=$("p"+e);n&&n.addClassName("flagged")}};return Post.make_request("/post/flag.json",{id:e,reason:n},r)},unflag:function(e,t){var n=function(){notice("Post was approved");if(t)t(e);else{var n=$("p"+e);n&&n.removeClassName("flagged")}};return Post.make_request("/post/flag.json",{id:e,unflag:1},n)},observe_text_area:function(e){$(e).observe("keydown",function(e){e.keyCode==Event.KEY_RETURN&&(e.stop(),this.up("form").simulate_submit())})},get_post_tags_by_type:function(e){var t=new Hash;return e.tags.each(function(e){var n=Post.tag_types.get(e);n||(n="general");var r=t.get(n);r||(r=[],t.set(n,r)),r.push(e)}),t},get_post_tags_with_type:function(e){var t=Post.get_post_tags_by_type(e),n=t.keys(),r=["artist","circle","copyright","character","faults","general"];n=n.sort(function(e,t){var n=r.indexOf(e);n==-1&&(n=999);var i=r.indexOf(t);return i==-1&&(i=999),n-i});var i=new Array;return n.each(function(e){var n=t.get(e);n.each(function(t){i.push([t,e])})}),i},register_resp:function(e){e.posts&&Post.register_posts(e.posts),e.tags&&Post.register_tags(e.tags),e.votes&&Post.register_votes(e.votes),e.pools&&Pool.register_pools(e.pools),e.pool_posts&&Pool.register_pool_posts(e.pool_posts,e.posts)},register:function(e){e.tags=e.tags.match(/\S+/g)||[],e.match_tags=e.tags.clone(),e.match_tags.push("rating:"+e.rating.charAt(0)),e.match_tags.push("status:"+e.status),this.posts.set(e.id,e)},register_posts:function(e){e.each(function(e){Post.register(e)})},unregister_all:function(){this.posts=new Hash},register_tags:function(e,t){this.tag_types.update(e),TagCompletion&&!t&&TagCompletion.update_tag_types()},register_votes:function(e){this.votes.update(e)},blacklists:[],is_blacklisted:function(e){var t=Post.posts.get(e),n=function(e){return t.match_tags.indexOf(e)!=-1},r=function(e){var t=e.require,r=t.length;for(var i=0;i<r;++i)if(!n(t[i]))return!1;var s=e.exclude,o=s.length;for(var i=0;i<o;++i)if(n(s[i]))return!1;return!0},i=Post.blacklists,s=i.length;for(var o=0;o<s;++o){var u=i[o];if(r(u))return!0}return!1},apply_blacklists:function(){Post.blacklists.each(function(e){e.hits=0});var e=0;Post.posts.each(function(t){var n=$("p"+t.key);if(!n)return;var r=t.value,i=r.match_tags.member.bind(r.match_tags);r.blacklisted=[],r.id!=Post.blacklist_options.exclude&&Post.blacklists.each(function(e){e.require.all(i)&&!e.exclude.any(i)&&(e.hits++,Post.disabled_blacklists[e.tags]||r.blacklisted.push(e))});var s=r.blacklisted.length>0;e+=s;if(Post.blacklist_options.replace)if(s){n.src="/images/blank.gif";var o=function(e){var t=e.target;t.stopObserving("load"),t.stopObserving("error"),t.src="/blacklisted-preview.png",t.removeClassName("javascript-hide")};n.observe("load",o),n.observe("error",o)}else n.src=r.preview_url,n.removeClassName("javascript-hide");else s?n.addClassName("javascript-hide").addClassName('blacklisted-post')/*<Pop.*/:n.removeClassName("javascript-hide")}),Post.countText&&Post.countText.update(e);var t=$("blacklisted-notice");return t&&t.show(e>0),e},current_blacklists:null,hide_inactive_blacklists:!0,disabled_blacklists:{},blacklists_update_disabled:function(){Post.blacklists.each(function(e){if(!e.a)return;Post.disabled_blacklists[e.tags]||e.hits==0?e.a.addClassName("blacklisted-tags-disabled"):e.a.removeClassName("blacklisted-tags-disabled")})},init_blacklisted:function(e){Post.blacklist_options=Object.extend({replace:!1,exclude:null},e);var t;Post.current_blacklists?t=Post.current_blacklists:t=jQuery.parseJSON(jQuery.cookie("blacklisted_tags"))||[],Post.blacklists=[],t.each(function(e){var t=e.replace(/(rating:[qes])\w+/,"$1"),n=t.match(/\S+/g);if(!n)return;var r={tags:n,original_tag_string:e,require:[],exclude:[],hits:0};n.each(function(e){e.charAt(0)=="-"?r.exclude.push(e.slice(1)):r.require.push(e)}),Post.blacklists.push(r)}),Post.countText=$("blacklist-count"),Post.countText&&Post.countText.update(""),Post.apply_blacklists();var n=$("blacklisted-sidebar");n&&n.show();var r=$("blacklisted-list");if(r){while(r.firstChild)r.removeChild(r.firstChild);Post.blacklists.sort(function(e,t){return e.hits==0&&t.hits>0?1:e.hits>0&&t.hits==0?-1:e.tags.join(" ").localeCompare(t.tags.join(" "))}),inactive_blacklists_hidden=0,Post.blacklists.each(function(e){if(Post.hide_inactive_blacklists&&!e.hits){++inactive_blacklists_hidden;return}var t=r.appendChild(document.createElement("li"));t.className="blacklisted-tags",t.style.position="relative";var n=t.appendChild($(document.createElement("a")));n.style.position="absolute",n.style.left="-0.75em",n.href="#",n.update(""),n.observe("click",function(t){if(!User.run_login_onclick(t))return!1;t.stop();var n=e.original_tag_string;User.modify_blacklist([],[n],function(e){notice('Unblacklisted "'+n+'"'),Post.current_blacklists=e.result,Post.init_blacklisted()})}),t.appendChild(document.createTextNode(" "));var i=t.appendChild(document.createElement("a"));e.a=i,i.href="#",i.className="no-focus-outline",e.hits?$(i).observe("click",function(t){Post.disabled_blacklists[e.tags]=!Post.disabled_blacklists[e.tags],Post.apply_blacklists(),Post.blacklists_update_disabled(),t.stop()}):i.addClassName("blacklisted-tags-disabled");var s=i.appendChild(document.createTextNode(e.tags.join(" ")));t.appendChild(document.createTextNode(" "));var o=t.appendChild(document.createElement("span"));o.className="post-count",e.hits>0&&o.appendChild(document.createTextNode("("+e.hits+")"))});if(Post.hide_inactive_blacklists&&inactive_blacklists_hidden>0){var i=r.appendChild(document.createElement("li"));i.className="no-focus-outline",i.id="blacklisted-tag-show-all";var s=i.appendChild(document.createElement("a"));s.href="#",s.className="no-focus-outline",$(s).observe("click",function(e){e.stop(),$("blacklisted-tag-show-all").hide(),Post.hide_inactive_blacklists=!1,Post.init_blacklisted()});var o=s.appendChild(document.createTextNode(" Show all blacklists"));i.appendChild(document.createTextNode(" "))}}Post.blacklists_update_disabled()},blacklist_add_commit:function(){var e=$("add-blacklist").value;if(e=="")return;$("add-blacklist").value="",User.modify_blacklist(e,[],function(t){notice('Blacklisted "'+e+'"'),Post.current_blacklists=t.result,Post.init_blacklisted()})},last_click_id:null,check_avatar_blacklist:function(e,t){return t&&t==this.last_click_id?!0:(this.last_click_id=t,Post.is_blacklisted(e)?(notice("This post matches one of your blacklists.  Click again to open."),!1):!0)},resize_image:function(){var e=$("image");e.original_width==null&&(e.original_width=e.width,e.original_height=e.height);var t=1;if(e.scale_factor==1||e.scale_factor==null){var n=$("right-col").clientWidth-15,r=window.innerHeight-15;t=Math.min(t,n/e.original_width),t=Math.min(t,r/e.original_height)}e.width=e.original_width*t,e.height=e.original_height*t,e.scale_factor=t;if(window.Note)for(var i=0;i<window.Note.all.length;++i)window.Note.all[i].adjustScale()},get_scroll_offset_to_center:function(e){var t=document.viewport.getDimensions(),n=e.cumulativeOffset(),r=(t.width-e.offsetWidth)/2,i=(t.height-e.offsetHeight)/2,s=n.left-r,o=n.top-i;return[s,o]},center_image:function(e){e||(e=$("image"));if(!e)return;e.setStyle({paddingLeft:0,paddingTop:0});var t=Post.get_scroll_offset_to_center(e),n=-t[0];n<0&&(n=0),e.setStyle({paddingLeft:n+"px"});var r=-t[1];r<0&&(r=0),e.setStyle({paddingTop:r+"px"});var i=document.viewport.getDimensions(),s=t[0]+i.width,o=t[1]+i.height;$(document.body).setStyle({minWidth:s+"px",minHeight:o+"px"});var t=Post.get_scroll_offset_to_center(e);window.scroll(t[0],t[1])},scale_and_fit_image:function(e){e||(e=$("image"));if(!e)return;e.original_width==null&&(e.original_width=e.width,e.original_height=e.height);var t=document.viewport.getDimensions(),n=t.width,r=t.height,i=n/e.original_width;e.original_height*i>r&&(i=r/e.original_height),i<1&&(e.width=e.original_width*i,e.height=e.original_height*i),this.center_image(e),Post.adjust_notes()},adjust_notes:function(){if(!window.Note)return;for(var e=0;e<window.Note.all.length;++e)window.Note.all[e].adjustScale()},highres:function(){var e=$("image");if(e.already_resized)return;e.already_resized=!0,e.scale_factor!=null&&e.scale_factor!=1&&Post.resize_image();var t=function(){e.original_height=null,e.original_width=null;var t=$("highres-show");e.height=t.getAttribute("link_height"),e.width=t.getAttribute("link_width"),$("note-container").insert({after:e}),e.src=t.href,window.Note&&window.Note.all.invoke("adjustScale")};$("resized_notice")&&$("resized_notice").hide(),e.height=e.width=0,e.src="",e.remove(),t(e)},set_same_user:function(e){var t=$("creator-id-css");t&&t.parentNode.removeChild(t);var n=".creator-id-"+e+" .directlink { background-color: #300 !important; }",r=document.createElement("style");r.id="creator-id-css",r.type="text/css",r.styleSheet?r.styleSheet.cssText=n:r.appendChild(document.createTextNode(n)),document.getElementsByTagName("head")[0].appendChild(r)},init_post_list:function(){Post.posts.each(function(e){var t=e[0],n=e[1],r=$("p"+t);if(!r)return;r=r.down(".directlink");if(!r)return;r.observe("mouseover",function(e){return Post.set_same_user(n.creator_id),!1},!0),r.observe("mouseout",function(e){return Post.set_same_user(null),!1},!0)})},init_hover_thumb:function(e,t,n,r){if(Prototype.Browser.IE)return;e.observe("mouseover",function(i){Post.hover_thumb_mouse_over(t,e,n,r)}),e.observe("mouseout",function(e){if(e.relatedTarget==n)return;Post.hover_thumb_mouse_out(n)}),n.hover_init||(n
.hover_init=!0,n.observe("mouseout",function(e){Post.hover_thumb_mouse_out(n)}))},hover_thumb_mouse_over:function(e,t,n,r){var i=Post.posts.get(e);n.hide();var s=t.cumulativeOffset();n.style.width="auto",n.style.height="auto",Post.is_blacklisted(e)?n.src="/images/blacklisted-preview.png":(n.src=i.preview_url,i.status!="deleted"&&(n.style.width=i.actual_preview_width+"px",n.style.height=i.actual_preview_height+"px"));var o=r.cumulativeOffset().top,u=o+r.getHeight()-1,a=s.top-2;if(a+n.getHeight()>u){var f=u-n.getHeight()-4;f>=o&&(a=f)}n.style.top=a+"px",n.show()},hover_thumb_mouse_out:function(e){e.hide()},acknowledge_new_deleted_posts:function(e){new Ajax.Request("/post/acknowledge_new_deleted_posts.json",{onComplete:function(e){var e=e.responseJSON;e.success?$("posts-deleted-notice")&&$("posts-deleted-notice").hide():notice("Error: "+e.reason)}})},hover_info_pin:function(e){var t=null;e!=null&&(t=Post.posts.get(e)),Post.hover_info_pinned_post=t,Post.hover_info_update()},hover_info_mouseover:function(e){var t=Post.posts.get(e);if(Post.hover_info_hovered_post==t)return;Post.hover_info_hovered_post=t,Post.hover_info_update()},hover_info_mouseout:function(){if(Post.hover_info_hovered_post==null)return;Post.hover_info_hovered_post=null,Post.hover_info_update()},hover_info_hovered_post:null,hover_info_displayed_post:null,hover_info_shift_held:!1,hover_info_pinned_post:null,hover_info_update:function(){var e=Post.hover_info_pinned_post;e||(e=Post.hover_info_hovered_post,Post.hover_info_shift_held||(e=null));if(Post.hover_info_displayed_post==e)return;Post.hover_info_displayed_post=e;var t=$("index-hover-info"),n=$("index-hover-overlay");if(!e){t.hide(),n.hide(),n.down("IMG").src="/images/blank.gif";return}t.down("#hover-dimensions").innerHTML=e.width+"x"+e.height,t.select("#hover-tags SPAN A").each(function(e){e.innerHTML=""});var r=Post.get_post_tags_by_type(e);r.each(function(e){var t=$("hover-tag-"+e[0]),n=[];e[1].each(function(e){n.push(e)}),t.innerHTML=n.join(" ")}),e.rating=="s"?t.down("#hover-rating").innerHTML="s":e.rating=="q"?t.down("#hover-rating").innerHTML="q":e.rating=="e"&&(t.down("#hover-rating").innerHTML="e"),t.down("#hover-post-id").innerHTML=e.id,t.down("#hover-score").innerHTML=e.score,e.is_shown_in_index?t.down("#hover-not-shown").hide():t.down("#hover-not-shown").show(),t.down("#hover-is-parent").show(e.has_children),t.down("#hover-is-child").show(e.parent_id!=null),t.down("#hover-is-pending").show(e.status=="pending"),t.down("#hover-is-flagged").show(e.status=="flagged");var i=function(e,t){(e.innerText||e).textContent=t};e.status=="flagged"&&(t.down("#hover-flagged-reason").setTextContent(e.flag_detail.reason),t.down("#hover-flagged-by").setTextContent(e.flag_detail.flagged_by)),t.down("#hover-file-size").innerHTML=number_to_human_size(e.file_size),t.down("#hover-author").innerHTML=e.author,t.show(),t.style.left="0px",t.style.top="0px";var s=t.scrollWidth,o=t.scrollHeight,u=$("p"+e.id).down("IMG"),a=u.cumulativeOffset(),f=a[0]+u.scrollWidth/2,l=a[1],c=f-s/2,h=l-o,p=document.viewport.getDimensions().width;c<0&&(c=0),c+s>p&&(c=p-s),t.style.left=c+"px",t.style.top=h+"px",n.down("A").href=(User.get_use_browser()?"/post/browse#":"/post/show/")+e.id,n.down("IMG").src=e.preview_url;var c=f-e.actual_preview_width/2,h=a[1];n.style.left=c+"px",n.style.top=h+"px",n.show()},hover_info_shift_down:function(){if(Post.hover_info_shift_held)return;Post.hover_info_shift_held=!0,Post.hover_info_update()},hover_info_shift_up:function(){if(!Post.hover_info_shift_held)return;Post.hover_info_shift_held=!1,Post.hover_info_update()},hover_info_init:function(){document.observe("keydown",function(e){if(e.keyCode!=16)return;Post.hover_info_shift_down()}),document.observe("keyup",function(e){if(e.keyCode!=16)return;Post.hover_info_shift_up()}),document.observe("blur",function(e){Post.hover_info_shift_up()});var e=$("index-hover-overlay");Post.posts.each(function(t){var n=t[0],r=t[1],i=$("p"+r.id);if(i==null)return;i.down("A").observe("mouseover",function(e){Post.hover_info_mouseover(n)}),i.down("A").observe("mouseout",function(t){if(t.relatedTarget&&t.relatedTarget.isParentNode(e))return;Post.hover_info_mouseout()})}),e.observe("mouseout",function(e){Post.hover_info_mouseout()})},highlight_posts_with_tag:function(e){Post.posts.each(function(t){var n=t[0],r=t[1],i=$("p"+r.id);if(!i)return;e&&r.tags.indexOf(e)!=-1?i.addClassName("highlighted-post"):i.removeClassName("highlighted-post")})},reparent_post:function(e,t,n,r){if(n){alert("The parent post has a parent, so this post can't be automatically reparented.");return}var i=[];new Ajax.Request("/post.json",{parameters:{tags:"parent:"+t},onComplete:function(n){var n=n.responseJSON;for(var s=0;s<n.length;++s){var o=n[s];if(o.id==t&&o.parent_id!=null){alert("The parent post has a parent, so this post can't be automatically reparented.");return}i.push({id:n[s].id,tags:"parent:"+e,old_tags:""})}r==null&&(r=function(){document.location.reload()}),Post.update_batch(i,r)}})},get_url_for_post_in_pool:function(e,t){return"/post/show/"+e+"?pool_id="+t},jump_to_post_in_pool:function(e,t){if(e==null){notice("No more posts in this pool");return}window.location.href=Post.get_url_for_post_in_pool(e,t)},InitBrowserLinks:function(){if(!User.get_use_browser())return;var e=function(e){var t=e.match(/^(https?:\/\/[^\/]+)\/([a-z]+)\/([a-z]+)\/([0-9]+)([^#]*)(#.*)?$/);return t?{controller:t[2],action:t[3],id:t[4],hash:t[6]}:null},t=function(e){var t=e.match(/^(https?:\/\/[^\/]+)\/post(\/index)?\?tags=([^&]*)$/);return t?t[3]:null},n=e(document.location.href),r=null;n&&n.controller=="pool"&&n.action=="show"&&(r=n.id),$$("A").each(function(n){if(n.hasClassName("no-browser-link")||n.up(".no-browser-link"))return;var i=t(n.href);if(i!=null){n.href="/post/browse#/"+i;return}var s=e(n.href);if(!s)return;if(s.hash)return;if(s.controller=="post"&&s.action=="show"){var o="/post/browse#"+s.id;r!=null&&(o+="/pool:"+r),n.browse_href=o,n.orig_href=n.href}else s.controller=="pool"&&s.action=="show"&&(n.browse_href="/post/browse#/pool:"+s.id,n.orig_href=n.href);n.browse_href&&(n.href=n.browse_href)})},cached_sample_urls:null,get_cached_sample_urls:function(){if(LocalStorageDisabled())return null;localStorage.sample_url_format!=2&&Post.clear_sample_url_cache();if(Post.cached_sample_urls!=null)return Post.cached_sample_urls;try{var e=JSON.parse(window.localStorage.sample_urls)}catch(t){return{}}return e==null?{}:(Post.cached_sample_urls=e,e)},clear_sample_url_cache:function(){"sample_urls"in localStorage&&delete window.localStorage.sample_urls,"sample_url_fifo"in localStorage&&delete window.localStorage.sample_url_fifo,localStorage.sample_url_format=2},cache_sample_urls:function(){var e=Post.get_cached_sample_urls();if(e==null)return;var t=window.localStorage.sample_url_fifo||null;t=t?t.split(","):[],Post.posts.each(function(n){var r=n[1];r.sample_url&&(e[r.id]=r.sample_url),t.push(r.id)}),t=t.splice(-1e3);var n={};t.each(function(e){n[e]=!0});var r=[];for(post_id in e)post_id in n||r.push(post_id);r.each(function(t){delete e[t]}),Post.cached_sample_urls=e;try{window.localStorage.sample_urls=JSON.stringify(e),window.localStorage.sample_url_fifo=t.join(",")}catch(i){throw Post.clear_sample_url_cache(),i}},prompt_to_delete:function(e,t){t==null&&(t=function(){window.location.reload()});var n=Post.posts.get(e).flag_detail,r=n?n.reason:"",i=prompt("Reason:",r);return i?(Post.approve(e,i,t),!0):!1}},PostModeMenu={mode:"view",init:function(e){try{this.pool_id=e;var t=$("mode-box");this.original_style={border:t.getStyle("border")},Cookie.get("mode")==""?(Cookie.put("mode","view"),$("mode").value="view"):$("mode").value=Cookie.get("mode")}catch(n){}this.vote_score=Cookie.get("vote"),this.vote_score==""?(this.vote_score=1,Cookie.put("vote",this.vote_score)):this.vote_score==+this.vote_score,Post.posts.each(function(e){var t=e[0],n=e[1],r=$("p"+n.id);if(r==null)return;r.down("A").observe("click",function(e){PostModeMenu.click(e,t)}),r.down("A").observe("mousedown",function(e){PostModeMenu.post_mousedown(e,t)}),r.down("A").observe("mouseover",function(e){PostModeMenu.post_mouseover(e,t)}),r.down("A").observe("mouseout",function(e){PostModeMenu.post_mouseout(e,t)}),r.down("A").observe("mouseup",function(e){PostModeMenu.post_mouseup(e,t)})}),document.observe("mouseup",function(e){PostModeMenu.post_mouseup(e,null)}),Event.observe(window,"pagehide",function(e){PostModeMenu.post_end_drag()}),this.change()},set_vote:function(e){this.vote_score=e,Cookie.put("vote",this.vote_score),Post.update_vote_widget("vote-menu",this.vote_score)},get_style_for_mode:function(e){return e=="view"?{background:""}:e=="edit"?{background:"#3A3"}:e=="rating-q"?{background:"#AAA"}:e=="rating-s"?{background:"#6F6"}:e=="rating-e"?{background:"#F66"}:e=="vote"?{background:"#FAA"}:e=="lock-rating"?{background:"#AA3"}:e=="lock-note"?{background:"#3AA"}:e=="approve"?{background:"#26A"}:e=="flag"?{background:"#F66"}:e=="add-to-pool"?{background:"#26A"}:e=="apply-tag-script"?{background:"#A3A"}:e=="reparent-quick"?{background:"#CCA"}:e=="remove-from-pool"?{background:"#CCA"}:e=="reparent"?{background:"#0C0"}:e=="dupe"?{background:"#0C0"}:{background:"#AFA"}},change:function(){if(!$("mode"))return;var e=$F("mode");Cookie.put("mode",e,7),PostModeMenu.mode=e,e.value!="edit"&&$("quick-edit").hide(),e.value!="apply-tag-script"&&($("edit-tag-script").hide(),Post.reset_tag_script_applied()),e=="vote"?(Post.update_vote_widget("vote-menu",this.vote_score),$("vote-score").show()):e=="apply-tag-script"&&($("edit-tag-script").show(),$("edit-tag-script").focus())},click:function(e,t){var n=$("mode");if(!n)return;if(n.value=="view")return!0;if(n.value=="edit")post_quick_edit.show(t);else if(n.value=="vote")Post.vote(t,this.vote_score);else if(n.value=="rating-q")Post.update_batch([{id:t,rating:"questionable"}]);else if(n.value=="rating-s")Post.update_batch([{id:t,rating:"safe"}]);else if(n.value=="rating-e")Post.update_batch([{id:t,rating:"explicit"}]);else if(n.value=="reparent"){if(t==id)return!1;TagScript.run(t,"parent:"+id)}else if(n.value=="dupe"){if(t==id)return!1;TagScript.run(t,"duplicate parent:"+id)}else n.value=="lock-rating"?Post.update_batch([{id:t,is_rating_locked:"1"}]):n.value=="lock-note"?Post.update_batch([{id:t,is_note_locked:"1"}]):n.value=="flag"?Post.flag(t):n.value=="approve"?Post.approve(t):n.value=="add-to-pool"?Pool.add_post(t,0):n.value=="remove-from-pool"&&Pool.remove_post(t,PostModeMenu.pool_id);e.stopPropagation(),e.preventDefault()},dragging_from_post:null,dragging_active:!1,dragging_list:null,dragging_hash:null,post_add_to_hovered_list:function(e){var t=t=$$("#p"+e+" > .directlink");t.length>0&&(t[0].addClassName("tag-script-applied"),Post.applied_list.push(t[0])),PostModeMenu.dragging_hash.get(e)||(PostModeMenu.dragging_hash.set(e,!0),PostModeMenu.dragging_list.push(e))},post_mousedown:function(e,t){if(e.button!=0)return;if(PostModeMenu.mode=="reparent-quick")PostModeMenu.dragging_from_post=t,PostModeMenu.post_begin_drag();else{if(PostModeMenu.mode!="apply-tag-script")return;Post.reset_tag_script_applied(),PostModeMenu.dragging_from_post=t,PostModeMenu.dragging_list=new Array,PostModeMenu.dragging_hash=new Hash,PostModeMenu.post_add_to_hovered_list(t)}e.preventDefault(),e.stopPropagation()},post_begin_drag:function(e){document.body.addClassName("dragging-to-post")},post_end_drag:function(){document.body.removeClassName("dragging-to-post"),PostModeMenu.dragging_from_post=null},post_mouseup:function(e,t){if(e.button!=0)return;if(!PostModeMenu.dragging_from_post)return;if(PostModeMenu.mode=="reparent-quick"){t&&(notice("Updating post"),Post.update_batch([{id:PostModeMenu.dragging_from_post,parent_id:t}])),PostModeMenu.post_end_drag();return}if(PostModeMenu.mode=="apply-tag-script"){if(t)return;var n=TagScript.TagEditArea.value;TagScript.run(PostModeMenu.dragging_list,n),PostModeMenu.dragging_from_post=null,PostModeMenu.dragging_active=!1,PostModeMenu.dragging_list=null,PostModeMenu.dragging_hash=null}},post_mouseover:function(e,t){var n=$("p"+t),r=PostModeMenu.get_style_for_mode(PostModeMenu.mode);n.down("span").setStyle(r);if(PostModeMenu.mode!="apply-tag-script")return;if(!PostModeMenu.dragging_from_post)return;t!=PostModeMenu.dragging_from_post&&(PostModeMenu.dragging_active=!0),PostModeMenu.post_add_to_hovered_list(t)},post_mouseout:function(e,t){var n=$("p"+t);n.down("span").setStyle({background:""})},apply_tag_script_to_all_posts:function(){var e=TagScript.TagEditArea.value,t=Post.posts.inject([],function(e,t){return e.push(t[0]),e});TagScript.run(t,e)}},TagScript={TagEditArea:null,load:function(){this.TagEditArea.value=Cookie.get("tag-script")},save:function(){Cookie.put("tag-script",this.TagEditArea.value)},init:function(e,t){this.TagEditArea=e,TagScript.load(),this.TagEditArea.observe("change",function(e){TagScript.save()}),this.TagEditArea.observe("focus",function(e){Post.reset_tag_script_applied()}),Event.on(window,"unload",function(){TagScript.save()}),document.observe("focus",function(e){TagScript.load()})},parse:function(e){return e.match(/\[.+?\]|\S+/g)},test:function(e,t){var n=t.match(/\S+/g),r=!0;return n.each(function(t){if(t[0]=="-"){if(e.include(t.substr(1,100)))throw r=!1,$break}else if(!e.include(t))throw r=!1,$break}),r},process:function(e,t){if(t.match(/^\[if/)){var n=t.match(/\[if\s+(.+?)\s*,\s*(.+?)\]/);return TagScript.test(e,n[1])?TagScript.process(e,n[2]):e}return t=="[reset]"?[]:t[0]=="-"&&t.indexOf("-pool:")!=0?e.reject(function(e){return e==t.substr(1,100)}):(e.push(t),e)},run:function(e,t,n){Object.isArray(e)||(e=$A([e]));var r=TagScript.parse(t)||[],i=new Array;e.each(function(e){var t=Post.posts.get(e),n=t.tags.join(" ");r.each(function(e){t.tags=TagScript.process(t.tags,e)}),i.push({id:e,old_tags:n,tags:t.tags.join(" ")})}),notice("Updating "+i.length+(e.length==1?" post":" posts")),Post.update_batch(i,n)}},PostQuickEdit.prototype.show=function(e){Post.hover_info_pin(e);var t=Post.posts.get(e);this.post_id=e,this.old_tags=t.tags.join(" "),this.container.down("#post_tags").value=t.tags.join(" ")+" rating:"+t.rating.substr(0,1)+" ",this.container.show(),this.container.down("#post_tags").focus()},PostQuickEdit.prototype.hide=function(){this.container.hide(),Post.hover_info_pin(null)},PostQuickEdit.prototype.submit_event=function(e){e.stop(),this.hide(),Post.update_batch([{id:this.post_id,tags:this.container.down("#post_tags").value,old_tags:this.old_tags}],function(){notice("Post updated"),this.hide()}.bind(this))},PostTagHistory={last_click:-1,checked:[],dragging:!1,init:function(){$("history").observe("mousedown",function(e){e.shiftKey||(PostTagHistory.last_click=-1),PostTagHistory.mouse_is_down(),e.stopPropagation(),e.preventDefault()},!0),PostTagHistory.update()},add_change:function(e,t,n){PostTagHistory.checked.push({id:e,post_id:t,user_id:n,on:!1,row:$("r"+e)}),$("r"+e).observe("mousedown",function(t){PostTagHistory.mousedown(e,t),!0}),$("r"+e).observe("mouseover",function(t){PostTagHistory.mouseover(e,t),!0})},update:function(){for(i=0;i<PostTagHistory.checked.length;++i){var e=PostTagHistory.checked[i].row;PostTagHistory.checked[i].on?e.addClassName("selected"):e.removeClassName("selected")}PostTagHistory.count_selected()>0?$("undo").className="":$("undo").className="footer-disabled",PostTagHistory.count_selected()==1?(i=PostTagHistory.get_first_selected_row(),$("revert").href="post_tag_history/revert?id="+PostTagHistory.checked[i].id,$("revert").className="",$("post_id").value=PostTagHistory.checked[i].post_id,$("user_name").value=PostTagHistory.checked[i].user_id):($("revert").href="#",$("revert").className="footer-disabled")},count_selected:function(){ret=0;for(i=0;i<PostTagHistory.checked.length;++i)PostTagHistory.checked[i].on&&++ret;return ret},get_first_selected_row:function(){for(i=0;i<PostTagHistory.checked.length;++i)if(PostTagHistory.checked[i].on)return i;return null},get_row_by_id:function(e){for(i=0;i<PostTagHistory.checked.length;++i)if(PostTagHistory.checked[i].id==e)return i;return null},set:function(e,t,n){i=e;for(;;){PostTagHistory.checked[i].on=n;if(i==t)break;i+=t>e?1:-1}},doc_mouseup:function(e){PostTagHistory.dragging=!1,document.stopObserving("mouseup",PostTagHistory.doc_mouseup)},mouse_is_down:function(){PostTagHistory.dragging=!0,document.observe("mouseup",PostTagHistory.doc_mouseup)},mousedown:function(e,t){if(!Event.isLeftClick(t))return;PostTagHistory.mouse_is_down();var n=PostTagHistory.get_row_by_id(e);if(n==null)return;var r=null,i=null;PostTagHistory.last_click!=-1&&t.shiftKey?(r=PostTagHistory.last_click,i=n):(r=i=PostTagHistory.last_click=n,PostTagHistory.checked[n].on=!PostTagHistory.checked[n].on);var s=PostTagHistory.checked[r].on;t.ctrlKey||PostTagHistory.set(0,PostTagHistory.checked.length-1,!1),PostTagHistory.set(r,i,s),PostTagHistory.update(),t.stopPropagation(),t.preventDefault()},mouseover:function(e,t){var n=PostTagHistory.get_row_by_id(e);if(!n)return;PostTagHistory.last_click==-1&&(PostTagHistory.last_click=n);if(!PostTagHistory.dragging)return;PostTagHistory.set(0,PostTagHistory.checked.length-1,!1),first=PostTagHistory.last_click,last=n,this_click=n,PostTagHistory.set(first,last,!0),PostTagHistory.update()},undo:function(){if(PostTagHistory.count_selected()==0)return;var e=[];for(i=0;i<PostTagHistory.checked.length;++i){if(!PostTagHistory.checked[i].on)continue;e.push(PostTagHistory.checked[i].id)}notice("Undoing..."),new Ajax.Request("/post_tag_history/undo.json",{parameters:{id:e.join(",")},onComplete:function(e){var e=e.responseJSON;e.success?notice("Changes undone."):notice("Error: "+e.reason)}})}};var _preload_image_pool=null;PreloadContainer=function(){_preload_image_pool==null&&(_preload_image_pool=new ImgPoolHandler),this.container=$(document.createElement("div")),this.container.style.display="none",document.body.appendChild(this.container),this.active_preloads=0,this.on_image_complete_event=this.on_image_complete_event.bindAsEventListener(this)},PreloadContainer.prototype.cancel_preload=function(e){e.stopObserving(),this.container.removeChild(e),_preload_image_pool.release(e),e.active&&--this.active_preloads},PreloadContainer.prototype.preload=function(e){++this.active_preloads;var t=_preload_image_pool.get();return t.observe("load",this.on_image_complete_event),t.observe("error",this.on_image_complete_event),t.src=e,t.active=!0,this.container.appendChild(t),t},PreloadContainer.prototype.get_all=function(){return this.container.childElements()},PreloadContainer.prototype.destroy=function(){this.get_all().each(function(e){this.cancel_preload(e)}.bind(this)),document.body.removeChild(this.container)},PreloadContainer.prototype.on_image_complete_event=function(e){--this.active_preloads,e.target.active=!1},Preload={preload_list:[],preload_container:null,preload_raw_urls:[],preload_started:!1,onload_event_initialized:!1,get_default_preload_container:function(){return this.preload_container||(this.preload_container=new PreloadContainer),this.preload_container},init:function(){if(this.onload_event_initialized)return;this.onload_event_initialized=!0,Event.observe(window,"load",function(){Preload.preload_started=!0,Preload.start_preload()})},preload:function(e){var t=this.get_default_preload_container();Preload.init(),Preload.preload_list.push([e,t]),Preload.start_preload()},preload_raw:function(e){Preload.init(),Preload.preload_raw_urls.push(e),Preload.start_preload()},create_raw_preload:function(e){return new Ajax.Request(e,{method:"get",evalJSON:!1,evalJS:!1,parameters:null})},start_preload:function(){if(!Preload.preload_started)return;for(var e=0;e<Preload.preload_list.length;++e){var t=Preload.preload_list[e],n=t[1];n.preload(t[0])}Preload.preload_list.length=[];for(var e=0;e<Preload.preload_raw_urls.length;++e){var r=Preload.preload_raw_urls[e];Preload.create_raw_preload(r)}Preload.preload_raw_urls=[]}},ReferralBanner=function(e){if(User.get_current_user_level()>30){this.container=null;return}this.container=e;if(!e)return;this.container.down(".close-button").on("click",function(e){e.stop(),this.container.removeClassName("shown")}.bind(this))},ReferralBanner.prototype.show_referral=function(){if(!this.container)return;this.container.show(),function(){this.container.addClassName("shown")}.bind(this).defer()},ReferralBanner.prototype.increment_view_count=function(){var e=Cookie.get_int("viewed");return++e,Cookie.put("viewed",e),e},ReferralBanner.prototype.increment_views_and_check_referral=function(){var e=86400,t=9999,n=this.increment_view_count(),r=Cookie.get_int("sref"),i=(new Date).getTime()/1e3;r&&(r>i||i-r>=e)&&(Cookie.put("sref",0),r=0,Cookie.put("vref",n-1));if(r)return;var s=Cookie.get_int("vref");if(n>=s&&n-s<t)return;Cookie.put("sref",i),this.show_referral()},RelatedTags={user_tags:[],recent_tags:[],recent_search:{},init:function(e,t){this.user_tags=(e.match(/\S+/g)||[]).sort(),this.recent_tags=Cookie.get("recent_tags").match(/\S+/g),this.recent_tags?this.recent_tags=this.recent_tags.sort().uniq(!0):this.recent_tags=[],t!=null&&t.match(/^http/)?this.find_artist($F("post_source")):this.build_all({})},toggle:function(e,t){var t=$(t),n=t.value.match(/\S+/g)||[],r=(e.innerText||e.textContent).replace(/ /g,"_");return n.include(r)?t.value=n.without(r).join(" ")+" ":t.value=n.concat([r]).join(" ")+" ",this.build_all(this.recent_search),!1},build_html:function(e,t){if(t==null||t.size()==0)return"";var n="",r=$F("post_tags").match(/\S+/g)||[];n+='<div class="tag-column">',n+="<h6><em>"+e.replace(/_/g," ")+"</em></h6>";for(var i=0;i<t.size();++i){var s=t[i];n+='<a href="/post?tags='+encodeURIComponent(s)+'" onclick="RelatedTags.toggle(this, \'post_tags\'); return false"',r.include(s)&&(n+=' style="background: rgb(0, 111, 250); color: white;"'),n+=">"+s.escapeHTML().replace(/_/g," ")+"</a><br> "}return n+="</div>",n},build_all:function(e){this.recent_search=e;var t=this.build_html("My Tags",this.user_tags)+this.build_html("Recent Tags",this.recent_tags),n=[];for(key in e)n.push(key);n.sort();for(var r=0;r<n.size();++r)t+=this.build_html(n[r],e[n[r]]);$("related").update(t)},find:function(e,t){$("related").update("<em>Fetching...</em>");var e=$(e),n=null;e.textLength==null&&(e.textLength=jQuery(e).val().length);if(e.selectionStart!=e.textLength){var r=e.selectionStart,i=e.selectionEnd;if(r!=i)while(i>0&&e.value[i]!=" ")i-=1;while(r>0&&e.value[r]!=" ")r-=1;e.value[r]==" "&&(r+=1);while(i<e.textLength&&e.value[i]!=" ")i+=1;n=e.value.slice(r,i)}else n=e.value;var s={tags:n};t&&(s.type=t),new Ajax.Request("/tag/related.json",{method:"get",parameters:s,onComplete:function(e){var e=e.responseJSON,t=this.convert_related_js_response(e);this.build_all(t)}.bind(this)})},convert_related_js_response:function(e){var t={};for(k in e){var n=e[k].map(function(e){return e[0]}).sort();t[k]=n}return t},find_artist:function(e){e.match(/^http/)&&new Ajax.Request("/artist.json",{method:"get",parameters:{url:e,limit:"10"},onComplete:function(e){var e=e.responseJSON;this.build_all({Artist:e.map(function(e){return e.name})})}.bind(this)})}},ThumbnailUserImage=function(e,t){ThumbnailUserImage.image_pool==null&&(ThumbnailUserImage.image_pool=new ImgPoolHandler),this.file=e,this.canvas=create_canvas_2d(),this.image=ThumbnailUserImage.image_pool.get(),this.onComplete=t,this.url=URL.createObjectURL(this.file),this.image.on("load",this.image_load_event.bindAsEventListener(this)),this.image.on("abort",this.image_abort_event.bindAsEventListener(this)),this.image.on("error",this.image_error_event.bindAsEventListener(this)),document.documentElement.addClassName("progress"),this.image.src=this.url},ThumbnailUserImage.image_pool=null,ThumbnailUserImage.prototype.destroy=function(){document.documentElement.removeClassName("progress"),this.onComplete=null,this.image.stopObserving(),ThumbnailUserImage.image_pool.release(this.image),this.image=null,this.url!=null&&(URL.revokeObjectURL(this.url),this.url=null)},ThumbnailUserImage.prototype.completed=function(e){this.onComplete&&this.onComplete(e),this.destroy()},ThumbnailUserImage.prototype.image_load_event=function(e){var t=this.image.width,n=this.image.height,r=128,i=128;if(t>r){var s=r/t;n*=s,t*=s}if(n>i){var s=i/n;n*=s,t*=s}t=Math.round(t),n=Math.round(n);var o=this.canvas;o.width=t,o.height=n;var u=o.getContext("2d");u.clearRect(0,0,o.width,o.height),u.drawImage(this.image,0,0,o.width,o.height);if(!this.check_image_contents()){this.completed({success:!1,chromeFailure:!0});return}this.completed({success:!0,canvas:this.canvas})},ThumbnailUserImage.prototype.check_image_contents=function(){var e=this.canvas.getContext("2d"),t=e.getImageData(0,0,this.canvas.width,this.canvas.height),n=t.data,r=3,i=t.width*t.height*4;while(r<i){if(n[r]!=0)return!0;r+=4}return!1},ThumbnailUserImage.prototype.image_abort_event=function(e){this.completed({success:!1,aborted:!0})},ThumbnailUserImage.prototype.image_error_event=function(e){this.completed({success:!1})};if(!("URL"in window)||create_canvas_2d()==null)ThumbnailUserImage=null;SimilarWithThumbnailing=function(e){this.similar=null,this.form=e,this.force_file=null,e.on("submit",this.form_submit_event.bindAsEventListener(this))},SimilarWithThumbnailing.prototype.form_submit_event=function(e){var t=this.form.down("#file");if(t.files==null||t.files.length==0)return;var n=t.files[0];if(this.force_file&&this.force_file==n){this.force_file=null;return}e.stop(),this.similar&&this.similar.destroy(),this.similar=new ThumbnailUserImage(n,this.complete.bind(this))},SimilarWithThumbnailing.prototype.complete=function(e){if(e.chromeFailure){notice("The image failed to load; submitting normally..."),this.force_file=this.file,function(){this.form.simulate_submit()}.bind(this).defer();return}if(!e.success){e.aborted||alert("The file couldn't be loaded.");return}var t=e.canvas.toDataURL(),n=new FormData;n.append("url",t);var r=new Ajax.Request("/post/similar.json",{method:"post",postBody:n,contentType:null,onComplete:function(e){var t=e.responseJSON;if(!t.success){notice(t.reason);return}window.location.href="/post/similar?search_id="+t.search_id}})};if(!("FormData"in window)||!ThumbnailUserImage)SimilarWithThumbnailing=null;TagCompletionClass=function(){this.loading=!1,this.loaded=!1;var e=5;localStorage.tag_data_format!=e&&(delete localStorage.tag_data,delete localStorage.tag_data_version,delete localStorage.recent_tags,localStorage.tag_data_format=e),this.recent_tags=localStorage.recent_tags||"",this.load_data_complete_callbacks=[],this.rapid_backspaces_received=0,this.updates_deferred=!1},TagCompletionClass.prototype.init=function(e){if(this.loaded)return;this.most_recent_tag_data_version=e},TagCompletionClass.prototype.load_data=function(e){if(this.loaded)return e&&e(),this.tag_data!=null;e&&this.load_data_complete_callbacks.push(e);if(this.loading)return this.tag_data!=null;this.loading=!0;var t=function(){this.loading=!1,this.loaded=!0,this.update_tag_types();var e=this.load_data_complete_callbacks;this.load_data_complete_callbacks=[],e.each(function(e){e()}.bind(this))}.bind(this);localStorage.tag_data!=null&&(this.tag_data=localStorage.tag_data);if(localStorage.tag_data!=null)if(this.most_recent_tag_data_version==null||localStorage.tag_data_version==this.most_recent_tag_data_version)return t(),this.tag_data!=null;var n={};localStorage.tag_data_version!=null&&(n.version=localStorage.tag_data_version);var r=new Ajax.Request("/tag/summary.json",{parameters:n,onSuccess:function(e){var n=e.responseJSON;if(n.unchanged){this.tag_data=localStorage.tag_data,t();return}this.tag_data=n.data,localStorage.tag_data=this.tag_data,localStorage.tag_data_version=n.version,t()}.bind(this)});return this.tag_data!=null},TagCompletionClass.prototype.observe_tag_changes_on_submit=function(e,t,n){return e.on("submit",function(e){var r=n?n.value:null;TagCompletion.add_recent_tags_from_update(t.value,r)})};var get_tag_from_string=function(e){var t=e.match(/\d+`([^`]*)`.*/);if(!t)throw"Unparsable cached tag: '"+e+"'";return t[1]},split_data=function(e,t){var n=e.split(t);if(n.length!=0){if(n[n.length-1]!="")throw"String doesn't end in separator";n.pop()}return n},join_data=function(e,t){return e.length==0?"":e.join(t)+t};TagCompletionClass.prototype.update_tag_types_for_list=function(e,t){var n={},r=split_data(e," "),i=0;return r.each(function(e){if(e=="")return;var t=get_tag_from_string(e);n[t]=i,++i}),Post.tag_types.each(function(e){var i=e[0],s=e[1],o=Post.tag_type_names.indexOf(s);if(o==-1)throw"Unknown tag type "+s;if(i in n){var a=n[i],f=r[a],l=f.match(/\d+(`.*)/),c=o+l[1];r[a]=c}else if(t){var u=o+"`"+i+"`";r.push(u)}}),join_data(r," ")},TagCompletionClass.prototype.update_tag_types=function(){if(!this.loaded)return;this.tag_data=this.update_tag_types_for_list(this.tag_data,!0),localStorage.tag_data=this.tag_data,this.recent_tags=this.update_tag_types_for_list(this.recent_tags,!1),localStorage.recent_tags=this.recent_tags},TagCompletionClass.prototype.create_tag_search_regex=function(e,t){var n=e.split(""),r=[],i="(([^`]*_)?";n.each(function(e){var t=RegExp.escape(e);i+=t}),i+=")",r.push(i);if(e.indexOf("_")!=-1){var s=e.split("_",1)[0],o=e.slice(s.length+1);s=RegExp.escape(s),o=RegExp.escape(o);var i="(";i+="("+s+"[^`]*_"+o+")",i+="|",i+="("+o+"[^`]*_"+s+")",i+=")",r.push(i)}if(!t.top_results_only){var i="(";n.each(function(e){var t=RegExp.escape(e);i+=t,i+="[^`]*"}),i+=")",r.push(i)}var u=r.join("|");return u="(\\d+)[^ ]*`("+u+")[^`]*`[^ ]* ",new RegExp(u,t.global?"g":"")},TagCompletionClass.prototype.retrieve_tag_search=function(e,t,n){var r=[],i=10;n.max_results!=null&&(i=n.max_results);while(r.length<i){var s=e.exec(t);if(!s)break;var o=s[0];if(o.indexOf(":deletethistag:")!=-1)continue;r.indexOf(o)==-1&&r.push(o)}return r},TagCompletionClass.prototype.add_recent_tag=function(e){if(e.indexOf(" ")!=-1||e.indexOf("`")!=-1)throw"Invalid recent tag: "+e;this.remove_recent_tag(e);var t=Post.tag_types.get(e)||"general",n=Post.tag_type_names.indexOf(t);if(n==-1)throw"Unknown tag type: "+t;var r=n+"`"+e+"` ";this.recent_tags=r+this.recent_tags;var i=16384;if(this.recent_tags.length>i*10/9){var s=this.recent_tags.indexOf(" ",i);s!=-1&&(this.recent_tags=this.recent_tags.slice(0,s+1))}localStorage.recent_tags=this.recent_tags},TagCompletionClass.prototype.remove_recent_tag=function(e){var t=RegExp.escape(e),n=new RegExp("\\d`"+t+"` ","g");this.recent_tags=this.recent_tags.replace(n,""),localStorage.recent_tags=this.recent_tags},TagCompletionClass.prototype.add_recent_tags_from_update=function(e,t){e=e.split(" "),t!=null&&(t=t.split(" ")),e.each(function(e){if(e.indexOf("`")!=-1)return;if("sqe".indexOf(e)!=-1)return;if(t&&t.indexOf(e)!=-1)return;if(t==null&&e.indexOf(":")==-1&&this.tag_data.indexOf("`"+e+"`")==-1)return;this.add_recent_tag(e)}.bind(this))},TagCompletionClass.prototype.reorder_search_results=function(e,t){var n=this.create_tag_search_regex(e,{top_results_only:!0,global:!1}),r=[],i=[];return t.each(function(e){n.test(e)?r.push(e):i.push(e)}),r.concat(i)},TagCompletionClass.prototype.complete_tag=function(e,t){if(this.tag_data==null)throw"Tag data isn't loaded";t==null&&(t={});if(e=="")return[[],0];var n=this.create_tag_search_regex(e,{global:!0}),r=this.retrieve_tag_search(n,this.recent_tags,{max_results:100}),i=this.retrieve_tag_search(n,this.tag_data,{max_results:100});r=this.reorder_search_results(e,r),i=this.reorder_search_results(e,i);var s=r.length,o=r.concat(i);"sqe".indexOf(e)!=-1&&o.unshift("0`"+e+"` "),o=o.slice(0,t.max_results!=null?t.max_results:10),s=Math.min(o.length,s);var u=[],a={},f=[];return o.each(function(e){var t=e.match(/(\d+)`([^`]*)`(([^ ]*)`)? /);if(!t)throw ReportError("Unparsable cached tag: '"+e+"'",null,null,null,null),"Unparsable cached tag: '"+e+"'";var e=t[2],n=Post.tag_type_names[t[1]],r=t[4];t[4]?r=r.split("`"):r=[],a[e]=n,u.indexOf(e)==-1&&(u.push(e),f.push(r))}),Post.register_tags(a,!0),[u,s,f]},!LocalStorageDisabled()&&"addEventListener"in document?TagCompletion=new TagCompletionClass:TagCompletion=null,TagCompletionBox=function(e){this.input_field=e,this.update=this.update.bind(this),this.last_value=this.input_field.value,this.input_field.setAttribute("autocomplete","off");var t='<div class="tag-completion-box"><ul class="color-tag-types"></ul></div>',n=t.createElement();n.tabindex=-1,document.body.appendChild(n),this.completion_box=n,document.on("mousedown",function(e){if(e.target.isParentNode(this.input_field)||e.target.isParentNode(this.completion_box))return;this.hide()}.bindAsEventListener(this)),this.input_field.on("mousedown",this.input_mouse.bindAsEventListener(this)),this.input_field.on("mouseup",this.input_mouse.bindAsEventListener(this)),this.input_field.parentNode.addEventListener("keydown",this.input_keydown.bindAsEventListener(this),!0),this.input_field.on("keypress",this.input_keypress.bindAsEventListener
(this)),this.completion_box.on("mouseover",".completed-tag",function(e,t){this.focus_element(t)}.bind(this)),this.completion_box.on("click","li",this.click_result.bind(this)),this.hide()},TagCompletionBox.prototype.input_mouse=function(e){this.update.defer()},TagCompletionBox.prototype.input_keydown=function(e){if(e.target!=this.input_field)return;e.keyCode==Event.KEY_BACKSPACE&&(++this.rapid_backspaces_received,this.backspace_timeout&&clearTimeout(this.backspace_timeout),this.backspace_timeout=setTimeout(function(){this.rapid_backspaces_received=0}.bind(this),100),this.rapid_backspaces_received>1&&(this.updates_deferred=!0,this.defer_timeout!=null&&clearTimeout(this.defer_timeout),this.defer_timeout=setTimeout(function(){this.updates_deferred=!1,this.update()}.bind(this),100)));if(!this.shown){this.update.defer();return}if(e.keyCode==Event.KEY_DOWN)e.stop(),this.select_next(!0);else if(e.keyCode==Event.KEY_UP)e.stop(),this.select_next(!1);else if(e.keyCode==Event.KEY_ESC)e.stop(),this.hide();else if(e.keyCode==Event.KEY_RETURN){var t=this.completion_box.down(".focused");t?(e.stop(),this.set_current_word(t.result_tag)):this.hide()}else this.update.defer()},TagCompletionBox.prototype.focus_element=function(e){if(e==null)throw"Can't select no element";var t=this.completion_box.down(".focused");t&&t.removeClassName("focused"),e&&e.addClassName("focused")},TagCompletionBox.prototype.select_next=function(e){var t=this.completion_box.down(".focused"),n=e?t.nextSiblings():t.previousSiblings(),r=Prototype.Selector.find(n,".completed-tag",0);r==null&&(r=this.completion_box.down(e?".completed-tag":".completed-tag:last-child")),this.focus_element(r)},TagCompletionBox.prototype.show=function(){this.shown=!0;var e=this.input_field.cumulativeOffset();this.completion_box.style.top=e.top+this.input_field.offsetHeight+"px",this.completion_box.style.left=e.left+"px",this.completion_box.style.minWidth=this.input_field.offsetWidth+"px"},TagCompletionBox.prototype.hide=function(){this.shown=!1,this.current_tag=null,this.completion_box.hide()},TagCompletionBox.prototype.click_result=function(e,t){e.stop();if(e.target.hasClassName("remove-recent-tag")){TagCompletion.remove_recent_tag(t.result_tag),this.update(!0);return}this.set_current_word(t.result_tag)},TagCompletionBox.prototype.get_input_word_offset=function(e){var t=e.value,n=t.lastIndexOf(" ",e.selectionStart-1);n==-1?n=0:++n;var r=t.indexOf(" ",e.selectionStart);return r==-1&&(r=t.length),{start:n,end:r}},TagCompletionBox.prototype.set_current_word=function(e){var t=this.get_input_word_offset(this.input_field),n=this.input_field.value,r=n.substr(0,t.start),i=n.substr(t.end),s=e;i.match(/^ +$/)&&(i=""),i==""&&(s+=" "),this.input_field.value=r+s+i;var o=r.length+s.length;this.input_field.selectionStart=this.input_field.selectionEnd=o,TagCompletion.add_recent_tag(e),this.hide()},TagCompletionBox.prototype.update=function(e){if(this.updates_deferred&&!e)return;if(TagCompletion.tag_data==null){var t=TagCompletion.load_data(function(){if(t)return;this.current_tag=null,this.update()}.bind(this));if(!t)return}var n=this.get_input_word_offset(this.input_field),r=this.input_field.value.substr(n.start,n.end-n.start);if(r==this.current_tag&&!e)return;this.hide();if(this.last_value==this.input_field.value&&!e)return;this.last_value=this.input_field.value,this.current_tag=r;if(!this.input_field.recursivelyVisible())return;var i=TagCompletion.complete_tag(r),s=i[0],o=i[2],u=i[1];if(s.length==0)return;if(s.length==1&&s[0]==r)return;this.show();var a=this.completion_box.down("UL");this.completion_box.hide();while(a.firstChild)a.removeChild(a.firstChild);for(var f=0;f<s.length;++f){var r=s[f],l=document.createElement("LI");l.className="completed-tag",l.setTextContent(r),a.appendChild(l);var c=o[f];if(c.length>0){var h=document.createElement("span");h.className="completed-tag-alias",h.setTextContent(c[0]),l.appendChild(h)}var p=Post.tag_types.get(r);l.className+=" tag-type-"+p;if(f<u){l.className+=" recent-tag";var d="<a class='remove-recent-tag' href='#'>X</a>'";l.appendChild(d.createElement())}l.result_tag=r}this.completion_box.show(),this.focus_element(this.completion_box.down(".completed-tag"))},TagCompletionBox.prototype.input_keypress=function(e){this.update.defer()};if(TagCompletion==null||!("addEventListener"in document))TagCompletionBox=function(){};AndroidDetectWindowSize.required=function(){return navigator.userAgent.indexOf("Android")!=-1},AndroidDetectWindowSize.prototype.dispatch_resize_event=function(){debug("dispatch final resize event");var e=document.createEvent("Event");e.initEvent("resize",!0,!0),document.documentElement.dispatchEvent(e)},AndroidDetectWindowSize.prototype.begin=function(){if(this.active)return;var e=this.current_window_size();if(this.window_size&&e[0]==this.window_size[0]&&e[1]==this.window_size[1]){debug("skipped window size detection");return}debug("begin window size detection, "+e[0]+"x"+e[1]+" at start (scroll pos "+document.documentElement.scrollHeight+")"),this.active=!0,this.padding.show(),$("sizing-body").setStyle({width:"0px",height:"0px"}),window.scrollTo(0,99999999),this.finish_timer=window.setTimeout(this.finish,0)},AndroidDetectWindowSize.prototype.end=function(){if(!this.active)return;this.active=!1,this.begin_timer!=null&&window.clearTimeout(this.begin_timer),this.begin_timer=null,this.finish_timer!=null&&window.clearTimeout(this.finish_timer),this.finish_timer=null,this.padding.hide()},AndroidDetectWindowSize.prototype.current_window_size=function(){var e=[window.innerWidth,window.innerHeight];return++e[1],e},AndroidDetectWindowSize.prototype.finish=function(){if(!this.active)return;debug("window size detection: finish(), at "+document.body.scrollTop);if(document.body.scrollTop==0){console.log("Waiting for scroll..."),this.finish_timer=window.setTimeout(this.finish,10);return}window.scrollTo(document.body.scrollLeft,document.body.scrollTop),this.end(),this.window_size=this.current_window_size(),debug("new window size: "+this.window_size[0]+"x"+this.window_size[1]),$("sizing-body").setStyle({width:this.window_size[0]+"px",height:this.window_size[1]+"px"}),this.dispatch_resize_event()},AndroidDetectWindowSize.prototype.event_onresize=function(e){if(this.last_window_orientation!=window.orientation){e.stop(),this.last_window_orientation=window.orientation,this.active?(debug("Orientation changed while already detecting window size; restarting"),this.end()):debug("Resize received with an orientation change; beginning"),this.begin();return}if(this.active){debug("stopping resize event while we're active"),e.stop();return}},EmulateDoubleClick.prototype.touchstart_event=function(e){var t=e.changedTouches[0],n=this.last_click,r={timeStamp:e.timeStamp,target:e.target,identifier:t.identifier,position:[t.screenX,t.screenY],clientPosition:[t.clientX,t.clientY]};this.last_click=r;if(n==null)return;if(e.touches.length>1)return;var i=e.timeStamp-n.timeStamp;if(i>500)return;var s=Math.pow(t.screenX-n.position[0],2)+Math.pow(t.screenY-n.position[1],2);if(s>500)return;if(e.target!=n.target)return;var o=document.createEvent("MouseEvent");o.initMouseEvent("dblclick",!0,!0,window,2,n.position[0],n.position[1],n.clientPosition[0],n.clientPosition[1],!1,!1,!1,!1,0,null),this.last_click=null,e.target.dispatchEvent(o)},EmulateDoubleClick.prototype.touchend_event=function(e){if(this.last_click==null)return;var t=this.last_click.identifier;if(t==null)return;var n=this.last_click.position,r=e.changedTouches[0];if(r.identifier==t){var i=Math.pow(r.screenX-n[0],2)+Math.pow(r.screenY-n[1],2);if(i>500){this.last_click=null;return}}},ResponsiveSingleClick=function(){this.click_event=this.click_event.bindAsEventListener(this),this.touchstart_event=this.touchstart_event.bindAsEventListener(this),this.touchend_event=this.touchend_event.bindAsEventListener(this),this.last_touch=null,window.addEventListener("touchstart",this.touchstart_event,!1),window.addEventListener("touchend",this.touchend_event,!1),window.addEventListener("click",this.click_event,!0)},ResponsiveSingleClick.prototype.touchstart_event=function(e){if(this.last_touch!=null){debug("Cancelling click (multitouch)"),this.last_touch=null;return}var t=e.changedTouches[0];this.last_touch=[t.screenX,t.screenY]},ResponsiveSingleClick.prototype.touchend_event=function(e){var t=this.last_touch;if(t==null)return;this.last_touch=null;var n=e.changedTouches[0],r=[n.screenX,n.screenY],i=distance_squared(r[0],r[1],t[0],t[1]);if(i>50)return;var s=document.createEvent("MouseEvent");s.initMouseEvent("click",!0,!0,window,1,n.screenX,n.screenY,n.clientX,n.clientY,!1,!1,!1,!1,0,null),s.synthesized_click=!0,function(){e.target.dispatchEvent(s)}.defer()},ResponsiveSingleClick.prototype.click_event=function(e){e.synthesized_click||e.stop()},PreventDragScrolling=function(){Element.observe(document,"touchmove",function(e){e.preventDefault()})};var MaintainUrlHash=function(){if(LocalStorageDisabled())return;var e=function(e,t,n){var r=localStorage.current_hash=UrlHash.get_raw_hash()};UrlHash.observe(null,e);var t=localStorage.getItem("current_hash");t&&UrlHash.set_raw_hash(t)},SendMissingResizeEvents=function(){if(window.navigator.standalone)return;if(navigator.userAgent.indexOf("Version/4.0.5")==-1)return;var e=window.orientation;window.addEventListener("orientationchange",function(t){if(e==window.orientation)return;e=window.orientation,debug("dispatch fake resize event");var t=document.createEvent("Event");t.initEvent("resize",!0,!0),document.documentElement.dispatchEvent(t)},!0)},InitializeFullScreenBrowserHandlers=function(){navigator.userAgent.indexOf("Android")!=-1&&navigator.userAgent.indexOf("WebKit")!=-1?(new ResponsiveSingleClick,new EmulateDoubleClick):(navigator.userAgent.indexOf("iPhone")!=-1||navigator.userAgent.indexOf("iPad")!=-1||navigator.userAgent.indexOf("iPod")!=-1)&&navigator.userAgent.indexOf("WebKit")!=-1&&(new ResponsiveSingleClick,new EmulateDoubleClick,window.navigator.standalone&&MaintainUrlHash(),SendMissingResizeEvents()),PreventDragScrolling()};SwipeHandler=function(e){this.element=e,this.dragger=new DragElement(e,{ondrag:this.ondrag.bind(this),onstartdrag:this.startdrag.bind(this)})},SwipeHandler.prototype.startdrag=function(){this.swiped_horizontal=!1,this.swiped_vertical=!1},SwipeHandler.prototype.ondrag=function(e){this.swiped_horizontal||Math.abs(e.aX)>100&&(this.element.fire("swipe:horizontal",{right:e.aX>0}),this.swiped_horizontal=!0),this.swiped_vertical||Math.abs(e.aY)>100&&(this.element.fire("swipe:vertical",{down:e.aY>0}),this.swiped_vertical=!0)},SwipeHandler.prototype.destroy=function(){this.dragger.destroy()},UrlHashHandler=function(){this.observers=new Hash,this.normalize=function(e){},this.denormalize=function(e){},this.deferred_sets=[],this.deferred_replace=!1,this.current_hash=this.parse(this.get_raw_hash()),this.normalize(this.current_hash),this.last_hashchange=this.current_hash.clone(),this.hashchange_event=this.hashchange_event.bindAsEventListener(this),Element.observe(window,"hashchange",this.hashchange_event)},UrlHashHandler.prototype.fire_observers=function(e,t){var n=e.keys();n=n.concat(t.keys()),n=n.uniq();var r=[];n.each(function(n){var i=e.get(n),s=t.get(n);i!=s&&r.push(n)}.bind(this));var i=[];r.each(function(e){var t=this.observers.get(e);if(t==null)return;i=i.concat(t)}.bind(this));var s=this.observers.get(null);s!=null&&(i=i.concat(s)),i.each(function(n){n(r,e,t)})},UrlHashHandler.prototype.set_normalize=function(e,t){this.normalize=e,this.denormalize=t,this.normalize(this.current_hash),this.set_all(this.current_hash.clone())},UrlHashHandler.prototype.hashchange_event=function(e){var t=this.last_hashchange.clone();this.normalize(t);var n=this.get_raw_hash(),r=this.parse(n);this.normalize(r),this.current_hash=r.clone(),this.last_hashchange=r.clone(),this.fire_observers(t,r)},UrlHashHandler.prototype.parse=function(e){e==null&&(e=""),e.substr(0,1)=="#"&&(e=e.substr(1));var t=e.split("?",1)[0],n=e.substr(t.length+1);t=window.decodeURIComponent(t);var r=new Hash;r.set("",t);if(n!=""){var i=n.split("&");for(var s=0;s<i.length;++s){var o=i[s],u=o.split("=",1)[0];if(u=="")continue;var a=o.substr(u.length+1);u=window.decodeURIComponent(u),a=window.decodeURIComponent(a),r.set(u,a)}}return r},UrlHashHandler.prototype.construct=function(e){var t="#",n=e.get("");n!=null&&(n=n.replace(/%/g,"%25").replace(/\?/g,"%3f"),t+=n);var r=[];return e.each(function(e){var t=e[0],n=e[1];if(t=="")return;if(n==null)return;t=window.encodeURIComponent(t),n=window.encodeURIComponent(n),r.push(t+"="+n)}),r.length!=0&&(t+="?"+r.join("&")),t},UrlHashHandler.prototype.get_raw_hash=function(){var e=window.location.href.split("#",1)[0];return window.location.href.substr(e.length)},UrlHashHandler.prototype.set_raw_hash=function(e){var t=this.parse(e);this.set_all(t)},UrlHashHandler.prototype.get=function(e){return this.current_hash.get(e)},UrlHashHandler.prototype.set=function(e,t){var n=this.current_hash.merge(e);this.normalize(n),this.set_all(n,t)},UrlHashHandler.prototype.set_deferred=function(e,t){this.deferred_sets.push(e),t&&(this.deferred_replace=!0);var n=function(){this.deferred_set_timer=null;var e=this.current_hash;this.deferred_sets.each(function(t){e=e.merge(t)}),this.normalize(e),this.set_all(e,this.deferred_replace),this.deferred_sets=[],this.hashchange_event(null),this.deferred_replace=!1}.bind(this);this.deferred_set_timer==null&&(this.deferred_set_timer=n.defer())},UrlHashHandler.prototype.set_all=function(e,t){e=e.clone(),this.normalize(e),this.current_hash=e.clone(),this.denormalize(e);var n=this.construct(e);if(window.location.hash!=n)if(window.history&&window.history.replaceState&&window.history.pushState&&!navigator.userAgent.match("Firefox/[45].")){var r=window.location.protocol+"//"+window.location.host+window.location.pathname+n;t?window.history.replaceState({},window.title,r):window.history.pushState({},window.title,r)}else window.location.hash=n;this.hashchange_event(null)},UrlHashHandler.prototype.observe=function(e,t){var n=this.observers.get(e);n==null&&(n=[],this.observers.set(e,n));if(n.indexOf(t)!=-1)return;n.push(t)},UrlHashHandler.prototype.stopObserving=function(e,t){var n=this.observers.get(e);if(n==null)return;n=n.without(t),this.observers.set(e,n)},UrlHash=new UrlHashHandler,User={disable_samples:function(){new Ajax.Request("/user/update.json",{parameters:{"user[show_samples]":!1},onComplete:function(e){var e=e.responseJSON;e.success?($("resized_notice").hide(),$("samples_disabled").show(),Post.highres()):notice("Error: "+e.reason)}})},destroy:function(e){notice("Deleting record #"+e),new Ajax.Request("/user_record/destroy.json",{parameters:{id:e},onComplete:function(e){e.status==200?notice("Record deleted"):notice("Access denied")}})},current_check:null,cancel_check:function(){current_check=null},reset_password:function(e,t,n){var r=new Ajax.Request("/user/reset_password.json",{parameters:{"user[name]":e,"user[email]":t},onComplete:function(e){var e=e.responseJSON;n(e)}})},check:function(e,t,n,r){var i={username:e};t&&(i.password=t);var s=new Ajax.Request("/user/check.json",{parameters:i,onSuccess:function(e){if(n&&e.request!=current_check)return;current_check=null;var e=e.responseJSON;r(e)}});n&&(current_check=s)},create:function(e,t,n,r){var i={"user[name]":e,"user[password]":t};n&&(i["user[email]"]=n);var s=new Ajax.Request("/user/create.json",{parameters:i,onComplete:function(e){var e=e.responseJSON;r(e)}})},set_login:function(e,t,n){Cookie.put("login",e),Cookie.put("pass_hash",t),Cookie.put("user_info",n)},check_name_timer:null,last_username_in_form:null,success_func:null,messages:[],init:function(){$("login-popup-notices").select("SPAN").each(function(e){User.messages.push(e.id)}),$$("FORM.need-signup").each(function(e){e.observe("submit",User.run_login_onsubmit)}),$("login-popup").observe("submit",function(e){e.stop(),User.form_submitted()}),$("login-popup-submit").observe("click",function(e){e.stop(),User.form_submitted()}),$("login-popup-cancel").observe("click",function(e){e.stop(),User.close(!1)}),$("login-popup-username").observe("blur",function(e){User.form_username_blur()}),$("login-popup-username").observe("focus",function(e){User.form_username_focus()}),$("login-popup-username").observe("keyup",function(e){User.form_username_changed(!0)}),$("login-tabs").select("LI").each(function(e){e.observe("mousedown",function(e){e.stop()})}),$("login-tabs").select("LI").each(function(e){e.observe("click",function(t){t.stop(),User.set_tab(e.id)})}),OnKey(13,{AllowInputFields:!0,Element:$("login-popup")},function(e){e.stop(),User.form_submitted()}),OnKey(27,{AllowInputFields:!0,AlwaysAllowOpera:!0},function(e){return User.success_func?(User.close(!1),!0):!1})},open:function(e){User.success_func&&User.close(!1),User.success_func=e,$("login-background").show(),$("login-container").show(),User.set_tab("tab-login")},close:function(e){if(!User.success_func)return;$("login-background").hide(),$("login-container").hide(),User.active_tab=null,User.check_name_timer=null;var t=User.success_func;User.success_func=null,success_func=null,e&&window.setTimeout(t,0)},run_login_onclick:function(e){e=Event.extend(e);var t=$(e.target),n=clone_event(e);return User.run_login(!0,function(){if(t.hasClassName("login-button")){Cookie.put("notice","You have been logged in."),document.location.reload();return}t.simulate_anchor_click(n)})?!0:(e.stop(),!1)},run_login_onsubmit:function(e){var t=$(e.target);User.run_login(!0,function(){t.simulate_submit()})||e.stop()},run_login:function(e,t){return Cookie.get("login")!=""?(e||t(),!0):(User.open(t),!1)},active_tab:null,set_tab:function(e){if(User.active_tab==e)return;User.active_tab=e,User.check_name_timer=null,User.last_username_in_form=null,$("login-tabs").select("LI").each(function(e){e.removeClassName("selected")}),$("login-tabs").down("#"+e).addClassName("selected"),$$(".tab-header-text").each(function(e){e.hide()}),$(e+"-text").show(),e=="tab-login"?($("login-popup-password").value==""&&$("login-popup-username").value!=""?$("login-popup-password").focus():$("login-popup-username").focus(),User.set_state("login-blank")):e=="tab-reset"&&(User.set_state("reset-blank"),$("login-popup-username").focus()),User.form_username_changed()},message:function(e){for(var t=0,n=User.messages.length;t<n;t++){var r=User.messages[t];$(r).hide()}$("login-popup-message").update(e),$("login-popup-message").show()},set_state:function(e){var t={};e.match(/^login-/)?(t["login-popup-password-box"]=!0,e=="login-blank"?$("login-popup-submit").update("Login"):e=="login-user-exists"?$("login-popup-submit").update("Login"):e=="login-confirm-password"?(t["login-popup-password-confirm-box"]=!0,$("login-popup-submit").update("Create account")):e=="login-confirm-password-mismatch"&&$("login-popup-submit").update("Create account"),t["login-popup-"+e]=!0):e.match(/^reset-/)&&(t["login-popup-email-box"]=!0,$("login-popup-submit").update("Reset password"),t["login-popup-"+e]=!0);var n=["login-popup-email-box","login-popup-password-box","login-popup-password-confirm-box"].concat(User.messages);current_state=e;for(var r=0,i=n.length;r<i;r++){var s=n[r];t[s]?$(s).show():$(s).hide()}},pending_username:null,form_username_changed:function(e){var t=$("login-popup-username").value;if(t==User.last_username_in_form)return;User.last_username_in_form=t,User.cancel_check(),User.check_name_timer&&window.clearTimeout(User.check_name_timer),User.pending_username=null;if(t==""){User.active_tab=="tab-login"?User.set_state("login-blank"):User.active_tab=="tab-reset"&&User.set_state("reset-blank");return}var n=500;!e&&User.check_name_timer&&(n=0),User.check_name_timer=window.setTimeout(function(){User.check_name_timer=null,User.check(t,null,!0,function(e){if(e.exists){var n=$("login-popup-username").value;n==t&&($("login-popup").focused?User.pending_username=e.name:$("login-popup-username").value=e.name)}if(User.active_tab=="tab-login"){if(!e.exists){User.set_state("login-confirm-password");return}User.set_state("login-user-exists")}else User.active_tab=="tab-reset"&&(e.exists?e.no_email?User.set_state("reset-user-has-no-email"):User.set_state("reset-user-exists"):User.set_state("reset-blank"))})},n)},form_username_focus:function(){$("login-popup").focused=!0},form_username_blur:function(){$("login-popup").focused=!1,User.pending_username&&($("login-popup").username.value=User.pending_username,User.pending_username=null),User.form_username_changed(!1)},form_submitted:function(){User.cancel_check(),User.check_name_timer&&window.clearTimeout(User.check_name_timer);var e=$("login-popup-username").value,t=$("login-popup-password").value,n=$("login-popup-password-confirm").value,r=$("login-popup-email").value;if(e=="")return;if(User.active_tab=="tab-login"){if(t==""){User.message("Please enter a password.");return}if(current_state=="login-confirm-password"){t!=n?User.message("The passwords you've entered don't match."):User.create(e,t,null,function(e){e.response=="success"?(User.set_login(e.name,e.pass_hash,e.user_info),User.close(!0)):e.response=="error"&&User.message(e.errors.join("<br>"))});return}User.check(e,t,!1,function(e){if(!e.exists){User.set_state("login-confirm-password");return}if(e.response=="wrong-password"){notice("Incorrect password");return}User.set_login(e.name,e.pass_hash,e.user_info),User.close(!0)})}else if(User.active_tab=="tab-reset"){if(r=="")return;User.reset_password(e,r,function(e){e.result=="success"?User.set_state("reset-successful"):e.result=="unknown-user"?User.set_state("reset-unknown-user"):e.result=="wrong-email"?User.set_state("reset-user-email-incorrect"):e.result=="no-email"?User.set_state("reset-user-has-no-email"):e.result=="invalid-email"&&User.set_state("reset-user-email-invalid")})}},modify_blacklist:function(e,t,n){new Ajax.Request("/user/modify_blacklist.json",{parameters:{"add[]":e,"remove[]":t},onComplete:function(e){var e=e.responseJSON;e.success?n&&n(e):notice("Error: "+e.reason)}})},set_pool_browse_mode:function(e){new Ajax.Request("/user/update.json",{parameters:{"user[pool_browse_mode]":e},onComplete:function(e){var e=e.responseJSON;e.success?window.location.reload():notice("Error: "+e.reason)}})},get_current_user_info:function(){var e=Cookie.get("user_info");return e?e.split(";"):null},get_current_user_info_field:function(e,t){var n=User.get_current_user_info();return n?e>=n.length?t:n[e]:t},get_current_user_id:function(){return parseInt(User.get_current_user_info_field(0,0))},get_current_user_level:function(){return parseInt(User.get_current_user_info_field(1,0))},get_use_browser:function(){var e=User.get_current_user_info_field(2,"0");return e=="1"},is_member_or_higher:function(){return User.get_current_user_level()>=20},is_mod_or_higher:function(){return User.get_current_user_level()>=40}},VoteWidget=function(e){this.container=e,this.post_id=null,this.displayed_hover=-1,this.displayed_set=-1,e.down(".vote-up")&&e.down(".vote-up").on("click",function(e){e.stop(),this.vote_up()}.bindAsEventListener(this));var t={0:"Remove vote",1:"Good",2:"Great",3:"Favorite"};for(var n=0;n<=3;++n){var r=this.container.down(".star-"+n);if(!r)continue;r.star=n,r.desc=t[n]}this.container.on("click",".star",function(e){e.stop(),this.activate_item(e.target)}.bindAsEventListener(this)),this.container.on("mouseover",".star",function(e){this.set_mouseover(e.target)}.bindAsEventListener(this)),this.container.on("mouseout",".star",function(e){this.set_mouseover(e.relatedTarget)}.bindAsEventListener(this)),document.on("posts:update",this.post_update_event.bindAsEventListener(this))},VoteWidget.prototype.get_star_element=function(e){return e?e.hasClassName("star")?e:e.up(".star"):null},VoteWidget.prototype.set_mouseover=function(e){e&&(e=this.get_star_element(e));if(!e){this.set_stars(null);var t=this.container.down(".vote-desc");return t&&t.update(),!1}this.set_stars(e.star);var t=this.container.down(".vote-desc");return t&&t.update(e.desc),!0},VoteWidget.prototype.activate_item=function(e){return e=this.get_star_element(e),e?(this.vote(e.star),e.star):null},VoteWidget.prototype.post_update_event=function(e){var t=this.post_id;if(e.memo.post_ids.get(t)==null)return;this.set_stars(this.displayed_hover);if(this.container.down("#post-score-"+t)){var n=Post.posts.get(t);n&&this.container.down("#post-score-"+t).update(n.score)}e.memo.resp.voted_by&&this.container.down("#favorited-by")&&this.container.down("#favorited-by").update(Favorite.link_to_users(e.memo.resp.voted_by[3]))},VoteWidget.prototype.set_post_id=function(e){var t=Post.votes.get(e)||0;this.post_id=e,this.set_stars(null)},VoteWidget.prototype.init_hotkeys=function(){OnKey(192,null,function(e){return this.vote(0),!0}.bindAsEventListener(this)),OnKey(49,null,function(e){return this.vote(1),!0}.bindAsEventListener(this)),OnKey(50,null,function(e){return this.vote(2),!0}.bindAsEventListener(this)),OnKey(51,null,function(e){return this.vote(3),!0}.bindAsEventListener(this))},VoteWidget.prototype.vote_up=function(){var e=Post.votes.get(this.post_id);return this.vote(e+1)},VoteWidget.prototype.vote=function(e){return Post.vote(this.post_id,e)};var array_select=function(e,t,n,r){r?e.push(t):e.push(n)};VoteWidget.prototype.set_stars=function(e){var t=Post.votes.get(this.post_id);if(this.displayed_hover==e&&this.displayed_set==t)return;this.displayed_hover=e,this.displayed_set=t;for(var n=0;n<=3;++n){var r=this.container.down(".star-"+n);if(!r)continue;var i=r.className;i=i.replace(/(star-hovered|star-unhovered|star-hovered-upto|star-hovered-after|star-set|star-unset|star-set-upto|star-set-after)(\s+|$)/g," "),i=i.strip();var s=i.split(" ");e!=null&&(array_select(s,"star-hovered","star-unhovered",e==n),array_select(s,"star-hovered-upto","star-hovered-after",e>=n)),array_select(s,"star-set","star-unset",t!=null&&t==n),array_select(s,"star-set-upto","star-set-after",t!=null&&t>=n),r.className=s.join(" ")}};